CLEAN REPO EXPORT
Generated: 2025-12-18 18:09:00Z
Root: C:\Dev\scv-repo

============================================================

===== FILE: .gitignore =====
# AI / ChatGPT exports
exports/
*.repo-export.txt
repo-export.txt



===== FILE: app_backend\__init__.py =====


===== FILE: app_backend\bff\router.py =====
from fastapi import APIRouter, HTTPException
from sqlalchemy import text
from database import SessionLocal

router = APIRouter(prefix="/bff", tags=["bff"])


@router.get("/clients")
def list_clients():
    db = SessionLocal()
    try:
        rows = db.execute(
            text("""
                SELECT
                    id, external_id, full_name, email, phone,
                    primary_address, country, tax_id, segment,
                    risk_rating
                FROM clients
                ORDER BY id
            """)
        ).fetchall()

        return {"clients": [dict(r._mapping) for r in rows]}
    finally:
        db.close()


@router.get("/clients/{client_id}")
def get_client_detail(client_id: int):
    db = SessionLocal()
    try:
        client = db.execute(
            text("SELECT * FROM clients WHERE id = :id"),
            {"id": client_id},
        ).fetchone()

        if not client:
            raise HTTPException(status_code=404, detail="Client not found")

        accounts = db.execute(
            text("SELECT * FROM accounts WHERE client_id = :id"),
            {"id": client_id},
        ).fetchall()

        operational_state = db.execute(
            text("""
                SELECT *
                FROM client_operational_state
                WHERE client_id = :id
                ORDER BY as_of DESC
                LIMIT 1
            """),
            {"id": client_id},
        ).fetchone()

        match_decisions = db.execute(
            text("""
                SELECT *
                FROM match_decisions
                WHERE matched_client_id = :id
                ORDER BY decided_at DESC
                LIMIT 10
            """),
            {"id": client_id},
        ).fetchall()

        return {
            "client": dict(client._mapping),
            "accounts": [dict(r._mapping) for r in accounts],
            "operational_state": dict(operational_state._mapping) if operational_state else None,
            "recent_match_decisions": [dict(r._mapping) for r in match_decisions],
        }

    finally:
        db.close()


===== FILE: app_backend\db.py =====
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, declarative_base

SQLALCHEMY_DATABASE_URL = "sqlite:///./scv_sources.db"

engine = create_engine(
    SQLALCHEMY_DATABASE_URL,
    connect_args={"check_same_thread": False},
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

Base = declarative_base()


===== FILE: app_backend\main.py =====
import os  # <-- Added the os import

from app_backend.bff.router import router as bff_router
from fastapi import FastAPI, Depends, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from fastapi.responses import FileResponse
from sqlalchemy.orm import Session
import json

from .db import Base, engine, SessionLocal
from . import models, schemas
from src.services.client_profile.service import ClientProfileService

# Initialise database
Base.metadata.create_all(bind=engine)

app = FastAPI(title="Single Client View (SCV) Backend")
app.include_router(bff_router)


# CORS (for frontend dev server access)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173", "http://127.0.0.1:5173"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Serve frontend static files (React app)
FRONTEND_DIST = "app_frontend/dist"
if os.path.isdir(FRONTEND_DIST):
    app.mount("/assets", StaticFiles(directory=os.path.join(FRONTEND_DIST, "assets")), name="assets")

    @app.get("/", include_in_schema=False)
    async def serve_index():
        index_path = os.path.join(FRONTEND_DIST, "index.html")
        return FileResponse(index_path)

# Serve MissionLog status snapshot JSON file
MISSIONLOG_PUBLIC = "app_frontend/public/missionlog"
if os.path.isdir(MISSIONLOG_PUBLIC):
    app.mount("/missionlog", StaticFiles(directory=MISSIONLOG_PUBLIC), name="missionlog")

# Dependency to get database session
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# Health check endpoint
@app.get("/health", tags=["system"])
def health_check():
    return {"status": "ok"}

# ------------------------------------
# Load raw records for a client
# ------------------------------------
def _load_raw_records_for_client(db: Session, client_id: str) -> list[dict[str, any]]:
    rows: list[models.SourceRecord] = (
        db.query(models.SourceRecord)
        .filter(models.SourceRecord.client_id == client_id)
        .all()
    )

    records: list[dict[str, any]] = []
    for row in rows:
        try:
            payload = json.loads(row.payload_json)
        except json.JSONDecodeError:
            continue

        if "_source" not in payload:
            payload["_source"] = row.system

        records.append(payload)

    return records

# Endpoint to get client profile
@app.get("/clients/{client_id}/profile", tags=["clients"])
def get_client_profile(client_id: str, db: Session = Depends(get_db)):
    raw_records = _load_raw_records_for_client(db, client_id)

    service = ClientProfileService()
    profile = service.assemble_base_profile(client_id, raw_records)

    if not profile:
        raise HTTPException(status_code=404, detail="Profile could not be assembled")

    return profile

# ------------------------------------
# Endpoint to get client sources
# ------------------------------------
@app.get("/clients/{client_id}/sources", tags=["clients"])
def get_client_sources(client_id: str, db: Session = Depends(get_db)):
    # Query the source records for the given client_id
    rows = db.query(models.SourceRecord).filter(models.SourceRecord.client_id == client_id).all()

    # If no sources found, return an empty list
    if not rows:
        return []

    # Otherwise, return the source records
    return rows






===== FILE: app_backend\MissionSmith-M7-SingleClientView.html =====
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MissionSmith</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{ --lp-border:#d9e2ea; --lp-text:#243745; }
    #launchpad .lp-actions > .lp-pill{
      appearance:none;display:inline-flex;align-items:center;justify-content:center;
      height:34px;padding:0 12px;width:132px;border-radius:999px;border:1px solid var(--lp-border);
      background:#f5f9fb;color:var(--lp-text);font-weight:600;font-size:13.5px;white-space:nowrap;
      transition:transform .06s ease,background .15s ease,border-color .15s ease;cursor:pointer;
    }
    #launchpad .lp-actions > .lp-pill:hover{ transform:translateY(-1px); background:#eef5f8; border-color:#c9d6e1; }
  </style>


  <style>
    :root{ --lp-border:#d9e2ea; --lp-text:#243745; }
    header.sticky.top-0 { background: rgba(255,255,255,.70); backdrop-filter: blur(4px); border-bottom:1px solid #e5e7eb; }
    header.sticky.top-0 > .mx-auto { max-width: 80rem; padding-left: 1rem; padding-right: 1rem; }
    header.sticky.top-0 .flex.items-center.gap-2 > button,
    header.sticky.top-0 .msx-framework-btn{
      appearance:none; display:inline-flex; align-items:center; justify-content:center;
      height:34px; padding:0 14px; min-width:220px;
      border-radius:999px; border:1px solid var(--lp-border);
      background:#f5f9fb; color:var(--lp-text); font-weight:600; font-size:13.5px; white-space:nowrap;
      transition:transform .06s ease, border-color .15s ease, background .15s ease; cursor:pointer;
    }
    header.sticky.top-0 .flex.items-center.gap-2 > button:hover,
    header.sticky.top-0 .msx-framework-btn:hover { transform:translateY(-1px); border-color:#c9d6e1; background:#eef5f8; }
    /* Teal badge gloss (if present) */
    header.sticky.top-0 .flex.items-center.gap-3 .h-7.w-7.rounded-xl{
      border-radius:9999px !important;
      background: radial-gradient(ellipse at 65% 35%, rgba(255,255,255,.22), rgba(255,255,255,0) 40%), #1ba39c !important;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.05), 0 1px 2px rgba(0,0,0,.06);
    }
  </style>

</head>
<body class="min-h-screen bg-gray-50">
  
<!-- ms-actions removed by request -->
</div>


<!-- ===== LaunchPad (functional shortcuts) ===== -->
<div id="launchpad" style="position:sticky;top:0;z-index:60;background:#fff;border-bottom:1px solid #d9e2ea;backdrop-filter:blur(4px);">
  <div class="inner" style="max-width:80rem;margin:0 auto;padding:0 1rem;">
    <div class="bar" style="display:flex;align-items:center;gap:8px;padding:10px 0;">
      <div class="lp-title" style="font-weight:700;color:#5e6b77;">LaunchPad</div>
      <div style="flex:1 1 auto;"></div>
      <div class="lp-actions" style="display:inline-flex;gap:8px;align-items:center;">
        <button onclick="try{MS_actions.generateAgents&&MS_actions.generateAgents()}catch(e){console.error(e)}" class="lp-pill">Agents</button>
        <button onclick="try{MS_actions.generateScaffold&&MS_actions.generateScaffold()}catch(e){console.error(e)}" class="lp-pill">Microservices</button>
        <button onclick="try{MS_actions.generateCICD&&MS_actions.generateCICD()}catch(e){console.error(e)}" class="lp-pill">CI/CD</button>
        <button onclick="try{MS_actions.generateDeploy&&MS_actions.generateDeploy()}catch(e){console.error(e)}" class="lp-pill">IaC</button>
        <button onclick="try{MS_actions.generatePolicies&&MS_actions.generatePolicies()}catch(e){console.error(e)}" class="lp-pill">Policies</button>
        <button onclick="try{MS_actions.generateLineage&&MS_actions.generateLineage()}catch(e){console.error(e)}" class="lp-pill">Lineage</button>
        <button onclick="(window.MS_actions&&MS_actions.generateAnalytics)?MS_actions.generateAnalytics():console.warn('Analytics handler missing')" class="lp-pill">Analytics</button>
      </div>
    </div>
  </div>
</div>

<div id="root"></div>
  <script type="text/babel" data-presets="env,react">

const { useMemo, useState, useEffect } = React;

/********************
 * CSV helpers + tests
 ********************/
const LB_RE = new RegExp("\\r\\n?|\\r", "g");
function splitLines(raw) {
  // Normalize CRLF || CR to LF, then split
  return raw.replace(LB_RE, "\n").split("\n");
}

function parseCSVSimple(text) {
  const lines = splitLines(text).filter(Boolean);
  if (lines.length < 2) return { headers: [], rows: [] };
  const headers = lines[0].split(",").map((h) => h.trim());
  const rows = lines.slice(1).map((line) => {
    const cells = line.split(",");
    const obj = {};
    headers.forEach((h, i) => (obj[h] = cells[i] ?? ""));
    return obj;
  });
  return { headers, rows };
}

// Self-tests (console)
(function runSelfTests() {
  const inputs = [
    { label: "LF", text: "a,b\\n1,2\\n3,4" },
    { label: "CRLF", text: "a,b\\r\\n1,2\\r\\n3,4" },
    { label: "CR", text: "a,b\\r1,2\\r3,4" },
  ];
  inputs.forEach(({ label, text }) => {
    const real = text
      .split("\\r\\n").join("\\r\\n")
      .split("\\n").join("\\n")
      .split("\\r").join("\\r");
    const { headers, rows } = parseCSVSimple(real
      .replace(/\\r\\n/g, "\r\n")
      .replace(/\\n/g, "\n")
      .replace(/\\r/g, "\r"));
    const ok = headers.length === 2 && rows.length === 2;
    // eslint-disable-next-line no-console
    console.log("CSV " + label + " split test: " + (ok ? "pass" : "fail"));
  });
})();

/********************
 * Initial data
 ********************/
const today = new Date().toISOString().split("T")[0];

const initialData = {
  "missionInfo": {
    "title": "M7 Single Client View",
    "sponsor": "Leon Orr",
    "owner": "Leon Orr",
    "stakeholders": "Leon Orr",
    "version": "v0.1",
    "description": "M7 Single Client View",
    "date": "2025-10-04"
  },
  "serviceConfig": {
    "default_service_name": "example-service",
    "default_backend_language": "java",
    "default_backend_framework": "spring-boot",
    "default_ui_language": "react18",
    "default_ui_framework": "nextjs",
    "default_database": "postgres",
    "default_migration_tool": "flyway",
    "default_outbox_enabled": true,
    "observability": {
      "tracing": "otel",
      "metrics": "red",
      "logs": "json",
      "otel_sampler": "parentbased_traceidratio",
      "otel_sampler_arg": 0.1
    },
    "security": {
      "authn": [
        "jwt"
      ],
      "authz": [
        "opa"
      ],
      "cors_allowlist": [
        "http://localhost:3000",
        "http://localhost:5173"
      ],
      "secrets_management": "vault",
      "image_signing": "cosign",
      "base_image_registry": "ghcr.io"
    },
    "nfr": {
      "slo": [
        {
          "name": "http_p95_ms",
          "target": 150
        },
        {
          "name": "error_rate",
          "target": "0.5%"
        },
        {
          "name": "availability",
          "target": "99.9%"
        },
        {
          "name": "throughput_rps",
          "target": ">=50"
        }
      ],
      "resilience": {
        "circuit_breaker": true,
        "retries": {
          "max": 3,
          "strategy": "exponential-jitter"
        },
        "idempotency_policy": "mutations_required",
        "graceful_shutdown_timeout_s": 20
      }
    },
    "governance": {
      "lineage": "required",
      "policy_packs": [
        "no-wildcard-iam",
        "no-plaintext-internal",
        "no-pii-in-logs",
        "signed-images-only",
        "mission-labels-required"
      ],
      "adr_required": true
    },
    "ci": {
      "gates": [
        "typecheck",
        "unit",
        "contract",
        "integration",
        "property",
        "sast",
        "sbom",
        "iac",
        "schema-compat",
        "docker-scan",
        "policy"
      ],
      "coverage_min": 0.8,
      "lint_required": true,
      "evidence_artifacts": [
        "junit.xml",
        "coverage.json",
        "conftest.json",
        "sbom.spdx.json",
        "lineage.json"
      ]
    },
    "deploy": {
      "default_strategy": "canary",
      "feature_flags": true,
      "namespace": "mission",
      "require_labels": {
        "mission/reference": true,
        "mission/theme": true,
        "mission/topic": true
      },
      "admission_policies": [
        "sigstore-verify",
        "mission-labels",
        "health-endpoints"
      ],
      "rollback": {
        "enabled": true,
        "validate_quarterly": true
      }
    },
    "ownership": {
      "owner": ""
    },
    "api": {
      "require_openapi": true,
      "contract_path": "openapi.yaml",
      "health_endpoints": [
        "/health",
        "/ready",
        "/version"
      ]
    },
    "data": {
      "golden_source_required": true,
      "openapi_tag": "x-golden-source",
      "allowed_topics": [
        "pricing",
        "counterparty",
        "orders",
        "trades"
      ]
    },
    "images": {
      "signed_only": true,
      "max_image_size_mb": 500,
      "approved_bases": [
        "ghcr.io/distroless",
        "gcr.io/distroless",
        "alpine:3"
      ]
    }
  },
  "objectives": [
    {
      "ref": "OBJ-001",
      "category": "Mission Objectives",
      "theme": "Data Integrity",
      "topic": "Golden Source",
      "codify": "API contract registry; OpenAPI refs include `x-golden-source=true`.",
      "automate": "OPA rule validates data-source tags during build.",
      "intercept": "CI fails if endpoint lacks `x-golden-source` tag.",
      "prove": "Build report confirming \u201cAll data sources validated as golden.\u201d",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Ensure all services consume and publish data only via golden-source APIs or message topics.",
      "decision": true
    },
    {
      "ref": "OBJ-002",
      "category": "Mission Objectives",
      "theme": "Automation & Delivery",
      "topic": "CI/CD Coverage",
      "codify": "`ci.yml` template required in every repo.",
      "automate": "GitHub Action executes on push and publishes artefact hash.",
      "intercept": "Pipeline missing \u2192 auto-raise issue or block merge.",
      "prove": "Successful workflow badge and artefact hash stored.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Every deployable unit must have a complete CI/CD pipeline that builds, tests, and produces a signed image.",
      "decision": true
    },
    {
      "ref": "OBJ-003",
      "category": "Mission Objectives",
      "theme": "Observability",
      "topic": "Telemetry",
      "codify": "Shared `otel-config.yaml` schema with standard field names.",
      "automate": "Build injects OpenTelemetry library and exporters.",
      "intercept": "Missing OTEL fields trigger alert in CI.",
      "prove": "Grafana dashboard shows active traces and metrics per service.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Standardise and auto-collect logs, metrics, and traces via OpenTelemetry.",
      "decision": true
    },
    {
      "ref": "OBJ-004",
      "category": "Mission Objectives",
      "theme": "Lineage & Traceability",
      "topic": "Artefact Discoverability",
      "codify": "`lineage.json` template emitted by pipeline.",
      "automate": "CI publishes lineage metadata to registry.",
      "intercept": "Missing lineage \u2192 build blocked or flagged.",
      "prove": "Lineage entry visible in OpenLineage UI.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Every artefact must be registered in the lineage registry with declared inputs and outputs.",
      "decision": true
    },
    {
      "ref": "OBJ-005",
      "category": "Mission Objectives",
      "theme": "Infrastructure as Code",
      "topic": "Declarative Systems",
      "codify": "Terraform, Rego, and Helm templates committed in repo.",
      "automate": "Terraform plan/apply and policy lint run in CI.",
      "intercept": "Missing IaC directory \u2192 CI warning.",
      "prove": "Verified `.tf` or `.rego` artefacts committed and validated.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "All infrastructure and policy must be declarative and stored as code.",
      "decision": true
    },
    {
      "ref": "OBJ-006",
      "category": "Mission Objectives",
      "theme": "Reliability",
      "topic": "Health Endpoints",
      "codify": "OpenAPI annotations define standard health contracts.",
      "automate": "CI test job queries these endpoints on every build.",
      "intercept": "Non-200 status blocks deploy.",
      "prove": "Automated test report shows uptime and response success.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Each service must expose `/health`, `/ready`, and `/version` endpoints.",
      "decision": true
    },
    {
      "ref": "OBJ-007",
      "category": "Mission Objectives",
      "theme": "Change Control",
      "topic": "Auditability",
      "codify": "Git commit metadata and versioned deployment manifests.",
      "automate": "CI annotates releases with actor and change reason.",
      "intercept": "Missing rollback metadata triggers warning.",
      "prove": "Version history and audit log linked to commit.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "All changes must be observable, reversible, and logged with human and agent attribution.",
      "decision": true
    }
  ],
  "principles": [
    {
      "ref": "PRI-001",
      "category": "Mission Principles",
      "theme": "Delivery Discipline",
      "topic": "Trunk-Based Development",
      "codify": "Branch protection rules; PR merge policy in GitHub.",
      "automate": "CI enforces merge checks and tests before commit to trunk.",
      "intercept": "Attempt to merge failing branch \u2192 PR blocked.",
      "prove": "Commit history shows <24h branch lifespan and green pipeline.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Maintain a single mainline branch; minimise long-lived feature branches.",
      "decision": true
    },
    {
      "ref": "PRI-002",
      "category": "Mission Principles",
      "theme": "Quality Assurance",
      "topic": "Evidence Before Release",
      "codify": "Release workflow requires `evidence.json` or build artefacts with test results.",
      "automate": "CI release job checks for evidence hash or signature.",
      "intercept": "Missing evidence file halts release job.",
      "prove": "Evidence artefact stored with release tag.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Deploy only when verifiable proof of readiness exists.",
      "decision": true
    },
    {
      "ref": "PRI-003",
      "category": "Mission Principles",
      "theme": "Design Integrity",
      "topic": "Everything as Code",
      "codify": "Repo structure includes `/infra`, `/policy`, `/docs` folders.",
      "automate": "Linter checks required directories and file patterns.",
      "intercept": "Missing directory \u2192 build warning or failure.",
      "prove": "Manifest of artefact types generated at build time.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "All infrastructure, policy, lineage, and documentation must be expressed as code.",
      "decision": true
    },
    {
      "ref": "PRI-004",
      "category": "Mission Principles",
      "theme": "Governance",
      "topic": "Guardrails Over Gates",
      "codify": "Rego/OPA rules define policy severity levels (`warn` vs `deny`).",
      "automate": "CI runs policy checks on each commit.",
      "intercept": "Exceeded threshold triggers issue but doesn\u2019t block build unless critical.",
      "prove": "Policy status log showing zero critical violations.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Automate compliance and quality controls without manual approval steps.",
      "decision": true
    },
    {
      "ref": "PRI-005",
      "category": "Mission Principles",
      "theme": "Automation",
      "topic": "Automate Where Evidence Exists",
      "codify": "Define measurable metrics in `mission-metrics.yaml`.",
      "automate": "CI executes tests or validations tied to those metrics.",
      "intercept": "Manual step found without automation tag \u2192 flag warning.",
      "prove": "Automated test coverage and metric dashboard.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Any measurable or testable requirement must be automated.",
      "decision": true
    },
    {
      "ref": "PRI-006",
      "category": "Mission Principles",
      "theme": "Observability",
      "topic": "Built-In Telemetry",
      "codify": "Shared instrumentation library (`otel-lib`).",
      "automate": "Static analysis ensures import of `otel-lib` or env var presence.",
      "intercept": "Missing instrumentation triggers build warning.",
      "prove": "Grafana dashboard populated automatically.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Embed observability hooks (logs, traces, metrics) in every template.",
      "decision": true
    },
    {
      "ref": "PRI-007",
      "category": "Mission Principles",
      "theme": "Stability & Reversibility",
      "topic": "Reproducible and Reversible Change",
      "codify": "Version manifests, Docker image digests, Terraform state snapshots.",
      "automate": "CI captures and archives state at build time.",
      "intercept": "Missing snapshot blocks promotion.",
      "prove": "Redeploy previous version reproduces same artefact hash.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Every artefact and deployment must be rebuildable and rollback-capable.",
      "decision": true
    }
  ],
  "guardrails": [
    {
      "ref": "GR-001",
      "category": "Mission Guardrails",
      "theme": "Logging Standards",
      "topic": "Structured JSON Logging",
      "codify": "Central `logging.jsonschema` published for all services.",
      "automate": "Linter or static analysis ensures schema compliance in CI.",
      "intercept": "CI fails if logs deviate from schema.",
      "prove": "Log sample validated against schema and included in evidence pack.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "All application logs must be structured JSON including request ID, user, and service context.",
      "decision": true
    },
    {
      "ref": "GR-002",
      "category": "Mission Guardrails",
      "theme": "Secrets Management",
      "topic": "No Hard-Coded Secrets",
      "codify": "`.secretlint.yml` or regex/entropy patterns in repo root.",
      "automate": "Secret scanner runs pre-commit and in CI.",
      "intercept": "Match found \u2192 merge blocked and issue created.",
      "prove": "CI artefact confirms \u201c0 secrets found.\u201d",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Repositories must not contain plaintext secrets or credentials.",
      "decision": true
    },
    {
      "ref": "GR-003",
      "category": "Mission Guardrails",
      "theme": "Testing Standards",
      "topic": "Automated Test Coverage",
      "codify": "Required `tests/` folder; test framework config present.",
      "automate": "CI runs test suite and reports coverage.",
      "intercept": "Test failures or missing coverage block pipeline.",
      "prove": "Test report attached to build artefacts.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Each repository must include automated unit and integration tests.",
      "decision": true
    },
    {
      "ref": "GR-004",
      "category": "Mission Guardrails",
      "theme": "API Governance",
      "topic": "Machine-Readable Contracts",
      "codify": "Presence of `openapi.yaml` or `schema.graphql`.",
      "automate": "Linter verifies schema syntax and completeness.",
      "intercept": "Missing or invalid schema \u2192 CI fails.",
      "prove": "Spec validated and linked in artefact manifest.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "All APIs must expose OpenAPI or GraphQL schema in repo root.",
      "decision": true
    },
    {
      "ref": "GR-005",
      "category": "Mission Guardrails",
      "theme": "Supply Chain Security",
      "topic": "Signed Base Images",
      "codify": "`Dockerfile` FROM statement restricted to whitelisted registries.",
      "automate": "CI verifies signature with Cosign/Sigstore.",
      "intercept": "Unsigned or unverified image blocks deployment.",
      "prove": "Signature verification log stored with image tag.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "All containers must originate from signed, approved base images.",
      "decision": true
    },
    {
      "ref": "GR-006",
      "category": "Mission Guardrails",
      "theme": "Data Lineage",
      "topic": "Source and Destination Tracking",
      "codify": "`lineage.json` or metadata annotations in code.",
      "automate": "CI publishes lineage metadata to OpenLineage registry.",
      "intercept": "Missing lineage entry triggers policy violation.",
      "prove": "Lineage visible in registry dashboard.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Every data pipeline or transformation must declare its source and destination.",
      "decision": true
    },
    {
      "ref": "GR-007",
      "category": "Mission Guardrails",
      "theme": "Operational Safety",
      "topic": "Rollback Readiness",
      "codify": "Rollback scripts or Helm history retained per environment.",
      "automate": "CI executes rollback dry-run quarterly.",
      "intercept": "Failed rollback test triggers alert.",
      "prove": "Report showing rollback simulation success.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "All deployments must have a defined and tested rollback mechanism.",
      "decision": true
    }
  ],
  "ground": [
    {
      "ref": "TOOL-001",
      "category": "Mission Tooling",
      "theme": "Source Control & Flow",
      "topic": "GitHub",
      "codify": "Repo initialised with `.github` config and branch protection rules.",
      "automate": "Enforce branch protection, required reviews, and signed commits.",
      "intercept": "PR fails if checks or reviews missing.",
      "prove": "Audit log of merges and signed commits.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Manage version control with branch protection and PR checks.",
      "decision": true
    },
    {
      "ref": "TOOL-002",
      "category": "Mission Tooling",
      "theme": "CI/CD",
      "topic": "GitHub Actions",
      "codify": "Standard `.github/workflows/ci.yml` templates.",
      "automate": "Actions triggered on push and pull requests.",
      "intercept": "Workflow failure blocks merge.",
      "prove": "CI badges and artefact hashes attached to releases.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Automate build, test, and deployment workflows.",
      "decision": true
    },
    {
      "ref": "TOOL-003",
      "category": "Mission Tooling",
      "theme": "IaC / Config",
      "topic": "Terraform",
      "codify": "`main.tf` defines environments and resources.",
      "automate": "Terraform plan/apply in pipeline.",
      "intercept": "Drift detection alerts in CI.",
      "prove": "Terraform plan output archived with build.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Provision cloud and infrastructure declaratively.",
      "decision": true
    },
    {
      "ref": "TOOL-004",
      "category": "Mission Tooling",
      "theme": "Policy Enforcement",
      "topic": "OPA / Conftest",
      "codify": "Policy packs in `/policy` folder.",
      "automate": "Conftest executes Rego policies in CI.",
      "intercept": "Violations flagged with severity.",
      "prove": "Conftest JSON output stored in build artefacts.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Enforce Mission Principles and Guardrails programmatically.",
      "decision": true
    },
    {
      "ref": "TOOL-005",
      "category": "Mission Tooling",
      "theme": "Observability",
      "topic": "OpenTelemetry + Grafana",
      "codify": "Shared `otel-config.yaml`; Grafana dashboards.",
      "automate": "Collector agents deployed automatically.",
      "intercept": "Missing OTEL data triggers alert.",
      "prove": "Dashboards display live telemetry.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Centralise logs, metrics, and traces across services.",
      "decision": true
    },
    {
      "ref": "TOOL-006",
      "category": "Mission Tooling",
      "theme": "Security / Secrets",
      "topic": "Trivy + Sigstore + Vault",
      "codify": "`trivy.yml` and Cosign key config.",
      "automate": "Trivy scan and Cosign signature in CI.",
      "intercept": "Vulnerabilities or unsigned images block deploy.",
      "prove": "Signed image logs + scan report stored.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Scan containers, sign images, and manage secrets.",
      "decision": true
    },
    {
      "ref": "TOOL-007",
      "category": "Mission Tooling",
      "theme": "Lineage & Metadata",
      "topic": "OpenLineage + Marquez",
      "codify": "`lineage.json` generated per pipeline.",
      "automate": "Pipeline publishes lineage metadata to registry.",
      "intercept": "Missing lineage raises CI warning.",
      "prove": "Lineage entries visible in Marquez UI.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Capture and visualise data lineage and build provenance.",
      "decision": true
    },
    {
      "ref": "TOOL-008",
      "category": "Mission Tooling",
      "theme": "Documentation",
      "topic": "MkDocs + Markdown ADRs",
      "codify": "`/docs` folder with Markdown and `mkdocs.yml`.",
      "automate": "Docs auto-built on merge to main.",
      "intercept": "Missing or broken link triggers warning.",
      "prove": "Published site and changelog per release.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Generate human-readable mission documentation.",
      "decision": true
    },
    {
      "ref": "TOOL-009",
      "category": "Mission Tooling",
      "theme": "AI Assist",
      "topic": "Copilot / ChatGPT / Gemini",
      "codify": "`.copilot` config and access policy.",
      "automate": "Inline AI suggestions enabled for approved repos.",
      "intercept": "None (advisory only).",
      "prove": "Generated docs and code reviews logged.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Support developers with contextual AI code and doc generation.",
      "decision": true
    },
    {
      "ref": "TOOL-010",
      "category": "Mission Tooling",
      "theme": "Containerisation",
      "topic": "Docker / Podman",
      "codify": "`Dockerfile` in each repo with approved base image.",
      "automate": "CI builds container images on every push.",
      "intercept": "Linting ensures image size and layer limits.",
      "prove": "Image digest and metadata captured in release.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Ensure consistent build artefacts and portable environments.",
      "decision": true
    },
    {
      "ref": "TOOL-011",
      "category": "Mission Tooling",
      "theme": "Deployment",
      "topic": "Kubernetes / Render / Cloud Run",
      "codify": "Helm charts or deployment manifests in `/deploy`.",
      "automate": "GitOps or CD workflow applies manifests.",
      "intercept": "Admission controller denies non-compliant deploys.",
      "prove": "Successful rollout recorded and observable.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Deploy applications in reproducible environments.",
      "decision": true
    },
    {
      "ref": "TOOL-012",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "Unit Tests",
      "codify": "`testing.md` lists per-lang defaults (Jest/Vitest, Pytest, JUnit, Go test).",
      "automate": "CI step runs `npm test` / `pytest` / `mvn test` / `go test`.",
      "intercept": "Non-zero exit blocks merge.",
      "prove": "JUnit/JSON test report uploaded.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Standardise on free unit-test frameworks per language.",
      "decision": true
    },
    {
      "ref": "TOOL-013",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "Contract Tests",
      "codify": "Pact files in `/contracts`; OpenAPI as source of truth.",
      "automate": "Pact tests run in CI; broker verification (OSS).",
      "intercept": "Failed verification blocks release.",
      "prove": "Pact verification report stored.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Enforce producer/consumer API contracts.",
      "decision": true
    },
    {
      "ref": "TOOL-014",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "API Tests",
      "codify": "Postman collections or `.http` specs in repo.",
      "automate": "Newman runs collections in CI.",
      "intercept": "Failing requests block pipeline.",
      "prove": "Newman HTML/JSON report artefact.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Automate API regression via collections.",
      "decision": true
    },
    {
      "ref": "TOOL-015",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "Integration (Containers)",
      "codify": "Testcontainers in test code; docker-compose for local.",
      "automate": "CI launches ephemeral containers for suites.",
      "intercept": "Startup/health failure fails job.",
      "prove": "Logs + container list archived.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Spin up real dependencies in tests.",
      "decision": true
    },
    {
      "ref": "TOOL-016",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "Performance / Load",
      "codify": "`k6` scripts in `/perf`.",
      "automate": "k6 runs on schedule or PR gates.",
      "intercept": "SLO breach flags PR or blocks merge (configurable).",
      "prove": "k6 summary + trend in artefacts.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Baseline latency and throughput SLIs.",
      "decision": true
    },
    {
      "ref": "TOOL-017",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "Dynamic Security",
      "codify": "ZAP baseline config in `/security/zap.yaml`.",
      "automate": "OWASP ZAP baseline scan in CI against preview URL.",
      "intercept": "High/critical issues block deploy.",
      "prove": "ZAP HTML report archived.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Catch common web vulnerabilities automatically.",
      "decision": true
    },
    {
      "ref": "TOOL-018",
      "category": "Mission Tooling",
      "theme": "Quality",
      "topic": "Static Analysis & Lint",
      "codify": "ESLint/Prettier, Flake8, golangci-lint configs.",
      "automate": "Lint job runs in CI on PRs.",
      "intercept": "Lint errors fail job.",
      "prove": "Lint report uploaded.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Enforce style and detect defects.",
      "decision": true
    },
    {
      "ref": "TOOL-019",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "Coverage",
      "codify": "Coverage config (nyc/Istanbul, coverage.py, JaCoCo).",
      "automate": "Coverage generated in CI; threshold gate optional.",
      "intercept": "Under-threshold blocks merge (if enabled).",
      "prove": "Coverage badge + report artefact.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Track and gate minimum coverage.",
      "decision": true
    },
    {
      "ref": "TOOL-020",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "UI End-to-End",
      "codify": "Playwright config + specs in `/e2e`.",
      "automate": "Playwright runs headless in CI.",
      "intercept": "Failing E2E blocks pipeline.",
      "prove": "Traces/videos uploaded by CI.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Cross-browser E2E tests.",
      "decision": true
    },
    {
      "ref": "TOOL-021",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "Service Virtualisation",
      "codify": "WireMock / MockServer configs in `/mocks`.",
      "automate": "Mock servers spun up in CI pre-test.",
      "intercept": "Mock startup failure fails job.",
      "prove": "Mock logs + mappings archived.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Decouple from unavailable or external dependencies.",
      "decision": true
    },
    {
      "ref": "TOOL-022",
      "category": "Mission Tooling",
      "theme": "Resilience",
      "topic": "Chaos Experiments",
      "codify": "LitmusChaos experiment manifests.",
      "automate": "Periodic chaos runs in non-prod.",
      "intercept": "Failed recovery raises incident.",
      "prove": "Chaos run report stored.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Validate graceful degradation and recovery.",
      "decision": true
    },
    {
      "ref": "TOOL-023",
      "category": "Mission Tooling",
      "theme": "Accessibility",
      "topic": "a11y Checks",
      "codify": "axe-core / pa11y configs and test scripts.",
      "automate": "a11y job runs on PRs.",
      "intercept": "WCAG violations flag PR / block per severity.",
      "prove": "a11y report artefact + trend.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Embed accessibility testing for web UIs.",
      "decision": true
    }
  ]
};

/********************
 * Constants
 ********************/
const SECTIONS = [
  { key: "info", label: "Mission Info" },
  { key: "objectives", label: "Mission Objectives" },
  { key: "principles", label: "Mission Principles" },
  { key: "guardrails", label: "Mission Guardrails" },
  { key: "ground", label: "Mission Tooling" },
  { key: "service", label: "Mission Services" },
  { key: "review", label: "Systems Check" },
];

/********************
 * UI atoms
 ********************/
const DecisionPill = ({ value }) => {
  const label = value === true ? "Accepted" : value === false ? "Later" : "Pending";
  const cls =
    value === true
      ? "bg-[color:var(--ms-teal)] text-white"
      : value === false
      ? "bg-[color:var(--ms-orange)] text-white"
      : "bg-gray-200 text-gray-700";
  return (
    <span className={`px-2 py-1 rounded-full text-xs font-medium ${cls}`}>{label}</span>
  );
};


const TopBar = ({ onImportJSON, progress }) => {
  return (
    <header className="sticky top-0 z-40 w-full border-b bg-white/70 backdrop-blur">
      <div className="mx-auto max-w-7xl px-4">
        <div className="flex h-14 items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="h-7 w-7 rounded-xl" style={{ background: "var(--ms-teal)" }} />
            <h1 className="text-lg font-semibold tracking-tight">MissionSmith</h1>
            <span className="ml-2 hidden text-sm text-gray-500 sm:block">
              Forge your Mission Objectives, Principles, Guardrails & Mission Tooling
            </span>
          </div>
          <div className="flex items-center gap-2">
            <button className="rounded-xl border px-3 py-1.5 text-sm hover:bg-gray-50" onClick={onImportJSON}>Import JSON</button>
          </div>
        </div>
        <div className="mb-3 mt-1 h-1 w-full overflow-hidden rounded-full bg-gray-100">
          <div className="h-full rounded-full" style={{ width: `${Math.round(progress * 100)}%`, background: "var(--ms-blue)" }} />
        </div>
      </div>
    </header>
  );
};

const Sidebar = ({ section, setSection }) => {
  return (
    <aside className="sticky top-14 h-[calc(100dvh-56px)] w-full max-w-[260px] shrink-0 border-r bg-white/60 p-3">
      <nav className="flex flex-col gap-1">
        {SECTIONS.map((s) => (
          <button
            key={s.key}
            onClick={() => setSection(s.key)}
            className={`flex items-center justify-between rounded-xl px-3 py-2 text-left text-sm hover:bg-gray-50 ${section === s.key ? "bg-gray-100" : ""}`}
          >
            <span>{s.label}</span>
            {section === s.key && (
              <span className="h-2 w-2 rounded-full" style={{ background: "var(--ms-teal)" }} />
            )}
          </button>
        ))}
      </nav>
      <div className="mt-4 rounded-xl border p-3 text-xs text-gray-600">
        <p className="font-medium">Tip</p>
        <p>Mission Info first, then review & accept rows section by section (Objectives, Principles, Guardrails, Tooling).</p>
      </div>
    </aside>
  );
};

/********************
 * Feature components
 ********************/
const RowEditor = ({ value, onChange, onClose }) => {
  const [local, setLocal] = useState(value);
  const update = (k, v) => setLocal((p) => ({ ...p, [k]: v }));
  const save = () => onChange(local);
  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/40 p-0 sm:items-center sm:p-8">
      <div className="w-full max-w-3xl rounded-2xl bg-white p-4 shadow-2xl sm:p-6">
        <div className="mb-3 flex items-center justify-between">
          <h3 className="text-base font-semibold">Edit: {local.ref} â€” {local.topic}</h3>
          <button className="rounded-lg border px-3 py-1 text-sm" onClick={onClose}>Close</button>
        </div>
        <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
          {[
            ["ref", "Ref"],
            ["category", "Category"],
            ["theme", "Theme"],
            ["topic", "Topic"],
            ["codify", "Codify"],
            ["automate", "Automate"],
            ["intercept", "Intercept"],
            ["prove", "Prove"],
            ["dependency", "Dependency"],
            ["status", "Status"],
            ["user_notes", "Notes"],
          ].map(([key, label]) => (
            <label key={key} className="flex flex-col text-sm">
              <span className="mb-1 text-gray-600">{label}</span>
              <textarea className="min-h-[42px] rounded-xl border p-2 focus:outline-none focus:ring-2" value={local[key] ?? ""} onChange={(e) => update(key, e.target.value)} />
            </label>
          ))}
        </div>
        <div className="mt-4 flex items-center justify-between">
          <div className="flex items-center gap-3 text-sm">
            <span>Decision:</span>
            <button className={`rounded-xl px-3 py-1 ${local.decision === true ? "text-white" : "border"}`} style={{ background: local.decision === true ? "var(--ms-teal)" : undefined }} onClick={() => update("decision", true)}>Accept</button>
            <button className={`rounded-xl px-3 py-1 ${local.decision === false ? "text-white" : "border"}`} style={{ background: local.decision === false ? "var(--ms-orange)" : undefined }} onClick={() => update("decision", false)}>Later</button>
            <button className="rounded-xl border px-3 py-1" onClick={() => update("decision", null)}>Clear</button>
          </div>
          <div className="flex items-center gap-2">
            <button className="rounded-xl border px-3 py-1" onClick={onClose}>Cancel</button>
            <button className="rounded-xl px-3 py-1 text-white" style={{ background: "var(--ms-teal)" }} onClick={save}>Save</button>
          </div>
        </div>
      </div>
    </div>
  );
};

const SectionTable = ({ title, rows, onRowsChange, allowAdd = false }) => {
  const [query, setQuery] = useState("");
  const [editing, setEditing] = useState(null);

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    if (!q) return rows;
    return rows.filter((r) => JSON.stringify(r).toLowerCase().includes(q));
  }, [query, rows]);

  const updateRow = (idx, patch) => {
    const next = [...rows];
    next[idx] = { ...rows[idx], ...patch };
    onRowsChange(next);
  };

  const removeRow = (idx) => {
    const next = [...rows];
    next.splice(idx, 1);
    onRowsChange(next);
  };

  const addRow = () => {
    const n = {
      ref: `NEW-${Math.random().toString(36).slice(2, 6).toUpperCase()}`,
      category: title,
      theme: "",
      topic: "",
      codify: "",
      automate: "",
      intercept: "",
      prove: "",
      dependency: "N/A",
      status: "option",
      user_notes: "",
      decision: null,
    };
    onRowsChange([n, ...rows]);
    setEditing({ idx: 0, value: n });
  };

  return (
    <div className="rounded-2xl border bg-white/70 p-3 sm:p-4">
      <div className="mb-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 className="text-base font-semibold">{title}</h2>
          <p className="text-xs text-gray-600">Search, accept/later, edit, || add.</p>
        </div>
        <div className="flex items-center gap-2">
          <input placeholder="Searchâ€¦" className="w-48 rounded-xl border px-3 py-1.5 text-sm" value={query} onChange={(e) => setQuery(e.target.value)} />
          {allowAdd && (
            <button onClick={addRow} className="rounded-xl px-3 py-1.5 text-sm text-white" style={{ background: "var(--ms-teal)" }}>+ Add</button>
          )}
        </div>
      </div>

      <div className="overflow-x-auto">
        <table className="min-w-full text-sm">
          <thead>
            <tr className="bg-gray-50 text-left text-xs uppercase text-gray-500">
              {["Ref", "Theme", "Topic", "Codify", "Automate", "Intercept", "Prove", "Dependency", "Decision", ""].map((h) => (
                <th key={h} className="whitespace-nowrap px-3 py-2 font-medium">{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {filtered.map((r, i) => (
              <tr key={r.ref} className="border-b hover:bg-gray-50">
                <td className="px-3 py-2 font-mono">{r.ref}</td>
                <td className="px-3 py-2">{r.theme}</td>
                <td className="px-3 py-2">
                  <div className="flex items-center gap-2">
                    <span className="font-medium">{r.topic}</span>
                    <button className="rounded-lg border px-2 py-0.5 text-xs" onClick={() => setEditing({ idx: i, value: r })}>Edit</button>
                  </div>
                </td>
                <td className="px-3 py-2 max-w-[260px] truncate" title={r.codify}>{r.codify}</td>
                <td className="px-3 py-2 max-w-[260px] truncate" title={r.automate}>{r.automate}</td>
                <td className="px-3 py-2 max-w-[260px] truncate" title={r.intercept}>{r.intercept}</td>
                <td className="px-3 py-2 max-w-[260px] truncate" title={r.prove}>{r.prove}</td>
                <td className="px-3 py-2">{r.dependency}</td>
                <td className="px-3 py-2">
                  <div className="flex items-center gap-2">
                    <button className={`rounded-xl px-2 py-1 text-xs ${r.decision === true ? "text-white" : "border"}`} style={{ background: r.decision === true ? "var(--ms-teal)" : undefined }} onClick={() => updateRow(i, { decision: true })}>Accept</button>
                    <button className={`rounded-xl px-2 py-1 text-xs ${r.decision === false ? "text-white" : "border"}`} style={{ background: r.decision === false ? "var(--ms-orange)" : undefined }} onClick={() => updateRow(i, { decision: false })}>Later</button>
                    <button className="rounded-xl border px-2 py-1 text-xs" onClick={() => updateRow(i, { decision: null })}>Clear</button>
                  </div>
                </td>
                <td className="px-3 py-2 text-right">
                  <button className="rounded-lg px-2 py-1 text-xs text-white" style={{ background: "var(--ms-red)" }} onClick={() => removeRow(i)}>Delete</button>
                </td>
              </tr>
            ))}
            {filtered.length === 0 && (
              <tr>
                <td className="px-3 py-6 text-center text-gray-500" colSpan={10}>No rows match your search.</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      {editing && (
        <RowEditor
          value={editing.value}
          onClose={() => setEditing(null)}
          onChange={(next) => {
            const updated = [...rows];
            updated[editing.idx] = next;
            onRowsChange(updated);
            setEditing(null);
          }}
        />
      )}
    </div>
  );
};

const Review = ({ data, onResetDecisions }) => {
  const flat = [
    ...data.objectives.map((r) => ({ ...r, section: "Mission Objectives" })),
    ...data.principles.map((r) => ({ ...r, section: "Mission Principles" })),
    ...data.guardrails.map((r) => ({ ...r, section: "Mission Guardrails" })),
    ...data.ground.map((r) => ({ ...r, section: "Mission Tooling" })),
  ];
  const accepted = flat.filter((r) => r.decision === true);
  const later = flat.filter((r) => r.decision === false);
  const pending = flat.filter((r) => r.decision === null);
  return (
    <div className="grid grid-cols-1 gap-4 lg:grid-cols-3">
      {[["Accepted", accepted, "var(--ms-teal)"],["Later", later, "var(--ms-orange)"],["Pending", pending, "var(--ms-blue)"]].map(([label, rows, color]) => (
        <div key={label} className="rounded-2xl border bg-white/70 p-4">
          <div className="mb-2 flex items-center justify-between">
            <h3 className="text-base font-semibold">{label}</h3>
            <span className="rounded-full px-2 py-1 text-xs text-white" style={{ background: color }}>{rows.length}</span>
          </div>
          <ul className="space-y-2">
            {rows.map((r) => (
              <li key={r.ref} className="rounded-xl border p-3 text-sm">
                <div className="mb-1 flex items-center justify-between">
                  <span className="font-medium">{r.ref} â€” {r.topic}</span>
                  <DecisionPill value={r.decision} />
                </div>
                <p className="text-xs text-gray-600">{r.section} â€¢ {r.theme}</p>
              </li>
            ))}
            {rows.length === 0 && (<li className="text-sm text-gray-500">Nothing here yet.</li>)}
          </ul>
        </div>
      ))}
      <div className="lg:col-span-3">
        <button className="rounded-xl px-3 py-2 text-sm text-white" style={{ background: "var(--ms-red)" }} onClick={onResetDecisions}>Reset all decisions</button>
      </div>
    </div>
  );
};


function ServiceConfig({ value, onChange }) {
  const [local, setLocal] = useState(value || {});
  const update = (path, v) => {
    const parts = path.split(".");
    const copy = JSON.parse(JSON.stringify(local || {}));
    let cur = copy;
    for (let i = 0; i < parts.length - 1; i++) {
      const k = parts[i];
      if (!cur[k] || typeof cur[k] !== "object") cur[k] = {};
      cur = cur[k];
    }
    cur[parts[parts.length-1]] = v;
    setLocal(copy);
  };
  const save = () => onChange(local);
  const arr = (a) => Array.isArray(a) ? a.join(", ") : (a || "");

  const opts = {
    backendLang: ["java17","python3.11","node18","go1.21"],
    backendFw:   ["spring-boot","fastapi","express","gin"],
    uiLang:      ["react18","angular16","vue3"],
    uiFw:        ["nextjs","cra","nuxt"],
    database:    ["postgres","mongodb","mysql","dynamodb"],
    migrate:     ["flyway","prisma","alembic","liquibase"],
    deploy:      ["rolling","blue-green","canary","feature-flag-only"],
    policies:    ["no-wildcard-iam","no-plaintext-internal","no-pii-in-logs","schema-compat","secure-dependencies"],
    cigates:     ["typecheck","unit","contract","property","sast","sbom","iac","schema-compat"]
  };

  return (
    <div className="rounded-2xl border bg-white/70 p-4 space-y-6">
      <h2 className="text-base font-semibold">Service Config (Mission-wide Defaults & Guardrails)</h2>
      <div className="space-y-3">
        <h3 className="text-sm font-semibold text-gray-700">Defaults (optional)</h3>
        <div className="grid gap-3 md:grid-cols-2">
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Default Service Name</span>
            <input className="rounded-xl border px-3 py-2" placeholder="example-service"
              value={local?.default_service_name || ""}
              onChange={e=>update("default_service_name", e.target.value)} />
          </label>
          <div />
        </div>
        <div className="grid gap-3 md:grid-cols-2">
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Default Backend Language</span>
            <input className="rounded-xl border px-3 py-2" list="opt-backend-lang" placeholder="e.g. java17"
              value={local?.default_backend_language || ""}
              onChange={e=>update("default_backend_language", e.target.value)} />
            <datalist id="opt-backend-lang">{opts.backendLang.map(o => <option key={o} value={o} />)}</datalist>
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Default Backend Framework</span>
            <input className="rounded-xl border px-3 py-2" list="opt-backend-fw" placeholder="e.g. spring-boot"
              value={local?.default_backend_framework || ""}
              onChange={e=>update("default_backend_framework", e.target.value)} />
            <datalist id="opt-backend-fw">{opts.backendFw.map(o => <option key={o} value={o} />)}</datalist>
          </label>
        </div>
        <div className="grid gap-3 md:grid-cols-2">
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Default UI Language</span>
            <input className="rounded-xl border px-3 py-2" list="opt-ui-lang" placeholder="e.g. react18"
              value={local?.default_ui_language || ""}
              onChange={e=>update("default_ui_language", e.target.value)} />
            <datalist id="opt-ui-lang">{opts.uiLang.map(o => <option key={o} value={o} />)}</datalist>
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Default UI Framework</span>
            <input className="rounded-xl border px-3 py-2" list="opt-ui-fw" placeholder="e.g. nextjs"
              value={local?.default_ui_framework || ""}
              onChange={e=>update("default_ui_framework", e.target.value)} />
            <datalist id="opt-ui-fw">{opts.uiFw.map(o => <option key={o} value={o} />)}</datalist>
          </label>
        </div>
        <div className="grid gap-3 md:grid-cols-3">
          <label className="flex flex-col text-sm md:col-span-1">
            <span className="mb-1 text-gray-600">Default Database</span>
            <input className="rounded-xl border px-3 py-2" list="opt-db" placeholder="e.g. postgres"
              value={local?.default_database || ""}
              onChange={e=>update("default_database", e.target.value)} />
            <datalist id="opt-db">{opts.database.map(o => <option key={o} value={o} />)}</datalist>
          </label>
          <label className="flex flex-col text-sm md:col-span-2">
            <span className="mb-1 text-gray-600">Default Migration Tool</span>
            <input className="rounded-xl border px-3 py-2" list="opt-mig" placeholder="e.g. flyway"
              value={local?.default_migration_tool || ""}
              onChange={e=>update("default_migration_tool", e.target.value)} />
            <datalist id="opt-mig">{opts.migrate.map(o => <option key={o} value={o} />)}</datalist>
          </label>
        </div>
        <label className="flex items-center gap-2 text-sm">
          <input type="checkbox" checked={!!local?.default_outbox_enabled}
            onChange={e=>update("default_outbox_enabled", e.target.checked)} />
          <span>Default Outbox Enabled</span>
        </label>
      </div>

      <div className="space-y-3">
        <h3 className="text-sm font-semibold text-gray-700">Security (guardrails)</h3>
        <div className="grid gap-3 md:grid-cols-3">
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">AuthN</span>
            <input className="rounded-xl border px-3 py-2" placeholder="e.g. jwt"
              value={arr(local?.security?.authn)}
              onChange={e=>update("security.authn", e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">AuthZ</span>
            <input className="rounded-xl border px-3 py-2" placeholder="e.g. opa"
              value={arr(local?.security?.authz)}
              onChange={e=>update("security.authz", e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">CORS Allowlist (comma-separated)</span>
            <input className="rounded-xl border px-3 py-2" placeholder="https://app.example.com"
              value={arr(local?.security?.cors_allowlist)}
              onChange={e=>update("security.cors_allowlist", e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} />
          </label>
        </div>
      </div>

      <div className="space-y-3">
        <h3 className="text-sm font-semibold text-gray-700">Observability (guardrails)</h3>
        <div className="grid gap-3 md:grid-cols-3">
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Tracing</span>
            <input className="rounded-xl border px-3 py-2" placeholder="otel"
              value={local?.observability?.tracing || ""}
              onChange={e=>update("observability.tracing", e.target.value)} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Metrics</span>
            <input className="rounded-xl border px-3 py-2" placeholder="red"
              value={local?.observability?.metrics || ""}
              onChange={e=>update("observability.metrics", e.target.value)} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Logs</span>
            <input className="rounded-xl border px-3 py-2" placeholder="json"
              value={local?.observability?.logs || ""}
              onChange={e=>update("observability.logs", e.target.value)} />
          </label>
        </div>
      </div>

      <div className="space-y-3">
        <h3 className="text-sm font-semibold text-gray-700">NFR: SLOs</h3>
        <div className="grid gap-3 md:grid-cols-2">
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">http_p95_ms</span>
            <input className="rounded-xl border px-3 py-2" type="number"
              value={(Number(local?.nfr?.slo?.find(s=>s.name==='http_p95_ms')?.target) || "")}
              onChange={e=>{
                const val = e.target.value === "" ? "" : Number(e.target.value);
                const arr = (local?.nfr?.slo || []).filter(s=>s.name!=="http_p95_ms");
                arr.push({ name: "http_p95_ms", target: val });
                update("nfr.slo", arr);
              }} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">error_rate</span>
            <input className="rounded-xl border px-3 py-2"
              value={(local?.nfr?.slo?.find(s=>s.name==='error_rate')?.target) ?? ""}
              onChange={e=>{
                const arr = (local?.nfr?.slo || []).filter(s=>s.name!=="error_rate");
                arr.push({ name: "error_rate", target: e.target.value });
                update("nfr.slo", arr);
              }} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">availability</span>
            <input className="rounded-xl border px-3 py-2"
              value={(local?.nfr?.slo?.find(s=>s.name==='availability')?.target) ?? ""}
              onChange={e=>{
                const arr = (local?.nfr?.slo || []).filter(s=>s.name!=="availability");
                arr.push({ name: "availability", target: e.target.value });
                update("nfr.slo", arr);
              }} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">throughput_rps (optional)</span>
            <input className="rounded-xl border px-3 py-2"
              value={(local?.nfr?.slo?.find(s=>s.name==='throughput_rps')?.target) ?? ""}
              onChange={e=>{
                const arr = (local?.nfr?.slo || []).filter(s=>s.name!=="throughput_rps");
                arr.push({ name: "throughput_rps", target: e.target.value });
                update("nfr.slo", arr);
              }} />
          </label>
        </div>
      </div>

      <div className="space-y-3">
        <h3 className="text-sm font-semibold text-gray-700">NFR: Resilience</h3>
        <div className="grid gap-3 md:grid-cols-3">
          <label className="flex items-center gap-2 text-sm">
            <input type="checkbox" checked={!!local?.nfr?.resilience?.circuit_breaker}
              onChange={e=>update("nfr.resilience.circuit_breaker", e.target.checked)} />
            <span>Circuit Breaker</span>
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Idempotency Policy</span>
            <select className="rounded-xl border px-3 py-2"
              value={local?.nfr?.resilience?.idempotency_policy || "mutations_required"}
              onChange={e=>update("nfr.resilience.idempotency_policy", e.target.value)}>
              <option value="mutations_required">mutations_required</option>
              <option value="recommended">recommended</option>
              <option value="off">off</option>
            </select>
          </label>
          <div className="grid gap-2">
            <label className="flex flex-col text-sm">
              <span className="mb-1 text-gray-600">Retries (max)</span>
              <input className="rounded-xl border px-3 py-2" type="number"
                value={(local?.nfr?.resilience?.retries?.max) ?? 0}
                onChange={e=>update("nfr.resilience.retries.max", Number(e.target.value))} />
            </label>
            <label className="flex flex-col text-sm">
              <span className="mb-1 text-gray-600">Retries (strategy)</span>
              <input className="rounded-xl border px-3 py-2" placeholder="exponential-jitter"
                value={(local?.nfr?.resilience?.retries?.strategy) ?? ""}
                onChange={e=>update("nfr.resilience.retries.strategy", e.target.value)} />
            </label>
          </div>
        </div>
      </div>

      <div className="space-y-3">
        <h3 className="text-sm font-semibold text-gray-700">Governance, CI/CD & Deploy</h3>
        <div className="grid gap-3 md:grid-cols-2">
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Governance: Lineage</span>
            <input className="rounded-xl border px-3 py-2" placeholder="required"
              value={local?.governance?.lineage || ""}
              onChange={e=>update("governance.lineage", e.target.value)} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Default Deploy Strategy</span>
            <input className="rounded-xl border px-3 py-2" list="opt-deploy" placeholder="e.g. canary"
              value={local?.deploy?.default_strategy || ""}
              onChange={e=>update("deploy.default_strategy", e.target.value)} />
            <datalist id="opt-deploy">{opts.deploy.map(o => <option key={o} value={o} />)}</datalist>
          </label>
        </div>
        <label className="flex items-center gap-2 text-sm">
          <input type="checkbox" checked={!!local?.deploy?.feature_flags}
            onChange={e=>update("deploy.feature_flags", e.target.checked)} />
          <span>Default Feature Flags Enabled</span>
        </label>
        <label className="flex flex-col text-sm">
          <span className="mb-1 text-gray-600">Policy Packs (comma-separated or custom)</span>
          <input className="rounded-xl border px-3 py-2" list="opt-policies" placeholder="no-wildcard-iam, no-pii-in-logs"
            value={arr(local?.governance?.policy_packs)}
            onChange={e=>update("governance.policy_packs", e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} />
          <datalist id="opt-policies">{opts.policies.map(o => <option key={o} value={o} />)}</datalist>
        </label>
        <label className="flex flex-col text-sm">
          <span className="mb-1 text-gray-600">CI Gates (comma-separated or custom)</span>
          <input className="rounded-xl border px-3 py-2" list="opt-cigates" placeholder="typecheck, unit, ..."
            value={arr(local?.ci?.gates)}
            onChange={e=>update("ci.gates", e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} />
          <datalist id="opt-cigates">{opts.cigates.map(o => <option key={o} value={o} />)}</datalist>
        </label>
        <label className="flex flex-col text-sm">
          <span className="mb-1 text-gray-600">Default Owner (optional)</span>
          <input className="rounded-xl border px-3 py-2" placeholder="team-trade"
            value={local?.ownership?.owner || ""}
            onChange={e=>update("ownership.owner", e.target.value)} />
        </label>
      </div>

      <div className="flex gap-2 pt-2">
        <button className="rounded-xl border px-3 py-1" onClick={()=>setLocal(value)}>Reset</button>
        <button className="rounded-xl px-3 py-1 text-white" style={{ background: "var(--ms-teal)" }} onClick={save}>Save</button>
      </div>
    </div>
  );
}


function MissionInfo({ value, onChange }) {
  const update = (k, v) => onChange({ ...value, [k]: v });
  return (
    <div className="rounded-2xl border bg-white/70 p-4 space-y-4">
      <h2 className="text-base font-semibold">Mission Information</h2>
      {[["title","Mission Title"],["sponsor","Sponsor"],["owner","Owner"],["stakeholders","Stakeholders"],["version","Version"],["description","Description"],["date","Date"]].map(([key, label]) => (
        <label key={key} className="flex flex-col text-sm">
          <span className="mb-1 text-gray-600">{label}</span>
          <input
            className="rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500"
            value={value?.[key] ?? ""}
            onChange={(e) => update(key, e.target.value)}
          />
        </label>
      ))}
    </div>
  );
}

/********************
 * Main App
 ********************/
function MissionSmithApp() {
  const [section, setSection] = useState("info");
  const [data, setData] = useState(initialData);

  
  
  useEffect(() => { window.__ms_data = data; window.__ms_getData = () => data; }, [data]);
useEffect(() => { window.__ms_data = data; window.__ms_getData = () => data; }, [data]);
const progress = useMemo(() => {
    const all = [...data.objectives, ...data.principles, ...data.guardrails, ...data.ground];
    const decided = all.filter((r) => r.decision !== null).length;
    return all.length ? decided / all.length : 0;
  }, [data]);

  const onRowsChange = (key, next) => setData((p) => ({ ...p, [key]: next }));

  const exportJSON = () => {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `missionsmith-framework.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const exportCSVHandler = () => exportCSV(data);

  
  // CSV Export helpers (flat table across all sections)
  const CSV_HEADERS = ["ref","category","theme","topic","codify","automate","intercept","prove","dependency","status","user_notes","decision"];
  function toCSVRow(obj){
    function esc(v){
      const s = (v === null || v === undefined) ? "" : String(v);
      const needsQuote = /[",\n]/.test(s);
      const out = s.replace(/"/g,'""');
      return needsQuote ? "\"" + out + "\"" : out;
    }
    return CSV_HEADERS.map(h => {
      if (h === "decision") {
        return esc(obj.decision === true ? "Accepted" : obj.decision === false ? "Later" : "Pending");
      }
      return esc(obj[h] ?? "");
    }).join(",");
  }
  function exportCSV(data){
    const flat = [
      ...data.objectives.map(r => ({...r})),
      ...data.principles.map(r => ({...r})),
      ...data.guardrails.map(r => ({...r})),
      ...data.ground.map(r => ({...r})),
    ];
    const header = CSV_HEADERS.join(",");
    const rows = flat.map(toCSVRow);
    const csv = [header, ...rows].join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "missionsmith-framework.csv";
    a.click();
    URL.revokeObjectURL(url);
  }
const importJSON = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".json,application/json";
    input.onchange = (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(String(reader.result));
          setData((p) => ({ ...p, ...parsed }));
          alert("Imported JSON successfully.");
        } catch (err) {
          alert("Invalid JSON file.");
        }
      };
      reader.readAsText(file);
    };
    input.click();
  };

  const importCSV = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".csv,text/csv";
    input.onchange = (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const text = String(reader.result);
        const { rows } = parseCSVSimple(text);

        const buckets = { objectives: [], principles: [], guardrails: [], ground: [] };
        for (const r of rows) {
          const item = {
            ref: r.ref || r.Ref || `CSV-${Math.random().toString(36).slice(2, 6).toUpperCase()}`,
            category: r.category || r.Category || "",
            theme: r.theme || r.Theme || "",
            topic: r.topic || r.Topic || "",
            codify: r.codify || r.Codify || "",
            automate: r.automate || r.Automate || "",
            intercept: r.intercept || r.Intercept || "",
            prove: r.prove || r.Prove || "",
            dependency: r.dependency || r.Dependency || "N/A",
            status: r.status || r.Status || "proposed",
            user_notes: r.user_notes || r.Notes || r.UserNotes || "",
            decision: null,
          };
          const cat = (item.category || "").toLowerCase();
          if (cat.includes("objective")) buckets.objectives.push(item);
          else if (cat.includes("principle")) buckets.principles.push(item);
          else if (cat.includes("guardrail")) buckets.guardrails.push(item);
          else if (cat.includes("ground")) buckets.ground.push(item);
        }
        setData((p) => ({
          objectives: buckets.objectives.length ? buckets.objectives : p.objectives,
          principles: buckets.principles.length ? buckets.principles : p.principles,
          guardrails: buckets.guardrails.length ? buckets.guardrails : p.guardrails,
          ground: buckets.ground.length ? buckets.ground : p.ground,
        }));
        alert("Imported CSV rows into the matching sections.");
      };
      reader.readAsText(file);
    };
    input.click();
  };

  const resetDecisions = () => {
    const reset = (arr) => arr.map((r) => ({ ...r, decision: null }));
    setData((p) => ({
      objectives: reset(p.objectives),
      principles: reset(p.principles),
      guardrails: reset(p.guardrails),
      ground: reset(p.ground),
    }));
  };

  return (
    <div className="min-h-dvh bg-gray-50">
      <style>{`
        :root{
          --ms-teal:   rgb(26,153,136);
          --ms-blue:   rgb(106,164,200);
          --ms-orange: rgb(235,86,0);
          --ms-mint:   rgb(162,255,232);
          --ms-red:    rgb(255,0,0);
        }
      `}</style>

      <TopBar onImportJSON={importJSON} progress={progress} />

      <main className="mx-auto grid max-w-7xl grid-cols-1 gap-4 px-4 pb-8 pt-4 sm:grid-cols-[260px_1fr]">
        <Sidebar section={section} setSection={setSection} />

        <div className="space-y-4">
          {section === "info" && (<MissionInfo value={data.missionInfo} onChange={(val) => setData((p) => ({ ...p, missionInfo: val }))} />)}
{section === "service" && (<ServiceConfig value={data.serviceConfig} onChange={(val) => setData((p) => ({ ...p, serviceConfig: val }))} />)}
          {section === "objectives" && (<SectionTable title="Mission Objectives" rows={data.objectives} onRowsChange={(rows) => onRowsChange("objectives", rows)} />)}
          {section === "principles" && (<SectionTable title="Mission Principles" rows={data.principles} onRowsChange={(rows) => onRowsChange("principles", rows)} />)}
          {section === "guardrails" && (<SectionTable title="Mission Guardrails" rows={data.guardrails} onRowsChange={(rows) => onRowsChange("guardrails", rows)} />)}
          {section === "ground" && (<SectionTable title="Mission Tooling" rows={data.ground} onRowsChange={(rows) => onRowsChange("ground", rows)} allowAdd />)}
          {section === "review" && (<Review data={data} onResetDecisions={resetDecisions} />)}
        </div>
      </main>
    </div>
  );
}

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MissionSmithApp />);
  </script>

<script>
window.MS_actions = (function(){
  const download = (filename, text, type) => {
    const blob = new Blob([text], {type});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 200);
  };

  const acceptedOnly = (arr = []) => (arr||[]).filter(x => {
  const d = x && x.decision;
  if (d === true) return true;
  if (typeof d === 'string') {
    const s = d.trim().toLowerCase();
    if (s === 'accepted' || s === 'accept' || s === 'true' || s === 'yes' || s === 'y') return true;
  }
  if (typeof d === 'number' && d === 1) return true;
  const s2 = x && (x.status || x.accepted);
  return (typeof s2 === 'string' && s2.toLowerCase() === 'accepted');
});

  const deriveAccepted = (data = {}) => ({
  objectives: acceptedOnly(data.objectives || []),
  principles: acceptedOnly(data.principles  || []),
  guardrails: acceptedOnly(data.guardrails  || []),
  ground:     acceptedOnly((data.ground || data.tooling || []) )
});

  const mdList = (title, items) =>
    items.length ? `\n## ${title}\n` + items.map(i=>`- **${i.name || i.id || "item"}**${i.description ? ` â€” ${i.description}` : ""}`).join("\n") + "\n" : "";

  const missionTitle = (data) => (data?.missionInfo?.title || "Mission").replace(/[^\w\-]+/g,"_");
  const getData = () => (typeof window.__ms_getData === 'function' ? window.__ms_getData() : (window.__ms_data || window.data || window.initialData || {}));

  const buildAgentsMd = (data) => {
  const acc = deriveAccepted(data);

  const section = (title, rows) => {
    if (!rows || !rows.length) return "";
    const blocks = rows.map(r => {
      const lines = [
        `- **${r.ref || r.id || ""} â€” ${r.topic || r.purpose || ""}** *(Theme: ${r.theme || ""}; Category: ${r.category || ""})*`,
        `  - Codify: ${r.codify || ""}`,
        `  - Automate: ${r.automate || ""}`,
        `  - Intercept: ${r.intercept || ""}`,
        `  - Prove: ${r.prove || ""}`,
        `  - Dependency: ${r.dependency || ""}`,
        `  - Notes: ${r.user_notes || r.notes || ""}`,
      ];
      return lines.join("\n");
    }).join("\n");
    return `\n## ${title}\n${blocks}\n`;
  };

  let md = `# Agents Charter â€” ${data?.missionInfo?.title || "Mission"}\n`;
  md += `\n> Generated from accepted items in Objectives, Principles, Guardrails and Tooling.\n`;
  md += section("Objectives", acc.objectives);
  md += section("Principles", acc.principles);
  md += section("Guardrails", acc.guardrails);
  md += section("Tooling", acc.ground);
  md += `\n---\nGenerated by MissionSmith\n`;
  return md;
};

  const buildPipelineYml = (data) => {
    const acc = deriveAccepted(data);
    const hasCIGuardrail = acc.guardrails.some(g => /ci|pipeline/i.test((g.name||"")+ " " + (g.description||"")));
    const gates = hasCIGuardrail ? (data?.serviceConfig?.ci?.gates || []) : [];
    const steps = gates.map(g => `      - name: ${g}\n        run: echo "Running ${g} gate"\n`).join("");
    return `name: pipeline\non: [push, pull_request]\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n${steps || '      - run: echo "No accepted CI gates configured"'}\n`;
  };

  const buildPolicyBundleTxt = (data) => {
    const acc = deriveAccepted(data);
    const hasPolicy = acc.guardrails.some(g => /policy/i.test((g.name||"")+ " " + (g.description||"")));
    const packs = hasPolicy ? (data?.serviceConfig?.governance?.policy_packs || []) : [];
    return packs.length ? packs.map(p=>`- ${p}`).join("\n") : "No accepted policy packs.";
  };

  const buildDeployPlan = (data) => {
    const acc = deriveAccepted(data);
    const hasDeploy = acc.guardrails.some(g => /deploy|release|rollout/i.test((g.name||"")+ " " + (g.description||"")));
    const sc = data?.serviceConfig?.deploy || {};
    return `strategy: ${hasDeploy ? (sc.default_strategy || "") : "UNSET (no accepted deploy guardrail)"}\nfeature_flags: ${!!sc.feature_flags}\n`;
  };

  const buildDashboards = (data) => {
    const acc = deriveAccepted(data);
    const hasSLO = acc.guardrails.some(g => /slo|observability|latency|error rate|availability/i.test((g.name||"")+ " " + (g.description||"")));
    const slos = hasSLO ? (data?.serviceConfig?.nfr?.slo || []) : [];
    if (!slos.length) return "# No accepted SLOs";
    return "panels:\n" + slos.map(s => `- title: ${s.name}\n  target: ${s.target}`).join("\n");
  };

  const buildLineage = (data) => {
    const acc = deriveAccepted(data);
    const hasLineage = acc.guardrails.some(g => /lineage|audit|governance/i.test((g.name||"")+ " " + (g.description||"")));
    if (!hasLineage) return JSON.stringify({ enabled:false, reason:"No accepted lineage guardrail" }, null, 2);
    const sc = data?.serviceConfig || {};
    return JSON.stringify({
      enabled: true,
      mission: data?.missionInfo?.title || "Mission",
      defaults: {
        backend: [sc.default_backend_language, sc.default_backend_framework].filter(Boolean).join(" + "),
        ui: [sc.default_ui_language, sc.default_ui_framework].filter(Boolean).join(" + "),
        database: sc.default_database || "",
        outbox: !!sc.default_outbox_enabled
      }
    }, null, 2);
  };

  return {
    generateJSON(){ const d=getData(); download(`${missionTitle(d)}.json`, JSON.stringify(d,null,2), "application/json"); },
    generateAgents(){ try{ const md = buildAgentsMd(getData()); if(!md || !md.trim()){ alert("Agents file is empty."); return; } download("agents.md", md, "text/markdown"); } catch(e){ console.error(e); alert("Failed to build agents.md"); } },
    generateScaffold(){
      try {
        const d = getData();
        const sc = d?.serviceConfig || {};
        const backend = [sc.default_backend_language, sc.default_backend_framework].filter(Boolean).join(" + ") || "(unset)";
        const ui      = [sc.default_ui_language, sc.default_ui_framework].filter(Boolean).join(" + ") || "(unset)";
        const dbLine  = `${sc.default_database || "(unset)"}; Migrations: ${sc.default_migration_tool || "(unset)"}; Outbox: ${!!sc.default_outbox_enabled}`;
        const secLine = JSON.stringify(sc.security || {});
        const obsLine = JSON.stringify(sc.observability || {});
        const lines = [
          `# Service Scaffold Plan â€” ${d?.missionInfo?.title || "Mission"}`,
          `Backend default: ${backend}`,
          `UI default: ${ui}`,
          `Database: ${dbLine}`,
          `Security: ${secLine}`,
          `Observability: ${obsLine}`,
          ``,
          `---`,
          `Generated by MissionSmith`
        ];
        download('service-scaffold-plan.md', lines.join('\n'), 'text/markdown');
      } catch (e) {
        console.error('generateScaffold failed', e);
        alert('Failed to build service-scaffold-plan.md');
      }
    },
    generateCICD(){ download("pipeline.yml", buildPipelineYml(getData()), "text/yaml"); },
    generatePolicies(){ download("policy-packs.txt", buildPolicyBundleTxt(getData()), "text/plain"); },
    generateDeploy(){ download("deploy-manifests-plan.yaml", buildDeployPlan(getData()), "text/yaml"); },
    generateDashboards(){ download("dashboards-alerts.yaml", buildDashboards(getData()), "text/yaml"); },
    generateLineage(){ download("lineage.json", buildLineage(getData()), "application/json"); }
  };
})();
</script>


<script>
(function(){
  function show(msg, src, line, col){
    const el = document.createElement('div');
    el.style.position='fixed'; el.style.left=0; el.style.right=0; el.style.bottom=0;
    el.style.background='rgba(220,38,38,0.95)'; el.style.color='#fff'; el.style.fontFamily='ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    el.style.whiteSpace='pre-wrap'; el.style.maxHeight='40vh'; el.style.overflow='auto'; el.style.padding='12px 16px'; el.style.zIndex=99999;
    el.textContent = 'MissionSmith runtime error:\n' + msg + (src ? ('\n@ ' + src + ':' + line + ':' + col) : '');
    document.body.appendChild(el);
  }
  window.addEventListener('error', e => show(e.message, e.filename, e.lineno, e.colno));
  window.addEventListener('unhandledrejection', e => show(String(e.reason || 'Unhandled promise rejection')));
})();
</script>


<script>
(function(){
  function show(msg, src, line, col){
    const el = document.createElement('div');
    el.style.position='fixed'; el.style.left=0; el.style.right=0; el.style.bottom=0;
    el.style.background='rgba(220,38,38,0.95)'; el.style.color='#fff'; el.style.fontFamily='ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    el.style.whiteSpace='pre-wrap'; el.style.maxHeight='40vh'; el.style.overflow='auto'; el.style.padding='12px 16px'; el.style.zIndex=99999;
    el.textContent = 'MissionSmith runtime error:\n' + msg + (src ? ('\n@ ' + src + ':' + line + ':' + col) : '');
    document.body.appendChild(el);
  }
  window.addEventListener('error', e => show(e.message, e.filename, e.lineno, e.colno));
  window.addEventListener('unhandledrejection', e => show(String(e.reason || 'Unhandled promise rejection')));
})();
</script>


<script>
(function(){
  function wireFrameworkButtons(){
    var hdr = document.querySelector('header.sticky.top-0');
    if(!hdr) return;
    var right = hdr.querySelector('.flex.items-center.gap-2');
    if(!right) return;

    // 1) Ensure Import button label
    var importBtn = right.querySelector('button');
    if(importBtn){
      var txt = (importBtn.textContent || '').trim().toLowerCase();
      if(txt.includes('import')){
        importBtn.textContent = 'Import Mission Framework';
      }
      // keep existing onClick handler (importJSON) intact
    }

    // 2) Inject Export button if not present
    if(!right.querySelector('.msx-framework-btn')){
      var exp = document.createElement('button');
      exp.className = 'msx-framework-btn';
      exp.textContent = 'Export Mission Framework';
      exp.addEventListener('click', function(){
        try {
          if (window.exportJSON) { window.exportJSON(); return; }
          if (window.MS_actions && typeof window.MS_actions.generateJSON === 'function') {
            window.MS_actions.generateJSON(); return;
          }
          console.warn('No export function found');
        } catch(e){ console.error(e); }
      });
      right.prepend(exp);
    }
  }
  document.addEventListener('DOMContentLoaded', wireFrameworkButtons);
  // Re-apply if React re-renders
  new MutationObserver(wireFrameworkButtons).observe(document.body, {childList:true, subtree:true});
})();
</script>


<!-- === Integrated CI/CD Generator v1.2 (no new screens) === -->
<script>
(function(){
  // --- Utilities ---
  function str(v){ return (v==null?'':String(v)); }
  function val(obj, path, fallback){
    try{
      return path.split('.').reduce((o,k)=> (o && (k in o) ? o[k] : undefined), obj) ?? fallback;
    }catch(_){ return fallback; }
  }
  function toProfile(sc){
    const lang = (str(sc.default_backend_language)).toLowerCase();
    if (/java/.test(lang)) return "java-maven";
    if (/python/.test(lang)) return "python-pytest";
    if (/node|javascript|ts|typescript/.test(lang)) return "node-npm";
    if (/go/.test(lang)) return "go";
    if (/dotnet|csharp/.test(lang)) return "dotnet";
    return "java-maven"; // default
  }
  function toGates(arr){
    if (Array.isArray(arr) && arr.length) return arr.map(x=>String(x).trim()).filter(Boolean);
    return "lint, unit, contract, integration, sast, sbom, iac, schema-compat, docker-scan, policy, sign"
      .split(',').map(s=>s.trim());
  }
  function registryDefault(sc){
    const r = str(sc.default_registry || "").trim();
    return r || "ghcr.io/OWNER/REPO";
  }

  // --- Generators (from LaunchPad v1.2) ---
  function genBuildTest(profile, gates){
    const has = t => gates.includes(t);
    const isJava = profile==='java-maven';
    const isNode = profile==='node-npm';
    const isPy   = profile==='python-pytest';
    let setup='';
    if(isJava) setup = "\n      - uses: actions/setup-java@v4\n        with:\n          distribution: temurin\n          java-version: '21'\n";
    if(isNode) setup = "\n      - uses: actions/setup-node@v4\n        with:\n          node-version: '20'\n";
    if(isPy)   setup = "\n      - uses: actions/setup-python@v5\n        with:\n          python-version: '3.11'\n";
    let lint='';
    if(has('lint')){
      if(isJava) lint = "      - name: Lint (Maven)\n        run: |\n          mvn -B -ntp -DskipTests=true spotless:check || true\n          mvn -B -ntp -DskipTests=true checkstyle:check || true\n";
      if(isNode) lint = "      - name: Lint (ESLint)\n        run: |\n          npm ci\n          npx eslint . || true\n";
      if(isPy)   lint = "      - name: Lint (flake8)\n        run: |\n          python -m pip install --upgrade pip\n          pip install flake8\n          flake8 . || true\n";
    }
    let tests='';
    if(has('unit') || has('integration')){
      if(isJava) tests = "      - name: Maven test (unit + integration)\n        run: mvn -B -ntp -DskipITs=false test\n";
      if(isNode) tests = "      - name: Node tests\n        run: |\n          npm ci\n          npm test --if-present\n";
      if(isPy)   tests = "      - name: PyTest\n        run: |\n          python -m pip install --upgrade pip\n          pip install -r requirements.txt || true\n          pytest -q --maxfail=1 --disable-warnings --junitxml=test-results/python-junit.xml\n";
    }
    const contract = has('contract')
      ? "      - name: Pact verify (if contracts present)\n        if: ${{ hashFiles('**/contracts/**') != '' }}\n        run: mvn -B -ntp pact:verify || echo \'No contracts\'\n" : "";
    const compat = has('schema-compat')
      ? "      - name: Schema compatibility check (if schemas present)\n        if: ${{ hashFiles('**/schemas/**') != '' }}\n        run: echo \'Implement your Avro/JSON compat check here\'\n" : "";

    return "name: ci-cd\n\non: [push, pull_request]\n\npermissions:\n  contents: read\n  packages: write\n  security-events: write\n\njobs:\n  build-test:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4" + setup + lint + tests + contract + compat +
      "      - name: Upload test results\n        if: ${{ always() }}\n        uses: actions/upload-artifact@v4\n        with:\n          name: test-results\n          path: |\n            **/target/surefire-reports/*.xml\n            **/target/failsafe-reports/*.xml\n            test-results/**/*.xml\n          if-no-files-found: ignore\n";
  }

  function genSecurity(gates){
    const has = t => gates.includes(t);
    let y = "name: security\n\non: [push, pull_request]\n\npermissions:\n  contents: read\n  security-events: write\n  packages: write\n\njobs:\n  security:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n";
    if(has('sast')) y += "      - name: Semgrep SAST\n        uses: returntocorp/semgrep-action@v1\n        with:\n          config: p/owasp-top-ten\n          generateSarif: true\n";
    if(has('docker-scan') || has('sbom') || has('sign')) y += "      - name: Set up Buildx\n        uses: docker/setup-buildx-action@v3\n      - name: Build image (no push)\n        uses: docker/build-push-action@v6\n        with:\n          context: .\n          push: false\n          load: true\n          tags: local/app:ci\n          provenance: false\n";
    if(has('docker-scan')) y += "      - name: Trivy image scan\n        uses: aquasecurity/trivy-action@0.28.0\n        with:\n          image-ref: local/app:ci\n          format: table\n          exit-code: '1'\n          ignore-unfixed: true\n";
    if(has('sbom')) y += "      - name: SBOM (Syft)\n        uses: anchore/sbom-action@v0\n        with:\n          image: local/app:ci\n          artifact-name: sbom.spdx.json\n";
    if(has('sign')) y += "      - name: Install Cosign\n        uses: sigstore/cosign-installer@v3.7.0\n      - name: Cosign sign (optional)\n        if: ${{ secrets.COSIGN_KEY != '' }}\n        env:\n          COSIGN_EXPERIMENTAL: '1'\n          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}\n        run: |\n          printf \"%s\" \"${{ secrets.COSIGN_KEY }}\" > cosign.key\n          cosign sign --key cosign.key local/app:ci\n";
    y += "      - name: Upload security artefacts\n        uses: actions/upload-artifact@v4\n        with:\n          name: security\n          path: |\n            semgrep.sarif\n            sbom.spdx.json\n          if-no-files-found: ignore\n";
    return y;
  }

  function genIaC(gates){
    const has = t => gates.includes(t);
    let y = "name: iac-policy\n\non: [push, pull_request]\n\npermissions:\n  contents: read\n\njobs:\n  iac-policy:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n";
    if(has('iac')) y += "      - name: Terraform fmt/validate/plan\n        if: ${{ hashFiles('**/*.tf') != '' }}\n        run: |\n          terraform -version || (curl -fsSL https://releases.hashicorp.com/terraform/1.9.5/terraform_1.9.5_linux_amd64.zip -o tf.zip && sudo unzip -o tf.zip -d /usr/local/bin)\n          terraform -chdir=infra fmt -check\n          terraform -chdir=infra init -input=false\n          terraform -chdir=infra validate\n          terraform -chdir=infra plan -input=false -lock=false -out=tfplan\n";
    if(has('policy')) y += "      - name: conftest policy check\n        if: ${{ hashFiles('policy/**.rego') != '' }}\n        uses: instrumenta/conftest-action@v0.3.0\n        with:\n          files: |\n            infra/**/*.tf\n            deploy/**/*.yaml\n";
    return y;
  }

  function genPackagePublish(registry){
    return "name: package-publish\non:\n  push:\n    branches: [ \"main\" ]\n  workflow_dispatch: {}\n\npermissions:\n  contents: read\n  packages: write\n\nenv:\n  REGISTRY: " + registry + "\n  IMAGE_SHA: " + registry + ":${{ github.sha }}\n  IMAGE_MAIN: " + registry + ":main\n\njobs:\n  build-push-sign:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: docker/setup-qemu-action@v3\n      - uses: docker/setup-buildx-action@v3\n      - uses: docker/login-action@v3\n        with:\n          registry: ghcr.io\n          username: ${{ github.actor }}\n          password: ${{ secrets.GITHUB_TOKEN }}\n      - name: Build & push (sha)\n        uses: docker/build-push-action@v6\n        with:\n          context: .\n          push: true\n          tags: ${{ env.IMAGE_SHA }}\n          provenance: false\n      - name: Build & push (main)\n        uses: docker/build-push-action@v6\n        with:\n          context: .\n          push: true\n          tags: ${{ env.IMAGE_MAIN }}\n          provenance: false\n      - name: Install Cosign\n        uses: sigstore/cosign-installer@v3.7.0\n      - name: Cosign sign (sha)\n        if: ${{ secrets.COSIGN_KEY != '' }}\n        env:\n          COSIGN_EXPERIMENTAL: \"1\"\n          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}\n        run: |\n          printf \"%s\" \"${{ secrets.COSIGN_KEY }}\" > cosign.key\n          cosign sign --key cosign.key ${{ env.IMAGE_SHA }}\n      - name: Cosign sign (main)\n        if: ${{ secrets.COSIGN_KEY != '' }}\n        env:\n          COSIGN_EXPERIMENTAL: \"1\"\n          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}\n        run: |\n          printf \"%s\" \"${{ secrets.COSIGN_KEY }}\" > cosign.key\n          cosign sign --key cosign.key ${{ env.IMAGE_MAIN }}\n";
  }

  function genPromoteDeploy(){
    return "name: promote-deploy\non:\n  workflow_dispatch:\n    inputs:\n      image:\n        description: \"Image to deploy (e.g., ghcr.io/owner/repo:sha)\"\n        required: false\n      envs:\n        description: \"Comma-separated envs to deploy (dev,staging,prod)\"\n        required: false\n        default: \"dev,staging,prod\"\n  push:\n    branches: [ \"main\" ]\n\npermissions:\n  contents: read\n  packages: read\n\nenv:\n  DEFAULT_IMAGE: ghcr.io/${{ github.repository }}:${{ github.sha }}\n  NAMESPACE: default\n  CANARY_REPLICAS: 1\n  STABLE_PERCENT: 90\n\njobs:\n  matrix-setup:\n    runs-on: ubuntu-latest\n    outputs:\n      envs: ${{ steps.mk.outputs.envs }}\n    steps:\n      - id: mk\n        run: |\n          IN=\"${{ github.event.inputs.envs }}\"\n          if [ -z \"$IN\" ]; then IN=\"dev,staging,prod\"; fi\n          echo \"envs=$(printf '[%s]' \\\"$(echo \\\"$IN\\\" | sed 's/,/","/g' | sed 's/^/\\\"/;s/$/\\\"/')\\\")\" >> $GITHUB_OUTPUT\n\n  deploy:\n    needs: matrix-setup\n    runs-on: ubuntu-latest\n    strategy:\n      matrix:\n        env: ${{ fromJson(needs.matrix-setup.outputs.envs) }}\n    environment: ${{ matrix.env }}\n    steps:\n      - uses: actions/checkout@v4\n      - name: Choose image\n        id: img\n        run: |\n          IMG=\"${{ github.event.inputs.image }}\"\n          if [ -z \"$IMG\" ]; then IMG=\"${{ env.DEFAULT_IMAGE }}\"; fi\n          echo \"image=$IMG\" >> $GITHUB_OUTPUT\n      - name: Install Cosign\n        uses: sigstore/cosign-installer@v3.7.0\n      - name: Verify image signature\n        env:\n          COSIGN_EXPERIMENTAL: \"1\"\n          COSIGN_PUBLIC_KEY: ${{ secrets.COSIGN_PUBLIC_KEY }}\n        run: |\n          if [ -z \"$COSIGN_PUBLIC_KEY\" ]; then\n            echo \"Missing COSIGN_PUBLIC_KEY; refusing to deploy unsigned/unverified image\" >&2\n            exit 1\n          fi\n          printf \"%s\" \"$COSIGN_PUBLIC_KEY\" > cosign.pub\n          cosign verify --key cosign.pub \"${{ steps.img.outputs.image }}\"\n      - name: Set kubeconfig\n        id: kube\n        run: |\n          ENV=\"${{ matrix.env }}\"\n          KC_VAR=\"KUBE_CONFIG_\${ENV^^}\"\n          KCONF=\"${!KC_VAR}\"\n          if [ -z \"$KCONF\" ]; then\n            echo \"Kubeconfig secret $KC_VAR is not set\" >&2\n            exit 1\n          fi\n          if echo \"$KCONF\" | grep -q \"apiVersion: v1\"; then\n            printf \"%s\" \"$KCONF\" > $HOME/.kubeconfig\n          else\n            printf \"%s\" \"$KCONF\" | base64 -d > $HOME/.kubeconfig\n          fi\n          echo \"KUBECONFIG=$HOME/.kubeconfig\" >> $GITHUB_ENV\n        env:\n          KUBE_CONFIG_DEV: ${{ secrets.KUBE_CONFIG_DEV }}\n          KUBE_CONFIG_STAGING: ${{ secrets.KUBE_CONFIG_STAGING }}\n          KUBE_CONFIG_PROD: ${{ secrets.KUBE_CONFIG_PROD }}\n      - name: Install kubectl\n        run: |\n          curl -fsSL https://storage.googleapis.com/kubernetes-release/release/v1.30.5/bin/linux/amd64/kubectl -o kubectl\n          chmod +x kubectl && sudo mv kubectl /usr/local/bin/\n      - name: Templatise manifests with image tag\n        run: |\n          ENV=\"${{ matrix.env }}\"\n          find \"deploy/\${ENV}\" -type f -name \"*.yaml\" -print0 | while IFS= read -r -d '' f; do\n            sed -i \"s#IMAGE_PLACEHOLDER#${{ steps.img.outputs.image }}#g\" \"$f\"\n            sed -i \"s#NAMESPACE_PLACEHOLDER#${{ env.NAMESPACE }}#g\" \"$f\"\n          done\n      - name: Apply canary (if present)\n        run: |\n          ENV=\"${{ matrix.env }}\"\n          if ls \"deploy/\${ENV}/canary/\"/*.yaml >/dev/null 2>&1; then\n            kubectl apply -n \"${{ env.NAMESPACE }}\" -f \"deploy/\${ENV}/canary/\"\n            kubectl rollout status -n \"${{ env.NAMESPACE }}\" deployment -l app.kubernetes.io/part-of=canary --timeout=120s\n          else\n            echo \"No canary overlay found; skipping canary\"\n          fi\n      - name: Bake\n        run: sleep 30\n      - name: Promote to stable\n        run: |\n          ENV=\"${{ matrix.env }}\"\n          kubectl apply -n \"${{ env.NAMESPACE }}\" -f \"deploy/\${ENV}/\"\n          kubectl rollout status -n \"${{ env.NAMESPACE }}\" deployment -l app.kubernetes.io/name=${{ github.event.repository.name }} --timeout=180s\n      - name: Cleanup canary\n        run: |\n          ENV=\"${{ matrix.env }}\"\n          if ls \"deploy/\${ENV}/canary/\"/*.yaml >/dev/null 2>&1; then\n            kubectl delete -n \"${{ env.NAMESPACE }}\" -f \"deploy/\${ENV}/canary/\" --ignore-not-found\n          fi\n";
  }

  function genReportMd(gates, profile){
    const tokenMap = { lint:'Lint', unit:'Unit tests', contract:'Contract tests', integration:'Integration tests', coverage:'Coverage', e2e:'End-to-end',
      sast:'SAST', 'docker-scan':'Container scan', sbom:'SBOM', sign:'Image signing', 'schema-compat':'Schema compatibility', iac:'IaC validate/plan', policy:'Policy check', observability:'Observability', chaos:'Chaos', a11y:'Accessibility', perf:'Performance'};
    const lines = ['# CI/CD Generation Report','',`Profile: **${profile}**`,'Gates:',''];
    gates.forEach(g=>lines.push(`- ${tokenMap[g] ? 'âœ…' : 'âš ï¸'} ${g}${tokenMap[g] ? '' : ' (unknown token)'}`));
    lines.push('\nFiles generated: ci-cd.yml, security.yml, iac-policy.yml, package-publish.yml, promote-deploy.yml');
    lines.push('Notes: Configure COSIGN_* and KUBE_CONFIG_* secrets for signing and deploy.');
    return lines.join('\n');
  }

  // --- Wire into MissionSmith button ---
  if (window.MS_actions) {
    const orig = window.MS_actions;
    orig.generateCICD = function(){
      try{
        const data = (typeof window.__ms_getData === 'function' ? window.__ms_getData() : window.__ms_data) || {};
        const sc = data.serviceConfig || {};
        const profile = toProfile(sc);
        const gates = toGates(val(sc, 'ci.gates', []));
        const registry = registryDefault(sc);

        const files = [
          {path: '.github/workflows/ci-cd.yml', content: genBuildTest(profile, gates)},
          {path: '.github/workflows/security.yml', content: genSecurity(gates)},
          {path: '.github/workflows/iac-policy.yml', content: genIaC(gates)},
          {path: '.github/workflows/package-publish.yml', content: genPackagePublish(registry)},
          {path: '.github/workflows/promote-deploy.yml', content: genPromoteDeploy()},
          {path: 'ci-cd-report.md', content: genReportMd(gates, profile)}
        ];

        // bundle download
        const chunks = ['# --- BEGIN MISSIONSMITH CI/CD BUNDLE ---'];
        for (const f of files) { chunks.push(`\n# FILE: ${f.path}\n\n${f.content}`); }
        const blob = new Blob([chunks.join('\n')], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'mission-cicd-bundle.txt';
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 200);

        alert('âœ… CI/CD workflows generated. Add COSIGN_* and KUBE_CONFIG_* secrets for signing/deploy.');
      }catch(e){
        console.error('generateCICD failed', e);
        alert('Failed to generate CI/CD workflows.');
      }
    };
    window.MS_actions = orig;
  }
})();
</script>

<!-- === Integrated IaC Generator v1.0 === -->
<script>
(function(){
  // Helpers
  function str(v){ return (v==null?'':String(v)); }
  function val(obj, path, fallback){
    try{ return path.split('.').reduce((o,k)=> (o && (k in o) ? o[k] : undefined), obj) ?? fallback; }catch(_){ return fallback; }
  }
  function appName(sc){
    const n = str(sc.default_service_name || 'app').trim() || 'app';
    return n.replace(/[^a-z0-9-]/ig,'-').toLowerCase();
  }
  function imageDefault(sc){
    const reg = str(sc.default_registry || '').trim() || 'ghcr.io/OWNER/REPO';
    return reg + ':main';
  }
  function sloTarget(sc, name, dflt){ try{ return (sc?.nfr?.slo||[]).find(s=>s.name===name)?.target ?? dflt; }catch(_){ return dflt; } }

  // YAML templates (with placeholders to be replaced by the deploy workflow)
  function baseDeploymentYaml(app){
    return `apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${app}
  namespace: NAMESPACE_PLACEHOLDER
  labels:
    app.kubernetes.io/name: ${app}
    app.kubernetes.io/instance: ${app}
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: ${app}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ${app}
    spec:
      containers:
      - name: ${app}
        image: IMAGE_PLACEHOLDER
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
        env:
        - name: OTEL_SERVICE_NAME
          value: "${app}"
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
`;
  }

  function serviceYaml(app){
    return `apiVersion: v1
kind: Service
metadata:
  name: ${app}
  namespace: NAMESPACE_PLACEHOLDER
spec:
  selector:
    app.kubernetes.io/name: ${app}
  ports:
  - name: http
    port: 80
    targetPort: 8080
  type: ClusterIP
`;
  }

  function namespaceYaml(){
    return `apiVersion: v1
kind: Namespace
metadata:
  name: NAMESPACE_PLACEHOLDER
`;
  }

  function canaryDeploymentYaml(app){
    return `apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${app}-canary
  namespace: NAMESPACE_PLACEHOLDER
  labels:
    app.kubernetes.io/name: ${app}
    app.kubernetes.io/part-of: canary
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: ${app}
      app.kubernetes.io/part-of: canary
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ${app}
        app.kubernetes.io/part-of: canary
    spec:
      containers:
      - name: ${app}
        image: IMAGE_PLACEHOLDER
        ports:
        - containerPort: 8080
`;
  }

  // Terraform (kubernetes provider) skeleton
  function tfProviders(){
    return `terraform {
  required_version = ">= 1.5.0"
  required_providers {
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = ">= 2.32.0"
    }
  }
}

# Uses KUBECONFIG from the environment (set by CI)
provider "kubernetes" {}
`;
  }
  function tfVariables(app, image){
    return `variable "namespace" { type = string  default = "default" }
variable "app_name"  { type = string  default = "${app}" }
variable "image"     { type = string  default = "${image}" }
`;
  }
  function tfMain(){
    return `resource "kubernetes_namespace" "ns" {
  metadata { name = var.namespace }
}

resource "kubernetes_deployment" "app" {
  metadata {
    name      = var.app_name
    namespace = var.namespace
    labels = {
      "app.kubernetes.io/name" = var.app_name
    }
  }
  spec {
    replicas = 2
    selector {
      match_labels = { "app.kubernetes.io/name" = var.app_name }
    }
    template {
      metadata {
        labels = { "app.kubernetes.io/name" = var.app_name }
      }
      spec {
        container {
          name  = var.app_name
          image = var.image
          port  { container_port = 8080 }
        }
      }
    }
  }
}

resource "kubernetes_service" "svc" {
  metadata {
    name      = var.app_name
    namespace = var.namespace
  }
  spec {
    selector = { "app.kubernetes.io/name" = var.app_name }
    port { port = 80  target_port = 8080 }
    type = "ClusterIP"
  }
}
`;
  }
  function tfOutputs(){
    return `output "service_name" { value = kubernetes_service.svc.metadata[0].name }
output "namespace"    { value = kubernetes_namespace.ns.metadata[0].name }
`;
  }

  function readme(){
    return `# MissionSmith IaC Bundle

This bundle includes:
- Kubernetes deploy manifests under \`deploy/{dev,staging,prod}\` (with \`IMAGE_PLACEHOLDER\` and \`NAMESPACE_PLACEHOLDER\` tokens)
- A Terraform skeleton under \`infra/\` using the Kubernetes provider

## Using with the generated CI/CD
- The \`promote-deploy.yml\` workflow will replace the placeholders and apply the manifests.
- Set the following secrets in your repo for each environment:
  - \`COSIGN_PUBLIC_KEY\` (for verification)
  - \`KUBE_CONFIG_DEV\`, \`KUBE_CONFIG_STAGING\`, \`KUBE_CONFIG_PROD\`

> You can also use \`infra/\` with \`terraform -chdir=infra init && terraform -chdir=infra apply -var namespace=<env> -var image=<image>\`.
`;
  }

  function bundleFiles(data){
    const sc = data?.serviceConfig || {};
    const app = appName(sc);
    const image = imageDefault(sc);

    const envs = ["dev","staging","prod"];
    const files = [];

    // Env-specific k8s manifests
    envs.forEach(env => {
      files.push({ path: `deploy/${env}/namespace.yaml`, content: namespaceYaml() });
      files.push({ path: `deploy/${env}/deployment.yaml`, content: baseDeploymentYaml(app) });
      files.push({ path: `deploy/${env}/service.yaml`, content: serviceYaml(app) });
      files.push({ path: `deploy/${env}/canary/deployment.yaml`, content: canaryDeploymentYaml(app) });
    });

    // Terraform skeleton
    files.push({ path: `infra/providers.tf`, content: tfProviders() });
    files.push({ path: `infra/variables.tf`, content: tfVariables(app, image) });
    files.push({ path: `infra/main.tf`, content: tfMain() });
    files.push({ path: `infra/outputs.tf`, content: tfOutputs() });
    files.push({ path: `README-IAC.md`, content: readme() });

    return files;
  }

  // Override the existing IaC button behaviour
  if (window.MS_actions) {
    const orig = window.MS_actions;
    orig.generateDeploy = function(){
      try{
        const data = (typeof window.__ms_getData === 'function' ? window.__ms_getData() : window.__ms_data) || {};
        const files = bundleFiles(data);

        const chunks = ['# --- BEGIN MISSIONSMITH IAC BUNDLE ---'];
        for (const f of files) { chunks.push(`\n# FILE: ${f.path}\n\n${f.content}`); }
        const blob = new Blob([chunks.join('\n')], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'mission-iac-bundle.txt';
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 200);

        alert('âœ… IaC bundle generated: deploy/{env}/... + infra/ (Terraform).');
      }catch(e){
        console.error('generateDeploy failed', e);
        alert('Failed to generate IaC bundle.');
      }
    };
    window.MS_actions = orig;
  }
})();
</script>


<!-- === MissionSmith Lineage Generator v1.0 === -->
<script>
(function(){
  function safe(v, d){ return (v===undefined || v===null) ? d : v; }
  function norm(s){ return String(s||'').trim().replace(/[^a-z0-9-_:.]/ig,'_'); }
  function title(s){ return String(s||'').trim(); }

  // Extract a best-effort model from the app's data blob
  function extractModel(data){
    const sc = data?.serviceConfig || {};
    const services = [];
    const datasets = [];
    const policies = [];
    const pipelines = [];
    const objectives = [];

    // Service
    const appName = sc.default_service_name || 'app';
    services.push({id: norm(appName), name: title(appName), kind:'service'});

    // Datasets / APIs (best effort)
    const ds = safe(sc.data_sources, []);
    ds.forEach((d, i)=>{
      const name = d?.name || `dataset_${i+1}`;
      datasets.push({id: norm(name), name: title(name), kind:'dataset'});
    });

    // Pipelines (from CI/CD + build stages if present)
    const pl = safe(data?.pipelines, []);
    pl.forEach((p, i)=>{
      const name = p?.name || `pipeline_${i+1}`;
      pipelines.push({id: norm(name), name: title(name), kind:'pipeline'});
    });

    // Policies / Guardrails
    const pol = safe(data?.policies, []);
    pol.forEach((p, i)=>{
      const name = p?.name || `policy_${i+1}`;
      policies.push({id: norm(name), name: title(name), kind:'policy'});
    });

    // Objectives (Mission Objectives sheet)
    const obj = safe(data?.objectives || data?.missionObjectives, []);
    obj.forEach((o, i)=>{
      const name = o?.reference || o?.name || `objective_${i+1}`;
      objectives.push({id: norm(name), name: title(name), kind:'objective'});
    });

    // Build edges heuristically:
    const edges = [];
    // service uses datasets
    datasets.forEach(d => edges.push({from: d.id, to: norm(appName), relation: 'consumed_by'}));
    // pipelines deploy service
    pipelines.forEach(p => edges.push({from: p.id, to: norm(appName), relation: 'deploys'}));
    // policies govern service and pipelines
    policies.forEach(pol => {
      edges.push({from: pol.id, to: norm(appName), relation:'governs'});
      pipelines.forEach(p => edges.push({from: pol.id, to: p.id, relation:'governs'}));
    });
    // objectives drive pipelines (if any)
    objectives.forEach(o => {
      pipelines.forEach(p => edges.push({from: o.id, to: p.id, relation:'drives'}));
    });

    return {services, datasets, policies, pipelines, objectives, edges};
  }

  function toCSV(model){
    const header = "from,to,relation\n";
    const rows = model.edges.map(e => `${e.from},${e.to},${e.relation}`);
    return header + rows.join("\n") + "\n";
  }

  function toDOT(model){
    const lines = [];
    lines.push('digraph MissionSmithLineage {');
    lines.push('  rankdir=LR;');
    function node(n, shape, color){
      lines.push(`  "${n.id}" [label="${n.name}\\n(${n.kind})", shape=${shape}, style=filled, fillcolor="${color}"];`);
    }
    model.datasets.forEach(n => node(n, 'cylinder', '#E0F7FA'));
    model.services.forEach(n => node(n, 'box', '#E8F5E9'));
    model.pipelines.forEach(n => node(n, 'component', '#EDE7F6'));
    model.policies.forEach(n => node(n, 'octagon', '#FFF3E0'));
    model.objectives.forEach(n => node(n, 'ellipse', '#F3E5F5'));

    model.edges.forEach(e => lines.push(`  "${e.from}" -> "${e.to}" [label="${e.relation}"];`));
    lines.push('}');
    return lines.join("\n");
  }

  // Minimal OpenLineage-style JSON (not full spec; enough for import/visualization tools)
  function toOpenLineage(model){
    const now = new Date().toISOString();
    const events = [];

    // Emit one RUN event per pipeline, pointing to the service dataset outputs
    model.pipelines.forEach(p => {
      const outputs = model.services.map(s => ({namespace:"app", name:s.name}));
      const inputs  = model.datasets.map(d => ({namespace:"data", name:d.name}));
      events.push({
        eventType: "COMPLETE",
        eventTime: now,
        run: { runId: `${p.id}-${now}` },
        job: { namespace: "mission-smith", name: p.name },
        inputs, outputs,
        producer: "missionsmith/lineage-generator"
      });
    });
    return JSON.stringify({version:"0.1", events}, null, 2);
  }

  // Hook up Lineage button if MS_actions present
  if (window.MS_actions){
    const orig = window.MS_actions;
    orig.generateLineage = function(){
      try{
        const data = (typeof window.__ms_getData === 'function' ? window.__ms_getData() : window.__ms_data) || {};
        const model = extractModel(data);

        const files = [
          { path: 'lineage/edges.csv', content: toCSV(model) },
          { path: 'lineage/graph.dot', content: toDOT(model) },
          { path: 'lineage/openlineage.json', content: toOpenLineage(model) },
          { path: 'lineage/README-LINEAGE.md', content:
`# MissionSmith Lineage Bundle

This bundle provides three interoperable artifacts:

1) **edges.csv** â€” simple \`from,to,relation\` edge list (easy to load in Neo4j/NetworkX/Gephi).
2) **graph.dot** â€” Graphviz DOT for quick rendering to SVG/PNG (\`dot -Tsvg graph.dot -o graph.svg\`).
3) **openlineage.json** â€” lightweight OpenLineage-style events that many tools can ingest (e.g. Marquez).

### Relations
- \`consumed_by\`: dataset â†’ service
- \`deploys\`: pipeline â†’ service
- \`governs\`: policy â†’ (service|pipeline)
- \`drives\`: objective â†’ pipeline

> Model is generated bestâ€‘effort from your MissionSmith data. Customize by editing this README or the JSON.
`
          }
        ];

        const chunks = ['# --- BEGIN MISSIONSMITH LINEAGE BUNDLE ---'];
        for (const f of files){ chunks.push(`\n# FILE: ${f.path}\n\n${f.content}`); }
        const blob = new Blob([chunks.join('\n')], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'mission-lineage-bundle.txt';
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 200);

        alert('âœ… Lineage bundle generated: edges.csv, graph.dot, openlineage.json.');
      }catch(e){
        console.error('generateLineage failed', e);
        alert('Failed to generate lineage bundle.');
      }
    };
    window.MS_actions = orig;
  }
})();
</script>


<!-- === MissionSmith Analytics Generator v1.0 === -->
<script>
(function(){
  function safe(v, d){ return (v===undefined||v===null) ? d : v; }
  function norm(s){ return String(s||'').trim().replace(/[^a-z0-9-_:.]/ig,'_'); }
  function title(s){ return String(s||'').trim(); }

  function extractKPIs(data){
    // Try multiple places: nfr.slo, nfr.kpis, analytics.kpis, objectives.*.kpi
    const sc = data?.serviceConfig || {};
    const slo = safe(sc?.nfr?.slo, []);
    const k1 = slo.map(s => ({key: norm(s.name||s.id||'slo'), name: title(s.name||s.id||'SLO'), target: s.target, window: s.window || '30d', unit: s.unit || '%', source: s.source || 'app_metrics'}));

    const k2 = safe(sc?.nfr?.kpis, []).map(k => ({
      key: norm(k.key||k.name), name: title(k.name||k.key), unit: k.unit||'count', target: k.target, source: k.source||'events'
    }));

    const k3 = safe(data?.analytics?.kpis, []).map(k => ({
      key: norm(k.key||k.name), name: title(k.name||k.key), unit: k.unit||'count', target: k.target, source: k.source||'warehouse'
    }));

    // derive from objectives with "KPI:" prefix
    const objectives = safe(data?.objectives || data?.missionObjectives, []);
    const k4 = objectives
      .filter(o => (o?.kpi || '').toString().length || /kpi[:=]/i.test(String(o?.notes||'')))
      .map((o,i)=>{
        const nm = o?.kpi || String(o?.notes||'').match(/kpi[:=]\s*([^\n]+)/i)?.[1] || `objective_kpi_${i+1}`;
        return {key: norm(nm), name: title(nm), unit: 'count', target: o?.target, source: 'derived'};
      });

    const all = [...k1, ...k2, ...k3, ...k4];
    // de-dup by key
    const seen = new Set(); const uniq=[];
    all.forEach(k => { if(!k.key) return; if(!seen.has(k.key)){ seen.add(k.key); uniq.push(k);} });
    if (uniq.length===0){
      // Provide sensible defaults
      uniq.push({key:'latency_p95_ms', name:'Latency p95', unit:'ms', target: 300, source:'app_metrics'});
      uniq.push({key:'error_rate_pct', name:'Error Rate', unit:'%', target: 1, source:'app_metrics'});
      uniq.push({key:'throughput_rps', name:'Throughput', unit:'rps', target: null, source:'app_metrics'});
    }
    return uniq;
  }

  function toMetricsCatalog(kpis){
    const lines = [];
    lines.push('apiVersion: v1');
    lines.push('kind: MetricsCatalog');
    lines.push('metadata:');
    lines.push('  name: missionsmith-metrics');
    lines.push('spec:');
    lines.push('  kpis:');
    kpis.forEach(k => {
      lines.push(`  - key: ${k.key}`);
      lines.push(`    name: "${k.name}"`);
      if (k.unit!=null) lines.push(`    unit: "${k.unit}"`);
      if (k.target!=null) lines.push(`    target: ${k.target}`);
      lines.push(`    source: "${k.source||'warehouse'}"`);
      lines.push(`    owners:`);
      lines.push(`      - platform`);
    });
    return lines.join('\n') + '\n';
  }

  function toPrometheusRules(kpis, app){
    const hdr = [
      'groups:',
      '- name: missionsmith.rules',
      '  interval: 30s',
      '  rules:'
    ];
    const rules = [];
    kpis.forEach(k => {
      if(/error_rate/.test(k.key)){
        rules.push(
`  - alert: HighErrorRate
    expr: rate(http_requests_total{service="${app}",status=~"5.."}[5m]) / clamp_min(rate(http_requests_total{service="${app}"}[5m]),1) * 100 > ${k.target||1}
    for: 10m
    labels: { severity: "page" }
    annotations:
      summary: "High error rate on ${app}"
      description: "Error rate > ${k.target||1}% for 10m"`);
      }
      if(/latency|p95/.test(k.key)){
        rules.push(
`  - alert: HighLatencyP95
    expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="${app}"}[5m])) by (le)) * 1000 > ${k.target||300}
    for: 10m
    labels: { severity: "page" }
    annotations:
      summary: "High latency p95 on ${app}"
      description: "Latency p95 > ${k.target||300}ms for 10m"`);
      }
    });
    if (rules.length===0){
      rules.push(
`  - alert: ServiceDown
    expr: up{service="${app}"} == 0
    for: 5m
    labels: { severity: "page" }
    annotations:
      summary: "${app} is down"
      description: "No scrape targets reporting for 5m"`);
    }
    return hdr.concat(rules).join('\n') + '\n';
  }

  function toGrafanaDashboard(kpis, app){
    // Minimal Grafana JSON model (v5+ export-ish, not strict; user can import and tweak).
    const dash = {
      annotations: { list: [{builtIn:1, datasource:'-- Grafana --', enable:true, hide:true, iconColor:'rgba(0, 211, 255, 1)', name:'Annotations & Alerts', type:'dashboard'}]},
      editable: true,
      graphTooltip: 0,
      panels: [],
      schemaVersion: 25,
      style: 'dark',
      tags: ['missionsmith','starter'],
      templating: { list: [{name: 'service', type: 'query', query: `label_values(up, service)`, label: 'Service', current: {text: app, value: app}}]},
      time: { from: 'now-6h', to: 'now' },
      timepicker: {},
      timezone: '',
      title: `${app} | MissionSmith Analytics`,
      version: 1
    };

    let id = 1; let y=0;
    function panelFor(key, title, expr){
      const p = {
        id: id++,
        gridPos: {h:8, w:12, x: (id%2?0:12), y: y + (id%2?0:8)},
        type: 'timeseries',
        title: `${title}`,
        targets: [{expr, refId:'A'}]
      };
      return p;
    }

    // Basic panels
    dash.panels.push(panelFor('rps', 'Throughput (RPS)', `sum(rate(http_requests_total{service="$service"}[1m]))`));
    dash.panels.push(panelFor('latency_p95', 'Latency p95 (ms)', `histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="$service"}[5m])) by (le)) * 1000`));
    dash.panels.push(panelFor('error_rate', 'Error Rate (%)', `sum(rate(http_requests_total{service="$service",status=~"5.."}[5m])) / clamp_min(sum(rate(http_requests_total{service="$service"}[5m])),1) * 100`));

    // KPI panels
    kpis.forEach(k => {
      if (/latency|p95/.test(k.key) || /error_rate/.test(k.key) || /throughput|rps/.test(k.key)) return;
      // Put generic counter panels â€” user can edit later
      dash.panels.push(panelFor(k.key, k.name, `sum(missionsmith_${k.key}{service="$service"})`));
    });

    return JSON.stringify(dash, null, 2);
  }

  function toDBTScaffold(app){
    return `# dbt project for MissionSmith
name: 'missionsmith_${app}'
version: '1.0'
config-version: 2

profile: 'default'

models:
  missionsmith_${app}:
    +materialized: view
`;
  }

  function toDBTModelSQL(kpis){
    const lines = [];
    lines.push('-- Example KPI model (replace with your warehouse SQL)');
    lines.push('with events as (');
    lines.push('  select * from source(\'app\', \'events\')');
    lines.push(')');
    lines.push('select');
    kpis.forEach((k,i)=>{
      const comma = (i<kpis.length-1)?',':'';
      lines.push(`  /* ${k.name} */ null as ${k.key}${comma}`);
    });
    lines.push('from events');
    lines.push('limit 1');
    return lines.join('\n') + '\n';
  }

  if (window.MS_actions){
    const orig = window.MS_actions;
    orig.generateAnalytics = function(){
      try{
        const data = (typeof window.__ms_getData === 'function' ? window.__ms_getData() : window.__ms_data) || {};
        const sc = data?.serviceConfig || {};
        const app = (sc.default_service_name || 'app').toString().trim();
        const kpis = extractKPIs(data);

        const files = [
          { path: 'analytics/metrics-catalog.yaml', content: toMetricsCatalog(kpis) },
          { path: 'analytics/prometheus-rules.yaml', content: toPrometheusRules(kpis, app) },
          { path: 'analytics/grafana-dashboard.json', content: toGrafanaDashboard(kpis, app) },
          { path: 'analytics/dbt/project.yml', content: toDBTScaffold(app) },
          { path: 'analytics/dbt/models/kpis.sql', content: toDBTModelSQL(kpis) },
          { path: 'analytics/README-ANALYTICS.md', content:
`# MissionSmith Analytics Bundle

This starter pack gives you:
- **metrics-catalog.yaml** â€” canonical KPI list (keys, units, targets, ownership).
- **prometheus-rules.yaml** â€” alert rules keyed off latency, error rate, and common KPIs.
- **grafana-dashboard.json** â€” importable dashboard with RPS, p95 latency, error %, and KPI panels.
- **dbt/** â€” a minimal scaffold to materialize KPI views in your warehouse.

## Next steps
1. Import \`grafana-dashboard.json\` into Grafana; set Prometheus as the data source.
2. Load \`prometheus-rules.yaml\` into your Prometheus/Alertmanager setup.
3. Store your KPI definitions in \`metrics-catalog.yaml\` and keep them versioned with code.
4. Point \`dbt/models/kpis.sql\` at your real warehouse schema and build with \`dbt build\`.

> KPIs were inferred from your MissionSmith data (nfr.slo / nfr.kpis / analytics.kpis / objectives). Edit this bundle as needed.
`}
        ];

        const chunks = ['# --- BEGIN MISSIONSMITH ANALYTICS BUNDLE ---'];
        files.forEach(f => chunks.push(`\n# FILE: ${f.path}\n\n${f.content}`));
        const blob = new Blob([chunks.join('\n')], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'mission-analytics-bundle.txt';
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 200);

        alert('âœ… Analytics bundle generated: metrics catalog, Prometheus rules, Grafana dashboard, dbt scaffold.');
      }catch(e){
        console.error('generateAnalytics failed', e);
        alert('Failed to generate analytics bundle.');
      }
    };
    window.MS_actions = orig;
  }
})();
</script>

</body>
</html>


===== FILE: app_backend\models.py =====
from sqlalchemy import Column, Integer, String, Text, UniqueConstraint
from .db import Base


class SourceRecord(Base):
    """
    Raw upstream record from a given system for a given client_id.

    These rows replace the hard-coded _mock_crm_source/_mock_kyc_source
    in ClientProfileService. We load them, decode the JSON payloads,
    and pass them into assemble_base_profile.
    """
    __tablename__ = "source_records"

    id = Column(Integer, primary_key=True, index=True)
    client_id = Column(String, index=True, nullable=False)
    system = Column(String, index=True, nullable=False)  # e.g. "CRM", "KYC"
    payload_json = Column(Text, nullable=False)          # JSON-encoded dict

    __table_args__ = (
        UniqueConstraint("client_id", "system", name="uq_client_system"),
    )


===== FILE: app_backend\requirements.txt =====
fastapi
uvicorn
sqlalchemy
pydantic
requests


===== FILE: app_backend\schemas.py =====
from typing import Any, Dict, Optional
from pydantic import BaseModel


class SourceRecordCreate(BaseModel):
    client_id: str
    system: str                   # "CRM", "KYC", "MDM", etc.
    payload: Dict[str, Any]       # raw record from that system


class SourceRecordRead(BaseModel):
    id: int
    client_id: str
    system: str
    payload: Dict[str, Any]

    class Config:
        orm_mode = True


===== FILE: app_frontend\eslint.config.js =====
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])


===== FILE: app_frontend\index.html =====
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- <link rel="icon" type="image/svg+xml" href="/vite.svg" /> -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SCV Frontend</title>

    <!-- MissionHalo fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;500;700&family=Raleway:wght@500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Fjalla One for MissionSmith / MissionAtlas / MissionLog -->
    <link
      href="https://fonts.googleapis.com/css2?family=Fjalla+One&display=swap"
      rel="stylesheet"
    />
  </head>

  <body class="bg-gray-100">
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>



===== FILE: app_frontend\package.json =====
{
  "name": "app_frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^19.2.0",
    "react-dom": "^19.2.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@tailwindcss/postcss": "^4.1.17",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.22",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.17",
    "vite": "^7.2.4"
  }
}


===== FILE: app_frontend\package-lock.json =====
{
  "name": "app_frontend",
  "version": "0.0.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "app_frontend",
      "version": "0.0.0",
      "dependencies": {
        "react": "^19.2.0",
        "react-dom": "^19.2.0"
      },
      "devDependencies": {
        "@eslint/js": "^9.39.1",
        "@tailwindcss/postcss": "^4.1.17",
        "@types/react": "^19.2.5",
        "@types/react-dom": "^19.2.3",
        "@vitejs/plugin-react": "^5.1.1",
        "autoprefixer": "^10.4.22",
        "eslint": "^9.39.1",
        "eslint-plugin-react-hooks": "^7.0.1",
        "eslint-plugin-react-refresh": "^0.4.24",
        "globals": "^16.5.0",
        "postcss": "^8.5.6",
        "tailwindcss": "^4.1.17",
        "vite": "^7.2.4"
      }
    },
    "node_modules/@alloc/quick-lru": {
      "version": "5.2.0",
      "resolved": "https://registry.npmjs.org/@alloc/quick-lru/-/quick-lru-5.2.0.tgz",
      "integrity": "sha512-UrcABB+4bUrFABwbluTIBErXwvbsU/V7TZWfmbgJfbkwiBuziS9gxdODUyuiecfdGQ85jglMW6juS3+z5TsKLw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/@babel/code-frame": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/code-frame/-/code-frame-7.27.1.tgz",
      "integrity": "sha512-cjQ7ZlQ0Mv3b47hABuTevyTuYN4i+loJKGeV9flcCgIK37cCXRh+L1bd3iBHlynerhQ7BhCkn2BPbQUL+rGqFg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-validator-identifier": "^7.27.1",
        "js-tokens": "^4.0.0",
        "picocolors": "^1.1.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/compat-data": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/compat-data/-/compat-data-7.28.5.tgz",
      "integrity": "sha512-6uFXyCayocRbqhZOB+6XcuZbkMNimwfVGFji8CTZnCzOHVGvDqzvitu1re2AU5LROliz7eQPhB8CpAMvnx9EjA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/core": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.28.5.tgz",
      "integrity": "sha512-e7jT4DxYvIDLk1ZHmU/m/mB19rex9sv0c2ftBtjSBv+kVM/902eh0fINUzD7UwLLNR+jU585GxUJ8/EBfAM5fw==",
      "dev": true,
      "license": "MIT",
      "peer": true,
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/generator": "^7.28.5",
        "@babel/helper-compilation-targets": "^7.27.2",
        "@babel/helper-module-transforms": "^7.28.3",
        "@babel/helpers": "^7.28.4",
        "@babel/parser": "^7.28.5",
        "@babel/template": "^7.27.2",
        "@babel/traverse": "^7.28.5",
        "@babel/types": "^7.28.5",
        "@jridgewell/remapping": "^2.3.5",
        "convert-source-map": "^2.0.0",
        "debug": "^4.1.0",
        "gensync": "^1.0.0-beta.2",
        "json5": "^2.2.3",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/babel"
      }
    },
    "node_modules/@babel/generator": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.28.5.tgz",
      "integrity": "sha512-3EwLFhZ38J4VyIP6WNtt2kUdW9dokXA9Cr4IVIFHuCpZ3H8/YFOl5JjZHisrn1fATPBmKKqXzDFvh9fUwHz6CQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.28.5",
        "@babel/types": "^7.28.5",
        "@jridgewell/gen-mapping": "^0.3.12",
        "@jridgewell/trace-mapping": "^0.3.28",
        "jsesc": "^3.0.2"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-compilation-targets": {
      "version": "7.27.2",
      "resolved": "https://registry.npmjs.org/@babel/helper-compilation-targets/-/helper-compilation-targets-7.27.2.tgz",
      "integrity": "sha512-2+1thGUUWWjLTYTHZWK1n8Yga0ijBz1XAhUXcKy81rd5g6yh7hGqMp45v7cadSbEHc9G3OTv45SyneRN3ps4DQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/compat-data": "^7.27.2",
        "@babel/helper-validator-option": "^7.27.1",
        "browserslist": "^4.24.0",
        "lru-cache": "^5.1.1",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-globals": {
      "version": "7.28.0",
      "resolved": "https://registry.npmjs.org/@babel/helper-globals/-/helper-globals-7.28.0.tgz",
      "integrity": "sha512-+W6cISkXFa1jXsDEdYA8HeevQT/FULhxzR99pxphltZcVaugps53THCeiWA8SguxxpSp3gKPiuYfSWopkLQ4hw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-module-imports": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-module-imports/-/helper-module-imports-7.27.1.tgz",
      "integrity": "sha512-0gSFWUPNXNopqtIPQvlD5WgXYI5GY2kP2cCvoT8kczjbfcfuIljTbcWrulD1CIPIX2gt1wghbDy08yE1p+/r3w==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/traverse": "^7.27.1",
        "@babel/types": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-module-transforms": {
      "version": "7.28.3",
      "resolved": "https://registry.npmjs.org/@babel/helper-module-transforms/-/helper-module-transforms-7.28.3.tgz",
      "integrity": "sha512-gytXUbs8k2sXS9PnQptz5o0QnpLL51SwASIORY6XaBKF88nsOT0Zw9szLqlSGQDP/4TljBAD5y98p2U1fqkdsw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-module-imports": "^7.27.1",
        "@babel/helper-validator-identifier": "^7.27.1",
        "@babel/traverse": "^7.28.3"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/helper-plugin-utils": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-plugin-utils/-/helper-plugin-utils-7.27.1.tgz",
      "integrity": "sha512-1gn1Up5YXka3YYAHGKpbideQ5Yjf1tDa9qYcgysz+cNCXukyLl6DjPXhD3VRwSb8c0J9tA4b2+rHEZtc6R0tlw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-string-parser": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-string-parser/-/helper-string-parser-7.27.1.tgz",
      "integrity": "sha512-qMlSxKbpRlAridDExk92nSobyDdpPijUq2DW6oDnUqd0iOGxmQjyqhMIihI9+zv4LPyZdRje2cavWPbCbWm3eA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-identifier": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.28.5.tgz",
      "integrity": "sha512-qSs4ifwzKJSV39ucNjsvc6WVHs6b7S03sOh2OcHF9UHfVPqWWALUsNUVzhSBiItjRZoLHx7nIarVjqKVusUZ1Q==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-option": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-option/-/helper-validator-option-7.27.1.tgz",
      "integrity": "sha512-YvjJow9FxbhFFKDSuFnVCe2WxXk1zWc22fFePVNEaWJEu8IrZVlda6N0uHwzZrUM1il7NC9Mlp4MaJYbYd9JSg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helpers": {
      "version": "7.28.4",
      "resolved": "https://registry.npmjs.org/@babel/helpers/-/helpers-7.28.4.tgz",
      "integrity": "sha512-HFN59MmQXGHVyYadKLVumYsA9dBFun/ldYxipEjzA4196jpLZd8UjEEBLkbEkvfYreDqJhZxYAWFPtrfhNpj4w==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/template": "^7.27.2",
        "@babel/types": "^7.28.4"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/parser": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.28.5.tgz",
      "integrity": "sha512-KKBU1VGYR7ORr3At5HAtUQ+TV3SzRCXmA/8OdDZiLDBIZxVyzXuztPjfLd3BV1PRAQGCMWWSHYhL0F8d5uHBDQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.28.5"
      },
      "bin": {
        "parser": "bin/babel-parser.js"
      },
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@babel/plugin-transform-react-jsx-self": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-self/-/plugin-transform-react-jsx-self-7.27.1.tgz",
      "integrity": "sha512-6UzkCs+ejGdZ5mFFC/OCUrv028ab2fp1znZmCZjAOBKiBK2jXD1O+BPSfX8X2qjJ75fZBMSnQn3Rq2mrBJK2mw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-transform-react-jsx-source": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-source/-/plugin-transform-react-jsx-source-7.27.1.tgz",
      "integrity": "sha512-zbwoTsBruTeKB9hSq73ha66iFeJHuaFkUbwvqElnygoNbj/jHRsSeokowZFN3CZ64IvEqcmmkVe89OPXc7ldAw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/template": {
      "version": "7.27.2",
      "resolved": "https://registry.npmjs.org/@babel/template/-/template-7.27.2.tgz",
      "integrity": "sha512-LPDZ85aEJyYSd18/DkjNh4/y1ntkE5KwUHWTiqgRxruuZL2F1yuHligVHLvcHY2vMHXttKFpJn6LwfI7cw7ODw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/parser": "^7.27.2",
        "@babel/types": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/traverse": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/traverse/-/traverse-7.28.5.tgz",
      "integrity": "sha512-TCCj4t55U90khlYkVV/0TfkJkAkUg3jZFA3Neb7unZT8CPok7iiRfaX0F+WnqWqt7OxhOn0uBKXCw4lbL8W0aQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/generator": "^7.28.5",
        "@babel/helper-globals": "^7.28.0",
        "@babel/parser": "^7.28.5",
        "@babel/template": "^7.27.2",
        "@babel/types": "^7.28.5",
        "debug": "^4.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/types": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.28.5.tgz",
      "integrity": "sha512-qQ5m48eI/MFLQ5PxQj4PFaprjyCTLI37ElWMmNs0K8Lk3dVeOdNpB3ks8jc7yM5CDmVC73eMVk/trk3fgmrUpA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-string-parser": "^7.27.1",
        "@babel/helper-validator-identifier": "^7.28.5"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@esbuild/aix-ppc64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.25.12.tgz",
      "integrity": "sha512-Hhmwd6CInZ3dwpuGTF8fJG6yoWmsToE+vYgD4nytZVxcu1ulHpUQRAB1UJ8+N1Am3Mz4+xOByoQoSZf4D+CpkA==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "aix"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/android-arm": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.25.12.tgz",
      "integrity": "sha512-VJ+sKvNA/GE7Ccacc9Cha7bpS8nyzVv0jdVgwNDaR4gDMC/2TTRc33Ip8qrNYUcpkOHUT5OZ0bUcNNVZQ9RLlg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/android-arm64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.25.12.tgz",
      "integrity": "sha512-6AAmLG7zwD1Z159jCKPvAxZd4y/VTO0VkprYy+3N2FtJ8+BQWFXU+OxARIwA46c5tdD9SsKGZ/1ocqBS/gAKHg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/android-x64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.25.12.tgz",
      "integrity": "sha512-5jbb+2hhDHx5phYR2By8GTWEzn6I9UqR11Kwf22iKbNpYrsmRB18aX/9ivc5cabcUiAT/wM+YIZ6SG9QO6a8kg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/darwin-arm64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.25.12.tgz",
      "integrity": "sha512-N3zl+lxHCifgIlcMUP5016ESkeQjLj/959RxxNYIthIg+CQHInujFuXeWbWMgnTo4cp5XVHqFPmpyu9J65C1Yg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/darwin-x64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.25.12.tgz",
      "integrity": "sha512-HQ9ka4Kx21qHXwtlTUVbKJOAnmG1ipXhdWTmNXiPzPfWKpXqASVcWdnf2bnL73wgjNrFXAa3yYvBSd9pzfEIpA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/freebsd-arm64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.25.12.tgz",
      "integrity": "sha512-gA0Bx759+7Jve03K1S0vkOu5Lg/85dou3EseOGUes8flVOGxbhDDh/iZaoek11Y8mtyKPGF3vP8XhnkDEAmzeg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/freebsd-x64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.25.12.tgz",
      "integrity": "sha512-TGbO26Yw2xsHzxtbVFGEXBFH0FRAP7gtcPE7P5yP7wGy7cXK2oO7RyOhL5NLiqTlBh47XhmIUXuGciXEqYFfBQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-arm": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.25.12.tgz",
      "integrity": "sha512-lPDGyC1JPDou8kGcywY0YILzWlhhnRjdof3UlcoqYmS9El818LLfJJc3PXXgZHrHCAKs/Z2SeZtDJr5MrkxtOw==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-arm64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.25.12.tgz",
      "integrity": "sha512-8bwX7a8FghIgrupcxb4aUmYDLp8pX06rGh5HqDT7bB+8Rdells6mHvrFHHW2JAOPZUbnjUpKTLg6ECyzvas2AQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-ia32": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.25.12.tgz",
      "integrity": "sha512-0y9KrdVnbMM2/vG8KfU0byhUN+EFCny9+8g202gYqSSVMonbsCfLjUO+rCci7pM0WBEtz+oK/PIwHkzxkyharA==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-loong64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.25.12.tgz",
      "integrity": "sha512-h///Lr5a9rib/v1GGqXVGzjL4TMvVTv+s1DPoxQdz7l/AYv6LDSxdIwzxkrPW438oUXiDtwM10o9PmwS/6Z0Ng==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-mips64el": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.25.12.tgz",
      "integrity": "sha512-iyRrM1Pzy9GFMDLsXn1iHUm18nhKnNMWscjmp4+hpafcZjrr2WbT//d20xaGljXDBYHqRcl8HnxbX6uaA/eGVw==",
      "cpu": [
        "mips64el"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-ppc64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.25.12.tgz",
      "integrity": "sha512-9meM/lRXxMi5PSUqEXRCtVjEZBGwB7P/D4yT8UG/mwIdze2aV4Vo6U5gD3+RsoHXKkHCfSxZKzmDssVlRj1QQA==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-riscv64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.25.12.tgz",
      "integrity": "sha512-Zr7KR4hgKUpWAwb1f3o5ygT04MzqVrGEGXGLnj15YQDJErYu/BGg+wmFlIDOdJp0PmB0lLvxFIOXZgFRrdjR0w==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-s390x": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.25.12.tgz",
      "integrity": "sha512-MsKncOcgTNvdtiISc/jZs/Zf8d0cl/t3gYWX8J9ubBnVOwlk65UIEEvgBORTiljloIWnBzLs4qhzPkJcitIzIg==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-x64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.25.12.tgz",
      "integrity": "sha512-uqZMTLr/zR/ed4jIGnwSLkaHmPjOjJvnm6TVVitAa08SLS9Z0VM8wIRx7gWbJB5/J54YuIMInDquWyYvQLZkgw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/netbsd-arm64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-arm64/-/netbsd-arm64-0.25.12.tgz",
      "integrity": "sha512-xXwcTq4GhRM7J9A8Gv5boanHhRa/Q9KLVmcyXHCTaM4wKfIpWkdXiMog/KsnxzJ0A1+nD+zoecuzqPmCRyBGjg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "netbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/netbsd-x64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.25.12.tgz",
      "integrity": "sha512-Ld5pTlzPy3YwGec4OuHh1aCVCRvOXdH8DgRjfDy/oumVovmuSzWfnSJg+VtakB9Cm0gxNO9BzWkj6mtO1FMXkQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "netbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/openbsd-arm64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-arm64/-/openbsd-arm64-0.25.12.tgz",
      "integrity": "sha512-fF96T6KsBo/pkQI950FARU9apGNTSlZGsv1jZBAlcLL1MLjLNIWPBkj5NlSz8aAzYKg+eNqknrUJ24QBybeR5A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/openbsd-x64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.25.12.tgz",
      "integrity": "sha512-MZyXUkZHjQxUvzK7rN8DJ3SRmrVrke8ZyRusHlP+kuwqTcfWLyqMOE3sScPPyeIXN/mDJIfGXvcMqCgYKekoQw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/openharmony-arm64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/openharmony-arm64/-/openharmony-arm64-0.25.12.tgz",
      "integrity": "sha512-rm0YWsqUSRrjncSXGA7Zv78Nbnw4XL6/dzr20cyrQf7ZmRcsovpcRBdhD43Nuk3y7XIoW2OxMVvwuRvk9XdASg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openharmony"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/sunos-x64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.25.12.tgz",
      "integrity": "sha512-3wGSCDyuTHQUzt0nV7bocDy72r2lI33QL3gkDNGkod22EsYl04sMf0qLb8luNKTOmgF/eDEDP5BFNwoBKH441w==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "sunos"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/win32-arm64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.25.12.tgz",
      "integrity": "sha512-rMmLrur64A7+DKlnSuwqUdRKyd3UE7oPJZmnljqEptesKM8wx9J8gx5u0+9Pq0fQQW8vqeKebwNXdfOyP+8Bsg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/win32-ia32": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.25.12.tgz",
      "integrity": "sha512-HkqnmmBoCbCwxUKKNPBixiWDGCpQGVsrQfJoVGYLPT41XWF8lHuE5N6WhVia2n4o5QK5M4tYr21827fNhi4byQ==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@eslint-community/eslint-utils": {
      "version": "4.9.0",
      "resolved": "https://registry.npmjs.org/@eslint-community/eslint-utils/-/eslint-utils-4.9.0.tgz",
      "integrity": "sha512-ayVFHdtZ+hsq1t2Dy24wCmGXGe4q9Gu3smhLYALJrr473ZH27MsnSL+LKUlimp4BWJqMDMLmPpx/Q9R3OAlL4g==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "eslint-visitor-keys": "^3.4.3"
      },
      "engines": {
        "node": "^12.22.0 || ^14.17.0 || >=16.0.0"
      },
      "funding": {
        "url": "https://opencollective.com/eslint"
      },
      "peerDependencies": {
        "eslint": "^6.0.0 || ^7.0.0 || >=8.0.0"
      }
    },
    "node_modules/@eslint-community/eslint-utils/node_modules/eslint-visitor-keys": {
      "version": "3.4.3",
      "resolved": "https://registry.npmjs.org/eslint-visitor-keys/-/eslint-visitor-keys-3.4.3.tgz",
      "integrity": "sha512-wpc+LXeiyiisxPlEkUzU6svyS1frIO3Mgxj1fdy7Pm8Ygzguax2N3Fa/D/ag1WqbOprdI+uY6wMUl8/a2G+iag==",
      "dev": true,
      "license": "Apache-2.0",
      "engines": {
        "node": "^12.22.0 || ^14.17.0 || >=16.0.0"
      },
      "funding": {
        "url": "https://opencollective.com/eslint"
      }
    },
    "node_modules/@eslint-community/regexpp": {
      "version": "4.12.2",
      "resolved": "https://registry.npmjs.org/@eslint-community/regexpp/-/regexpp-4.12.2.tgz",
      "integrity": "sha512-EriSTlt5OC9/7SXkRSCAhfSxxoSUgBm33OH+IkwbdpgoqsSsUg7y3uh+IICI/Qg4BBWr3U2i39RpmycbxMq4ew==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": "^12.0.0 || ^14.0.0 || >=16.0.0"
      }
    },
    "node_modules/@eslint/config-array": {
      "version": "0.21.1",
      "resolved": "https://registry.npmjs.org/@eslint/config-array/-/config-array-0.21.1.tgz",
      "integrity": "sha512-aw1gNayWpdI/jSYVgzN5pL0cfzU02GT3NBpeT/DXbx1/1x7ZKxFPd9bwrzygx/qiwIQiJ1sw/zD8qY/kRvlGHA==",
      "dev": true,
      "license": "Apache-2.0",
      "dependencies": {
        "@eslint/object-schema": "^2.1.7",
        "debug": "^4.3.1",
        "minimatch": "^3.1.2"
      },
      "engines": {
        "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
      }
    },
    "node_modules/@eslint/config-helpers": {
      "version": "0.4.2",
      "resolved": "https://registry.npmjs.org/@eslint/config-helpers/-/config-helpers-0.4.2.tgz",
      "integrity": "sha512-gBrxN88gOIf3R7ja5K9slwNayVcZgK6SOUORm2uBzTeIEfeVaIhOpCtTox3P6R7o2jLFwLFTLnC7kU/RGcYEgw==",
      "dev": true,
      "license": "Apache-2.0",
      "dependencies": {
        "@eslint/core": "^0.17.0"
      },
      "engines": {
        "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
      }
    },
    "node_modules/@eslint/core": {
      "version": "0.17.0",
      "resolved": "https://registry.npmjs.org/@eslint/core/-/core-0.17.0.tgz",
      "integrity": "sha512-yL/sLrpmtDaFEiUj1osRP4TI2MDz1AddJL+jZ7KSqvBuliN4xqYY54IfdN8qD8Toa6g1iloph1fxQNkjOxrrpQ==",
      "dev": true,
      "license": "Apache-2.0",
      "dependencies": {
        "@types/json-schema": "^7.0.15"
      },
      "engines": {
        "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
      }
    },
    "node_modules/@eslint/eslintrc": {
      "version": "3.3.3",
      "resolved": "https://registry.npmjs.org/@eslint/eslintrc/-/eslintrc-3.3.3.tgz",
      "integrity": "sha512-Kr+LPIUVKz2qkx1HAMH8q1q6azbqBAsXJUxBl/ODDuVPX45Z9DfwB8tPjTi6nNZ8BuM3nbJxC5zCAg5elnBUTQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "ajv": "^6.12.4",
        "debug": "^4.3.2",
        "espree": "^10.0.1",
        "globals": "^14.0.0",
        "ignore": "^5.2.0",
        "import-fresh": "^3.2.1",
        "js-yaml": "^4.1.1",
        "minimatch": "^3.1.2",
        "strip-json-comments": "^3.1.1"
      },
      "engines": {
        "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
      },
      "funding": {
        "url": "https://opencollective.com/eslint"
      }
    },
    "node_modules/@eslint/eslintrc/node_modules/globals": {
      "version": "14.0.0",
      "resolved": "https://registry.npmjs.org/globals/-/globals-14.0.0.tgz",
      "integrity": "sha512-oahGvuMGQlPw/ivIYBjVSrWAfWLBeku5tpPE2fOPLi+WHffIWbuh2tCjhyQhTBPMf5E9jDEH4FOmTYgYwbKwtQ==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/@eslint/js": {
      "version": "9.39.1",
      "resolved": "https://registry.npmjs.org/@eslint/js/-/js-9.39.1.tgz",
      "integrity": "sha512-S26Stp4zCy88tH94QbBv3XCuzRQiZ9yXofEILmglYTh/Ug/a9/umqvgFtYBAo3Lp0nsI/5/qH1CCrbdK3AP1Tw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
      },
      "funding": {
        "url": "https://eslint.org/donate"
      }
    },
    "node_modules/@eslint/object-schema": {
      "version": "2.1.7",
      "resolved": "https://registry.npmjs.org/@eslint/object-schema/-/object-schema-2.1.7.tgz",
      "integrity": "sha512-VtAOaymWVfZcmZbp6E2mympDIHvyjXs/12LqWYjVw6qjrfF+VK+fyG33kChz3nnK+SU5/NeHOqrTEHS8sXO3OA==",
      "dev": true,
      "license": "Apache-2.0",
      "engines": {
        "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
      }
    },
    "node_modules/@eslint/plugin-kit": {
      "version": "0.4.1",
      "resolved": "https://registry.npmjs.org/@eslint/plugin-kit/-/plugin-kit-0.4.1.tgz",
      "integrity": "sha512-43/qtrDUokr7LJqoF2c3+RInu/t4zfrpYdoSDfYyhg52rwLV6TnOvdG4fXm7IkSB3wErkcmJS9iEhjVtOSEjjA==",
      "dev": true,
      "license": "Apache-2.0",
      "dependencies": {
        "@eslint/core": "^0.17.0",
        "levn": "^0.4.1"
      },
      "engines": {
        "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
      }
    },
    "node_modules/@humanfs/core": {
      "version": "0.19.1",
      "resolved": "https://registry.npmjs.org/@humanfs/core/-/core-0.19.1.tgz",
      "integrity": "sha512-5DyQ4+1JEUzejeK1JGICcideyfUbGixgS9jNgex5nqkW+cY7WZhxBigmieN5Qnw9ZosSNVC9KQKyb+GUaGyKUA==",
      "dev": true,
      "license": "Apache-2.0",
      "engines": {
        "node": ">=18.18.0"
      }
    },
    "node_modules/@humanfs/node": {
      "version": "0.16.7",
      "resolved": "https://registry.npmjs.org/@humanfs/node/-/node-0.16.7.tgz",
      "integrity": "sha512-/zUx+yOsIrG4Y43Eh2peDeKCxlRt/gET6aHfaKpuq267qXdYDFViVHfMaLyygZOnl0kGWxFIgsBy8QFuTLUXEQ==",
      "dev": true,
      "license": "Apache-2.0",
      "dependencies": {
        "@humanfs/core": "^0.19.1",
        "@humanwhocodes/retry": "^0.4.0"
      },
      "engines": {
        "node": ">=18.18.0"
      }
    },
    "node_modules/@humanwhocodes/module-importer": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/@humanwhocodes/module-importer/-/module-importer-1.0.1.tgz",
      "integrity": "sha512-bxveV4V8v5Yb4ncFTT3rPSgZBOpCkjfK0y4oVVVJwIuDVBRMDXrPyXRL988i5ap9m9bnyEEjWfm5WkBmtffLfA==",
      "dev": true,
      "license": "Apache-2.0",
      "engines": {
        "node": ">=12.22"
      },
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/nzakas"
      }
    },
    "node_modules/@humanwhocodes/retry": {
      "version": "0.4.3",
      "resolved": "https://registry.npmjs.org/@humanwhocodes/retry/-/retry-0.4.3.tgz",
      "integrity": "sha512-bV0Tgo9K4hfPCek+aMAn81RppFKv2ySDQeMoSZuvTASywNTnVJCArCZE2FWqpvIatKu7VMRLWlR1EazvVhDyhQ==",
      "dev": true,
      "license": "Apache-2.0",
      "engines": {
        "node": ">=18.18"
      },
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/nzakas"
      }
    },
    "node_modules/@jridgewell/gen-mapping": {
      "version": "0.3.13",
      "resolved": "https://registry.npmjs.org/@jridgewell/gen-mapping/-/gen-mapping-0.3.13.tgz",
      "integrity": "sha512-2kkt/7niJ6MgEPxF0bYdQ6etZaA+fQvDcLKckhy1yIQOzaoKjBBjSj63/aLVjYE3qhRt5dvM+uUyfCg6UKCBbA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@jridgewell/sourcemap-codec": "^1.5.0",
        "@jridgewell/trace-mapping": "^0.3.24"
      }
    },
    "node_modules/@jridgewell/remapping": {
      "version": "2.3.5",
      "resolved": "https://registry.npmjs.org/@jridgewell/remapping/-/remapping-2.3.5.tgz",
      "integrity": "sha512-LI9u/+laYG4Ds1TDKSJW2YPrIlcVYOwi2fUC6xB43lueCjgxV4lffOCZCtYFiH6TNOX+tQKXx97T4IKHbhyHEQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@jridgewell/gen-mapping": "^0.3.5",
        "@jridgewell/trace-mapping": "^0.3.24"
      }
    },
    "node_modules/@jridgewell/resolve-uri": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/@jridgewell/resolve-uri/-/resolve-uri-3.1.2.tgz",
      "integrity": "sha512-bRISgCIjP20/tbWSPWMEi54QVPRZExkuD9lJL+UIxUKtwVJA8wW1Trb1jMs1RFXo1CBTNZ/5hpC9QvmKWdopKw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@jridgewell/sourcemap-codec": {
      "version": "1.5.5",
      "resolved": "https://registry.npmjs.org/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.5.5.tgz",
      "integrity": "sha512-cYQ9310grqxueWbl+WuIUIaiUaDcj7WOq5fVhEljNVgRfOUhY9fy2zTvfoqWsnebh8Sl70VScFbICvJnLKB0Og==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@jridgewell/trace-mapping": {
      "version": "0.3.31",
      "resolved": "https://registry.npmjs.org/@jridgewell/trace-mapping/-/trace-mapping-0.3.31.tgz",
      "integrity": "sha512-zzNR+SdQSDJzc8joaeP8QQoCQr8NuYx2dIIytl1QeBEZHJ9uW6hebsrYgbz8hJwUQao3TWCMtmfV8Nu1twOLAw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@jridgewell/resolve-uri": "^3.1.0",
        "@jridgewell/sourcemap-codec": "^1.4.14"
      }
    },
    "node_modules/@rolldown/pluginutils": {
      "version": "1.0.0-beta.47",
      "resolved": "https://registry.npmjs.org/@rolldown/pluginutils/-/pluginutils-1.0.0-beta.47.tgz",
      "integrity": "sha512-8QagwMH3kNCuzD8EWL8R2YPW5e4OrHNSAHRFDdmFqEwEaD/KcNKjVoumo+gP2vW5eKB2UPbM6vTYiGZX0ixLnw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@rollup/rollup-android-arm-eabi": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.53.3.tgz",
      "integrity": "sha512-mRSi+4cBjrRLoaal2PnqH82Wqyb+d3HsPUN/W+WslCXsZsyHa9ZeQQX/pQsZaVIWDkPcpV6jJ+3KLbTbgnwv8w==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-android-arm64": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm64/-/rollup-android-arm64-4.53.3.tgz",
      "integrity": "sha512-CbDGaMpdE9sh7sCmTrTUyllhrg65t6SwhjlMJsLr+J8YjFuPmCEjbBSx4Z/e4SmDyH3aB5hGaJUP2ltV/vcs4w==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-darwin-arm64": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-arm64/-/rollup-darwin-arm64-4.53.3.tgz",
      "integrity": "sha512-Nr7SlQeqIBpOV6BHHGZgYBuSdanCXuw09hon14MGOLGmXAFYjx1wNvquVPmpZnl0tLjg25dEdr4IQ6GgyToCUA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-darwin-x64": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-x64/-/rollup-darwin-x64-4.53.3.tgz",
      "integrity": "sha512-DZ8N4CSNfl965CmPktJ8oBnfYr3F8dTTNBQkRlffnUarJ2ohudQD17sZBa097J8xhQ26AwhHJ5mvUyQW8ddTsQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-arm64": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-arm64/-/rollup-freebsd-arm64-4.53.3.tgz",
      "integrity": "sha512-yMTrCrK92aGyi7GuDNtGn2sNW+Gdb4vErx4t3Gv/Tr+1zRb8ax4z8GWVRfr3Jw8zJWvpGHNpss3vVlbF58DZ4w==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-x64": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-x64/-/rollup-freebsd-x64-4.53.3.tgz",
      "integrity": "sha512-lMfF8X7QhdQzseM6XaX0vbno2m3hlyZFhwcndRMw8fbAGUGL3WFMBdK0hbUBIUYcEcMhVLr1SIamDeuLBnXS+Q==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-gnueabihf": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-gnueabihf/-/rollup-linux-arm-gnueabihf-4.53.3.tgz",
      "integrity": "sha512-k9oD15soC/Ln6d2Wv/JOFPzZXIAIFLp6B+i14KhxAfnq76ajt0EhYc5YPeX6W1xJkAdItcVT+JhKl1QZh44/qw==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-musleabihf": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-musleabihf/-/rollup-linux-arm-musleabihf-4.53.3.tgz",
      "integrity": "sha512-vTNlKq+N6CK/8UktsrFuc+/7NlEYVxgaEgRXVUVK258Z5ymho29skzW1sutgYjqNnquGwVUObAaxae8rZ6YMhg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-gnu": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-gnu/-/rollup-linux-arm64-gnu-4.53.3.tgz",
      "integrity": "sha512-RGrFLWgMhSxRs/EWJMIFM1O5Mzuz3Xy3/mnxJp/5cVhZ2XoCAxJnmNsEyeMJtpK+wu0FJFWz+QF4mjCA7AUQ3w==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-musl": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-musl/-/rollup-linux-arm64-musl-4.53.3.tgz",
      "integrity": "sha512-kASyvfBEWYPEwe0Qv4nfu6pNkITLTb32p4yTgzFCocHnJLAHs+9LjUu9ONIhvfT/5lv4YS5muBHyuV84epBo/A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-loong64-gnu": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-loong64-gnu/-/rollup-linux-loong64-gnu-4.53.3.tgz",
      "integrity": "sha512-JiuKcp2teLJwQ7vkJ95EwESWkNRFJD7TQgYmCnrPtlu50b4XvT5MOmurWNrCj3IFdyjBQ5p9vnrX4JM6I8OE7g==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-ppc64-gnu": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-ppc64-gnu/-/rollup-linux-ppc64-gnu-4.53.3.tgz",
      "integrity": "sha512-EoGSa8nd6d3T7zLuqdojxC20oBfNT8nexBbB/rkxgKj5T5vhpAQKKnD+h3UkoMuTyXkP5jTjK/ccNRmQrPNDuw==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-gnu": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-gnu/-/rollup-linux-riscv64-gnu-4.53.3.tgz",
      "integrity": "sha512-4s+Wped2IHXHPnAEbIB0YWBv7SDohqxobiiPA1FIWZpX+w9o2i4LezzH/NkFUl8LRci/8udci6cLq+jJQlh+0g==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-musl": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-musl/-/rollup-linux-riscv64-musl-4.53.3.tgz",
      "integrity": "sha512-68k2g7+0vs2u9CxDt5ktXTngsxOQkSEV/xBbwlqYcUrAVh6P9EgMZvFsnHy4SEiUl46Xf0IObWVbMvPrr2gw8A==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-s390x-gnu": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-s390x-gnu/-/rollup-linux-s390x-gnu-4.53.3.tgz",
      "integrity": "sha512-VYsFMpULAz87ZW6BVYw3I6sWesGpsP9OPcyKe8ofdg9LHxSbRMd7zrVrr5xi/3kMZtpWL/wC+UIJWJYVX5uTKg==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-gnu": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-gnu/-/rollup-linux-x64-gnu-4.53.3.tgz",
      "integrity": "sha512-3EhFi1FU6YL8HTUJZ51imGJWEX//ajQPfqWLI3BQq4TlvHy4X0MOr5q3D2Zof/ka0d5FNdPwZXm3Yyib/UEd+w==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-musl": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-musl/-/rollup-linux-x64-musl-4.53.3.tgz",
      "integrity": "sha512-eoROhjcc6HbZCJr+tvVT8X4fW3/5g/WkGvvmwz/88sDtSJzO7r/blvoBDgISDiCjDRZmHpwud7h+6Q9JxFwq1Q==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-openharmony-arm64": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-openharmony-arm64/-/rollup-openharmony-arm64-4.53.3.tgz",
      "integrity": "sha512-OueLAWgrNSPGAdUdIjSWXw+u/02BRTcnfw9PN41D2vq/JSEPnJnVuBgw18VkN8wcd4fjUs+jFHVM4t9+kBSNLw==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openharmony"
      ]
    },
    "node_modules/@rollup/rollup-win32-arm64-msvc": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-arm64-msvc/-/rollup-win32-arm64-msvc-4.53.3.tgz",
      "integrity": "sha512-GOFuKpsxR/whszbF/bzydebLiXIHSgsEUp6M0JI8dWvi+fFa1TD6YQa4aSZHtpmh2/uAlj/Dy+nmby3TJ3pkTw==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-ia32-msvc": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-ia32-msvc/-/rollup-win32-ia32-msvc-4.53.3.tgz",
      "integrity": "sha512-iah+THLcBJdpfZ1TstDFbKNznlzoxa8fmnFYK4V67HvmuNYkVdAywJSoteUszvBQ9/HqN2+9AZghbajMsFT+oA==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-x64-gnu": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-gnu/-/rollup-win32-x64-gnu-4.53.3.tgz",
      "integrity": "sha512-J9QDiOIZlZLdcot5NXEepDkstocktoVjkaKUtqzgzpt2yWjGlbYiKyp05rWwk4nypbYUNoFAztEgixoLaSETkg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@tailwindcss/node": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/node/-/node-4.1.17.tgz",
      "integrity": "sha512-csIkHIgLb3JisEFQ0vxr2Y57GUNYh447C8xzwj89U/8fdW8LhProdxvnVH6U8M2Y73QKiTIH+LWbK3V2BBZsAg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@jridgewell/remapping": "^2.3.4",
        "enhanced-resolve": "^5.18.3",
        "jiti": "^2.6.1",
        "lightningcss": "1.30.2",
        "magic-string": "^0.30.21",
        "source-map-js": "^1.2.1",
        "tailwindcss": "4.1.17"
      }
    },
    "node_modules/@tailwindcss/oxide": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide/-/oxide-4.1.17.tgz",
      "integrity": "sha512-F0F7d01fmkQhsTjXezGBLdrl1KresJTcI3DB8EkScCldyKp3Msz4hub4uyYaVnk88BAS1g5DQjjF6F5qczheLA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">= 10"
      },
      "optionalDependencies": {
        "@tailwindcss/oxide-android-arm64": "4.1.17",
        "@tailwindcss/oxide-darwin-arm64": "4.1.17",
        "@tailwindcss/oxide-darwin-x64": "4.1.17",
        "@tailwindcss/oxide-freebsd-x64": "4.1.17",
        "@tailwindcss/oxide-linux-arm-gnueabihf": "4.1.17",
        "@tailwindcss/oxide-linux-arm64-gnu": "4.1.17",
        "@tailwindcss/oxide-linux-arm64-musl": "4.1.17",
        "@tailwindcss/oxide-linux-x64-gnu": "4.1.17",
        "@tailwindcss/oxide-linux-x64-musl": "4.1.17",
        "@tailwindcss/oxide-wasm32-wasi": "4.1.17",
        "@tailwindcss/oxide-win32-arm64-msvc": "4.1.17",
        "@tailwindcss/oxide-win32-x64-msvc": "4.1.17"
      }
    },
    "node_modules/@tailwindcss/oxide-android-arm64": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-android-arm64/-/oxide-android-arm64-4.1.17.tgz",
      "integrity": "sha512-BMqpkJHgOZ5z78qqiGE6ZIRExyaHyuxjgrJ6eBO5+hfrfGkuya0lYfw8fRHG77gdTjWkNWEEm+qeG2cDMxArLQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-darwin-arm64": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-darwin-arm64/-/oxide-darwin-arm64-4.1.17.tgz",
      "integrity": "sha512-EquyumkQweUBNk1zGEU/wfZo2qkp/nQKRZM8bUYO0J+Lums5+wl2CcG1f9BgAjn/u9pJzdYddHWBiFXJTcxmOg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-darwin-x64": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-darwin-x64/-/oxide-darwin-x64-4.1.17.tgz",
      "integrity": "sha512-gdhEPLzke2Pog8s12oADwYu0IAw04Y2tlmgVzIN0+046ytcgx8uZmCzEg4VcQh+AHKiS7xaL8kGo/QTiNEGRog==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-freebsd-x64": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-freebsd-x64/-/oxide-freebsd-x64-4.1.17.tgz",
      "integrity": "sha512-hxGS81KskMxML9DXsaXT1H0DyA+ZBIbyG/sSAjWNe2EDl7TkPOBI42GBV3u38itzGUOmFfCzk1iAjDXds8Oh0g==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-linux-arm-gnueabihf": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-linux-arm-gnueabihf/-/oxide-linux-arm-gnueabihf-4.1.17.tgz",
      "integrity": "sha512-k7jWk5E3ldAdw0cNglhjSgv501u7yrMf8oeZ0cElhxU6Y2o7f8yqelOp3fhf7evjIS6ujTI3U8pKUXV2I4iXHQ==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-linux-arm64-gnu": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-linux-arm64-gnu/-/oxide-linux-arm64-gnu-4.1.17.tgz",
      "integrity": "sha512-HVDOm/mxK6+TbARwdW17WrgDYEGzmoYayrCgmLEw7FxTPLcp/glBisuyWkFz/jb7ZfiAXAXUACfyItn+nTgsdQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-linux-arm64-musl": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-linux-arm64-musl/-/oxide-linux-arm64-musl-4.1.17.tgz",
      "integrity": "sha512-HvZLfGr42i5anKtIeQzxdkw/wPqIbpeZqe7vd3V9vI3RQxe3xU1fLjss0TjyhxWcBaipk7NYwSrwTwK1hJARMg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-linux-x64-gnu": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-linux-x64-gnu/-/oxide-linux-x64-gnu-4.1.17.tgz",
      "integrity": "sha512-M3XZuORCGB7VPOEDH+nzpJ21XPvK5PyjlkSFkFziNHGLc5d6g3di2McAAblmaSUNl8IOmzYwLx9NsE7bplNkwQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-linux-x64-musl": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-linux-x64-musl/-/oxide-linux-x64-musl-4.1.17.tgz",
      "integrity": "sha512-k7f+pf9eXLEey4pBlw+8dgfJHY4PZ5qOUFDyNf7SI6lHjQ9Zt7+NcscjpwdCEbYi6FI5c2KDTDWyf2iHcCSyyQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-wasm32-wasi": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-wasm32-wasi/-/oxide-wasm32-wasi-4.1.17.tgz",
      "integrity": "sha512-cEytGqSSoy7zK4JRWiTCx43FsKP/zGr0CsuMawhH67ONlH+T79VteQeJQRO/X7L0juEUA8ZyuYikcRBf0vsxhg==",
      "bundleDependencies": [
        "@napi-rs/wasm-runtime",
        "@emnapi/core",
        "@emnapi/runtime",
        "@tybys/wasm-util",
        "@emnapi/wasi-threads",
        "tslib"
      ],
      "cpu": [
        "wasm32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "dependencies": {
        "@emnapi/core": "^1.6.0",
        "@emnapi/runtime": "^1.6.0",
        "@emnapi/wasi-threads": "^1.1.0",
        "@napi-rs/wasm-runtime": "^1.0.7",
        "@tybys/wasm-util": "^0.10.1",
        "tslib": "^2.4.0"
      },
      "engines": {
        "node": ">=14.0.0"
      }
    },
    "node_modules/@tailwindcss/oxide-win32-arm64-msvc": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-win32-arm64-msvc/-/oxide-win32-arm64-msvc-4.1.17.tgz",
      "integrity": "sha512-JU5AHr7gKbZlOGvMdb4722/0aYbU+tN6lv1kONx0JK2cGsh7g148zVWLM0IKR3NeKLv+L90chBVYcJ8uJWbC9A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide/node_modules/@tailwindcss/oxide-win32-x64-msvc": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-win32-x64-msvc/-/oxide-win32-x64-msvc-4.1.17.tgz",
      "integrity": "sha512-SKWM4waLuqx0IH+FMDUw6R66Hu4OuTALFgnleKbqhgGU30DY20NORZMZUKgLRjQXNN2TLzKvh48QXTig4h4bGw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/postcss": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/@tailwindcss/postcss/-/postcss-4.1.17.tgz",
      "integrity": "sha512-+nKl9N9mN5uJ+M7dBOOCzINw94MPstNR/GtIhz1fpZysxL/4a+No64jCBD6CPN+bIHWFx3KWuu8XJRrj/572Dw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@alloc/quick-lru": "^5.2.0",
        "@tailwindcss/node": "4.1.17",
        "@tailwindcss/oxide": "4.1.17",
        "postcss": "^8.4.41",
        "tailwindcss": "4.1.17"
      }
    },
    "node_modules/@types/babel__core": {
      "version": "7.20.5",
      "resolved": "https://registry.npmjs.org/@types/babel__core/-/babel__core-7.20.5.tgz",
      "integrity": "sha512-qoQprZvz5wQFJwMDqeseRXWv3rqMvhgpbXFfVyWhbx9X47POIA6i/+dXefEmZKoAgOaTdaIgNSMqMIU61yRyzA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.20.7",
        "@babel/types": "^7.20.7",
        "@types/babel__generator": "*",
        "@types/babel__template": "*",
        "@types/babel__traverse": "*"
      }
    },
    "node_modules/@types/babel__generator": {
      "version": "7.27.0",
      "resolved": "https://registry.npmjs.org/@types/babel__generator/-/babel__generator-7.27.0.tgz",
      "integrity": "sha512-ufFd2Xi92OAVPYsy+P4n7/U7e68fex0+Ee8gSG9KX7eo084CWiQ4sdxktvdl0bOPupXtVJPY19zk6EwWqUQ8lg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.0.0"
      }
    },
    "node_modules/@types/babel__template": {
      "version": "7.4.4",
      "resolved": "https://registry.npmjs.org/@types/babel__template/-/babel__template-7.4.4.tgz",
      "integrity": "sha512-h/NUaSyG5EyxBIp8YRxo4RMe2/qQgvyowRwVMzhYhBCONbW8PUsg4lkFMrhgZhUe5z3L3MiLDuvyJ/CaPa2A8A==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.1.0",
        "@babel/types": "^7.0.0"
      }
    },
    "node_modules/@types/babel__traverse": {
      "version": "7.28.0",
      "resolved": "https://registry.npmjs.org/@types/babel__traverse/-/babel__traverse-7.28.0.tgz",
      "integrity": "sha512-8PvcXf70gTDZBgt9ptxJ8elBeBjcLOAcOtoO/mPJjtji1+CdGbHgm77om1GrsPxsiE+uXIpNSK64UYaIwQXd4Q==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.28.2"
      }
    },
    "node_modules/@types/estree": {
      "version": "1.0.8",
      "resolved": "https://registry.npmjs.org/@types/estree/-/estree-1.0.8.tgz",
      "integrity": "sha512-dWHzHa2WqEXI/O1E9OjrocMTKJl2mSrEolh1Iomrv6U+JuNwaHXsXx9bLu5gG7BUWFIN0skIQJQ/L1rIex4X6w==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/json-schema": {
      "version": "7.0.15",
      "resolved": "https://registry.npmjs.org/@types/json-schema/-/json-schema-7.0.15.tgz",
      "integrity": "sha512-5+fP8P8MFNC+AyZCDxrB2pkZFPGzqQWUzpSeuuVLvm8VMcorNYavBqoFcxK8bQz4Qsbn4oUEEem4wDLfcysGHA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/react": {
      "version": "19.2.7",
      "resolved": "https://registry.npmjs.org/@types/react/-/react-19.2.7.tgz",
      "integrity": "sha512-MWtvHrGZLFttgeEj28VXHxpmwYbor/ATPYbBfSFZEIRK0ecCFLl2Qo55z52Hss+UV9CRN7trSeq1zbgx7YDWWg==",
      "dev": true,
      "license": "MIT",
      "peer": true,
      "dependencies": {
        "csstype": "^3.2.2"
      }
    },
    "node_modules/@types/react-dom": {
      "version": "19.2.3",
      "resolved": "https://registry.npmjs.org/@types/react-dom/-/react-dom-19.2.3.tgz",
      "integrity": "sha512-jp2L/eY6fn+KgVVQAOqYItbF0VY/YApe5Mz2F0aykSO8gx31bYCZyvSeYxCHKvzHG5eZjc+zyaS5BrBWya2+kQ==",
      "dev": true,
      "license": "MIT",
      "peerDependencies": {
        "@types/react": "^19.2.0"
      }
    },
    "node_modules/@vitejs/plugin-react": {
      "version": "5.1.1",
      "resolved": "https://registry.npmjs.org/@vitejs/plugin-react/-/plugin-react-5.1.1.tgz",
      "integrity": "sha512-WQfkSw0QbQ5aJ2CHYw23ZGkqnRwqKHD/KYsMeTkZzPT4Jcf0DcBxBtwMJxnu6E7oxw5+JC6ZAiePgh28uJ1HBA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/core": "^7.28.5",
        "@babel/plugin-transform-react-jsx-self": "^7.27.1",
        "@babel/plugin-transform-react-jsx-source": "^7.27.1",
        "@rolldown/pluginutils": "1.0.0-beta.47",
        "@types/babel__core": "^7.20.5",
        "react-refresh": "^0.18.0"
      },
      "engines": {
        "node": "^20.19.0 || >=22.12.0"
      },
      "peerDependencies": {
        "vite": "^4.2.0 || ^5.0.0 || ^6.0.0 || ^7.0.0"
      }
    },
    "node_modules/acorn": {
      "version": "8.15.0",
      "resolved": "https://registry.npmjs.org/acorn/-/acorn-8.15.0.tgz",
      "integrity": "sha512-NZyJarBfL7nWwIq+FDL6Zp/yHEhePMNnnJ0y3qfieCrmNvYct8uvtiV41UvlSe6apAfk0fY1FbWx+NwfmpvtTg==",
      "dev": true,
      "license": "MIT",
      "peer": true,
      "bin": {
        "acorn": "bin/acorn"
      },
      "engines": {
        "node": ">=0.4.0"
      }
    },
    "node_modules/acorn-jsx": {
      "version": "5.3.2",
      "resolved": "https://registry.npmjs.org/acorn-jsx/-/acorn-jsx-5.3.2.tgz",
      "integrity": "sha512-rq9s+JNhf0IChjtDXxllJ7g41oZk5SlXtp0LHwyA5cejwn7vKmKp4pPri6YEePv2PU65sAsegbXtIinmDFDXgQ==",
      "dev": true,
      "license": "MIT",
      "peerDependencies": {
        "acorn": "^6.0.0 || ^7.0.0 || ^8.0.0"
      }
    },
    "node_modules/ajv": {
      "version": "6.12.6",
      "resolved": "https://registry.npmjs.org/ajv/-/ajv-6.12.6.tgz",
      "integrity": "sha512-j3fVLgvTo527anyYyJOGTYJbG+vnnQYvE0m5mmkc1TK+nxAppkCLMIL0aZ4dblVCNoGShhm+kzE4ZUykBoMg4g==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "fast-deep-equal": "^3.1.1",
        "fast-json-stable-stringify": "^2.0.0",
        "json-schema-traverse": "^0.4.1",
        "uri-js": "^4.2.2"
      },
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/epoberezkin"
      }
    },
    "node_modules/ansi-styles": {
      "version": "4.3.0",
      "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-4.3.0.tgz",
      "integrity": "sha512-zbB9rCJAT1rbjiVDb2hqKFHNYLxgtk8NURxZ3IZwD3F6NtxbXZQCnnSi1Lkx+IDohdPlFp222wVALIheZJQSEg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "color-convert": "^2.0.1"
      },
      "engines": {
        "node": ">=8"
      },
      "funding": {
        "url": "https://github.com/chalk/ansi-styles?sponsor=1"
      }
    },
    "node_modules/argparse": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/argparse/-/argparse-2.0.1.tgz",
      "integrity": "sha512-8+9WqebbFzpX9OR+Wa6O29asIogeRMzcGtAINdpMHHyAg10f05aSFVBbcEqGf/PXw1EjAZ+q2/bEBg3DvurK3Q==",
      "dev": true,
      "license": "Python-2.0"
    },
    "node_modules/autoprefixer": {
      "version": "10.4.22",
      "resolved": "https://registry.npmjs.org/autoprefixer/-/autoprefixer-10.4.22.tgz",
      "integrity": "sha512-ARe0v/t9gO28Bznv6GgqARmVqcWOV3mfgUPn9becPHMiD3o9BwlRgaeccZnwTpZ7Zwqrm+c1sUSsMxIzQzc8Xg==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/autoprefixer"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "browserslist": "^4.27.0",
        "caniuse-lite": "^1.0.30001754",
        "fraction.js": "^5.3.4",
        "normalize-range": "^0.1.2",
        "picocolors": "^1.1.1",
        "postcss-value-parser": "^4.2.0"
      },
      "bin": {
        "autoprefixer": "bin/autoprefixer"
      },
      "engines": {
        "node": "^10 || ^12 || >=14"
      },
      "peerDependencies": {
        "postcss": "^8.1.0"
      }
    },
    "node_modules/balanced-match": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/balanced-match/-/balanced-match-1.0.2.tgz",
      "integrity": "sha512-3oSeUO0TMV67hN1AmbXsK4yaqU7tjiHlbxRDZOpH0KW9+CeX4bRAaX0Anxt0tx2MrpRpWwQaPwIlISEJhYU5Pw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/baseline-browser-mapping": {
      "version": "2.8.32",
      "resolved": "https://registry.npmjs.org/baseline-browser-mapping/-/baseline-browser-mapping-2.8.32.tgz",
      "integrity": "sha512-OPz5aBThlyLFgxyhdwf/s2+8ab3OvT7AdTNvKHBwpXomIYeXqpUUuT8LrdtxZSsWJ4R4CU1un4XGh5Ez3nlTpw==",
      "dev": true,
      "license": "Apache-2.0",
      "bin": {
        "baseline-browser-mapping": "dist/cli.js"
      }
    },
    "node_modules/brace-expansion": {
      "version": "1.1.12",
      "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-1.1.12.tgz",
      "integrity": "sha512-9T9UjW3r0UW5c1Q7GTwllptXwhvYmEzFhzMfZ9H7FQWt+uZePjZPjBP/W1ZEyZ1twGWom5/56TF4lPcqjnDHcg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "balanced-match": "^1.0.0",
        "concat-map": "0.0.1"
      }
    },
    "node_modules/browserslist": {
      "version": "4.28.0",
      "resolved": "https://registry.npmjs.org/browserslist/-/browserslist-4.28.0.tgz",
      "integrity": "sha512-tbydkR/CxfMwelN0vwdP/pLkDwyAASZ+VfWm4EOwlB6SWhx1sYnWLqo8N5j0rAzPfzfRaxt0mM/4wPU/Su84RQ==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/browserslist"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "peer": true,
      "dependencies": {
        "baseline-browser-mapping": "^2.8.25",
        "caniuse-lite": "^1.0.30001754",
        "electron-to-chromium": "^1.5.249",
        "node-releases": "^2.0.27",
        "update-browserslist-db": "^1.1.4"
      },
      "bin": {
        "browserslist": "cli.js"
      },
      "engines": {
        "node": "^6 || ^7 || ^8 || ^9 || ^10 || ^11 || ^12 || >=13.7"
      }
    },
    "node_modules/callsites": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/callsites/-/callsites-3.1.0.tgz",
      "integrity": "sha512-P8BjAsXvZS+VIDUI11hHCQEv74YT67YUi5JJFNWIqL235sBmjX4+qx9Muvls5ivyNENctx46xQLQ3aTuE7ssaQ==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/caniuse-lite": {
      "version": "1.0.30001757",
      "resolved": "https://registry.npmjs.org/caniuse-lite/-/caniuse-lite-1.0.30001757.tgz",
      "integrity": "sha512-r0nnL/I28Zi/yjk1el6ilj27tKcdjLsNqAOZr0yVjWPrSQyHgKI2INaEWw21bAQSv2LXRt1XuCS/GomNpWOxsQ==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/caniuse-lite"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "CC-BY-4.0"
    },
    "node_modules/chalk": {
      "version": "4.1.2",
      "resolved": "https://registry.npmjs.org/chalk/-/chalk-4.1.2.tgz",
      "integrity": "sha512-oKnbhFyRIXpUuez8iBMmyEa4nbj4IOQyuhc/wy9kY7/WVPcwIO9VA668Pu8RkO7+0G76SLROeyw9CpQ061i4mA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "ansi-styles": "^4.1.0",
        "supports-color": "^7.1.0"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/chalk/chalk?sponsor=1"
      }
    },
    "node_modules/color-convert": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/color-convert/-/color-convert-2.0.1.tgz",
      "integrity": "sha512-RRECPsj7iu/xb5oKYcsFHSppFNnsj/52OVTRKb4zP5onXwVF3zVmmToNcOfGC+CRDpfK/U584fMg38ZHCaElKQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "color-name": "~1.1.4"
      },
      "engines": {
        "node": ">=7.0.0"
      }
    },
    "node_modules/color-name": {
      "version": "1.1.4",
      "resolved": "https://registry.npmjs.org/color-name/-/color-name-1.1.4.tgz",
      "integrity": "sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/concat-map": {
      "version": "0.0.1",
      "resolved": "https://registry.npmjs.org/concat-map/-/concat-map-0.0.1.tgz",
      "integrity": "sha512-/Srv4dswyQNBfohGpz9o6Yb3Gz3SrUDqBH5rTuhGR7ahtlbYKnVxw2bCFMRljaA7EXHaXZ8wsHdodFvbkhKmqg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/convert-source-map": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/convert-source-map/-/convert-source-map-2.0.0.tgz",
      "integrity": "sha512-Kvp459HrV2FEJ1CAsi1Ku+MY3kasH19TFykTz2xWmMeq6bk2NU3XXvfJ+Q61m0xktWwt+1HSYf3JZsTms3aRJg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/cross-spawn": {
      "version": "7.0.6",
      "resolved": "https://registry.npmjs.org/cross-spawn/-/cross-spawn-7.0.6.tgz",
      "integrity": "sha512-uV2QOWP2nWzsy2aMp8aRibhi9dlzF5Hgh5SHaB9OiTGEyDTiJJyx0uy51QXdyWbtAHNua4XJzUKca3OzKUd3vA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "path-key": "^3.1.0",
        "shebang-command": "^2.0.0",
        "which": "^2.0.1"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/csstype": {
      "version": "3.2.3",
      "resolved": "https://registry.npmjs.org/csstype/-/csstype-3.2.3.tgz",
      "integrity": "sha512-z1HGKcYy2xA8AGQfwrn0PAy+PB7X/GSj3UVJW9qKyn43xWa+gl5nXmU4qqLMRzWVLFC8KusUX8T/0kCiOYpAIQ==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/debug": {
      "version": "4.4.3",
      "resolved": "https://registry.npmjs.org/debug/-/debug-4.4.3.tgz",
      "integrity": "sha512-RGwwWnwQvkVfavKVt22FGLw+xYSdzARwm0ru6DhTVA3umU5hZc28V3kO4stgYryrTlLpuvgI9GiijltAjNbcqA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "ms": "^2.1.3"
      },
      "engines": {
        "node": ">=6.0"
      },
      "peerDependenciesMeta": {
        "supports-color": {
          "optional": true
        }
      }
    },
    "node_modules/deep-is": {
      "version": "0.1.4",
      "resolved": "https://registry.npmjs.org/deep-is/-/deep-is-0.1.4.tgz",
      "integrity": "sha512-oIPzksmTg4/MriiaYGO+okXDT7ztn/w3Eptv/+gSIdMdKsJo0u4CfYNFJPy+4SKMuCqGw2wxnA+URMg3t8a/bQ==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/detect-libc": {
      "version": "2.1.2",
      "resolved": "https://registry.npmjs.org/detect-libc/-/detect-libc-2.1.2.tgz",
      "integrity": "sha512-Btj2BOOO83o3WyH59e8MgXsxEQVcarkUOpEYrubB0urwnN10yQ364rsiByU11nZlqWYZm05i/of7io4mzihBtQ==",
      "dev": true,
      "license": "Apache-2.0",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/electron-to-chromium": {
      "version": "1.5.262",
      "resolved": "https://registry.npmjs.org/electron-to-chromium/-/electron-to-chromium-1.5.262.tgz",
      "integrity": "sha512-NlAsMteRHek05jRUxUR0a5jpjYq9ykk6+kO0yRaMi5moe7u0fVIOeQ3Y30A8dIiWFBNUoQGi1ljb1i5VtS9WQQ==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/enhanced-resolve": {
      "version": "5.18.3",
      "resolved": "https://registry.npmjs.org/enhanced-resolve/-/enhanced-resolve-5.18.3.tgz",
      "integrity": "sha512-d4lC8xfavMeBjzGr2vECC3fsGXziXZQyJxD868h2M/mBI3PwAuODxAkLkq5HYuvrPYcUtiLzsTo8U3PgX3Ocww==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "graceful-fs": "^4.2.4",
        "tapable": "^2.2.0"
      },
      "engines": {
        "node": ">=10.13.0"
      }
    },
    "node_modules/esbuild": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.25.12.tgz",
      "integrity": "sha512-bbPBYYrtZbkt6Os6FiTLCTFxvq4tt3JKall1vRwshA3fdVztsLAatFaZobhkBC8/BrPetoa0oksYoKXoG4ryJg==",
      "dev": true,
      "hasInstallScript": true,
      "license": "MIT",
      "bin": {
        "esbuild": "bin/esbuild"
      },
      "engines": {
        "node": ">=18"
      },
      "optionalDependencies": {
        "@esbuild/aix-ppc64": "0.25.12",
        "@esbuild/android-arm": "0.25.12",
        "@esbuild/android-arm64": "0.25.12",
        "@esbuild/android-x64": "0.25.12",
        "@esbuild/darwin-arm64": "0.25.12",
        "@esbuild/darwin-x64": "0.25.12",
        "@esbuild/freebsd-arm64": "0.25.12",
        "@esbuild/freebsd-x64": "0.25.12",
        "@esbuild/linux-arm": "0.25.12",
        "@esbuild/linux-arm64": "0.25.12",
        "@esbuild/linux-ia32": "0.25.12",
        "@esbuild/linux-loong64": "0.25.12",
        "@esbuild/linux-mips64el": "0.25.12",
        "@esbuild/linux-ppc64": "0.25.12",
        "@esbuild/linux-riscv64": "0.25.12",
        "@esbuild/linux-s390x": "0.25.12",
        "@esbuild/linux-x64": "0.25.12",
        "@esbuild/netbsd-arm64": "0.25.12",
        "@esbuild/netbsd-x64": "0.25.12",
        "@esbuild/openbsd-arm64": "0.25.12",
        "@esbuild/openbsd-x64": "0.25.12",
        "@esbuild/openharmony-arm64": "0.25.12",
        "@esbuild/sunos-x64": "0.25.12",
        "@esbuild/win32-arm64": "0.25.12",
        "@esbuild/win32-ia32": "0.25.12",
        "@esbuild/win32-x64": "0.25.12"
      }
    },
    "node_modules/esbuild/node_modules/@esbuild/win32-x64": {
      "version": "0.25.12",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.25.12.tgz",
      "integrity": "sha512-alJC0uCZpTFrSL0CCDjcgleBXPnCrEAhTBILpeAp7M/OFgoqtAetfBzX0xM00MUsVVPpVjlPuMbREqnZCXaTnA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/escalade": {
      "version": "3.2.0",
      "resolved": "https://registry.npmjs.org/escalade/-/escalade-3.2.0.tgz",
      "integrity": "sha512-WUj2qlxaQtO4g6Pq5c29GTcWGDyd8itL8zTlipgECz3JesAiiOKotd8JU6otB3PACgG6xkJUyVhboMS+bje/jA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/escape-string-regexp": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/escape-string-regexp/-/escape-string-regexp-4.0.0.tgz",
      "integrity": "sha512-TtpcNJ3XAzx3Gq8sWRzJaVajRs0uVxA2YAkdb1jm2YkPz4G6egUFAyA3n5vtEIZefPk5Wa4UXbKuS5fKkJWdgA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/eslint": {
      "version": "9.39.1",
      "resolved": "https://registry.npmjs.org/eslint/-/eslint-9.39.1.tgz",
      "integrity": "sha512-BhHmn2yNOFA9H9JmmIVKJmd288g9hrVRDkdoIgRCRuSySRUHH7r/DI6aAXW9T1WwUuY3DFgrcaqB+deURBLR5g==",
      "dev": true,
      "license": "MIT",
      "peer": true,
      "dependencies": {
        "@eslint-community/eslint-utils": "^4.8.0",
        "@eslint-community/regexpp": "^4.12.1",
        "@eslint/config-array": "^0.21.1",
        "@eslint/config-helpers": "^0.4.2",
        "@eslint/core": "^0.17.0",
        "@eslint/eslintrc": "^3.3.1",
        "@eslint/js": "9.39.1",
        "@eslint/plugin-kit": "^0.4.1",
        "@humanfs/node": "^0.16.6",
        "@humanwhocodes/module-importer": "^1.0.1",
        "@humanwhocodes/retry": "^0.4.2",
        "@types/estree": "^1.0.6",
        "ajv": "^6.12.4",
        "chalk": "^4.0.0",
        "cross-spawn": "^7.0.6",
        "debug": "^4.3.2",
        "escape-string-regexp": "^4.0.0",
        "eslint-scope": "^8.4.0",
        "eslint-visitor-keys": "^4.2.1",
        "espree": "^10.4.0",
        "esquery": "^1.5.0",
        "esutils": "^2.0.2",
        "fast-deep-equal": "^3.1.3",
        "file-entry-cache": "^8.0.0",
        "find-up": "^5.0.0",
        "glob-parent": "^6.0.2",
        "ignore": "^5.2.0",
        "imurmurhash": "^0.1.4",
        "is-glob": "^4.0.0",
        "json-stable-stringify-without-jsonify": "^1.0.1",
        "lodash.merge": "^4.6.2",
        "minimatch": "^3.1.2",
        "natural-compare": "^1.4.0",
        "optionator": "^0.9.3"
      },
      "bin": {
        "eslint": "bin/eslint.js"
      },
      "engines": {
        "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
      },
      "funding": {
        "url": "https://eslint.org/donate"
      },
      "peerDependencies": {
        "jiti": "*"
      },
      "peerDependenciesMeta": {
        "jiti": {
          "optional": true
        }
      }
    },
    "node_modules/eslint-plugin-react-hooks": {
      "version": "7.0.1",
      "resolved": "https://registry.npmjs.org/eslint-plugin-react-hooks/-/eslint-plugin-react-hooks-7.0.1.tgz",
      "integrity": "sha512-O0d0m04evaNzEPoSW+59Mezf8Qt0InfgGIBJnpC0h3NH/WjUAR7BIKUfysC6todmtiZ/A0oUVS8Gce0WhBrHsA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/core": "^7.24.4",
        "@babel/parser": "^7.24.4",
        "hermes-parser": "^0.25.1",
        "zod": "^3.25.0 || ^4.0.0",
        "zod-validation-error": "^3.5.0 || ^4.0.0"
      },
      "engines": {
        "node": ">=18"
      },
      "peerDependencies": {
        "eslint": "^3.0.0 || ^4.0.0 || ^5.0.0 || ^6.0.0 || ^7.0.0 || ^8.0.0-0 || ^9.0.0"
      }
    },
    "node_modules/eslint-plugin-react-refresh": {
      "version": "0.4.24",
      "resolved": "https://registry.npmjs.org/eslint-plugin-react-refresh/-/eslint-plugin-react-refresh-0.4.24.tgz",
      "integrity": "sha512-nLHIW7TEq3aLrEYWpVaJ1dRgFR+wLDPN8e8FpYAql/bMV2oBEfC37K0gLEGgv9fy66juNShSMV8OkTqzltcG/w==",
      "dev": true,
      "license": "MIT",
      "peerDependencies": {
        "eslint": ">=8.40"
      }
    },
    "node_modules/eslint-scope": {
      "version": "8.4.0",
      "resolved": "https://registry.npmjs.org/eslint-scope/-/eslint-scope-8.4.0.tgz",
      "integrity": "sha512-sNXOfKCn74rt8RICKMvJS7XKV/Xk9kA7DyJr8mJik3S7Cwgy3qlkkmyS2uQB3jiJg6VNdZd/pDBJu0nvG2NlTg==",
      "dev": true,
      "license": "BSD-2-Clause",
      "dependencies": {
        "esrecurse": "^4.3.0",
        "estraverse": "^5.2.0"
      },
      "engines": {
        "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
      },
      "funding": {
        "url": "https://opencollective.com/eslint"
      }
    },
    "node_modules/eslint-visitor-keys": {
      "version": "4.2.1",
      "resolved": "https://registry.npmjs.org/eslint-visitor-keys/-/eslint-visitor-keys-4.2.1.tgz",
      "integrity": "sha512-Uhdk5sfqcee/9H/rCOJikYz67o0a2Tw2hGRPOG2Y1R2dg7brRe1uG0yaNQDHu+TO/uQPF/5eCapvYSmHUjt7JQ==",
      "dev": true,
      "license": "Apache-2.0",
      "engines": {
        "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
      },
      "funding": {
        "url": "https://opencollective.com/eslint"
      }
    },
    "node_modules/espree": {
      "version": "10.4.0",
      "resolved": "https://registry.npmjs.org/espree/-/espree-10.4.0.tgz",
      "integrity": "sha512-j6PAQ2uUr79PZhBjP5C5fhl8e39FmRnOjsD5lGnWrFU8i2G776tBK7+nP8KuQUTTyAZUwfQqXAgrVH5MbH9CYQ==",
      "dev": true,
      "license": "BSD-2-Clause",
      "dependencies": {
        "acorn": "^8.15.0",
        "acorn-jsx": "^5.3.2",
        "eslint-visitor-keys": "^4.2.1"
      },
      "engines": {
        "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
      },
      "funding": {
        "url": "https://opencollective.com/eslint"
      }
    },
    "node_modules/esquery": {
      "version": "1.6.0",
      "resolved": "https://registry.npmjs.org/esquery/-/esquery-1.6.0.tgz",
      "integrity": "sha512-ca9pw9fomFcKPvFLXhBKUK90ZvGibiGOvRJNbjljY7s7uq/5YO4BOzcYtJqExdx99rF6aAcnRxHmcUHcz6sQsg==",
      "dev": true,
      "license": "BSD-3-Clause",
      "dependencies": {
        "estraverse": "^5.1.0"
      },
      "engines": {
        "node": ">=0.10"
      }
    },
    "node_modules/esrecurse": {
      "version": "4.3.0",
      "resolved": "https://registry.npmjs.org/esrecurse/-/esrecurse-4.3.0.tgz",
      "integrity": "sha512-KmfKL3b6G+RXvP8N1vr3Tq1kL/oCFgn2NYXEtqP8/L3pKapUA4G8cFVaoF3SU323CD4XypR/ffioHmkti6/Tag==",
      "dev": true,
      "license": "BSD-2-Clause",
      "dependencies": {
        "estraverse": "^5.2.0"
      },
      "engines": {
        "node": ">=4.0"
      }
    },
    "node_modules/estraverse": {
      "version": "5.3.0",
      "resolved": "https://registry.npmjs.org/estraverse/-/estraverse-5.3.0.tgz",
      "integrity": "sha512-MMdARuVEQziNTeJD8DgMqmhwR11BRQ/cBP+pLtYdSTnf3MIO8fFeiINEbX36ZdNlfU/7A9f3gUw49B3oQsvwBA==",
      "dev": true,
      "license": "BSD-2-Clause",
      "engines": {
        "node": ">=4.0"
      }
    },
    "node_modules/esutils": {
      "version": "2.0.3",
      "resolved": "https://registry.npmjs.org/esutils/-/esutils-2.0.3.tgz",
      "integrity": "sha512-kVscqXk4OCp68SZ0dkgEKVi6/8ij300KBWTJq32P/dYeWTSwK41WyTxalN1eRmA5Z9UU/LX9D7FWSmV9SAYx6g==",
      "dev": true,
      "license": "BSD-2-Clause",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/fast-deep-equal": {
      "version": "3.1.3",
      "resolved": "https://registry.npmjs.org/fast-deep-equal/-/fast-deep-equal-3.1.3.tgz",
      "integrity": "sha512-f3qQ9oQy9j2AhBe/H9VC91wLmKBCCU/gDOnKNAYG5hswO7BLKj09Hc5HYNz9cGI++xlpDCIgDaitVs03ATR84Q==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/fast-json-stable-stringify": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/fast-json-stable-stringify/-/fast-json-stable-stringify-2.1.0.tgz",
      "integrity": "sha512-lhd/wF+Lk98HZoTCtlVraHtfh5XYijIjalXck7saUtuanSDyLMxnHhSXEDJqHxD7msR8D0uCmqlkwjCV8xvwHw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/fast-levenshtein": {
      "version": "2.0.6",
      "resolved": "https://registry.npmjs.org/fast-levenshtein/-/fast-levenshtein-2.0.6.tgz",
      "integrity": "sha512-DCXu6Ifhqcks7TZKY3Hxp3y6qphY5SJZmrWMDrKcERSOXWQdMhU9Ig/PYrzyw/ul9jOIyh0N4M0tbC5hodg8dw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/fdir": {
      "version": "6.5.0",
      "resolved": "https://registry.npmjs.org/fdir/-/fdir-6.5.0.tgz",
      "integrity": "sha512-tIbYtZbucOs0BRGqPJkshJUYdL+SDH7dVM8gjy+ERp3WAUjLEFJE+02kanyHtwjWOnwrKYBiwAmM0p4kLJAnXg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=12.0.0"
      },
      "peerDependencies": {
        "picomatch": "^3 || ^4"
      },
      "peerDependenciesMeta": {
        "picomatch": {
          "optional": true
        }
      }
    },
    "node_modules/file-entry-cache": {
      "version": "8.0.0",
      "resolved": "https://registry.npmjs.org/file-entry-cache/-/file-entry-cache-8.0.0.tgz",
      "integrity": "sha512-XXTUwCvisa5oacNGRP9SfNtYBNAMi+RPwBFmblZEF7N7swHYQS6/Zfk7SRwx4D5j3CH211YNRco1DEMNVfZCnQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "flat-cache": "^4.0.0"
      },
      "engines": {
        "node": ">=16.0.0"
      }
    },
    "node_modules/find-up": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/find-up/-/find-up-5.0.0.tgz",
      "integrity": "sha512-78/PXT1wlLLDgTzDs7sjq9hzz0vXD+zn+7wypEe4fXQxCmdmqfGsEPQxmiCSQI3ajFV91bVSsvNtrJRiW6nGng==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "locate-path": "^6.0.0",
        "path-exists": "^4.0.0"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/flat-cache": {
      "version": "4.0.1",
      "resolved": "https://registry.npmjs.org/flat-cache/-/flat-cache-4.0.1.tgz",
      "integrity": "sha512-f7ccFPK3SXFHpx15UIGyRJ/FJQctuKZ0zVuN3frBo4HnK3cay9VEW0R6yPYFHC0AgqhukPzKjq22t5DmAyqGyw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "flatted": "^3.2.9",
        "keyv": "^4.5.4"
      },
      "engines": {
        "node": ">=16"
      }
    },
    "node_modules/flatted": {
      "version": "3.3.3",
      "resolved": "https://registry.npmjs.org/flatted/-/flatted-3.3.3.tgz",
      "integrity": "sha512-GX+ysw4PBCz0PzosHDepZGANEuFCMLrnRTiEy9McGjmkCQYwRq4A/X786G/fjM/+OjsWSU1ZrY5qyARZmO/uwg==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/fraction.js": {
      "version": "5.3.4",
      "resolved": "https://registry.npmjs.org/fraction.js/-/fraction.js-5.3.4.tgz",
      "integrity": "sha512-1X1NTtiJphryn/uLQz3whtY6jK3fTqoE3ohKs0tT+Ujr1W59oopxmoEh7Lu5p6vBaPbgoM0bzveAW4Qi5RyWDQ==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": "*"
      },
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/rawify"
      }
    },
    "node_modules/fsevents": {
      "version": "2.3.3",
      "resolved": "https://registry.npmjs.org/fsevents/-/fsevents-2.3.3.tgz",
      "integrity": "sha512-5xoDfX+fL7faATnagmWPpbFtwh/R77WmMMqqHGS65C3vvB0YHrgF+B1YmZ3441tMj5n63k0212XNoJwzlhffQw==",
      "dev": true,
      "hasInstallScript": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": "^8.16.0 || ^10.6.0 || >=11.0.0"
      }
    },
    "node_modules/gensync": {
      "version": "1.0.0-beta.2",
      "resolved": "https://registry.npmjs.org/gensync/-/gensync-1.0.0-beta.2.tgz",
      "integrity": "sha512-3hN7NaskYvMDLQY55gnW3NQ+mesEAepTqlg+VEbj7zzqEMBVNhzcGYYeqFo/TlYz6eQiFcp1HcsCZO+nGgS8zg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/glob-parent": {
      "version": "6.0.2",
      "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-6.0.2.tgz",
      "integrity": "sha512-XxwI8EOhVQgWp6iDL+3b0r86f4d6AX6zSU55HfB4ydCEuXLXc5FcYeOu+nnGftS4TEju/11rt4KJPTMgbfmv4A==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "is-glob": "^4.0.3"
      },
      "engines": {
        "node": ">=10.13.0"
      }
    },
    "node_modules/globals": {
      "version": "16.5.0",
      "resolved": "https://registry.npmjs.org/globals/-/globals-16.5.0.tgz",
      "integrity": "sha512-c/c15i26VrJ4IRt5Z89DnIzCGDn9EcebibhAOjw5ibqEHsE1wLUgkPn9RDmNcUKyU87GeaL633nyJ+pplFR2ZQ==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/graceful-fs": {
      "version": "4.2.11",
      "resolved": "https://registry.npmjs.org/graceful-fs/-/graceful-fs-4.2.11.tgz",
      "integrity": "sha512-RbJ5/jmFcNNCcDV5o9eTnBLJ/HszWV0P73bc+Ff4nS/rJj+YaS6IGyiOL0VoBYX+l1Wrl3k63h/KrH+nhJ0XvQ==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/has-flag": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/has-flag/-/has-flag-4.0.0.tgz",
      "integrity": "sha512-EykJT/Q1KjTWctppgIAgfSO0tKVuZUjhgMr17kqTumMl6Afv3EISleU7qZUzoXDFTAHTDC4NOoG/ZxU3EvlMPQ==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/hermes-estree": {
      "version": "0.25.1",
      "resolved": "https://registry.npmjs.org/hermes-estree/-/hermes-estree-0.25.1.tgz",
      "integrity": "sha512-0wUoCcLp+5Ev5pDW2OriHC2MJCbwLwuRx+gAqMTOkGKJJiBCLjtrvy4PWUGn6MIVefecRpzoOZ/UV6iGdOr+Cw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/hermes-parser": {
      "version": "0.25.1",
      "resolved": "https://registry.npmjs.org/hermes-parser/-/hermes-parser-0.25.1.tgz",
      "integrity": "sha512-6pEjquH3rqaI6cYAXYPcz9MS4rY6R4ngRgrgfDshRptUZIc3lw0MCIJIGDj9++mfySOuPTHB4nrSW99BCvOPIA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "hermes-estree": "0.25.1"
      }
    },
    "node_modules/ignore": {
      "version": "5.3.2",
      "resolved": "https://registry.npmjs.org/ignore/-/ignore-5.3.2.tgz",
      "integrity": "sha512-hsBTNUqQTDwkWtcdYI2i06Y/nUBEsNEDJKjWdigLvegy8kDuJAS8uRlpkkcQpyEXL0Z/pjDy5HBmMjRCJ2gq+g==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">= 4"
      }
    },
    "node_modules/import-fresh": {
      "version": "3.3.1",
      "resolved": "https://registry.npmjs.org/import-fresh/-/import-fresh-3.3.1.tgz",
      "integrity": "sha512-TR3KfrTZTYLPB6jUjfx6MF9WcWrHL9su5TObK4ZkYgBdWKPOFoSoQIdEuTuR82pmtxH2spWG9h6etwfr1pLBqQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "parent-module": "^1.0.0",
        "resolve-from": "^4.0.0"
      },
      "engines": {
        "node": ">=6"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/imurmurhash": {
      "version": "0.1.4",
      "resolved": "https://registry.npmjs.org/imurmurhash/-/imurmurhash-0.1.4.tgz",
      "integrity": "sha512-JmXMZ6wuvDmLiHEml9ykzqO6lwFbof0GG4IkcGaENdCRDDmMVnny7s5HsIgHCbaq0w2MyPhDqkhTUgS2LU2PHA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.8.19"
      }
    },
    "node_modules/is-extglob": {
      "version": "2.1.1",
      "resolved": "https://registry.npmjs.org/is-extglob/-/is-extglob-2.1.1.tgz",
      "integrity": "sha512-SbKbANkN603Vi4jEZv49LeVJMn4yGwsbzZworEoyEiutsN3nJYdbO36zfhGJ6QEDpOZIFkDtnq5JRxmvl3jsoQ==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/is-glob": {
      "version": "4.0.3",
      "resolved": "https://registry.npmjs.org/is-glob/-/is-glob-4.0.3.tgz",
      "integrity": "sha512-xelSayHH36ZgE7ZWhli7pW34hNbNl8Ojv5KVmkJD4hBdD3th8Tfk9vYasLM+mXWOZhFkgZfxhLSnrwRr4elSSg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "is-extglob": "^2.1.1"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/isexe": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/isexe/-/isexe-2.0.0.tgz",
      "integrity": "sha512-RHxMLp9lnKHGHRng9QFhRCMbYAcVpn69smSGcq3f36xjgVVWThj4qqLbTLlq7Ssj8B+fIQ1EuCEGI2lKsyQeIw==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/jiti": {
      "version": "2.6.1",
      "resolved": "https://registry.npmjs.org/jiti/-/jiti-2.6.1.tgz",
      "integrity": "sha512-ekilCSN1jwRvIbgeg/57YFh8qQDNbwDb9xT/qu2DAHbFFZUicIl4ygVaAvzveMhMVr3LnpSKTNnwt8PoOfmKhQ==",
      "dev": true,
      "license": "MIT",
      "bin": {
        "jiti": "lib/jiti-cli.mjs"
      }
    },
    "node_modules/js-tokens": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/js-tokens/-/js-tokens-4.0.0.tgz",
      "integrity": "sha512-RdJUflcE3cUzKiMqQgsCu06FPu9UdIJO0beYbPhHN4k6apgJtifcoCtT9bcxOpYBtpD2kCM6Sbzg4CausW/PKQ==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/js-yaml": {
      "version": "4.1.1",
      "resolved": "https://registry.npmjs.org/js-yaml/-/js-yaml-4.1.1.tgz",
      "integrity": "sha512-qQKT4zQxXl8lLwBtHMWwaTcGfFOZviOJet3Oy/xmGk2gZH677CJM9EvtfdSkgWcATZhj/55JZ0rmy3myCT5lsA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "argparse": "^2.0.1"
      },
      "bin": {
        "js-yaml": "bin/js-yaml.js"
      }
    },
    "node_modules/jsesc": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/jsesc/-/jsesc-3.1.0.tgz",
      "integrity": "sha512-/sM3dO2FOzXjKQhJuo0Q173wf2KOo8t4I8vHy6lF9poUp7bKT0/NHE8fPX23PwfhnykfqnC2xRxOnVw5XuGIaA==",
      "dev": true,
      "license": "MIT",
      "bin": {
        "jsesc": "bin/jsesc"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/json-buffer": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/json-buffer/-/json-buffer-3.0.1.tgz",
      "integrity": "sha512-4bV5BfR2mqfQTJm+V5tPPdf+ZpuhiIvTuAB5g8kcrXOZpTT/QwwVRWBywX1ozr6lEuPdbHxwaJlm9G6mI2sfSQ==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/json-schema-traverse": {
      "version": "0.4.1",
      "resolved": "https://registry.npmjs.org/json-schema-traverse/-/json-schema-traverse-0.4.1.tgz",
      "integrity": "sha512-xbbCH5dCYU5T8LcEhhuh7HJ88HXuW3qsI3Y0zOZFKfZEHcpWiHU/Jxzk629Brsab/mMiHQti9wMP+845RPe3Vg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/json-stable-stringify-without-jsonify": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/json-stable-stringify-without-jsonify/-/json-stable-stringify-without-jsonify-1.0.1.tgz",
      "integrity": "sha512-Bdboy+l7tA3OGW6FjyFHWkP5LuByj1Tk33Ljyq0axyzdk9//JSi2u3fP1QSmd1KNwq6VOKYGlAu87CisVir6Pw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/json5": {
      "version": "2.2.3",
      "resolved": "https://registry.npmjs.org/json5/-/json5-2.2.3.tgz",
      "integrity": "sha512-XmOWe7eyHYH14cLdVPoyg+GOH3rYX++KpzrylJwSW98t3Nk+U8XOl8FWKOgwtzdb8lXGf6zYwDUzeHMWfxasyg==",
      "dev": true,
      "license": "MIT",
      "bin": {
        "json5": "lib/cli.js"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/keyv": {
      "version": "4.5.4",
      "resolved": "https://registry.npmjs.org/keyv/-/keyv-4.5.4.tgz",
      "integrity": "sha512-oxVHkHR/EJf2CNXnWxRLW6mg7JyCCUcG0DtEGmL2ctUo1PNTin1PUil+r/+4r5MpVgC/fn1kjsx7mjSujKqIpw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "json-buffer": "3.0.1"
      }
    },
    "node_modules/levn": {
      "version": "0.4.1",
      "resolved": "https://registry.npmjs.org/levn/-/levn-0.4.1.tgz",
      "integrity": "sha512-+bT2uH4E5LGE7h/n3evcS/sQlJXCpIp6ym8OWJ5eV6+67Dsql/LaaT7qJBAt2rzfoa/5QBGBhxDix1dMt2kQKQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "prelude-ls": "^1.2.1",
        "type-check": "~0.4.0"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/lightningcss": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss/-/lightningcss-1.30.2.tgz",
      "integrity": "sha512-utfs7Pr5uJyyvDETitgsaqSyjCb2qNRAtuqUeWIAKztsOYdcACf2KtARYXg2pSvhkt+9NfoaNY7fxjl6nuMjIQ==",
      "dev": true,
      "license": "MPL-2.0",
      "dependencies": {
        "detect-libc": "^2.0.3"
      },
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      },
      "optionalDependencies": {
        "lightningcss-android-arm64": "1.30.2",
        "lightningcss-darwin-arm64": "1.30.2",
        "lightningcss-darwin-x64": "1.30.2",
        "lightningcss-freebsd-x64": "1.30.2",
        "lightningcss-linux-arm-gnueabihf": "1.30.2",
        "lightningcss-linux-arm64-gnu": "1.30.2",
        "lightningcss-linux-arm64-musl": "1.30.2",
        "lightningcss-linux-x64-gnu": "1.30.2",
        "lightningcss-linux-x64-musl": "1.30.2",
        "lightningcss-win32-arm64-msvc": "1.30.2",
        "lightningcss-win32-x64-msvc": "1.30.2"
      }
    },
    "node_modules/lightningcss-android-arm64": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-android-arm64/-/lightningcss-android-arm64-1.30.2.tgz",
      "integrity": "sha512-BH9sEdOCahSgmkVhBLeU7Hc9DWeZ1Eb6wNS6Da8igvUwAe0sqROHddIlvU06q3WyXVEOYDZ6ykBZQnjTbmo4+A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-darwin-arm64": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-darwin-arm64/-/lightningcss-darwin-arm64-1.30.2.tgz",
      "integrity": "sha512-ylTcDJBN3Hp21TdhRT5zBOIi73P6/W0qwvlFEk22fkdXchtNTOU4Qc37SkzV+EKYxLouZ6M4LG9NfZ1qkhhBWA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-darwin-x64": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-darwin-x64/-/lightningcss-darwin-x64-1.30.2.tgz",
      "integrity": "sha512-oBZgKchomuDYxr7ilwLcyms6BCyLn0z8J0+ZZmfpjwg9fRVZIR5/GMXd7r9RH94iDhld3UmSjBM6nXWM2TfZTQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-freebsd-x64": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-freebsd-x64/-/lightningcss-freebsd-x64-1.30.2.tgz",
      "integrity": "sha512-c2bH6xTrf4BDpK8MoGG4Bd6zAMZDAXS569UxCAGcA7IKbHNMlhGQ89eRmvpIUGfKWNVdbhSbkQaWhEoMGmGslA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-linux-arm-gnueabihf": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-linux-arm-gnueabihf/-/lightningcss-linux-arm-gnueabihf-1.30.2.tgz",
      "integrity": "sha512-eVdpxh4wYcm0PofJIZVuYuLiqBIakQ9uFZmipf6LF/HRj5Bgm0eb3qL/mr1smyXIS1twwOxNWndd8z0E374hiA==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-linux-arm64-gnu": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-linux-arm64-gnu/-/lightningcss-linux-arm64-gnu-1.30.2.tgz",
      "integrity": "sha512-UK65WJAbwIJbiBFXpxrbTNArtfuznvxAJw4Q2ZGlU8kPeDIWEX1dg3rn2veBVUylA2Ezg89ktszWbaQnxD/e3A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-linux-arm64-musl": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-linux-arm64-musl/-/lightningcss-linux-arm64-musl-1.30.2.tgz",
      "integrity": "sha512-5Vh9dGeblpTxWHpOx8iauV02popZDsCYMPIgiuw97OJ5uaDsL86cnqSFs5LZkG3ghHoX5isLgWzMs+eD1YzrnA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-linux-x64-gnu": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-linux-x64-gnu/-/lightningcss-linux-x64-gnu-1.30.2.tgz",
      "integrity": "sha512-Cfd46gdmj1vQ+lR6VRTTadNHu6ALuw2pKR9lYq4FnhvgBc4zWY1EtZcAc6EffShbb1MFrIPfLDXD6Xprbnni4w==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-linux-x64-musl": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-linux-x64-musl/-/lightningcss-linux-x64-musl-1.30.2.tgz",
      "integrity": "sha512-XJaLUUFXb6/QG2lGIW6aIk6jKdtjtcffUT0NKvIqhSBY3hh9Ch+1LCeH80dR9q9LBjG3ewbDjnumefsLsP6aiA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-win32-arm64-msvc": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-win32-arm64-msvc/-/lightningcss-win32-arm64-msvc-1.30.2.tgz",
      "integrity": "sha512-FZn+vaj7zLv//D/192WFFVA0RgHawIcHqLX9xuWiQt7P0PtdFEVaxgF9rjM/IRYHQXNnk61/H/gb2Ei+kUQ4xQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss/node_modules/lightningcss-win32-x64-msvc": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-win32-x64-msvc/-/lightningcss-win32-x64-msvc-1.30.2.tgz",
      "integrity": "sha512-5g1yc73p+iAkid5phb4oVFMB45417DkRevRbt/El/gKXJk4jid+vPFF/AXbxn05Aky8PapwzZrdJShv5C0avjw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/locate-path": {
      "version": "6.0.0",
      "resolved": "https://registry.npmjs.org/locate-path/-/locate-path-6.0.0.tgz",
      "integrity": "sha512-iPZK6eYjbxRu3uB4/WZ3EsEIMJFMqAoopl3R+zuq0UjcAm/MO6KCweDgPfP3elTztoKP3KtnVHxTn2NHBSDVUw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "p-locate": "^5.0.0"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/lodash.merge": {
      "version": "4.6.2",
      "resolved": "https://registry.npmjs.org/lodash.merge/-/lodash.merge-4.6.2.tgz",
      "integrity": "sha512-0KpjqXRVvrYyCsX1swR/XTK0va6VQkQM6MNo7PqW77ByjAhoARA8EfrP1N4+KlKj8YS0ZUCtRT/YUuhyYDujIQ==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/lru-cache": {
      "version": "5.1.1",
      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-5.1.1.tgz",
      "integrity": "sha512-KpNARQA3Iwv+jTA0utUVVbrh+Jlrr1Fv0e56GGzAFOXN7dk/FviaDW8LHmK52DlcH4WP2n6gI8vN1aesBFgo9w==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "yallist": "^3.0.2"
      }
    },
    "node_modules/magic-string": {
      "version": "0.30.21",
      "resolved": "https://registry.npmjs.org/magic-string/-/magic-string-0.30.21.tgz",
      "integrity": "sha512-vd2F4YUyEXKGcLHoq+TEyCjxueSeHnFxyyjNp80yg0XV4vUhnDer/lvvlqM/arB5bXQN5K2/3oinyCRyx8T2CQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@jridgewell/sourcemap-codec": "^1.5.5"
      }
    },
    "node_modules/minimatch": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-3.1.2.tgz",
      "integrity": "sha512-J7p63hRiAjw1NDEww1W7i37+ByIrOWO5XQQAzZ3VOcL0PNybwpfmV/N05zFAzwQ9USyEcX6t3UO+K5aqBQOIHw==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "brace-expansion": "^1.1.7"
      },
      "engines": {
        "node": "*"
      }
    },
    "node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/nanoid": {
      "version": "3.3.11",
      "resolved": "https://registry.npmjs.org/nanoid/-/nanoid-3.3.11.tgz",
      "integrity": "sha512-N8SpfPUnUp1bK+PMYW8qSWdl9U+wwNWI4QKxOYDy9JAro3WMX7p2OeVRF9v+347pnakNevPmiHhNmZ2HbFA76w==",
      "dev": true,
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "bin": {
        "nanoid": "bin/nanoid.cjs"
      },
      "engines": {
        "node": "^10 || ^12 || ^13.7 || ^14 || >=15.0.1"
      }
    },
    "node_modules/natural-compare": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/natural-compare/-/natural-compare-1.4.0.tgz",
      "integrity": "sha512-OWND8ei3VtNC9h7V60qff3SVobHr996CTwgxubgyQYEpg290h9J0buyECNNJexkFm5sOajh5G116RYA1c8ZMSw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/node-releases": {
      "version": "2.0.27",
      "resolved": "https://registry.npmjs.org/node-releases/-/node-releases-2.0.27.tgz",
      "integrity": "sha512-nmh3lCkYZ3grZvqcCH+fjmQ7X+H0OeZgP40OierEaAptX4XofMh5kwNbWh7lBduUzCcV/8kZ+NDLCwm2iorIlA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/normalize-range": {
      "version": "0.1.2",
      "resolved": "https://registry.npmjs.org/normalize-range/-/normalize-range-0.1.2.tgz",
      "integrity": "sha512-bdok/XvKII3nUpklnV6P2hxtMNrCboOjAcyBuQnWEhO665FwrSNRxU+AqpsyvO6LgGYPspN+lu5CLtw4jPRKNA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/optionator": {
      "version": "0.9.4",
      "resolved": "https://registry.npmjs.org/optionator/-/optionator-0.9.4.tgz",
      "integrity": "sha512-6IpQ7mKUxRcZNLIObR0hz7lxsapSSIYNZJwXPGeF0mTVqGKFIXj1DQcMoT22S3ROcLyY/rz0PWaWZ9ayWmad9g==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "deep-is": "^0.1.3",
        "fast-levenshtein": "^2.0.6",
        "levn": "^0.4.1",
        "prelude-ls": "^1.2.1",
        "type-check": "^0.4.0",
        "word-wrap": "^1.2.5"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/p-limit": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/p-limit/-/p-limit-3.1.0.tgz",
      "integrity": "sha512-TYOanM3wGwNGsZN2cVTYPArw454xnXj5qmWF1bEoAc4+cU/ol7GVh7odevjp1FNHduHc3KZMcFduxU5Xc6uJRQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "yocto-queue": "^0.1.0"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/p-locate": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/p-locate/-/p-locate-5.0.0.tgz",
      "integrity": "sha512-LaNjtRWUBY++zB5nE/NwcaoMylSPk+S+ZHNB1TzdbMJMny6dynpAGt7X/tl/QYq3TIeE6nxHppbo2LGymrG5Pw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "p-limit": "^3.0.2"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/parent-module": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/parent-module/-/parent-module-1.0.1.tgz",
      "integrity": "sha512-GQ2EWRpQV8/o+Aw8YqtfZZPfNRWZYkbidE9k5rpl/hC3vtHHBfGm2Ifi6qWV+coDGkrUKZAxE3Lot5kcsRlh+g==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "callsites": "^3.0.0"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/path-exists": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/path-exists/-/path-exists-4.0.0.tgz",
      "integrity": "sha512-ak9Qy5Q7jYb2Wwcey5Fpvg2KoAc/ZIhLSLOSBmRmygPsGwkVVt0fZa0qrtMz+m6tJTAHfZQ8FnmB4MG4LWy7/w==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/path-key": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/path-key/-/path-key-3.1.1.tgz",
      "integrity": "sha512-ojmeN0qd+y0jszEtoY48r0Peq5dwMEkIlCOu6Q5f41lfkswXuKtYrhgoTpLnyIcHm24Uhqx+5Tqm2InSwLhE6Q==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/picocolors": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/picocolors/-/picocolors-1.1.1.tgz",
      "integrity": "sha512-xceH2snhtb5M9liqDsmEw56le376mTZkEX/jEb/RxNFyegNul7eNslCXP9FDj/Lcu0X8KEyMceP2ntpaHrDEVA==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/picomatch": {
      "version": "4.0.3",
      "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-4.0.3.tgz",
      "integrity": "sha512-5gTmgEY/sqK6gFXLIsQNH19lWb4ebPDLA4SdLP7dsWkIXHWlG66oPuVvXSGFPppYZz8ZDZq0dYYrbHfBCVUb1Q==",
      "dev": true,
      "license": "MIT",
      "peer": true,
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/jonschlinkert"
      }
    },
    "node_modules/postcss": {
      "version": "8.5.6",
      "resolved": "https://registry.npmjs.org/postcss/-/postcss-8.5.6.tgz",
      "integrity": "sha512-3Ybi1tAuwAP9s0r1UQ2J4n5Y0G05bJkpUIO0/bI9MhwmD70S5aTWbXGBwxHrelT+XM1k6dM0pk+SwNkpTRN7Pg==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/postcss"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "peer": true,
      "dependencies": {
        "nanoid": "^3.3.11",
        "picocolors": "^1.1.1",
        "source-map-js": "^1.2.1"
      },
      "engines": {
        "node": "^10 || ^12 || >=14"
      }
    },
    "node_modules/postcss-value-parser": {
      "version": "4.2.0",
      "resolved": "https://registry.npmjs.org/postcss-value-parser/-/postcss-value-parser-4.2.0.tgz",
      "integrity": "sha512-1NNCs6uurfkVbeXG4S8JFT9t19m45ICnif8zWLd5oPSZ50QnwMfK+H3jv408d4jw/7Bttv5axS5IiHoLaVNHeQ==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/prelude-ls": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/prelude-ls/-/prelude-ls-1.2.1.tgz",
      "integrity": "sha512-vkcDPrRZo1QZLbn5RLGPpg/WmIQ65qoWWhcGKf/b5eplkkarX0m9z8ppCat4mlOqUsWpyNuYgO3VRyrYHSzX5g==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/punycode": {
      "version": "2.3.1",
      "resolved": "https://registry.npmjs.org/punycode/-/punycode-2.3.1.tgz",
      "integrity": "sha512-vYt7UD1U9Wg6138shLtLOvdAu+8DsC/ilFtEVHcH+wydcSpNE20AfSOduf6MkRFahL5FY7X1oU7nKVZFtfq8Fg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/react": {
      "version": "19.2.0",
      "resolved": "https://registry.npmjs.org/react/-/react-19.2.0.tgz",
      "integrity": "sha512-tmbWg6W31tQLeB5cdIBOicJDJRR2KzXsV7uSK9iNfLWQ5bIZfxuPEHp7M8wiHyHnn0DD1i7w3Zmin0FtkrwoCQ==",
      "license": "MIT",
      "peer": true,
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/react-dom": {
      "version": "19.2.0",
      "resolved": "https://registry.npmjs.org/react-dom/-/react-dom-19.2.0.tgz",
      "integrity": "sha512-UlbRu4cAiGaIewkPyiRGJk0imDN2T3JjieT6spoL2UeSf5od4n5LB/mQ4ejmxhCFT1tYe8IvaFulzynWovsEFQ==",
      "license": "MIT",
      "dependencies": {
        "scheduler": "^0.27.0"
      },
      "peerDependencies": {
        "react": "^19.2.0"
      }
    },
    "node_modules/react-refresh": {
      "version": "0.18.0",
      "resolved": "https://registry.npmjs.org/react-refresh/-/react-refresh-0.18.0.tgz",
      "integrity": "sha512-QgT5//D3jfjJb6Gsjxv0Slpj23ip+HtOpnNgnb2S5zU3CB26G/IDPGoy4RJB42wzFE46DRsstbW6tKHoKbhAxw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/resolve-from": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/resolve-from/-/resolve-from-4.0.0.tgz",
      "integrity": "sha512-pb/MYmXstAkysRFx8piNI1tGFNQIFA3vkE3Gq4EuA1dF6gHp/+vgZqsCGJapvy8N3Q+4o7FwvquPJcnZ7RYy4g==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/rollup": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/rollup/-/rollup-4.53.3.tgz",
      "integrity": "sha512-w8GmOxZfBmKknvdXU1sdM9NHcoQejwF/4mNgj2JuEEdRaHwwF12K7e9eXn1nLZ07ad+du76mkVsyeb2rKGllsA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/estree": "1.0.8"
      },
      "bin": {
        "rollup": "dist/bin/rollup"
      },
      "engines": {
        "node": ">=18.0.0",
        "npm": ">=8.0.0"
      },
      "optionalDependencies": {
        "@rollup/rollup-android-arm-eabi": "4.53.3",
        "@rollup/rollup-android-arm64": "4.53.3",
        "@rollup/rollup-darwin-arm64": "4.53.3",
        "@rollup/rollup-darwin-x64": "4.53.3",
        "@rollup/rollup-freebsd-arm64": "4.53.3",
        "@rollup/rollup-freebsd-x64": "4.53.3",
        "@rollup/rollup-linux-arm-gnueabihf": "4.53.3",
        "@rollup/rollup-linux-arm-musleabihf": "4.53.3",
        "@rollup/rollup-linux-arm64-gnu": "4.53.3",
        "@rollup/rollup-linux-arm64-musl": "4.53.3",
        "@rollup/rollup-linux-loong64-gnu": "4.53.3",
        "@rollup/rollup-linux-ppc64-gnu": "4.53.3",
        "@rollup/rollup-linux-riscv64-gnu": "4.53.3",
        "@rollup/rollup-linux-riscv64-musl": "4.53.3",
        "@rollup/rollup-linux-s390x-gnu": "4.53.3",
        "@rollup/rollup-linux-x64-gnu": "4.53.3",
        "@rollup/rollup-linux-x64-musl": "4.53.3",
        "@rollup/rollup-openharmony-arm64": "4.53.3",
        "@rollup/rollup-win32-arm64-msvc": "4.53.3",
        "@rollup/rollup-win32-ia32-msvc": "4.53.3",
        "@rollup/rollup-win32-x64-gnu": "4.53.3",
        "@rollup/rollup-win32-x64-msvc": "4.53.3",
        "fsevents": "~2.3.2"
      }
    },
    "node_modules/rollup/node_modules/@rollup/rollup-win32-x64-msvc": {
      "version": "4.53.3",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-msvc/-/rollup-win32-x64-msvc-4.53.3.tgz",
      "integrity": "sha512-UhTd8u31dXadv0MopwGgNOBpUVROFKWVQgAg5N1ESyCz8AuBcMqm4AuTjrwgQKGDfoFuz02EuMRHQIw/frmYKQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/scheduler": {
      "version": "0.27.0",
      "resolved": "https://registry.npmjs.org/scheduler/-/scheduler-0.27.0.tgz",
      "integrity": "sha512-eNv+WrVbKu1f3vbYJT/xtiF5syA5HPIMtf9IgY/nKg0sWqzAUEvqY/xm7OcZc/qafLx/iO9FgOmeSAp4v5ti/Q==",
      "license": "MIT"
    },
    "node_modules/semver": {
      "version": "6.3.1",
      "resolved": "https://registry.npmjs.org/semver/-/semver-6.3.1.tgz",
      "integrity": "sha512-BR7VvDCVHO+q2xBEWskxS6DJE1qRnb7DxzUrogb71CWoSficBxYsiAGd+Kl0mmq/MprG9yArRkyrQxTO6XjMzA==",
      "dev": true,
      "license": "ISC",
      "bin": {
        "semver": "bin/semver.js"
      }
    },
    "node_modules/shebang-command": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/shebang-command/-/shebang-command-2.0.0.tgz",
      "integrity": "sha512-kHxr2zZpYtdmrN1qDjrrX/Z1rR1kG8Dx+gkpK1G4eXmvXswmcE1hTWBWYUzlraYw1/yZp6YuDY77YtvbN0dmDA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "shebang-regex": "^3.0.0"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/shebang-regex": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/shebang-regex/-/shebang-regex-3.0.0.tgz",
      "integrity": "sha512-7++dFhtcx3353uBaq8DDR4NuxBetBzC7ZQOhmTQInHEd6bSrXdiEyzCvG07Z44UYdLShWUyXt5M/yhz8ekcb1A==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/source-map-js": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/source-map-js/-/source-map-js-1.2.1.tgz",
      "integrity": "sha512-UXWMKhLOwVKb728IUtQPXxfYU+usdybtUrK/8uGE8CQMvrhOpwvzDBwj0QhSL7MQc7vIsISBG8VQ8+IDQxpfQA==",
      "dev": true,
      "license": "BSD-3-Clause",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/strip-json-comments": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/strip-json-comments/-/strip-json-comments-3.1.1.tgz",
      "integrity": "sha512-6fPc+R4ihwqP6N/aIv2f1gMH8lOVtWQHoqC4yK6oSDVVocumAsfCqjkXnqiYMhmMwS/mEHLp7Vehlt3ql6lEig==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/supports-color": {
      "version": "7.2.0",
      "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-7.2.0.tgz",
      "integrity": "sha512-qpCAvRl9stuOHveKsn7HncJRvv501qIacKzQlO/+Lwxc9+0q2wLyv4Dfvt80/DPn2pqOBsJdDiogXGR9+OvwRw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "has-flag": "^4.0.0"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/tailwindcss": {
      "version": "4.1.17",
      "resolved": "https://registry.npmjs.org/tailwindcss/-/tailwindcss-4.1.17.tgz",
      "integrity": "sha512-j9Ee2YjuQqYT9bbRTfTZht9W/ytp5H+jJpZKiYdP/bpnXARAuELt9ofP0lPnmHjbga7SNQIxdTAXCmtKVYjN+Q==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/tapable": {
      "version": "2.3.0",
      "resolved": "https://registry.npmjs.org/tapable/-/tapable-2.3.0.tgz",
      "integrity": "sha512-g9ljZiwki/LfxmQADO3dEY1CbpmXT5Hm2fJ+QaGKwSXUylMybePR7/67YW7jOrrvjEgL1Fmz5kzyAjWVWLlucg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/webpack"
      }
    },
    "node_modules/tinyglobby": {
      "version": "0.2.15",
      "resolved": "https://registry.npmjs.org/tinyglobby/-/tinyglobby-0.2.15.tgz",
      "integrity": "sha512-j2Zq4NyQYG5XMST4cbs02Ak8iJUdxRM0XI5QyxXuZOzKOINmWurp3smXu3y5wDcJrptwpSjgXHzIQxR0omXljQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "fdir": "^6.5.0",
        "picomatch": "^4.0.3"
      },
      "engines": {
        "node": ">=12.0.0"
      },
      "funding": {
        "url": "https://github.com/sponsors/SuperchupuDev"
      }
    },
    "node_modules/type-check": {
      "version": "0.4.0",
      "resolved": "https://registry.npmjs.org/type-check/-/type-check-0.4.0.tgz",
      "integrity": "sha512-XleUoc9uwGXqjWwXaUTZAmzMcFZ5858QA2vvx1Ur5xIcixXIP+8LnFDgRplU30us6teqdlskFfu+ae4K79Ooew==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "prelude-ls": "^1.2.1"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/update-browserslist-db": {
      "version": "1.1.4",
      "resolved": "https://registry.npmjs.org/update-browserslist-db/-/update-browserslist-db-1.1.4.tgz",
      "integrity": "sha512-q0SPT4xyU84saUX+tomz1WLkxUbuaJnR1xWt17M7fJtEJigJeWUNGUqrauFXsHnqev9y9JTRGwk13tFBuKby4A==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/browserslist"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "escalade": "^3.2.0",
        "picocolors": "^1.1.1"
      },
      "bin": {
        "update-browserslist-db": "cli.js"
      },
      "peerDependencies": {
        "browserslist": ">= 4.21.0"
      }
    },
    "node_modules/uri-js": {
      "version": "4.4.1",
      "resolved": "https://registry.npmjs.org/uri-js/-/uri-js-4.4.1.tgz",
      "integrity": "sha512-7rKUyy33Q1yc98pQ1DAmLtwX109F7TIfWlW1Ydo8Wl1ii1SeHieeh0HHfPeL2fMXK6z0s8ecKs9frCuLJvndBg==",
      "dev": true,
      "license": "BSD-2-Clause",
      "dependencies": {
        "punycode": "^2.1.0"
      }
    },
    "node_modules/vite": {
      "version": "7.2.4",
      "resolved": "https://registry.npmjs.org/vite/-/vite-7.2.4.tgz",
      "integrity": "sha512-NL8jTlbo0Tn4dUEXEsUg8KeyG/Lkmc4Fnzb8JXN/Ykm9G4HNImjtABMJgkQoVjOBN/j2WAwDTRytdqJbZsah7w==",
      "dev": true,
      "license": "MIT",
      "peer": true,
      "dependencies": {
        "esbuild": "^0.25.0",
        "fdir": "^6.5.0",
        "picomatch": "^4.0.3",
        "postcss": "^8.5.6",
        "rollup": "^4.43.0",
        "tinyglobby": "^0.2.15"
      },
      "bin": {
        "vite": "bin/vite.js"
      },
      "engines": {
        "node": "^20.19.0 || >=22.12.0"
      },
      "funding": {
        "url": "https://github.com/vitejs/vite?sponsor=1"
      },
      "optionalDependencies": {
        "fsevents": "~2.3.3"
      },
      "peerDependencies": {
        "@types/node": "^20.19.0 || >=22.12.0",
        "jiti": ">=1.21.0",
        "less": "^4.0.0",
        "lightningcss": "^1.21.0",
        "sass": "^1.70.0",
        "sass-embedded": "^1.70.0",
        "stylus": ">=0.54.8",
        "sugarss": "^5.0.0",
        "terser": "^5.16.0",
        "tsx": "^4.8.1",
        "yaml": "^2.4.2"
      },
      "peerDependenciesMeta": {
        "@types/node": {
          "optional": true
        },
        "jiti": {
          "optional": true
        },
        "less": {
          "optional": true
        },
        "lightningcss": {
          "optional": true
        },
        "sass": {
          "optional": true
        },
        "sass-embedded": {
          "optional": true
        },
        "stylus": {
          "optional": true
        },
        "sugarss": {
          "optional": true
        },
        "terser": {
          "optional": true
        },
        "tsx": {
          "optional": true
        },
        "yaml": {
          "optional": true
        }
      }
    },
    "node_modules/which": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/which/-/which-2.0.2.tgz",
      "integrity": "sha512-BLI3Tl1TW3Pvl70l3yq3Y64i+awpwXqsGBYWkkqMtnbXgrMD+yj7rhW0kuEDxzJaYXGjEW5ogapKNMEKNMjibA==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "isexe": "^2.0.0"
      },
      "bin": {
        "node-which": "bin/node-which"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/word-wrap": {
      "version": "1.2.5",
      "resolved": "https://registry.npmjs.org/word-wrap/-/word-wrap-1.2.5.tgz",
      "integrity": "sha512-BN22B5eaMMI9UMtjrGd5g5eCYPpCPDUy0FJXbYsaT5zYxjFOckS53SQDE3pWkVoWpHXVb3BrYcEN4Twa55B5cA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/yallist": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/yallist/-/yallist-3.1.1.tgz",
      "integrity": "sha512-a4UGQaWPH59mOXUYnAG2ewncQS4i4F43Tv3JoAM+s2VDAmS9NsK8GpDMLrCHPksFT7h3K6TOoUNn2pb7RoXx4g==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/yocto-queue": {
      "version": "0.1.0",
      "resolved": "https://registry.npmjs.org/yocto-queue/-/yocto-queue-0.1.0.tgz",
      "integrity": "sha512-rVksvsnNCdJ/ohGc6xgPwyN8eheCxsiLM8mxuE/t/mOVqJewPuO1miLpTHQiRgTKCLexL4MeAFVagts7HmNZ2Q==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/zod": {
      "version": "4.1.13",
      "resolved": "https://registry.npmjs.org/zod/-/zod-4.1.13.tgz",
      "integrity": "sha512-AvvthqfqrAhNH9dnfmrfKzX5upOdjUVJYFqNSlkmGf64gRaTzlPwz99IHYnVs28qYAybvAlBV+H7pn0saFY4Ig==",
      "dev": true,
      "license": "MIT",
      "peer": true,
      "funding": {
        "url": "https://github.com/sponsors/colinhacks"
      }
    },
    "node_modules/zod-validation-error": {
      "version": "4.0.2",
      "resolved": "https://registry.npmjs.org/zod-validation-error/-/zod-validation-error-4.0.2.tgz",
      "integrity": "sha512-Q6/nZLe6jxuU80qb/4uJ4t5v2VEZ44lzQjPDhYJNztRQ4wyWc6VF3D3Kb/fAuPetZQnhS3hnajCf9CsWesghLQ==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=18.0.0"
      },
      "peerDependencies": {
        "zod": "^3.25.0 || ^4.0.0"
      }
    }
  }
}


===== FILE: app_frontend\postcss.config.js =====
// app_frontend/postcss.config.js
export default {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};






===== FILE: app_frontend\public\missionlog\status_snapshot.json =====
{
  "generated_at": "2025-12-07T07:48:56Z",
  "epics": [
    {
      "epic_id": "E00",
      "name": "Application Bootstrapping",
      "overall_status": "Complete",
      "features": [
        {
          "feature_id": "FT-00-BE",
          "name": "Backend Fundamentals",
          "epic_id": "E00",
          "overall_status": "Complete",
          "stories": [
            {
              "story_id": "ST-00",
              "name": "Provide Basic Backend API Availability",
              "feature_id": "FT-00-BE",
              "overall_status": "Complete",
              "testing_status": "pass",
              "halo_adherence": "pass",
              "guardrail_adherence": "pass",
              "code_quality_adherence": "pass",
              "security_policy_adherence": "pass"
            }
          ]
        }
      ]
    },
    {
      "epic_id": "E00-UI",
      "name": "User Interface Bootstrapping",
      "overall_status": "In Progress",
      "features": [
        {
          "feature_id": "FT-00-UI",
          "name": "Frontend Fundamentals",
          "epic_id": "E00-UI",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-00-FRONTEND-UI-SHELL",
              "name": "Provide Frontend UI Shell Availability",
              "feature_id": "FT-00-UI",
              "overall_status": "In Progress",
              "testing_status": "pass",
              "halo_adherence": "pass",
              "guardrail_adherence": "not_run",
              "code_quality_adherence": "pass",
              "security_policy_adherence": "pass"
            }
          ]
        }
      ]
    },
    {
      "epic_id": "EP-01",
      "name": "Client Ingestion & Normalisation",
      "overall_status": "In Progress",
      "features": [
        {
          "feature_id": "FT-01",
          "name": "Source System Configuration",
          "epic_id": "EP-01",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-01",
              "name": "Register CRM source",
              "feature_id": "FT-01",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            },
            {
              "story_id": "ST-02",
              "name": "Register KYC source",
              "feature_id": "FT-01",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        },
        {
          "feature_id": "FT-02",
          "name": "Schema Mapping to Canonical Model",
          "epic_id": "EP-01",
          "overall_status": "Complete",
          "stories": [
            {
              "story_id": "ST-03",
              "name": "Map identity fields",
              "feature_id": "FT-02",
              "overall_status": "Complete",
              "testing_status": "pass",
              "halo_adherence": "pass",
              "guardrail_adherence": "pass",
              "code_quality_adherence": "pass",
              "security_policy_adherence": "pass"
            },
            {
              "story_id": "ST-04",
              "name": "Map identifiers",
              "feature_id": "FT-02",
              "overall_status": "Complete",
              "testing_status": "pass",
              "halo_adherence": "pass",
              "guardrail_adherence": "pass",
              "code_quality_adherence": "pass",
              "security_policy_adherence": "pass"
            }
          ]
        },
        {
          "feature_id": "FT-03",
          "name": "Initial Bulk Ingestion",
          "epic_id": "EP-01",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-05",
              "name": "Bulk load CRM",
              "feature_id": "FT-03",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            },
            {
              "story_id": "ST-06",
              "name": "Bulk load KYC",
              "feature_id": "FT-03",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        },
        {
          "feature_id": "FT-04",
          "name": "Incremental Ingestion & Change Detection",
          "epic_id": "EP-01",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-07",
              "name": "Detect upstream deltas",
              "feature_id": "FT-04",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            },
            {
              "story_id": "ST-08",
              "name": "Apply deltas",
              "feature_id": "FT-04",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        }
      ]
    },
    {
      "epic_id": "EP-02",
      "name": "Client Matching & Golden Record",
      "overall_status": "In Progress",
      "features": [
        {
          "feature_id": "FT-05",
          "name": "Exact Match Rules",
          "epic_id": "EP-02",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-09",
              "name": "Match by tax ID",
              "feature_id": "FT-05",
              "overall_status": "Complete",
              "testing_status": "pass",
              "halo_adherence": "pass",
              "guardrail_adherence": "pass",
              "code_quality_adherence": "pass",
              "security_policy_adherence": "pass"
            },
            {
              "story_id": "ST-10",
              "name": "Match by registration number",
              "feature_id": "FT-05",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        },
        {
          "feature_id": "FT-06",
          "name": "Fuzzy & Probabilistic Matching",
          "epic_id": "EP-02",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-11",
              "name": "Fuzzy name match",
              "feature_id": "FT-06",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            },
            {
              "story_id": "ST-12",
              "name": "Attribute confidence",
              "feature_id": "FT-06",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        },
        {
          "feature_id": "FT-07",
          "name": "Golden Record Construction",
          "epic_id": "EP-02",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-13",
              "name": "Merge identity",
              "feature_id": "FT-07",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            },
            {
              "story_id": "ST-14",
              "name": "Merge addresses",
              "feature_id": "FT-07",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            },
            {
              "story_id": "ST-15",
              "name": "Record lineage",
              "feature_id": "FT-07",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        }
      ]
    },
    {
      "epic_id": "EP-03",
      "name": "Client Search",
      "overall_status": "In Progress",
      "features": [
        {
          "feature_id": "FT-08",
          "name": "Search Index & Normalisation",
          "epic_id": "EP-03",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-16",
              "name": "Build index",
              "feature_id": "FT-08",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            },
            {
              "story_id": "ST-17",
              "name": "Normalise search fields",
              "feature_id": "FT-08",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        },
        {
          "feature_id": "FT-09",
          "name": "Fuzzy Search & Ranking",
          "epic_id": "EP-03",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-18",
              "name": "Fuzzy search queries",
              "feature_id": "FT-09",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            },
            {
              "story_id": "ST-19",
              "name": "Search ranking",
              "feature_id": "FT-09",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        }
      ]
    },
    {
      "epic_id": "EP-04",
      "name": "Client Profile Assembly",
      "overall_status": "In Progress",
      "features": [
        {
          "feature_id": "FT-10",
          "name": "Assemble Canonical Profile",
          "epic_id": "EP-04",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-20",
              "name": "Assemble base profile",
              "feature_id": "FT-10",
              "overall_status": "Complete",
              "testing_status": "pass",
              "halo_adherence": "pass",
              "guardrail_adherence": "pass",
              "code_quality_adherence": "pass",
              "security_policy_adherence": "pass"
            },
            {
              "story_id": "ST-21",
              "name": "Assemble metadata",
              "feature_id": "FT-10",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        },
        {
          "feature_id": "FT-11",
          "name": "Lineage Exposure",
          "epic_id": "EP-04",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-22",
              "name": "Expose lineage",
              "feature_id": "FT-11",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            },
            {
              "story_id": "ST-23",
              "name": "Drill-down lineage",
              "feature_id": "FT-11",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        },
        {
          "feature_id": "FT-12",
          "name": "Conflict Presentation",
          "epic_id": "EP-04",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-24",
              "name": "Flag conflicts",
              "feature_id": "FT-12",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            },
            {
              "story_id": "ST-25",
              "name": "Show merge logic",
              "feature_id": "FT-12",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        }
      ]
    },
    {
      "epic_id": "EP-05",
      "name": "Data Quality & Lineage",
      "overall_status": "In Progress",
      "features": [
        {
          "feature_id": "FT-13",
          "name": "Lineage Tracking",
          "epic_id": "EP-05",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-26",
              "name": "Store lineage history",
              "feature_id": "FT-13",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            },
            {
              "story_id": "ST-27",
              "name": "Timestamp lineage",
              "feature_id": "FT-13",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        },
        {
          "feature_id": "FT-14",
          "name": "Data Quality Scoring",
          "epic_id": "EP-05",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-28",
              "name": "Compute freshness",
              "feature_id": "FT-14",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            },
            {
              "story_id": "ST-29",
              "name": "Compute completeness",
              "feature_id": "FT-14",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        },
        {
          "feature_id": "FT-15",
          "name": "Auditability & Evidence",
          "epic_id": "EP-05",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-30",
              "name": "Audit ingestion",
              "feature_id": "FT-15",
              "overall_status": "In Progress",
              "testing_status": "pass",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "pass",
              "security_policy_adherence": "pass"
            },
            {
              "story_id": "ST-31",
              "name": "Audit merge",
              "feature_id": "FT-15",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        }
      ]
    },
    {
      "epic_id": "EP-06",
      "name": "Integration & API Exposure",
      "overall_status": "In Progress",
      "features": [
        {
          "feature_id": "FT-16",
          "name": "Search API",
          "epic_id": "EP-06",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-32",
              "name": "Search API basic",
              "feature_id": "FT-16",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            },
            {
              "story_id": "ST-33",
              "name": "Search API ranking",
              "feature_id": "FT-16",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        },
        {
          "feature_id": "FT-17",
          "name": "Client Profile API",
          "epic_id": "EP-06",
          "overall_status": "In Progress",
          "stories": [
            {
              "story_id": "ST-34",
              "name": "Profile API basic",
              "feature_id": "FT-17",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            },
            {
              "story_id": "ST-35",
              "name": "Profile API lineage",
              "feature_id": "FT-17",
              "overall_status": "In Progress",
              "testing_status": "not_run",
              "halo_adherence": "pass",
              "guardrail_adherence": "fail",
              "code_quality_adherence": "fail",
              "security_policy_adherence": "fail"
            }
          ]
        }
      ]
    }
  ]
}

===== FILE: app_frontend\public\MissionSmith-M7-SingleClientView.html =====
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MissionSmith</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{ --lp-border:#d9e2ea; --lp-text:#243745; }
    #launchpad .lp-actions > .lp-pill{
      appearance:none;display:inline-flex;align-items:center;justify-content:center;
      height:34px;padding:0 12px;width:132px;border-radius:999px;border:1px solid var(--lp-border);
      background:#f5f9fb;color:var(--lp-text);font-weight:600;font-size:13.5px;white-space:nowrap;
      transition:transform .06s ease,background .15s ease,border-color .15s ease;cursor:pointer;
    }
    #launchpad .lp-actions > .lp-pill:hover{ transform:translateY(-1px); background:#eef5f8; border-color:#c9d6e1; }
  </style>


  <style>
    :root{ --lp-border:#d9e2ea; --lp-text:#243745; }
    header.sticky.top-0 { background: rgba(255,255,255,.70); backdrop-filter: blur(4px); border-bottom:1px solid #e5e7eb; }
    header.sticky.top-0 > .mx-auto { max-width: 80rem; padding-left: 1rem; padding-right: 1rem; }
    header.sticky.top-0 .flex.items-center.gap-2 > button,
    header.sticky.top-0 .msx-framework-btn{
      appearance:none; display:inline-flex; align-items:center; justify-content:center;
      height:34px; padding:0 14px; min-width:220px;
      border-radius:999px; border:1px solid var(--lp-border);
      background:#f5f9fb; color:var(--lp-text); font-weight:600; font-size:13.5px; white-space:nowrap;
      transition:transform .06s ease, border-color .15s ease, background .15s ease; cursor:pointer;
    }
    header.sticky.top-0 .flex.items-center.gap-2 > button:hover,
    header.sticky.top-0 .msx-framework-btn:hover { transform:translateY(-1px); border-color:#c9d6e1; background:#eef5f8; }
    /* Teal badge gloss (if present) */
    header.sticky.top-0 .flex.items-center.gap-3 .h-7.w-7.rounded-xl{
      border-radius:9999px !important;
      background: radial-gradient(ellipse at 65% 35%, rgba(255,255,255,.22), rgba(255,255,255,0) 40%), #1ba39c !important;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.05), 0 1px 2px rgba(0,0,0,.06);
    }
  </style>

</head>
<body class="min-h-screen bg-gray-50">
  
<!-- ms-actions removed by request -->
</div>


<!-- ===== LaunchPad (functional shortcuts) ===== -->
<div id="launchpad" style="position:sticky;top:0;z-index:60;background:#fff;border-bottom:1px solid #d9e2ea;backdrop-filter:blur(4px);">
  <div class="inner" style="max-width:80rem;margin:0 auto;padding:0 1rem;">
    <div class="bar" style="display:flex;align-items:center;gap:8px;padding:10px 0;">
      <div class="lp-title" style="font-weight:700;color:#5e6b77;">LaunchPad</div>
      <div style="flex:1 1 auto;"></div>
      <div class="lp-actions" style="display:inline-flex;gap:8px;align-items:center;">
        <button onclick="try{MS_actions.generateAgents&&MS_actions.generateAgents()}catch(e){console.error(e)}" class="lp-pill">Agents</button>
        <button onclick="try{MS_actions.generateScaffold&&MS_actions.generateScaffold()}catch(e){console.error(e)}" class="lp-pill">Microservices</button>
        <button onclick="try{MS_actions.generateCICD&&MS_actions.generateCICD()}catch(e){console.error(e)}" class="lp-pill">CI/CD</button>
        <button onclick="try{MS_actions.generateDeploy&&MS_actions.generateDeploy()}catch(e){console.error(e)}" class="lp-pill">IaC</button>
        <button onclick="try{MS_actions.generatePolicies&&MS_actions.generatePolicies()}catch(e){console.error(e)}" class="lp-pill">Policies</button>
        <button onclick="try{MS_actions.generateLineage&&MS_actions.generateLineage()}catch(e){console.error(e)}" class="lp-pill">Lineage</button>
        <button onclick="(window.MS_actions&&MS_actions.generateAnalytics)?MS_actions.generateAnalytics():console.warn('Analytics handler missing')" class="lp-pill">Analytics</button>
      </div>
    </div>
  </div>
</div>

<div id="root"></div>
  <script type="text/babel" data-presets="env,react">

const { useMemo, useState, useEffect } = React;

/********************
 * CSV helpers + tests
 ********************/
const LB_RE = new RegExp("\\r\\n?|\\r", "g");
function splitLines(raw) {
  // Normalize CRLF || CR to LF, then split
  return raw.replace(LB_RE, "\n").split("\n");
}

function parseCSVSimple(text) {
  const lines = splitLines(text).filter(Boolean);
  if (lines.length < 2) return { headers: [], rows: [] };
  const headers = lines[0].split(",").map((h) => h.trim());
  const rows = lines.slice(1).map((line) => {
    const cells = line.split(",");
    const obj = {};
    headers.forEach((h, i) => (obj[h] = cells[i] ?? ""));
    return obj;
  });
  return { headers, rows };
}

// Self-tests (console)
(function runSelfTests() {
  const inputs = [
    { label: "LF", text: "a,b\\n1,2\\n3,4" },
    { label: "CRLF", text: "a,b\\r\\n1,2\\r\\n3,4" },
    { label: "CR", text: "a,b\\r1,2\\r3,4" },
  ];
  inputs.forEach(({ label, text }) => {
    const real = text
      .split("\\r\\n").join("\\r\\n")
      .split("\\n").join("\\n")
      .split("\\r").join("\\r");
    const { headers, rows } = parseCSVSimple(real
      .replace(/\\r\\n/g, "\r\n")
      .replace(/\\n/g, "\n")
      .replace(/\\r/g, "\r"));
    const ok = headers.length === 2 && rows.length === 2;
    // eslint-disable-next-line no-console
    console.log("CSV " + label + " split test: " + (ok ? "pass" : "fail"));
  });
})();

/********************
 * Initial data
 ********************/
const today = new Date().toISOString().split("T")[0];

const initialData = {
  "missionInfo": {
    "title": "M7 Single Client View",
    "sponsor": "Leon Orr",
    "owner": "Leon Orr",
    "stakeholders": "Leon Orr",
    "version": "v0.1",
    "description": "M7 Single Client View",
    "date": "2025-10-04"
  },
  "serviceConfig": {
    "default_service_name": "example-service",
    "default_backend_language": "java",
    "default_backend_framework": "spring-boot",
    "default_ui_language": "react18",
    "default_ui_framework": "nextjs",
    "default_database": "postgres",
    "default_migration_tool": "flyway",
    "default_outbox_enabled": true,
    "observability": {
      "tracing": "otel",
      "metrics": "red",
      "logs": "json",
      "otel_sampler": "parentbased_traceidratio",
      "otel_sampler_arg": 0.1
    },
    "security": {
      "authn": [
        "jwt"
      ],
      "authz": [
        "opa"
      ],
      "cors_allowlist": [
        "http://localhost:3000",
        "http://localhost:5173"
      ],
      "secrets_management": "vault",
      "image_signing": "cosign",
      "base_image_registry": "ghcr.io"
    },
    "nfr": {
      "slo": [
        {
          "name": "http_p95_ms",
          "target": 150
        },
        {
          "name": "error_rate",
          "target": "0.5%"
        },
        {
          "name": "availability",
          "target": "99.9%"
        },
        {
          "name": "throughput_rps",
          "target": ">=50"
        }
      ],
      "resilience": {
        "circuit_breaker": true,
        "retries": {
          "max": 3,
          "strategy": "exponential-jitter"
        },
        "idempotency_policy": "mutations_required",
        "graceful_shutdown_timeout_s": 20
      }
    },
    "governance": {
      "lineage": "required",
      "policy_packs": [
        "no-wildcard-iam",
        "no-plaintext-internal",
        "no-pii-in-logs",
        "signed-images-only",
        "mission-labels-required"
      ],
      "adr_required": true
    },
    "ci": {
      "gates": [
        "typecheck",
        "unit",
        "contract",
        "integration",
        "property",
        "sast",
        "sbom",
        "iac",
        "schema-compat",
        "docker-scan",
        "policy"
      ],
      "coverage_min": 0.8,
      "lint_required": true,
      "evidence_artifacts": [
        "junit.xml",
        "coverage.json",
        "conftest.json",
        "sbom.spdx.json",
        "lineage.json"
      ]
    },
    "deploy": {
      "default_strategy": "canary",
      "feature_flags": true,
      "namespace": "mission",
      "require_labels": {
        "mission/reference": true,
        "mission/theme": true,
        "mission/topic": true
      },
      "admission_policies": [
        "sigstore-verify",
        "mission-labels",
        "health-endpoints"
      ],
      "rollback": {
        "enabled": true,
        "validate_quarterly": true
      }
    },
    "ownership": {
      "owner": ""
    },
    "api": {
      "require_openapi": true,
      "contract_path": "openapi.yaml",
      "health_endpoints": [
        "/health",
        "/ready",
        "/version"
      ]
    },
    "data": {
      "golden_source_required": true,
      "openapi_tag": "x-golden-source",
      "allowed_topics": [
        "pricing",
        "counterparty",
        "orders",
        "trades"
      ]
    },
    "images": {
      "signed_only": true,
      "max_image_size_mb": 500,
      "approved_bases": [
        "ghcr.io/distroless",
        "gcr.io/distroless",
        "alpine:3"
      ]
    }
  },
  "objectives": [
    {
      "ref": "OBJ-001",
      "category": "Mission Objectives",
      "theme": "Data Integrity",
      "topic": "Golden Source",
      "codify": "API contract registry; OpenAPI refs include `x-golden-source=true`.",
      "automate": "OPA rule validates data-source tags during build.",
      "intercept": "CI fails if endpoint lacks `x-golden-source` tag.",
      "prove": "Build report confirming \u201cAll data sources validated as golden.\u201d",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Ensure all services consume and publish data only via golden-source APIs or message topics.",
      "decision": true
    },
    {
      "ref": "OBJ-002",
      "category": "Mission Objectives",
      "theme": "Automation & Delivery",
      "topic": "CI/CD Coverage",
      "codify": "`ci.yml` template required in every repo.",
      "automate": "GitHub Action executes on push and publishes artefact hash.",
      "intercept": "Pipeline missing \u2192 auto-raise issue or block merge.",
      "prove": "Successful workflow badge and artefact hash stored.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Every deployable unit must have a complete CI/CD pipeline that builds, tests, and produces a signed image.",
      "decision": true
    },
    {
      "ref": "OBJ-003",
      "category": "Mission Objectives",
      "theme": "Observability",
      "topic": "Telemetry",
      "codify": "Shared `otel-config.yaml` schema with standard field names.",
      "automate": "Build injects OpenTelemetry library and exporters.",
      "intercept": "Missing OTEL fields trigger alert in CI.",
      "prove": "Grafana dashboard shows active traces and metrics per service.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Standardise and auto-collect logs, metrics, and traces via OpenTelemetry.",
      "decision": true
    },
    {
      "ref": "OBJ-004",
      "category": "Mission Objectives",
      "theme": "Lineage & Traceability",
      "topic": "Artefact Discoverability",
      "codify": "`lineage.json` template emitted by pipeline.",
      "automate": "CI publishes lineage metadata to registry.",
      "intercept": "Missing lineage \u2192 build blocked or flagged.",
      "prove": "Lineage entry visible in OpenLineage UI.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Every artefact must be registered in the lineage registry with declared inputs and outputs.",
      "decision": true
    },
    {
      "ref": "OBJ-005",
      "category": "Mission Objectives",
      "theme": "Infrastructure as Code",
      "topic": "Declarative Systems",
      "codify": "Terraform, Rego, and Helm templates committed in repo.",
      "automate": "Terraform plan/apply and policy lint run in CI.",
      "intercept": "Missing IaC directory \u2192 CI warning.",
      "prove": "Verified `.tf` or `.rego` artefacts committed and validated.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "All infrastructure and policy must be declarative and stored as code.",
      "decision": true
    },
    {
      "ref": "OBJ-006",
      "category": "Mission Objectives",
      "theme": "Reliability",
      "topic": "Health Endpoints",
      "codify": "OpenAPI annotations define standard health contracts.",
      "automate": "CI test job queries these endpoints on every build.",
      "intercept": "Non-200 status blocks deploy.",
      "prove": "Automated test report shows uptime and response success.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Each service must expose `/health`, `/ready`, and `/version` endpoints.",
      "decision": true
    },
    {
      "ref": "OBJ-007",
      "category": "Mission Objectives",
      "theme": "Change Control",
      "topic": "Auditability",
      "codify": "Git commit metadata and versioned deployment manifests.",
      "automate": "CI annotates releases with actor and change reason.",
      "intercept": "Missing rollback metadata triggers warning.",
      "prove": "Version history and audit log linked to commit.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "All changes must be observable, reversible, and logged with human and agent attribution.",
      "decision": true
    }
  ],
  "principles": [
    {
      "ref": "PRI-001",
      "category": "Mission Principles",
      "theme": "Delivery Discipline",
      "topic": "Trunk-Based Development",
      "codify": "Branch protection rules; PR merge policy in GitHub.",
      "automate": "CI enforces merge checks and tests before commit to trunk.",
      "intercept": "Attempt to merge failing branch \u2192 PR blocked.",
      "prove": "Commit history shows <24h branch lifespan and green pipeline.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Maintain a single mainline branch; minimise long-lived feature branches.",
      "decision": true
    },
    {
      "ref": "PRI-002",
      "category": "Mission Principles",
      "theme": "Quality Assurance",
      "topic": "Evidence Before Release",
      "codify": "Release workflow requires `evidence.json` or build artefacts with test results.",
      "automate": "CI release job checks for evidence hash or signature.",
      "intercept": "Missing evidence file halts release job.",
      "prove": "Evidence artefact stored with release tag.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Deploy only when verifiable proof of readiness exists.",
      "decision": true
    },
    {
      "ref": "PRI-003",
      "category": "Mission Principles",
      "theme": "Design Integrity",
      "topic": "Everything as Code",
      "codify": "Repo structure includes `/infra`, `/policy`, `/docs` folders.",
      "automate": "Linter checks required directories and file patterns.",
      "intercept": "Missing directory \u2192 build warning or failure.",
      "prove": "Manifest of artefact types generated at build time.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "All infrastructure, policy, lineage, and documentation must be expressed as code.",
      "decision": true
    },
    {
      "ref": "PRI-004",
      "category": "Mission Principles",
      "theme": "Governance",
      "topic": "Guardrails Over Gates",
      "codify": "Rego/OPA rules define policy severity levels (`warn` vs `deny`).",
      "automate": "CI runs policy checks on each commit.",
      "intercept": "Exceeded threshold triggers issue but doesn\u2019t block build unless critical.",
      "prove": "Policy status log showing zero critical violations.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Automate compliance and quality controls without manual approval steps.",
      "decision": true
    },
    {
      "ref": "PRI-005",
      "category": "Mission Principles",
      "theme": "Automation",
      "topic": "Automate Where Evidence Exists",
      "codify": "Define measurable metrics in `mission-metrics.yaml`.",
      "automate": "CI executes tests or validations tied to those metrics.",
      "intercept": "Manual step found without automation tag \u2192 flag warning.",
      "prove": "Automated test coverage and metric dashboard.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Any measurable or testable requirement must be automated.",
      "decision": true
    },
    {
      "ref": "PRI-006",
      "category": "Mission Principles",
      "theme": "Observability",
      "topic": "Built-In Telemetry",
      "codify": "Shared instrumentation library (`otel-lib`).",
      "automate": "Static analysis ensures import of `otel-lib` or env var presence.",
      "intercept": "Missing instrumentation triggers build warning.",
      "prove": "Grafana dashboard populated automatically.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Embed observability hooks (logs, traces, metrics) in every template.",
      "decision": true
    },
    {
      "ref": "PRI-007",
      "category": "Mission Principles",
      "theme": "Stability & Reversibility",
      "topic": "Reproducible and Reversible Change",
      "codify": "Version manifests, Docker image digests, Terraform state snapshots.",
      "automate": "CI captures and archives state at build time.",
      "intercept": "Missing snapshot blocks promotion.",
      "prove": "Redeploy previous version reproduces same artefact hash.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Every artefact and deployment must be rebuildable and rollback-capable.",
      "decision": true
    }
  ],
  "guardrails": [
    {
      "ref": "GR-001",
      "category": "Mission Guardrails",
      "theme": "Logging Standards",
      "topic": "Structured JSON Logging",
      "codify": "Central `logging.jsonschema` published for all services.",
      "automate": "Linter or static analysis ensures schema compliance in CI.",
      "intercept": "CI fails if logs deviate from schema.",
      "prove": "Log sample validated against schema and included in evidence pack.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "All application logs must be structured JSON including request ID, user, and service context.",
      "decision": true
    },
    {
      "ref": "GR-002",
      "category": "Mission Guardrails",
      "theme": "Secrets Management",
      "topic": "No Hard-Coded Secrets",
      "codify": "`.secretlint.yml` or regex/entropy patterns in repo root.",
      "automate": "Secret scanner runs pre-commit and in CI.",
      "intercept": "Match found \u2192 merge blocked and issue created.",
      "prove": "CI artefact confirms \u201c0 secrets found.\u201d",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Repositories must not contain plaintext secrets or credentials.",
      "decision": true
    },
    {
      "ref": "GR-003",
      "category": "Mission Guardrails",
      "theme": "Testing Standards",
      "topic": "Automated Test Coverage",
      "codify": "Required `tests/` folder; test framework config present.",
      "automate": "CI runs test suite and reports coverage.",
      "intercept": "Test failures or missing coverage block pipeline.",
      "prove": "Test report attached to build artefacts.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Each repository must include automated unit and integration tests.",
      "decision": true
    },
    {
      "ref": "GR-004",
      "category": "Mission Guardrails",
      "theme": "API Governance",
      "topic": "Machine-Readable Contracts",
      "codify": "Presence of `openapi.yaml` or `schema.graphql`.",
      "automate": "Linter verifies schema syntax and completeness.",
      "intercept": "Missing or invalid schema \u2192 CI fails.",
      "prove": "Spec validated and linked in artefact manifest.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "All APIs must expose OpenAPI or GraphQL schema in repo root.",
      "decision": true
    },
    {
      "ref": "GR-005",
      "category": "Mission Guardrails",
      "theme": "Supply Chain Security",
      "topic": "Signed Base Images",
      "codify": "`Dockerfile` FROM statement restricted to whitelisted registries.",
      "automate": "CI verifies signature with Cosign/Sigstore.",
      "intercept": "Unsigned or unverified image blocks deployment.",
      "prove": "Signature verification log stored with image tag.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "All containers must originate from signed, approved base images.",
      "decision": true
    },
    {
      "ref": "GR-006",
      "category": "Mission Guardrails",
      "theme": "Data Lineage",
      "topic": "Source and Destination Tracking",
      "codify": "`lineage.json` or metadata annotations in code.",
      "automate": "CI publishes lineage metadata to OpenLineage registry.",
      "intercept": "Missing lineage entry triggers policy violation.",
      "prove": "Lineage visible in registry dashboard.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Every data pipeline or transformation must declare its source and destination.",
      "decision": true
    },
    {
      "ref": "GR-007",
      "category": "Mission Guardrails",
      "theme": "Operational Safety",
      "topic": "Rollback Readiness",
      "codify": "Rollback scripts or Helm history retained per environment.",
      "automate": "CI executes rollback dry-run quarterly.",
      "intercept": "Failed rollback test triggers alert.",
      "prove": "Report showing rollback simulation success.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "All deployments must have a defined and tested rollback mechanism.",
      "decision": true
    }
  ],
  "ground": [
    {
      "ref": "TOOL-001",
      "category": "Mission Tooling",
      "theme": "Source Control & Flow",
      "topic": "GitHub",
      "codify": "Repo initialised with `.github` config and branch protection rules.",
      "automate": "Enforce branch protection, required reviews, and signed commits.",
      "intercept": "PR fails if checks or reviews missing.",
      "prove": "Audit log of merges and signed commits.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Manage version control with branch protection and PR checks.",
      "decision": true
    },
    {
      "ref": "TOOL-002",
      "category": "Mission Tooling",
      "theme": "CI/CD",
      "topic": "GitHub Actions",
      "codify": "Standard `.github/workflows/ci.yml` templates.",
      "automate": "Actions triggered on push and pull requests.",
      "intercept": "Workflow failure blocks merge.",
      "prove": "CI badges and artefact hashes attached to releases.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Automate build, test, and deployment workflows.",
      "decision": true
    },
    {
      "ref": "TOOL-003",
      "category": "Mission Tooling",
      "theme": "IaC / Config",
      "topic": "Terraform",
      "codify": "`main.tf` defines environments and resources.",
      "automate": "Terraform plan/apply in pipeline.",
      "intercept": "Drift detection alerts in CI.",
      "prove": "Terraform plan output archived with build.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Provision cloud and infrastructure declaratively.",
      "decision": true
    },
    {
      "ref": "TOOL-004",
      "category": "Mission Tooling",
      "theme": "Policy Enforcement",
      "topic": "OPA / Conftest",
      "codify": "Policy packs in `/policy` folder.",
      "automate": "Conftest executes Rego policies in CI.",
      "intercept": "Violations flagged with severity.",
      "prove": "Conftest JSON output stored in build artefacts.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Enforce Mission Principles and Guardrails programmatically.",
      "decision": true
    },
    {
      "ref": "TOOL-005",
      "category": "Mission Tooling",
      "theme": "Observability",
      "topic": "OpenTelemetry + Grafana",
      "codify": "Shared `otel-config.yaml`; Grafana dashboards.",
      "automate": "Collector agents deployed automatically.",
      "intercept": "Missing OTEL data triggers alert.",
      "prove": "Dashboards display live telemetry.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Centralise logs, metrics, and traces across services.",
      "decision": true
    },
    {
      "ref": "TOOL-006",
      "category": "Mission Tooling",
      "theme": "Security / Secrets",
      "topic": "Trivy + Sigstore + Vault",
      "codify": "`trivy.yml` and Cosign key config.",
      "automate": "Trivy scan and Cosign signature in CI.",
      "intercept": "Vulnerabilities or unsigned images block deploy.",
      "prove": "Signed image logs + scan report stored.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Scan containers, sign images, and manage secrets.",
      "decision": true
    },
    {
      "ref": "TOOL-007",
      "category": "Mission Tooling",
      "theme": "Lineage & Metadata",
      "topic": "OpenLineage + Marquez",
      "codify": "`lineage.json` generated per pipeline.",
      "automate": "Pipeline publishes lineage metadata to registry.",
      "intercept": "Missing lineage raises CI warning.",
      "prove": "Lineage entries visible in Marquez UI.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Capture and visualise data lineage and build provenance.",
      "decision": true
    },
    {
      "ref": "TOOL-008",
      "category": "Mission Tooling",
      "theme": "Documentation",
      "topic": "MkDocs + Markdown ADRs",
      "codify": "`/docs` folder with Markdown and `mkdocs.yml`.",
      "automate": "Docs auto-built on merge to main.",
      "intercept": "Missing or broken link triggers warning.",
      "prove": "Published site and changelog per release.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Generate human-readable mission documentation.",
      "decision": true
    },
    {
      "ref": "TOOL-009",
      "category": "Mission Tooling",
      "theme": "AI Assist",
      "topic": "Copilot / ChatGPT / Gemini",
      "codify": "`.copilot` config and access policy.",
      "automate": "Inline AI suggestions enabled for approved repos.",
      "intercept": "None (advisory only).",
      "prove": "Generated docs and code reviews logged.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Support developers with contextual AI code and doc generation.",
      "decision": true
    },
    {
      "ref": "TOOL-010",
      "category": "Mission Tooling",
      "theme": "Containerisation",
      "topic": "Docker / Podman",
      "codify": "`Dockerfile` in each repo with approved base image.",
      "automate": "CI builds container images on every push.",
      "intercept": "Linting ensures image size and layer limits.",
      "prove": "Image digest and metadata captured in release.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Ensure consistent build artefacts and portable environments.",
      "decision": true
    },
    {
      "ref": "TOOL-011",
      "category": "Mission Tooling",
      "theme": "Deployment",
      "topic": "Kubernetes / Render / Cloud Run",
      "codify": "Helm charts or deployment manifests in `/deploy`.",
      "automate": "GitOps or CD workflow applies manifests.",
      "intercept": "Admission controller denies non-compliant deploys.",
      "prove": "Successful rollout recorded and observable.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Deploy applications in reproducible environments.",
      "decision": true
    },
    {
      "ref": "TOOL-012",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "Unit Tests",
      "codify": "`testing.md` lists per-lang defaults (Jest/Vitest, Pytest, JUnit, Go test).",
      "automate": "CI step runs `npm test` / `pytest` / `mvn test` / `go test`.",
      "intercept": "Non-zero exit blocks merge.",
      "prove": "JUnit/JSON test report uploaded.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Standardise on free unit-test frameworks per language.",
      "decision": true
    },
    {
      "ref": "TOOL-013",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "Contract Tests",
      "codify": "Pact files in `/contracts`; OpenAPI as source of truth.",
      "automate": "Pact tests run in CI; broker verification (OSS).",
      "intercept": "Failed verification blocks release.",
      "prove": "Pact verification report stored.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Enforce producer/consumer API contracts.",
      "decision": true
    },
    {
      "ref": "TOOL-014",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "API Tests",
      "codify": "Postman collections or `.http` specs in repo.",
      "automate": "Newman runs collections in CI.",
      "intercept": "Failing requests block pipeline.",
      "prove": "Newman HTML/JSON report artefact.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Automate API regression via collections.",
      "decision": true
    },
    {
      "ref": "TOOL-015",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "Integration (Containers)",
      "codify": "Testcontainers in test code; docker-compose for local.",
      "automate": "CI launches ephemeral containers for suites.",
      "intercept": "Startup/health failure fails job.",
      "prove": "Logs + container list archived.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Spin up real dependencies in tests.",
      "decision": true
    },
    {
      "ref": "TOOL-016",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "Performance / Load",
      "codify": "`k6` scripts in `/perf`.",
      "automate": "k6 runs on schedule or PR gates.",
      "intercept": "SLO breach flags PR or blocks merge (configurable).",
      "prove": "k6 summary + trend in artefacts.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Baseline latency and throughput SLIs.",
      "decision": true
    },
    {
      "ref": "TOOL-017",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "Dynamic Security",
      "codify": "ZAP baseline config in `/security/zap.yaml`.",
      "automate": "OWASP ZAP baseline scan in CI against preview URL.",
      "intercept": "High/critical issues block deploy.",
      "prove": "ZAP HTML report archived.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Catch common web vulnerabilities automatically.",
      "decision": true
    },
    {
      "ref": "TOOL-018",
      "category": "Mission Tooling",
      "theme": "Quality",
      "topic": "Static Analysis & Lint",
      "codify": "ESLint/Prettier, Flake8, golangci-lint configs.",
      "automate": "Lint job runs in CI on PRs.",
      "intercept": "Lint errors fail job.",
      "prove": "Lint report uploaded.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Enforce style and detect defects.",
      "decision": true
    },
    {
      "ref": "TOOL-019",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "Coverage",
      "codify": "Coverage config (nyc/Istanbul, coverage.py, JaCoCo).",
      "automate": "Coverage generated in CI; threshold gate optional.",
      "intercept": "Under-threshold blocks merge (if enabled).",
      "prove": "Coverage badge + report artefact.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Track and gate minimum coverage.",
      "decision": true
    },
    {
      "ref": "TOOL-020",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "UI End-to-End",
      "codify": "Playwright config + specs in `/e2e`.",
      "automate": "Playwright runs headless in CI.",
      "intercept": "Failing E2E blocks pipeline.",
      "prove": "Traces/videos uploaded by CI.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Cross-browser E2E tests.",
      "decision": true
    },
    {
      "ref": "TOOL-021",
      "category": "Mission Tooling",
      "theme": "Testing",
      "topic": "Service Virtualisation",
      "codify": "WireMock / MockServer configs in `/mocks`.",
      "automate": "Mock servers spun up in CI pre-test.",
      "intercept": "Mock startup failure fails job.",
      "prove": "Mock logs + mappings archived.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Decouple from unavailable or external dependencies.",
      "decision": true
    },
    {
      "ref": "TOOL-022",
      "category": "Mission Tooling",
      "theme": "Resilience",
      "topic": "Chaos Experiments",
      "codify": "LitmusChaos experiment manifests.",
      "automate": "Periodic chaos runs in non-prod.",
      "intercept": "Failed recovery raises incident.",
      "prove": "Chaos run report stored.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Validate graceful degradation and recovery.",
      "decision": true
    },
    {
      "ref": "TOOL-023",
      "category": "Mission Tooling",
      "theme": "Accessibility",
      "topic": "a11y Checks",
      "codify": "axe-core / pa11y configs and test scripts.",
      "automate": "a11y job runs on PRs.",
      "intercept": "WCAG violations flag PR / block per severity.",
      "prove": "a11y report artefact + trend.",
      "dependency": "None",
      "status": "proposed",
      "user_notes": "Embed accessibility testing for web UIs.",
      "decision": true
    }
  ]
};

/********************
 * Constants
 ********************/
const SECTIONS = [
  { key: "info", label: "Mission Info" },
  { key: "objectives", label: "Mission Objectives" },
  { key: "principles", label: "Mission Principles" },
  { key: "guardrails", label: "Mission Guardrails" },
  { key: "ground", label: "Mission Tooling" },
  { key: "service", label: "Mission Services" },
  { key: "review", label: "Systems Check" },
];

/********************
 * UI atoms
 ********************/
const DecisionPill = ({ value }) => {
  const label = value === true ? "Accepted" : value === false ? "Later" : "Pending";
  const cls =
    value === true
      ? "bg-[color:var(--ms-teal)] text-white"
      : value === false
      ? "bg-[color:var(--ms-orange)] text-white"
      : "bg-gray-200 text-gray-700";
  return (
    <span className={`px-2 py-1 rounded-full text-xs font-medium ${cls}`}>{label}</span>
  );
};


const TopBar = ({ onImportJSON, progress }) => {
  return (
    <header className="sticky top-0 z-40 w-full border-b bg-white/70 backdrop-blur">
      <div className="mx-auto max-w-7xl px-4">
        <div className="flex h-14 items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="h-7 w-7 rounded-xl" style={{ background: "var(--ms-teal)" }} />
            <h1 className="text-lg font-semibold tracking-tight">MissionSmith</h1>
            <span className="ml-2 hidden text-sm text-gray-500 sm:block">
              Forge your Mission Objectives, Principles, Guardrails & Mission Tooling
            </span>
          </div>
          <div className="flex items-center gap-2">
            <button className="rounded-xl border px-3 py-1.5 text-sm hover:bg-gray-50" onClick={onImportJSON}>Import JSON</button>
          </div>
        </div>
        <div className="mb-3 mt-1 h-1 w-full overflow-hidden rounded-full bg-gray-100">
          <div className="h-full rounded-full" style={{ width: `${Math.round(progress * 100)}%`, background: "var(--ms-blue)" }} />
        </div>
      </div>
    </header>
  );
};

const Sidebar = ({ section, setSection }) => {
  return (
    <aside className="sticky top-14 h-[calc(100dvh-56px)] w-full max-w-[260px] shrink-0 border-r bg-white/60 p-3">
      <nav className="flex flex-col gap-1">
        {SECTIONS.map((s) => (
          <button
            key={s.key}
            onClick={() => setSection(s.key)}
            className={`flex items-center justify-between rounded-xl px-3 py-2 text-left text-sm hover:bg-gray-50 ${section === s.key ? "bg-gray-100" : ""}`}
          >
            <span>{s.label}</span>
            {section === s.key && (
              <span className="h-2 w-2 rounded-full" style={{ background: "var(--ms-teal)" }} />
            )}
          </button>
        ))}
      </nav>
      <div className="mt-4 rounded-xl border p-3 text-xs text-gray-600">
        <p className="font-medium">Tip</p>
        <p>Mission Info first, then review & accept rows section by section (Objectives, Principles, Guardrails, Tooling).</p>
      </div>
    </aside>
  );
};

/********************
 * Feature components
 ********************/
const RowEditor = ({ value, onChange, onClose }) => {
  const [local, setLocal] = useState(value);
  const update = (k, v) => setLocal((p) => ({ ...p, [k]: v }));
  const save = () => onChange(local);
  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/40 p-0 sm:items-center sm:p-8">
      <div className="w-full max-w-3xl rounded-2xl bg-white p-4 shadow-2xl sm:p-6">
        <div className="mb-3 flex items-center justify-between">
          <h3 className="text-base font-semibold">Edit: {local.ref} â€” {local.topic}</h3>
          <button className="rounded-lg border px-3 py-1 text-sm" onClick={onClose}>Close</button>
        </div>
        <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
          {[
            ["ref", "Ref"],
            ["category", "Category"],
            ["theme", "Theme"],
            ["topic", "Topic"],
            ["codify", "Codify"],
            ["automate", "Automate"],
            ["intercept", "Intercept"],
            ["prove", "Prove"],
            ["dependency", "Dependency"],
            ["status", "Status"],
            ["user_notes", "Notes"],
          ].map(([key, label]) => (
            <label key={key} className="flex flex-col text-sm">
              <span className="mb-1 text-gray-600">{label}</span>
              <textarea className="min-h-[42px] rounded-xl border p-2 focus:outline-none focus:ring-2" value={local[key] ?? ""} onChange={(e) => update(key, e.target.value)} />
            </label>
          ))}
        </div>
        <div className="mt-4 flex items-center justify-between">
          <div className="flex items-center gap-3 text-sm">
            <span>Decision:</span>
            <button className={`rounded-xl px-3 py-1 ${local.decision === true ? "text-white" : "border"}`} style={{ background: local.decision === true ? "var(--ms-teal)" : undefined }} onClick={() => update("decision", true)}>Accept</button>
            <button className={`rounded-xl px-3 py-1 ${local.decision === false ? "text-white" : "border"}`} style={{ background: local.decision === false ? "var(--ms-orange)" : undefined }} onClick={() => update("decision", false)}>Later</button>
            <button className="rounded-xl border px-3 py-1" onClick={() => update("decision", null)}>Clear</button>
          </div>
          <div className="flex items-center gap-2">
            <button className="rounded-xl border px-3 py-1" onClick={onClose}>Cancel</button>
            <button className="rounded-xl px-3 py-1 text-white" style={{ background: "var(--ms-teal)" }} onClick={save}>Save</button>
          </div>
        </div>
      </div>
    </div>
  );
};

const SectionTable = ({ title, rows, onRowsChange, allowAdd = false }) => {
  const [query, setQuery] = useState("");
  const [editing, setEditing] = useState(null);

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    if (!q) return rows;
    return rows.filter((r) => JSON.stringify(r).toLowerCase().includes(q));
  }, [query, rows]);

  const updateRow = (idx, patch) => {
    const next = [...rows];
    next[idx] = { ...rows[idx], ...patch };
    onRowsChange(next);
  };

  const removeRow = (idx) => {
    const next = [...rows];
    next.splice(idx, 1);
    onRowsChange(next);
  };

  const addRow = () => {
    const n = {
      ref: `NEW-${Math.random().toString(36).slice(2, 6).toUpperCase()}`,
      category: title,
      theme: "",
      topic: "",
      codify: "",
      automate: "",
      intercept: "",
      prove: "",
      dependency: "N/A",
      status: "option",
      user_notes: "",
      decision: null,
    };
    onRowsChange([n, ...rows]);
    setEditing({ idx: 0, value: n });
  };

  return (
    <div className="rounded-2xl border bg-white/70 p-3 sm:p-4">
      <div className="mb-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 className="text-base font-semibold">{title}</h2>
          <p className="text-xs text-gray-600">Search, accept/later, edit, || add.</p>
        </div>
        <div className="flex items-center gap-2">
          <input placeholder="Searchâ€¦" className="w-48 rounded-xl border px-3 py-1.5 text-sm" value={query} onChange={(e) => setQuery(e.target.value)} />
          {allowAdd && (
            <button onClick={addRow} className="rounded-xl px-3 py-1.5 text-sm text-white" style={{ background: "var(--ms-teal)" }}>+ Add</button>
          )}
        </div>
      </div>

      <div className="overflow-x-auto">
        <table className="min-w-full text-sm">
          <thead>
            <tr className="bg-gray-50 text-left text-xs uppercase text-gray-500">
              {["Ref", "Theme", "Topic", "Codify", "Automate", "Intercept", "Prove", "Dependency", "Decision", ""].map((h) => (
                <th key={h} className="whitespace-nowrap px-3 py-2 font-medium">{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {filtered.map((r, i) => (
              <tr key={r.ref} className="border-b hover:bg-gray-50">
                <td className="px-3 py-2 font-mono">{r.ref}</td>
                <td className="px-3 py-2">{r.theme}</td>
                <td className="px-3 py-2">
                  <div className="flex items-center gap-2">
                    <span className="font-medium">{r.topic}</span>
                    <button className="rounded-lg border px-2 py-0.5 text-xs" onClick={() => setEditing({ idx: i, value: r })}>Edit</button>
                  </div>
                </td>
                <td className="px-3 py-2 max-w-[260px] truncate" title={r.codify}>{r.codify}</td>
                <td className="px-3 py-2 max-w-[260px] truncate" title={r.automate}>{r.automate}</td>
                <td className="px-3 py-2 max-w-[260px] truncate" title={r.intercept}>{r.intercept}</td>
                <td className="px-3 py-2 max-w-[260px] truncate" title={r.prove}>{r.prove}</td>
                <td className="px-3 py-2">{r.dependency}</td>
                <td className="px-3 py-2">
                  <div className="flex items-center gap-2">
                    <button className={`rounded-xl px-2 py-1 text-xs ${r.decision === true ? "text-white" : "border"}`} style={{ background: r.decision === true ? "var(--ms-teal)" : undefined }} onClick={() => updateRow(i, { decision: true })}>Accept</button>
                    <button className={`rounded-xl px-2 py-1 text-xs ${r.decision === false ? "text-white" : "border"}`} style={{ background: r.decision === false ? "var(--ms-orange)" : undefined }} onClick={() => updateRow(i, { decision: false })}>Later</button>
                    <button className="rounded-xl border px-2 py-1 text-xs" onClick={() => updateRow(i, { decision: null })}>Clear</button>
                  </div>
                </td>
                <td className="px-3 py-2 text-right">
                  <button className="rounded-lg px-2 py-1 text-xs text-white" style={{ background: "var(--ms-red)" }} onClick={() => removeRow(i)}>Delete</button>
                </td>
              </tr>
            ))}
            {filtered.length === 0 && (
              <tr>
                <td className="px-3 py-6 text-center text-gray-500" colSpan={10}>No rows match your search.</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      {editing && (
        <RowEditor
          value={editing.value}
          onClose={() => setEditing(null)}
          onChange={(next) => {
            const updated = [...rows];
            updated[editing.idx] = next;
            onRowsChange(updated);
            setEditing(null);
          }}
        />
      )}
    </div>
  );
};

const Review = ({ data, onResetDecisions }) => {
  const flat = [
    ...data.objectives.map((r) => ({ ...r, section: "Mission Objectives" })),
    ...data.principles.map((r) => ({ ...r, section: "Mission Principles" })),
    ...data.guardrails.map((r) => ({ ...r, section: "Mission Guardrails" })),
    ...data.ground.map((r) => ({ ...r, section: "Mission Tooling" })),
  ];
  const accepted = flat.filter((r) => r.decision === true);
  const later = flat.filter((r) => r.decision === false);
  const pending = flat.filter((r) => r.decision === null);
  return (
    <div className="grid grid-cols-1 gap-4 lg:grid-cols-3">
      {[["Accepted", accepted, "var(--ms-teal)"],["Later", later, "var(--ms-orange)"],["Pending", pending, "var(--ms-blue)"]].map(([label, rows, color]) => (
        <div key={label} className="rounded-2xl border bg-white/70 p-4">
          <div className="mb-2 flex items-center justify-between">
            <h3 className="text-base font-semibold">{label}</h3>
            <span className="rounded-full px-2 py-1 text-xs text-white" style={{ background: color }}>{rows.length}</span>
          </div>
          <ul className="space-y-2">
            {rows.map((r) => (
              <li key={r.ref} className="rounded-xl border p-3 text-sm">
                <div className="mb-1 flex items-center justify-between">
                  <span className="font-medium">{r.ref} â€” {r.topic}</span>
                  <DecisionPill value={r.decision} />
                </div>
                <p className="text-xs text-gray-600">{r.section} â€¢ {r.theme}</p>
              </li>
            ))}
            {rows.length === 0 && (<li className="text-sm text-gray-500">Nothing here yet.</li>)}
          </ul>
        </div>
      ))}
      <div className="lg:col-span-3">
        <button className="rounded-xl px-3 py-2 text-sm text-white" style={{ background: "var(--ms-red)" }} onClick={onResetDecisions}>Reset all decisions</button>
      </div>
    </div>
  );
};


function ServiceConfig({ value, onChange }) {
  const [local, setLocal] = useState(value || {});
  const update = (path, v) => {
    const parts = path.split(".");
    const copy = JSON.parse(JSON.stringify(local || {}));
    let cur = copy;
    for (let i = 0; i < parts.length - 1; i++) {
      const k = parts[i];
      if (!cur[k] || typeof cur[k] !== "object") cur[k] = {};
      cur = cur[k];
    }
    cur[parts[parts.length-1]] = v;
    setLocal(copy);
  };
  const save = () => onChange(local);
  const arr = (a) => Array.isArray(a) ? a.join(", ") : (a || "");

  const opts = {
    backendLang: ["java17","python3.11","node18","go1.21"],
    backendFw:   ["spring-boot","fastapi","express","gin"],
    uiLang:      ["react18","angular16","vue3"],
    uiFw:        ["nextjs","cra","nuxt"],
    database:    ["postgres","mongodb","mysql","dynamodb"],
    migrate:     ["flyway","prisma","alembic","liquibase"],
    deploy:      ["rolling","blue-green","canary","feature-flag-only"],
    policies:    ["no-wildcard-iam","no-plaintext-internal","no-pii-in-logs","schema-compat","secure-dependencies"],
    cigates:     ["typecheck","unit","contract","property","sast","sbom","iac","schema-compat"]
  };

  return (
    <div className="rounded-2xl border bg-white/70 p-4 space-y-6">
      <h2 className="text-base font-semibold">Service Config (Mission-wide Defaults & Guardrails)</h2>
      <div className="space-y-3">
        <h3 className="text-sm font-semibold text-gray-700">Defaults (optional)</h3>
        <div className="grid gap-3 md:grid-cols-2">
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Default Service Name</span>
            <input className="rounded-xl border px-3 py-2" placeholder="example-service"
              value={local?.default_service_name || ""}
              onChange={e=>update("default_service_name", e.target.value)} />
          </label>
          <div />
        </div>
        <div className="grid gap-3 md:grid-cols-2">
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Default Backend Language</span>
            <input className="rounded-xl border px-3 py-2" list="opt-backend-lang" placeholder="e.g. java17"
              value={local?.default_backend_language || ""}
              onChange={e=>update("default_backend_language", e.target.value)} />
            <datalist id="opt-backend-lang">{opts.backendLang.map(o => <option key={o} value={o} />)}</datalist>
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Default Backend Framework</span>
            <input className="rounded-xl border px-3 py-2" list="opt-backend-fw" placeholder="e.g. spring-boot"
              value={local?.default_backend_framework || ""}
              onChange={e=>update("default_backend_framework", e.target.value)} />
            <datalist id="opt-backend-fw">{opts.backendFw.map(o => <option key={o} value={o} />)}</datalist>
          </label>
        </div>
        <div className="grid gap-3 md:grid-cols-2">
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Default UI Language</span>
            <input className="rounded-xl border px-3 py-2" list="opt-ui-lang" placeholder="e.g. react18"
              value={local?.default_ui_language || ""}
              onChange={e=>update("default_ui_language", e.target.value)} />
            <datalist id="opt-ui-lang">{opts.uiLang.map(o => <option key={o} value={o} />)}</datalist>
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Default UI Framework</span>
            <input className="rounded-xl border px-3 py-2" list="opt-ui-fw" placeholder="e.g. nextjs"
              value={local?.default_ui_framework || ""}
              onChange={e=>update("default_ui_framework", e.target.value)} />
            <datalist id="opt-ui-fw">{opts.uiFw.map(o => <option key={o} value={o} />)}</datalist>
          </label>
        </div>
        <div className="grid gap-3 md:grid-cols-3">
          <label className="flex flex-col text-sm md:col-span-1">
            <span className="mb-1 text-gray-600">Default Database</span>
            <input className="rounded-xl border px-3 py-2" list="opt-db" placeholder="e.g. postgres"
              value={local?.default_database || ""}
              onChange={e=>update("default_database", e.target.value)} />
            <datalist id="opt-db">{opts.database.map(o => <option key={o} value={o} />)}</datalist>
          </label>
          <label className="flex flex-col text-sm md:col-span-2">
            <span className="mb-1 text-gray-600">Default Migration Tool</span>
            <input className="rounded-xl border px-3 py-2" list="opt-mig" placeholder="e.g. flyway"
              value={local?.default_migration_tool || ""}
              onChange={e=>update("default_migration_tool", e.target.value)} />
            <datalist id="opt-mig">{opts.migrate.map(o => <option key={o} value={o} />)}</datalist>
          </label>
        </div>
        <label className="flex items-center gap-2 text-sm">
          <input type="checkbox" checked={!!local?.default_outbox_enabled}
            onChange={e=>update("default_outbox_enabled", e.target.checked)} />
          <span>Default Outbox Enabled</span>
        </label>
      </div>

      <div className="space-y-3">
        <h3 className="text-sm font-semibold text-gray-700">Security (guardrails)</h3>
        <div className="grid gap-3 md:grid-cols-3">
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">AuthN</span>
            <input className="rounded-xl border px-3 py-2" placeholder="e.g. jwt"
              value={arr(local?.security?.authn)}
              onChange={e=>update("security.authn", e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">AuthZ</span>
            <input className="rounded-xl border px-3 py-2" placeholder="e.g. opa"
              value={arr(local?.security?.authz)}
              onChange={e=>update("security.authz", e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">CORS Allowlist (comma-separated)</span>
            <input className="rounded-xl border px-3 py-2" placeholder="https://app.example.com"
              value={arr(local?.security?.cors_allowlist)}
              onChange={e=>update("security.cors_allowlist", e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} />
          </label>
        </div>
      </div>

      <div className="space-y-3">
        <h3 className="text-sm font-semibold text-gray-700">Observability (guardrails)</h3>
        <div className="grid gap-3 md:grid-cols-3">
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Tracing</span>
            <input className="rounded-xl border px-3 py-2" placeholder="otel"
              value={local?.observability?.tracing || ""}
              onChange={e=>update("observability.tracing", e.target.value)} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Metrics</span>
            <input className="rounded-xl border px-3 py-2" placeholder="red"
              value={local?.observability?.metrics || ""}
              onChange={e=>update("observability.metrics", e.target.value)} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Logs</span>
            <input className="rounded-xl border px-3 py-2" placeholder="json"
              value={local?.observability?.logs || ""}
              onChange={e=>update("observability.logs", e.target.value)} />
          </label>
        </div>
      </div>

      <div className="space-y-3">
        <h3 className="text-sm font-semibold text-gray-700">NFR: SLOs</h3>
        <div className="grid gap-3 md:grid-cols-2">
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">http_p95_ms</span>
            <input className="rounded-xl border px-3 py-2" type="number"
              value={(Number(local?.nfr?.slo?.find(s=>s.name==='http_p95_ms')?.target) || "")}
              onChange={e=>{
                const val = e.target.value === "" ? "" : Number(e.target.value);
                const arr = (local?.nfr?.slo || []).filter(s=>s.name!=="http_p95_ms");
                arr.push({ name: "http_p95_ms", target: val });
                update("nfr.slo", arr);
              }} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">error_rate</span>
            <input className="rounded-xl border px-3 py-2"
              value={(local?.nfr?.slo?.find(s=>s.name==='error_rate')?.target) ?? ""}
              onChange={e=>{
                const arr = (local?.nfr?.slo || []).filter(s=>s.name!=="error_rate");
                arr.push({ name: "error_rate", target: e.target.value });
                update("nfr.slo", arr);
              }} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">availability</span>
            <input className="rounded-xl border px-3 py-2"
              value={(local?.nfr?.slo?.find(s=>s.name==='availability')?.target) ?? ""}
              onChange={e=>{
                const arr = (local?.nfr?.slo || []).filter(s=>s.name!=="availability");
                arr.push({ name: "availability", target: e.target.value });
                update("nfr.slo", arr);
              }} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">throughput_rps (optional)</span>
            <input className="rounded-xl border px-3 py-2"
              value={(local?.nfr?.slo?.find(s=>s.name==='throughput_rps')?.target) ?? ""}
              onChange={e=>{
                const arr = (local?.nfr?.slo || []).filter(s=>s.name!=="throughput_rps");
                arr.push({ name: "throughput_rps", target: e.target.value });
                update("nfr.slo", arr);
              }} />
          </label>
        </div>
      </div>

      <div className="space-y-3">
        <h3 className="text-sm font-semibold text-gray-700">NFR: Resilience</h3>
        <div className="grid gap-3 md:grid-cols-3">
          <label className="flex items-center gap-2 text-sm">
            <input type="checkbox" checked={!!local?.nfr?.resilience?.circuit_breaker}
              onChange={e=>update("nfr.resilience.circuit_breaker", e.target.checked)} />
            <span>Circuit Breaker</span>
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Idempotency Policy</span>
            <select className="rounded-xl border px-3 py-2"
              value={local?.nfr?.resilience?.idempotency_policy || "mutations_required"}
              onChange={e=>update("nfr.resilience.idempotency_policy", e.target.value)}>
              <option value="mutations_required">mutations_required</option>
              <option value="recommended">recommended</option>
              <option value="off">off</option>
            </select>
          </label>
          <div className="grid gap-2">
            <label className="flex flex-col text-sm">
              <span className="mb-1 text-gray-600">Retries (max)</span>
              <input className="rounded-xl border px-3 py-2" type="number"
                value={(local?.nfr?.resilience?.retries?.max) ?? 0}
                onChange={e=>update("nfr.resilience.retries.max", Number(e.target.value))} />
            </label>
            <label className="flex flex-col text-sm">
              <span className="mb-1 text-gray-600">Retries (strategy)</span>
              <input className="rounded-xl border px-3 py-2" placeholder="exponential-jitter"
                value={(local?.nfr?.resilience?.retries?.strategy) ?? ""}
                onChange={e=>update("nfr.resilience.retries.strategy", e.target.value)} />
            </label>
          </div>
        </div>
      </div>

      <div className="space-y-3">
        <h3 className="text-sm font-semibold text-gray-700">Governance, CI/CD & Deploy</h3>
        <div className="grid gap-3 md:grid-cols-2">
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Governance: Lineage</span>
            <input className="rounded-xl border px-3 py-2" placeholder="required"
              value={local?.governance?.lineage || ""}
              onChange={e=>update("governance.lineage", e.target.value)} />
          </label>
          <label className="flex flex-col text-sm">
            <span className="mb-1 text-gray-600">Default Deploy Strategy</span>
            <input className="rounded-xl border px-3 py-2" list="opt-deploy" placeholder="e.g. canary"
              value={local?.deploy?.default_strategy || ""}
              onChange={e=>update("deploy.default_strategy", e.target.value)} />
            <datalist id="opt-deploy">{opts.deploy.map(o => <option key={o} value={o} />)}</datalist>
          </label>
        </div>
        <label className="flex items-center gap-2 text-sm">
          <input type="checkbox" checked={!!local?.deploy?.feature_flags}
            onChange={e=>update("deploy.feature_flags", e.target.checked)} />
          <span>Default Feature Flags Enabled</span>
        </label>
        <label className="flex flex-col text-sm">
          <span className="mb-1 text-gray-600">Policy Packs (comma-separated or custom)</span>
          <input className="rounded-xl border px-3 py-2" list="opt-policies" placeholder="no-wildcard-iam, no-pii-in-logs"
            value={arr(local?.governance?.policy_packs)}
            onChange={e=>update("governance.policy_packs", e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} />
          <datalist id="opt-policies">{opts.policies.map(o => <option key={o} value={o} />)}</datalist>
        </label>
        <label className="flex flex-col text-sm">
          <span className="mb-1 text-gray-600">CI Gates (comma-separated or custom)</span>
          <input className="rounded-xl border px-3 py-2" list="opt-cigates" placeholder="typecheck, unit, ..."
            value={arr(local?.ci?.gates)}
            onChange={e=>update("ci.gates", e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} />
          <datalist id="opt-cigates">{opts.cigates.map(o => <option key={o} value={o} />)}</datalist>
        </label>
        <label className="flex flex-col text-sm">
          <span className="mb-1 text-gray-600">Default Owner (optional)</span>
          <input className="rounded-xl border px-3 py-2" placeholder="team-trade"
            value={local?.ownership?.owner || ""}
            onChange={e=>update("ownership.owner", e.target.value)} />
        </label>
      </div>

      <div className="flex gap-2 pt-2">
        <button className="rounded-xl border px-3 py-1" onClick={()=>setLocal(value)}>Reset</button>
        <button className="rounded-xl px-3 py-1 text-white" style={{ background: "var(--ms-teal)" }} onClick={save}>Save</button>
      </div>
    </div>
  );
}


function MissionInfo({ value, onChange }) {
  const update = (k, v) => onChange({ ...value, [k]: v });
  return (
    <div className="rounded-2xl border bg-white/70 p-4 space-y-4">
      <h2 className="text-base font-semibold">Mission Information</h2>
      {[["title","Mission Title"],["sponsor","Sponsor"],["owner","Owner"],["stakeholders","Stakeholders"],["version","Version"],["description","Description"],["date","Date"]].map(([key, label]) => (
        <label key={key} className="flex flex-col text-sm">
          <span className="mb-1 text-gray-600">{label}</span>
          <input
            className="rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500"
            value={value?.[key] ?? ""}
            onChange={(e) => update(key, e.target.value)}
          />
        </label>
      ))}
    </div>
  );
}

/********************
 * Main App
 ********************/
function MissionSmithApp() {
  const [section, setSection] = useState("info");
  const [data, setData] = useState(initialData);

  
  
  useEffect(() => { window.__ms_data = data; window.__ms_getData = () => data; }, [data]);
useEffect(() => { window.__ms_data = data; window.__ms_getData = () => data; }, [data]);
const progress = useMemo(() => {
    const all = [...data.objectives, ...data.principles, ...data.guardrails, ...data.ground];
    const decided = all.filter((r) => r.decision !== null).length;
    return all.length ? decided / all.length : 0;
  }, [data]);

  const onRowsChange = (key, next) => setData((p) => ({ ...p, [key]: next }));

  const exportJSON = () => {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `missionsmith-framework.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const exportCSVHandler = () => exportCSV(data);

  
  // CSV Export helpers (flat table across all sections)
  const CSV_HEADERS = ["ref","category","theme","topic","codify","automate","intercept","prove","dependency","status","user_notes","decision"];
  function toCSVRow(obj){
    function esc(v){
      const s = (v === null || v === undefined) ? "" : String(v);
      const needsQuote = /[",\n]/.test(s);
      const out = s.replace(/"/g,'""');
      return needsQuote ? "\"" + out + "\"" : out;
    }
    return CSV_HEADERS.map(h => {
      if (h === "decision") {
        return esc(obj.decision === true ? "Accepted" : obj.decision === false ? "Later" : "Pending");
      }
      return esc(obj[h] ?? "");
    }).join(",");
  }
  function exportCSV(data){
    const flat = [
      ...data.objectives.map(r => ({...r})),
      ...data.principles.map(r => ({...r})),
      ...data.guardrails.map(r => ({...r})),
      ...data.ground.map(r => ({...r})),
    ];
    const header = CSV_HEADERS.join(",");
    const rows = flat.map(toCSVRow);
    const csv = [header, ...rows].join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "missionsmith-framework.csv";
    a.click();
    URL.revokeObjectURL(url);
  }
const importJSON = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".json,application/json";
    input.onchange = (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(String(reader.result));
          setData((p) => ({ ...p, ...parsed }));
          alert("Imported JSON successfully.");
        } catch (err) {
          alert("Invalid JSON file.");
        }
      };
      reader.readAsText(file);
    };
    input.click();
  };

  const importCSV = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".csv,text/csv";
    input.onchange = (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const text = String(reader.result);
        const { rows } = parseCSVSimple(text);

        const buckets = { objectives: [], principles: [], guardrails: [], ground: [] };
        for (const r of rows) {
          const item = {
            ref: r.ref || r.Ref || `CSV-${Math.random().toString(36).slice(2, 6).toUpperCase()}`,
            category: r.category || r.Category || "",
            theme: r.theme || r.Theme || "",
            topic: r.topic || r.Topic || "",
            codify: r.codify || r.Codify || "",
            automate: r.automate || r.Automate || "",
            intercept: r.intercept || r.Intercept || "",
            prove: r.prove || r.Prove || "",
            dependency: r.dependency || r.Dependency || "N/A",
            status: r.status || r.Status || "proposed",
            user_notes: r.user_notes || r.Notes || r.UserNotes || "",
            decision: null,
          };
          const cat = (item.category || "").toLowerCase();
          if (cat.includes("objective")) buckets.objectives.push(item);
          else if (cat.includes("principle")) buckets.principles.push(item);
          else if (cat.includes("guardrail")) buckets.guardrails.push(item);
          else if (cat.includes("ground")) buckets.ground.push(item);
        }
        setData((p) => ({
          objectives: buckets.objectives.length ? buckets.objectives : p.objectives,
          principles: buckets.principles.length ? buckets.principles : p.principles,
          guardrails: buckets.guardrails.length ? buckets.guardrails : p.guardrails,
          ground: buckets.ground.length ? buckets.ground : p.ground,
        }));
        alert("Imported CSV rows into the matching sections.");
      };
      reader.readAsText(file);
    };
    input.click();
  };

  const resetDecisions = () => {
    const reset = (arr) => arr.map((r) => ({ ...r, decision: null }));
    setData((p) => ({
      objectives: reset(p.objectives),
      principles: reset(p.principles),
      guardrails: reset(p.guardrails),
      ground: reset(p.ground),
    }));
  };

  return (
    <div className="min-h-dvh bg-gray-50">
      <style>{`
        :root{
          --ms-teal:   rgb(26,153,136);
          --ms-blue:   rgb(106,164,200);
          --ms-orange: rgb(235,86,0);
          --ms-mint:   rgb(162,255,232);
          --ms-red:    rgb(255,0,0);
        }
      `}</style>

      <TopBar onImportJSON={importJSON} progress={progress} />

      <main className="mx-auto grid max-w-7xl grid-cols-1 gap-4 px-4 pb-8 pt-4 sm:grid-cols-[260px_1fr]">
        <Sidebar section={section} setSection={setSection} />

        <div className="space-y-4">
          {section === "info" && (<MissionInfo value={data.missionInfo} onChange={(val) => setData((p) => ({ ...p, missionInfo: val }))} />)}
{section === "service" && (<ServiceConfig value={data.serviceConfig} onChange={(val) => setData((p) => ({ ...p, serviceConfig: val }))} />)}
          {section === "objectives" && (<SectionTable title="Mission Objectives" rows={data.objectives} onRowsChange={(rows) => onRowsChange("objectives", rows)} />)}
          {section === "principles" && (<SectionTable title="Mission Principles" rows={data.principles} onRowsChange={(rows) => onRowsChange("principles", rows)} />)}
          {section === "guardrails" && (<SectionTable title="Mission Guardrails" rows={data.guardrails} onRowsChange={(rows) => onRowsChange("guardrails", rows)} />)}
          {section === "ground" && (<SectionTable title="Mission Tooling" rows={data.ground} onRowsChange={(rows) => onRowsChange("ground", rows)} allowAdd />)}
          {section === "review" && (<Review data={data} onResetDecisions={resetDecisions} />)}
        </div>
      </main>
    </div>
  );
}

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MissionSmithApp />);
  </script>

<script>
window.MS_actions = (function(){
  const download = (filename, text, type) => {
    const blob = new Blob([text], {type});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 200);
  };

  const acceptedOnly = (arr = []) => (arr||[]).filter(x => {
  const d = x && x.decision;
  if (d === true) return true;
  if (typeof d === 'string') {
    const s = d.trim().toLowerCase();
    if (s === 'accepted' || s === 'accept' || s === 'true' || s === 'yes' || s === 'y') return true;
  }
  if (typeof d === 'number' && d === 1) return true;
  const s2 = x && (x.status || x.accepted);
  return (typeof s2 === 'string' && s2.toLowerCase() === 'accepted');
});

  const deriveAccepted = (data = {}) => ({
  objectives: acceptedOnly(data.objectives || []),
  principles: acceptedOnly(data.principles  || []),
  guardrails: acceptedOnly(data.guardrails  || []),
  ground:     acceptedOnly((data.ground || data.tooling || []) )
});

  const mdList = (title, items) =>
    items.length ? `\n## ${title}\n` + items.map(i=>`- **${i.name || i.id || "item"}**${i.description ? ` â€” ${i.description}` : ""}`).join("\n") + "\n" : "";

  const missionTitle = (data) => (data?.missionInfo?.title || "Mission").replace(/[^\w\-]+/g,"_");
  const getData = () => (typeof window.__ms_getData === 'function' ? window.__ms_getData() : (window.__ms_data || window.data || window.initialData || {}));

  const buildAgentsMd = (data) => {
  const acc = deriveAccepted(data);

  const section = (title, rows) => {
    if (!rows || !rows.length) return "";
    const blocks = rows.map(r => {
      const lines = [
        `- **${r.ref || r.id || ""} â€” ${r.topic || r.purpose || ""}** *(Theme: ${r.theme || ""}; Category: ${r.category || ""})*`,
        `  - Codify: ${r.codify || ""}`,
        `  - Automate: ${r.automate || ""}`,
        `  - Intercept: ${r.intercept || ""}`,
        `  - Prove: ${r.prove || ""}`,
        `  - Dependency: ${r.dependency || ""}`,
        `  - Notes: ${r.user_notes || r.notes || ""}`,
      ];
      return lines.join("\n");
    }).join("\n");
    return `\n## ${title}\n${blocks}\n`;
  };

  let md = `# Agents Charter â€” ${data?.missionInfo?.title || "Mission"}\n`;
  md += `\n> Generated from accepted items in Objectives, Principles, Guardrails and Tooling.\n`;
  md += section("Objectives", acc.objectives);
  md += section("Principles", acc.principles);
  md += section("Guardrails", acc.guardrails);
  md += section("Tooling", acc.ground);
  md += `\n---\nGenerated by MissionSmith\n`;
  return md;
};

  const buildPipelineYml = (data) => {
    const acc = deriveAccepted(data);
    const hasCIGuardrail = acc.guardrails.some(g => /ci|pipeline/i.test((g.name||"")+ " " + (g.description||"")));
    const gates = hasCIGuardrail ? (data?.serviceConfig?.ci?.gates || []) : [];
    const steps = gates.map(g => `      - name: ${g}\n        run: echo "Running ${g} gate"\n`).join("");
    return `name: pipeline\non: [push, pull_request]\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n${steps || '      - run: echo "No accepted CI gates configured"'}\n`;
  };

  const buildPolicyBundleTxt = (data) => {
    const acc = deriveAccepted(data);
    const hasPolicy = acc.guardrails.some(g => /policy/i.test((g.name||"")+ " " + (g.description||"")));
    const packs = hasPolicy ? (data?.serviceConfig?.governance?.policy_packs || []) : [];
    return packs.length ? packs.map(p=>`- ${p}`).join("\n") : "No accepted policy packs.";
  };

  const buildDeployPlan = (data) => {
    const acc = deriveAccepted(data);
    const hasDeploy = acc.guardrails.some(g => /deploy|release|rollout/i.test((g.name||"")+ " " + (g.description||"")));
    const sc = data?.serviceConfig?.deploy || {};
    return `strategy: ${hasDeploy ? (sc.default_strategy || "") : "UNSET (no accepted deploy guardrail)"}\nfeature_flags: ${!!sc.feature_flags}\n`;
  };

  const buildDashboards = (data) => {
    const acc = deriveAccepted(data);
    const hasSLO = acc.guardrails.some(g => /slo|observability|latency|error rate|availability/i.test((g.name||"")+ " " + (g.description||"")));
    const slos = hasSLO ? (data?.serviceConfig?.nfr?.slo || []) : [];
    if (!slos.length) return "# No accepted SLOs";
    return "panels:\n" + slos.map(s => `- title: ${s.name}\n  target: ${s.target}`).join("\n");
  };

  const buildLineage = (data) => {
    const acc = deriveAccepted(data);
    const hasLineage = acc.guardrails.some(g => /lineage|audit|governance/i.test((g.name||"")+ " " + (g.description||"")));
    if (!hasLineage) return JSON.stringify({ enabled:false, reason:"No accepted lineage guardrail" }, null, 2);
    const sc = data?.serviceConfig || {};
    return JSON.stringify({
      enabled: true,
      mission: data?.missionInfo?.title || "Mission",
      defaults: {
        backend: [sc.default_backend_language, sc.default_backend_framework].filter(Boolean).join(" + "),
        ui: [sc.default_ui_language, sc.default_ui_framework].filter(Boolean).join(" + "),
        database: sc.default_database || "",
        outbox: !!sc.default_outbox_enabled
      }
    }, null, 2);
  };

  return {
    generateJSON(){ const d=getData(); download(`${missionTitle(d)}.json`, JSON.stringify(d,null,2), "application/json"); },
    generateAgents(){ try{ const md = buildAgentsMd(getData()); if(!md || !md.trim()){ alert("Agents file is empty."); return; } download("agents.md", md, "text/markdown"); } catch(e){ console.error(e); alert("Failed to build agents.md"); } },
    generateScaffold(){
      try {
        const d = getData();
        const sc = d?.serviceConfig || {};
        const backend = [sc.default_backend_language, sc.default_backend_framework].filter(Boolean).join(" + ") || "(unset)";
        const ui      = [sc.default_ui_language, sc.default_ui_framework].filter(Boolean).join(" + ") || "(unset)";
        const dbLine  = `${sc.default_database || "(unset)"}; Migrations: ${sc.default_migration_tool || "(unset)"}; Outbox: ${!!sc.default_outbox_enabled}`;
        const secLine = JSON.stringify(sc.security || {});
        const obsLine = JSON.stringify(sc.observability || {});
        const lines = [
          `# Service Scaffold Plan â€” ${d?.missionInfo?.title || "Mission"}`,
          `Backend default: ${backend}`,
          `UI default: ${ui}`,
          `Database: ${dbLine}`,
          `Security: ${secLine}`,
          `Observability: ${obsLine}`,
          ``,
          `---`,
          `Generated by MissionSmith`
        ];
        download('service-scaffold-plan.md', lines.join('\n'), 'text/markdown');
      } catch (e) {
        console.error('generateScaffold failed', e);
        alert('Failed to build service-scaffold-plan.md');
      }
    },
    generateCICD(){ download("pipeline.yml", buildPipelineYml(getData()), "text/yaml"); },
    generatePolicies(){ download("policy-packs.txt", buildPolicyBundleTxt(getData()), "text/plain"); },
    generateDeploy(){ download("deploy-manifests-plan.yaml", buildDeployPlan(getData()), "text/yaml"); },
    generateDashboards(){ download("dashboards-alerts.yaml", buildDashboards(getData()), "text/yaml"); },
    generateLineage(){ download("lineage.json", buildLineage(getData()), "application/json"); }
  };
})();
</script>


<script>
(function(){
  function show(msg, src, line, col){
    const el = document.createElement('div');
    el.style.position='fixed'; el.style.left=0; el.style.right=0; el.style.bottom=0;
    el.style.background='rgba(220,38,38,0.95)'; el.style.color='#fff'; el.style.fontFamily='ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    el.style.whiteSpace='pre-wrap'; el.style.maxHeight='40vh'; el.style.overflow='auto'; el.style.padding='12px 16px'; el.style.zIndex=99999;
    el.textContent = 'MissionSmith runtime error:\n' + msg + (src ? ('\n@ ' + src + ':' + line + ':' + col) : '');
    document.body.appendChild(el);
  }
  window.addEventListener('error', e => show(e.message, e.filename, e.lineno, e.colno));
  window.addEventListener('unhandledrejection', e => show(String(e.reason || 'Unhandled promise rejection')));
})();
</script>


<script>
(function(){
  function show(msg, src, line, col){
    const el = document.createElement('div');
    el.style.position='fixed'; el.style.left=0; el.style.right=0; el.style.bottom=0;
    el.style.background='rgba(220,38,38,0.95)'; el.style.color='#fff'; el.style.fontFamily='ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    el.style.whiteSpace='pre-wrap'; el.style.maxHeight='40vh'; el.style.overflow='auto'; el.style.padding='12px 16px'; el.style.zIndex=99999;
    el.textContent = 'MissionSmith runtime error:\n' + msg + (src ? ('\n@ ' + src + ':' + line + ':' + col) : '');
    document.body.appendChild(el);
  }
  window.addEventListener('error', e => show(e.message, e.filename, e.lineno, e.colno));
  window.addEventListener('unhandledrejection', e => show(String(e.reason || 'Unhandled promise rejection')));
})();
</script>


<script>
(function(){
  function wireFrameworkButtons(){
    var hdr = document.querySelector('header.sticky.top-0');
    if(!hdr) return;
    var right = hdr.querySelector('.flex.items-center.gap-2');
    if(!right) return;

    // 1) Ensure Import button label
    var importBtn = right.querySelector('button');
    if(importBtn){
      var txt = (importBtn.textContent || '').trim().toLowerCase();
      if(txt.includes('import')){
        importBtn.textContent = 'Import Mission Framework';
      }
      // keep existing onClick handler (importJSON) intact
    }

    // 2) Inject Export button if not present
    if(!right.querySelector('.msx-framework-btn')){
      var exp = document.createElement('button');
      exp.className = 'msx-framework-btn';
      exp.textContent = 'Export Mission Framework';
      exp.addEventListener('click', function(){
        try {
          if (window.exportJSON) { window.exportJSON(); return; }
          if (window.MS_actions && typeof window.MS_actions.generateJSON === 'function') {
            window.MS_actions.generateJSON(); return;
          }
          console.warn('No export function found');
        } catch(e){ console.error(e); }
      });
      right.prepend(exp);
    }
  }
  document.addEventListener('DOMContentLoaded', wireFrameworkButtons);
  // Re-apply if React re-renders
  new MutationObserver(wireFrameworkButtons).observe(document.body, {childList:true, subtree:true});
})();
</script>


<!-- === Integrated CI/CD Generator v1.2 (no new screens) === -->
<script>
(function(){
  // --- Utilities ---
  function str(v){ return (v==null?'':String(v)); }
  function val(obj, path, fallback){
    try{
      return path.split('.').reduce((o,k)=> (o && (k in o) ? o[k] : undefined), obj) ?? fallback;
    }catch(_){ return fallback; }
  }
  function toProfile(sc){
    const lang = (str(sc.default_backend_language)).toLowerCase();
    if (/java/.test(lang)) return "java-maven";
    if (/python/.test(lang)) return "python-pytest";
    if (/node|javascript|ts|typescript/.test(lang)) return "node-npm";
    if (/go/.test(lang)) return "go";
    if (/dotnet|csharp/.test(lang)) return "dotnet";
    return "java-maven"; // default
  }
  function toGates(arr){
    if (Array.isArray(arr) && arr.length) return arr.map(x=>String(x).trim()).filter(Boolean);
    return "lint, unit, contract, integration, sast, sbom, iac, schema-compat, docker-scan, policy, sign"
      .split(',').map(s=>s.trim());
  }
  function registryDefault(sc){
    const r = str(sc.default_registry || "").trim();
    return r || "ghcr.io/OWNER/REPO";
  }

  // --- Generators (from LaunchPad v1.2) ---
  function genBuildTest(profile, gates){
    const has = t => gates.includes(t);
    const isJava = profile==='java-maven';
    const isNode = profile==='node-npm';
    const isPy   = profile==='python-pytest';
    let setup='';
    if(isJava) setup = "\n      - uses: actions/setup-java@v4\n        with:\n          distribution: temurin\n          java-version: '21'\n";
    if(isNode) setup = "\n      - uses: actions/setup-node@v4\n        with:\n          node-version: '20'\n";
    if(isPy)   setup = "\n      - uses: actions/setup-python@v5\n        with:\n          python-version: '3.11'\n";
    let lint='';
    if(has('lint')){
      if(isJava) lint = "      - name: Lint (Maven)\n        run: |\n          mvn -B -ntp -DskipTests=true spotless:check || true\n          mvn -B -ntp -DskipTests=true checkstyle:check || true\n";
      if(isNode) lint = "      - name: Lint (ESLint)\n        run: |\n          npm ci\n          npx eslint . || true\n";
      if(isPy)   lint = "      - name: Lint (flake8)\n        run: |\n          python -m pip install --upgrade pip\n          pip install flake8\n          flake8 . || true\n";
    }
    let tests='';
    if(has('unit') || has('integration')){
      if(isJava) tests = "      - name: Maven test (unit + integration)\n        run: mvn -B -ntp -DskipITs=false test\n";
      if(isNode) tests = "      - name: Node tests\n        run: |\n          npm ci\n          npm test --if-present\n";
      if(isPy)   tests = "      - name: PyTest\n        run: |\n          python -m pip install --upgrade pip\n          pip install -r requirements.txt || true\n          pytest -q --maxfail=1 --disable-warnings --junitxml=test-results/python-junit.xml\n";
    }
    const contract = has('contract')
      ? "      - name: Pact verify (if contracts present)\n        if: ${{ hashFiles('**/contracts/**') != '' }}\n        run: mvn -B -ntp pact:verify || echo \'No contracts\'\n" : "";
    const compat = has('schema-compat')
      ? "      - name: Schema compatibility check (if schemas present)\n        if: ${{ hashFiles('**/schemas/**') != '' }}\n        run: echo \'Implement your Avro/JSON compat check here\'\n" : "";

    return "name: ci-cd\n\non: [push, pull_request]\n\npermissions:\n  contents: read\n  packages: write\n  security-events: write\n\njobs:\n  build-test:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4" + setup + lint + tests + contract + compat +
      "      - name: Upload test results\n        if: ${{ always() }}\n        uses: actions/upload-artifact@v4\n        with:\n          name: test-results\n          path: |\n            **/target/surefire-reports/*.xml\n            **/target/failsafe-reports/*.xml\n            test-results/**/*.xml\n          if-no-files-found: ignore\n";
  }

  function genSecurity(gates){
    const has = t => gates.includes(t);
    let y = "name: security\n\non: [push, pull_request]\n\npermissions:\n  contents: read\n  security-events: write\n  packages: write\n\njobs:\n  security:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n";
    if(has('sast')) y += "      - name: Semgrep SAST\n        uses: returntocorp/semgrep-action@v1\n        with:\n          config: p/owasp-top-ten\n          generateSarif: true\n";
    if(has('docker-scan') || has('sbom') || has('sign')) y += "      - name: Set up Buildx\n        uses: docker/setup-buildx-action@v3\n      - name: Build image (no push)\n        uses: docker/build-push-action@v6\n        with:\n          context: .\n          push: false\n          load: true\n          tags: local/app:ci\n          provenance: false\n";
    if(has('docker-scan')) y += "      - name: Trivy image scan\n        uses: aquasecurity/trivy-action@0.28.0\n        with:\n          image-ref: local/app:ci\n          format: table\n          exit-code: '1'\n          ignore-unfixed: true\n";
    if(has('sbom')) y += "      - name: SBOM (Syft)\n        uses: anchore/sbom-action@v0\n        with:\n          image: local/app:ci\n          artifact-name: sbom.spdx.json\n";
    if(has('sign')) y += "      - name: Install Cosign\n        uses: sigstore/cosign-installer@v3.7.0\n      - name: Cosign sign (optional)\n        if: ${{ secrets.COSIGN_KEY != '' }}\n        env:\n          COSIGN_EXPERIMENTAL: '1'\n          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}\n        run: |\n          printf \"%s\" \"${{ secrets.COSIGN_KEY }}\" > cosign.key\n          cosign sign --key cosign.key local/app:ci\n";
    y += "      - name: Upload security artefacts\n        uses: actions/upload-artifact@v4\n        with:\n          name: security\n          path: |\n            semgrep.sarif\n            sbom.spdx.json\n          if-no-files-found: ignore\n";
    return y;
  }

  function genIaC(gates){
    const has = t => gates.includes(t);
    let y = "name: iac-policy\n\non: [push, pull_request]\n\npermissions:\n  contents: read\n\njobs:\n  iac-policy:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n";
    if(has('iac')) y += "      - name: Terraform fmt/validate/plan\n        if: ${{ hashFiles('**/*.tf') != '' }}\n        run: |\n          terraform -version || (curl -fsSL https://releases.hashicorp.com/terraform/1.9.5/terraform_1.9.5_linux_amd64.zip -o tf.zip && sudo unzip -o tf.zip -d /usr/local/bin)\n          terraform -chdir=infra fmt -check\n          terraform -chdir=infra init -input=false\n          terraform -chdir=infra validate\n          terraform -chdir=infra plan -input=false -lock=false -out=tfplan\n";
    if(has('policy')) y += "      - name: conftest policy check\n        if: ${{ hashFiles('policy/**.rego') != '' }}\n        uses: instrumenta/conftest-action@v0.3.0\n        with:\n          files: |\n            infra/**/*.tf\n            deploy/**/*.yaml\n";
    return y;
  }

  function genPackagePublish(registry){
    return "name: package-publish\non:\n  push:\n    branches: [ \"main\" ]\n  workflow_dispatch: {}\n\npermissions:\n  contents: read\n  packages: write\n\nenv:\n  REGISTRY: " + registry + "\n  IMAGE_SHA: " + registry + ":${{ github.sha }}\n  IMAGE_MAIN: " + registry + ":main\n\njobs:\n  build-push-sign:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: docker/setup-qemu-action@v3\n      - uses: docker/setup-buildx-action@v3\n      - uses: docker/login-action@v3\n        with:\n          registry: ghcr.io\n          username: ${{ github.actor }}\n          password: ${{ secrets.GITHUB_TOKEN }}\n      - name: Build & push (sha)\n        uses: docker/build-push-action@v6\n        with:\n          context: .\n          push: true\n          tags: ${{ env.IMAGE_SHA }}\n          provenance: false\n      - name: Build & push (main)\n        uses: docker/build-push-action@v6\n        with:\n          context: .\n          push: true\n          tags: ${{ env.IMAGE_MAIN }}\n          provenance: false\n      - name: Install Cosign\n        uses: sigstore/cosign-installer@v3.7.0\n      - name: Cosign sign (sha)\n        if: ${{ secrets.COSIGN_KEY != '' }}\n        env:\n          COSIGN_EXPERIMENTAL: \"1\"\n          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}\n        run: |\n          printf \"%s\" \"${{ secrets.COSIGN_KEY }}\" > cosign.key\n          cosign sign --key cosign.key ${{ env.IMAGE_SHA }}\n      - name: Cosign sign (main)\n        if: ${{ secrets.COSIGN_KEY != '' }}\n        env:\n          COSIGN_EXPERIMENTAL: \"1\"\n          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}\n        run: |\n          printf \"%s\" \"${{ secrets.COSIGN_KEY }}\" > cosign.key\n          cosign sign --key cosign.key ${{ env.IMAGE_MAIN }}\n";
  }

  function genPromoteDeploy(){
    return "name: promote-deploy\non:\n  workflow_dispatch:\n    inputs:\n      image:\n        description: \"Image to deploy (e.g., ghcr.io/owner/repo:sha)\"\n        required: false\n      envs:\n        description: \"Comma-separated envs to deploy (dev,staging,prod)\"\n        required: false\n        default: \"dev,staging,prod\"\n  push:\n    branches: [ \"main\" ]\n\npermissions:\n  contents: read\n  packages: read\n\nenv:\n  DEFAULT_IMAGE: ghcr.io/${{ github.repository }}:${{ github.sha }}\n  NAMESPACE: default\n  CANARY_REPLICAS: 1\n  STABLE_PERCENT: 90\n\njobs:\n  matrix-setup:\n    runs-on: ubuntu-latest\n    outputs:\n      envs: ${{ steps.mk.outputs.envs }}\n    steps:\n      - id: mk\n        run: |\n          IN=\"${{ github.event.inputs.envs }}\"\n          if [ -z \"$IN\" ]; then IN=\"dev,staging,prod\"; fi\n          echo \"envs=$(printf '[%s]' \\\"$(echo \\\"$IN\\\" | sed 's/,/","/g' | sed 's/^/\\\"/;s/$/\\\"/')\\\")\" >> $GITHUB_OUTPUT\n\n  deploy:\n    needs: matrix-setup\n    runs-on: ubuntu-latest\n    strategy:\n      matrix:\n        env: ${{ fromJson(needs.matrix-setup.outputs.envs) }}\n    environment: ${{ matrix.env }}\n    steps:\n      - uses: actions/checkout@v4\n      - name: Choose image\n        id: img\n        run: |\n          IMG=\"${{ github.event.inputs.image }}\"\n          if [ -z \"$IMG\" ]; then IMG=\"${{ env.DEFAULT_IMAGE }}\"; fi\n          echo \"image=$IMG\" >> $GITHUB_OUTPUT\n      - name: Install Cosign\n        uses: sigstore/cosign-installer@v3.7.0\n      - name: Verify image signature\n        env:\n          COSIGN_EXPERIMENTAL: \"1\"\n          COSIGN_PUBLIC_KEY: ${{ secrets.COSIGN_PUBLIC_KEY }}\n        run: |\n          if [ -z \"$COSIGN_PUBLIC_KEY\" ]; then\n            echo \"Missing COSIGN_PUBLIC_KEY; refusing to deploy unsigned/unverified image\" >&2\n            exit 1\n          fi\n          printf \"%s\" \"$COSIGN_PUBLIC_KEY\" > cosign.pub\n          cosign verify --key cosign.pub \"${{ steps.img.outputs.image }}\"\n      - name: Set kubeconfig\n        id: kube\n        run: |\n          ENV=\"${{ matrix.env }}\"\n          KC_VAR=\"KUBE_CONFIG_\${ENV^^}\"\n          KCONF=\"${!KC_VAR}\"\n          if [ -z \"$KCONF\" ]; then\n            echo \"Kubeconfig secret $KC_VAR is not set\" >&2\n            exit 1\n          fi\n          if echo \"$KCONF\" | grep -q \"apiVersion: v1\"; then\n            printf \"%s\" \"$KCONF\" > $HOME/.kubeconfig\n          else\n            printf \"%s\" \"$KCONF\" | base64 -d > $HOME/.kubeconfig\n          fi\n          echo \"KUBECONFIG=$HOME/.kubeconfig\" >> $GITHUB_ENV\n        env:\n          KUBE_CONFIG_DEV: ${{ secrets.KUBE_CONFIG_DEV }}\n          KUBE_CONFIG_STAGING: ${{ secrets.KUBE_CONFIG_STAGING }}\n          KUBE_CONFIG_PROD: ${{ secrets.KUBE_CONFIG_PROD }}\n      - name: Install kubectl\n        run: |\n          curl -fsSL https://storage.googleapis.com/kubernetes-release/release/v1.30.5/bin/linux/amd64/kubectl -o kubectl\n          chmod +x kubectl && sudo mv kubectl /usr/local/bin/\n      - name: Templatise manifests with image tag\n        run: |\n          ENV=\"${{ matrix.env }}\"\n          find \"deploy/\${ENV}\" -type f -name \"*.yaml\" -print0 | while IFS= read -r -d '' f; do\n            sed -i \"s#IMAGE_PLACEHOLDER#${{ steps.img.outputs.image }}#g\" \"$f\"\n            sed -i \"s#NAMESPACE_PLACEHOLDER#${{ env.NAMESPACE }}#g\" \"$f\"\n          done\n      - name: Apply canary (if present)\n        run: |\n          ENV=\"${{ matrix.env }}\"\n          if ls \"deploy/\${ENV}/canary/\"/*.yaml >/dev/null 2>&1; then\n            kubectl apply -n \"${{ env.NAMESPACE }}\" -f \"deploy/\${ENV}/canary/\"\n            kubectl rollout status -n \"${{ env.NAMESPACE }}\" deployment -l app.kubernetes.io/part-of=canary --timeout=120s\n          else\n            echo \"No canary overlay found; skipping canary\"\n          fi\n      - name: Bake\n        run: sleep 30\n      - name: Promote to stable\n        run: |\n          ENV=\"${{ matrix.env }}\"\n          kubectl apply -n \"${{ env.NAMESPACE }}\" -f \"deploy/\${ENV}/\"\n          kubectl rollout status -n \"${{ env.NAMESPACE }}\" deployment -l app.kubernetes.io/name=${{ github.event.repository.name }} --timeout=180s\n      - name: Cleanup canary\n        run: |\n          ENV=\"${{ matrix.env }}\"\n          if ls \"deploy/\${ENV}/canary/\"/*.yaml >/dev/null 2>&1; then\n            kubectl delete -n \"${{ env.NAMESPACE }}\" -f \"deploy/\${ENV}/canary/\" --ignore-not-found\n          fi\n";
  }

  function genReportMd(gates, profile){
    const tokenMap = { lint:'Lint', unit:'Unit tests', contract:'Contract tests', integration:'Integration tests', coverage:'Coverage', e2e:'End-to-end',
      sast:'SAST', 'docker-scan':'Container scan', sbom:'SBOM', sign:'Image signing', 'schema-compat':'Schema compatibility', iac:'IaC validate/plan', policy:'Policy check', observability:'Observability', chaos:'Chaos', a11y:'Accessibility', perf:'Performance'};
    const lines = ['# CI/CD Generation Report','',`Profile: **${profile}**`,'Gates:',''];
    gates.forEach(g=>lines.push(`- ${tokenMap[g] ? 'âœ…' : 'âš ï¸'} ${g}${tokenMap[g] ? '' : ' (unknown token)'}`));
    lines.push('\nFiles generated: ci-cd.yml, security.yml, iac-policy.yml, package-publish.yml, promote-deploy.yml');
    lines.push('Notes: Configure COSIGN_* and KUBE_CONFIG_* secrets for signing and deploy.');
    return lines.join('\n');
  }

  // --- Wire into MissionSmith button ---
  if (window.MS_actions) {
    const orig = window.MS_actions;
    orig.generateCICD = function(){
      try{
        const data = (typeof window.__ms_getData === 'function' ? window.__ms_getData() : window.__ms_data) || {};
        const sc = data.serviceConfig || {};
        const profile = toProfile(sc);
        const gates = toGates(val(sc, 'ci.gates', []));
        const registry = registryDefault(sc);

        const files = [
          {path: '.github/workflows/ci-cd.yml', content: genBuildTest(profile, gates)},
          {path: '.github/workflows/security.yml', content: genSecurity(gates)},
          {path: '.github/workflows/iac-policy.yml', content: genIaC(gates)},
          {path: '.github/workflows/package-publish.yml', content: genPackagePublish(registry)},
          {path: '.github/workflows/promote-deploy.yml', content: genPromoteDeploy()},
          {path: 'ci-cd-report.md', content: genReportMd(gates, profile)}
        ];

        // bundle download
        const chunks = ['# --- BEGIN MISSIONSMITH CI/CD BUNDLE ---'];
        for (const f of files) { chunks.push(`\n# FILE: ${f.path}\n\n${f.content}`); }
        const blob = new Blob([chunks.join('\n')], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'mission-cicd-bundle.txt';
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 200);

        alert('âœ… CI/CD workflows generated. Add COSIGN_* and KUBE_CONFIG_* secrets for signing/deploy.');
      }catch(e){
        console.error('generateCICD failed', e);
        alert('Failed to generate CI/CD workflows.');
      }
    };
    window.MS_actions = orig;
  }
})();
</script>

<!-- === Integrated IaC Generator v1.0 === -->
<script>
(function(){
  // Helpers
  function str(v){ return (v==null?'':String(v)); }
  function val(obj, path, fallback){
    try{ return path.split('.').reduce((o,k)=> (o && (k in o) ? o[k] : undefined), obj) ?? fallback; }catch(_){ return fallback; }
  }
  function appName(sc){
    const n = str(sc.default_service_name || 'app').trim() || 'app';
    return n.replace(/[^a-z0-9-]/ig,'-').toLowerCase();
  }
  function imageDefault(sc){
    const reg = str(sc.default_registry || '').trim() || 'ghcr.io/OWNER/REPO';
    return reg + ':main';
  }
  function sloTarget(sc, name, dflt){ try{ return (sc?.nfr?.slo||[]).find(s=>s.name===name)?.target ?? dflt; }catch(_){ return dflt; } }

  // YAML templates (with placeholders to be replaced by the deploy workflow)
  function baseDeploymentYaml(app){
    return `apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${app}
  namespace: NAMESPACE_PLACEHOLDER
  labels:
    app.kubernetes.io/name: ${app}
    app.kubernetes.io/instance: ${app}
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: ${app}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ${app}
    spec:
      containers:
      - name: ${app}
        image: IMAGE_PLACEHOLDER
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
        env:
        - name: OTEL_SERVICE_NAME
          value: "${app}"
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
`;
  }

  function serviceYaml(app){
    return `apiVersion: v1
kind: Service
metadata:
  name: ${app}
  namespace: NAMESPACE_PLACEHOLDER
spec:
  selector:
    app.kubernetes.io/name: ${app}
  ports:
  - name: http
    port: 80
    targetPort: 8080
  type: ClusterIP
`;
  }

  function namespaceYaml(){
    return `apiVersion: v1
kind: Namespace
metadata:
  name: NAMESPACE_PLACEHOLDER
`;
  }

  function canaryDeploymentYaml(app){
    return `apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${app}-canary
  namespace: NAMESPACE_PLACEHOLDER
  labels:
    app.kubernetes.io/name: ${app}
    app.kubernetes.io/part-of: canary
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: ${app}
      app.kubernetes.io/part-of: canary
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ${app}
        app.kubernetes.io/part-of: canary
    spec:
      containers:
      - name: ${app}
        image: IMAGE_PLACEHOLDER
        ports:
        - containerPort: 8080
`;
  }

  // Terraform (kubernetes provider) skeleton
  function tfProviders(){
    return `terraform {
  required_version = ">= 1.5.0"
  required_providers {
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = ">= 2.32.0"
    }
  }
}

# Uses KUBECONFIG from the environment (set by CI)
provider "kubernetes" {}
`;
  }
  function tfVariables(app, image){
    return `variable "namespace" { type = string  default = "default" }
variable "app_name"  { type = string  default = "${app}" }
variable "image"     { type = string  default = "${image}" }
`;
  }
  function tfMain(){
    return `resource "kubernetes_namespace" "ns" {
  metadata { name = var.namespace }
}

resource "kubernetes_deployment" "app" {
  metadata {
    name      = var.app_name
    namespace = var.namespace
    labels = {
      "app.kubernetes.io/name" = var.app_name
    }
  }
  spec {
    replicas = 2
    selector {
      match_labels = { "app.kubernetes.io/name" = var.app_name }
    }
    template {
      metadata {
        labels = { "app.kubernetes.io/name" = var.app_name }
      }
      spec {
        container {
          name  = var.app_name
          image = var.image
          port  { container_port = 8080 }
        }
      }
    }
  }
}

resource "kubernetes_service" "svc" {
  metadata {
    name      = var.app_name
    namespace = var.namespace
  }
  spec {
    selector = { "app.kubernetes.io/name" = var.app_name }
    port { port = 80  target_port = 8080 }
    type = "ClusterIP"
  }
}
`;
  }
  function tfOutputs(){
    return `output "service_name" { value = kubernetes_service.svc.metadata[0].name }
output "namespace"    { value = kubernetes_namespace.ns.metadata[0].name }
`;
  }

  function readme(){
    return `# MissionSmith IaC Bundle

This bundle includes:
- Kubernetes deploy manifests under \`deploy/{dev,staging,prod}\` (with \`IMAGE_PLACEHOLDER\` and \`NAMESPACE_PLACEHOLDER\` tokens)
- A Terraform skeleton under \`infra/\` using the Kubernetes provider

## Using with the generated CI/CD
- The \`promote-deploy.yml\` workflow will replace the placeholders and apply the manifests.
- Set the following secrets in your repo for each environment:
  - \`COSIGN_PUBLIC_KEY\` (for verification)
  - \`KUBE_CONFIG_DEV\`, \`KUBE_CONFIG_STAGING\`, \`KUBE_CONFIG_PROD\`

> You can also use \`infra/\` with \`terraform -chdir=infra init && terraform -chdir=infra apply -var namespace=<env> -var image=<image>\`.
`;
  }

  function bundleFiles(data){
    const sc = data?.serviceConfig || {};
    const app = appName(sc);
    const image = imageDefault(sc);

    const envs = ["dev","staging","prod"];
    const files = [];

    // Env-specific k8s manifests
    envs.forEach(env => {
      files.push({ path: `deploy/${env}/namespace.yaml`, content: namespaceYaml() });
      files.push({ path: `deploy/${env}/deployment.yaml`, content: baseDeploymentYaml(app) });
      files.push({ path: `deploy/${env}/service.yaml`, content: serviceYaml(app) });
      files.push({ path: `deploy/${env}/canary/deployment.yaml`, content: canaryDeploymentYaml(app) });
    });

    // Terraform skeleton
    files.push({ path: `infra/providers.tf`, content: tfProviders() });
    files.push({ path: `infra/variables.tf`, content: tfVariables(app, image) });
    files.push({ path: `infra/main.tf`, content: tfMain() });
    files.push({ path: `infra/outputs.tf`, content: tfOutputs() });
    files.push({ path: `README-IAC.md`, content: readme() });

    return files;
  }

  // Override the existing IaC button behaviour
  if (window.MS_actions) {
    const orig = window.MS_actions;
    orig.generateDeploy = function(){
      try{
        const data = (typeof window.__ms_getData === 'function' ? window.__ms_getData() : window.__ms_data) || {};
        const files = bundleFiles(data);

        const chunks = ['# --- BEGIN MISSIONSMITH IAC BUNDLE ---'];
        for (const f of files) { chunks.push(`\n# FILE: ${f.path}\n\n${f.content}`); }
        const blob = new Blob([chunks.join('\n')], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'mission-iac-bundle.txt';
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 200);

        alert('âœ… IaC bundle generated: deploy/{env}/... + infra/ (Terraform).');
      }catch(e){
        console.error('generateDeploy failed', e);
        alert('Failed to generate IaC bundle.');
      }
    };
    window.MS_actions = orig;
  }
})();
</script>


<!-- === MissionSmith Lineage Generator v1.0 === -->
<script>
(function(){
  function safe(v, d){ return (v===undefined || v===null) ? d : v; }
  function norm(s){ return String(s||'').trim().replace(/[^a-z0-9-_:.]/ig,'_'); }
  function title(s){ return String(s||'').trim(); }

  // Extract a best-effort model from the app's data blob
  function extractModel(data){
    const sc = data?.serviceConfig || {};
    const services = [];
    const datasets = [];
    const policies = [];
    const pipelines = [];
    const objectives = [];

    // Service
    const appName = sc.default_service_name || 'app';
    services.push({id: norm(appName), name: title(appName), kind:'service'});

    // Datasets / APIs (best effort)
    const ds = safe(sc.data_sources, []);
    ds.forEach((d, i)=>{
      const name = d?.name || `dataset_${i+1}`;
      datasets.push({id: norm(name), name: title(name), kind:'dataset'});
    });

    // Pipelines (from CI/CD + build stages if present)
    const pl = safe(data?.pipelines, []);
    pl.forEach((p, i)=>{
      const name = p?.name || `pipeline_${i+1}`;
      pipelines.push({id: norm(name), name: title(name), kind:'pipeline'});
    });

    // Policies / Guardrails
    const pol = safe(data?.policies, []);
    pol.forEach((p, i)=>{
      const name = p?.name || `policy_${i+1}`;
      policies.push({id: norm(name), name: title(name), kind:'policy'});
    });

    // Objectives (Mission Objectives sheet)
    const obj = safe(data?.objectives || data?.missionObjectives, []);
    obj.forEach((o, i)=>{
      const name = o?.reference || o?.name || `objective_${i+1}`;
      objectives.push({id: norm(name), name: title(name), kind:'objective'});
    });

    // Build edges heuristically:
    const edges = [];
    // service uses datasets
    datasets.forEach(d => edges.push({from: d.id, to: norm(appName), relation: 'consumed_by'}));
    // pipelines deploy service
    pipelines.forEach(p => edges.push({from: p.id, to: norm(appName), relation: 'deploys'}));
    // policies govern service and pipelines
    policies.forEach(pol => {
      edges.push({from: pol.id, to: norm(appName), relation:'governs'});
      pipelines.forEach(p => edges.push({from: pol.id, to: p.id, relation:'governs'}));
    });
    // objectives drive pipelines (if any)
    objectives.forEach(o => {
      pipelines.forEach(p => edges.push({from: o.id, to: p.id, relation:'drives'}));
    });

    return {services, datasets, policies, pipelines, objectives, edges};
  }

  function toCSV(model){
    const header = "from,to,relation\n";
    const rows = model.edges.map(e => `${e.from},${e.to},${e.relation}`);
    return header + rows.join("\n") + "\n";
  }

  function toDOT(model){
    const lines = [];
    lines.push('digraph MissionSmithLineage {');
    lines.push('  rankdir=LR;');
    function node(n, shape, color){
      lines.push(`  "${n.id}" [label="${n.name}\\n(${n.kind})", shape=${shape}, style=filled, fillcolor="${color}"];`);
    }
    model.datasets.forEach(n => node(n, 'cylinder', '#E0F7FA'));
    model.services.forEach(n => node(n, 'box', '#E8F5E9'));
    model.pipelines.forEach(n => node(n, 'component', '#EDE7F6'));
    model.policies.forEach(n => node(n, 'octagon', '#FFF3E0'));
    model.objectives.forEach(n => node(n, 'ellipse', '#F3E5F5'));

    model.edges.forEach(e => lines.push(`  "${e.from}" -> "${e.to}" [label="${e.relation}"];`));
    lines.push('}');
    return lines.join("\n");
  }

  // Minimal OpenLineage-style JSON (not full spec; enough for import/visualization tools)
  function toOpenLineage(model){
    const now = new Date().toISOString();
    const events = [];

    // Emit one RUN event per pipeline, pointing to the service dataset outputs
    model.pipelines.forEach(p => {
      const outputs = model.services.map(s => ({namespace:"app", name:s.name}));
      const inputs  = model.datasets.map(d => ({namespace:"data", name:d.name}));
      events.push({
        eventType: "COMPLETE",
        eventTime: now,
        run: { runId: `${p.id}-${now}` },
        job: { namespace: "mission-smith", name: p.name },
        inputs, outputs,
        producer: "missionsmith/lineage-generator"
      });
    });
    return JSON.stringify({version:"0.1", events}, null, 2);
  }

  // Hook up Lineage button if MS_actions present
  if (window.MS_actions){
    const orig = window.MS_actions;
    orig.generateLineage = function(){
      try{
        const data = (typeof window.__ms_getData === 'function' ? window.__ms_getData() : window.__ms_data) || {};
        const model = extractModel(data);

        const files = [
          { path: 'lineage/edges.csv', content: toCSV(model) },
          { path: 'lineage/graph.dot', content: toDOT(model) },
          { path: 'lineage/openlineage.json', content: toOpenLineage(model) },
          { path: 'lineage/README-LINEAGE.md', content:
`# MissionSmith Lineage Bundle

This bundle provides three interoperable artifacts:

1) **edges.csv** â€” simple \`from,to,relation\` edge list (easy to load in Neo4j/NetworkX/Gephi).
2) **graph.dot** â€” Graphviz DOT for quick rendering to SVG/PNG (\`dot -Tsvg graph.dot -o graph.svg\`).
3) **openlineage.json** â€” lightweight OpenLineage-style events that many tools can ingest (e.g. Marquez).

### Relations
- \`consumed_by\`: dataset â†’ service
- \`deploys\`: pipeline â†’ service
- \`governs\`: policy â†’ (service|pipeline)
- \`drives\`: objective â†’ pipeline

> Model is generated bestâ€‘effort from your MissionSmith data. Customize by editing this README or the JSON.
`
          }
        ];

        const chunks = ['# --- BEGIN MISSIONSMITH LINEAGE BUNDLE ---'];
        for (const f of files){ chunks.push(`\n# FILE: ${f.path}\n\n${f.content}`); }
        const blob = new Blob([chunks.join('\n')], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'mission-lineage-bundle.txt';
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 200);

        alert('âœ… Lineage bundle generated: edges.csv, graph.dot, openlineage.json.');
      }catch(e){
        console.error('generateLineage failed', e);
        alert('Failed to generate lineage bundle.');
      }
    };
    window.MS_actions = orig;
  }
})();
</script>


<!-- === MissionSmith Analytics Generator v1.0 === -->
<script>
(function(){
  function safe(v, d){ return (v===undefined||v===null) ? d : v; }
  function norm(s){ return String(s||'').trim().replace(/[^a-z0-9-_:.]/ig,'_'); }
  function title(s){ return String(s||'').trim(); }

  function extractKPIs(data){
    // Try multiple places: nfr.slo, nfr.kpis, analytics.kpis, objectives.*.kpi
    const sc = data?.serviceConfig || {};
    const slo = safe(sc?.nfr?.slo, []);
    const k1 = slo.map(s => ({key: norm(s.name||s.id||'slo'), name: title(s.name||s.id||'SLO'), target: s.target, window: s.window || '30d', unit: s.unit || '%', source: s.source || 'app_metrics'}));

    const k2 = safe(sc?.nfr?.kpis, []).map(k => ({
      key: norm(k.key||k.name), name: title(k.name||k.key), unit: k.unit||'count', target: k.target, source: k.source||'events'
    }));

    const k3 = safe(data?.analytics?.kpis, []).map(k => ({
      key: norm(k.key||k.name), name: title(k.name||k.key), unit: k.unit||'count', target: k.target, source: k.source||'warehouse'
    }));

    // derive from objectives with "KPI:" prefix
    const objectives = safe(data?.objectives || data?.missionObjectives, []);
    const k4 = objectives
      .filter(o => (o?.kpi || '').toString().length || /kpi[:=]/i.test(String(o?.notes||'')))
      .map((o,i)=>{
        const nm = o?.kpi || String(o?.notes||'').match(/kpi[:=]\s*([^\n]+)/i)?.[1] || `objective_kpi_${i+1}`;
        return {key: norm(nm), name: title(nm), unit: 'count', target: o?.target, source: 'derived'};
      });

    const all = [...k1, ...k2, ...k3, ...k4];
    // de-dup by key
    const seen = new Set(); const uniq=[];
    all.forEach(k => { if(!k.key) return; if(!seen.has(k.key)){ seen.add(k.key); uniq.push(k);} });
    if (uniq.length===0){
      // Provide sensible defaults
      uniq.push({key:'latency_p95_ms', name:'Latency p95', unit:'ms', target: 300, source:'app_metrics'});
      uniq.push({key:'error_rate_pct', name:'Error Rate', unit:'%', target: 1, source:'app_metrics'});
      uniq.push({key:'throughput_rps', name:'Throughput', unit:'rps', target: null, source:'app_metrics'});
    }
    return uniq;
  }

  function toMetricsCatalog(kpis){
    const lines = [];
    lines.push('apiVersion: v1');
    lines.push('kind: MetricsCatalog');
    lines.push('metadata:');
    lines.push('  name: missionsmith-metrics');
    lines.push('spec:');
    lines.push('  kpis:');
    kpis.forEach(k => {
      lines.push(`  - key: ${k.key}`);
      lines.push(`    name: "${k.name}"`);
      if (k.unit!=null) lines.push(`    unit: "${k.unit}"`);
      if (k.target!=null) lines.push(`    target: ${k.target}`);
      lines.push(`    source: "${k.source||'warehouse'}"`);
      lines.push(`    owners:`);
      lines.push(`      - platform`);
    });
    return lines.join('\n') + '\n';
  }

  function toPrometheusRules(kpis, app){
    const hdr = [
      'groups:',
      '- name: missionsmith.rules',
      '  interval: 30s',
      '  rules:'
    ];
    const rules = [];
    kpis.forEach(k => {
      if(/error_rate/.test(k.key)){
        rules.push(
`  - alert: HighErrorRate
    expr: rate(http_requests_total{service="${app}",status=~"5.."}[5m]) / clamp_min(rate(http_requests_total{service="${app}"}[5m]),1) * 100 > ${k.target||1}
    for: 10m
    labels: { severity: "page" }
    annotations:
      summary: "High error rate on ${app}"
      description: "Error rate > ${k.target||1}% for 10m"`);
      }
      if(/latency|p95/.test(k.key)){
        rules.push(
`  - alert: HighLatencyP95
    expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="${app}"}[5m])) by (le)) * 1000 > ${k.target||300}
    for: 10m
    labels: { severity: "page" }
    annotations:
      summary: "High latency p95 on ${app}"
      description: "Latency p95 > ${k.target||300}ms for 10m"`);
      }
    });
    if (rules.length===0){
      rules.push(
`  - alert: ServiceDown
    expr: up{service="${app}"} == 0
    for: 5m
    labels: { severity: "page" }
    annotations:
      summary: "${app} is down"
      description: "No scrape targets reporting for 5m"`);
    }
    return hdr.concat(rules).join('\n') + '\n';
  }

  function toGrafanaDashboard(kpis, app){
    // Minimal Grafana JSON model (v5+ export-ish, not strict; user can import and tweak).
    const dash = {
      annotations: { list: [{builtIn:1, datasource:'-- Grafana --', enable:true, hide:true, iconColor:'rgba(0, 211, 255, 1)', name:'Annotations & Alerts', type:'dashboard'}]},
      editable: true,
      graphTooltip: 0,
      panels: [],
      schemaVersion: 25,
      style: 'dark',
      tags: ['missionsmith','starter'],
      templating: { list: [{name: 'service', type: 'query', query: `label_values(up, service)`, label: 'Service', current: {text: app, value: app}}]},
      time: { from: 'now-6h', to: 'now' },
      timepicker: {},
      timezone: '',
      title: `${app} | MissionSmith Analytics`,
      version: 1
    };

    let id = 1; let y=0;
    function panelFor(key, title, expr){
      const p = {
        id: id++,
        gridPos: {h:8, w:12, x: (id%2?0:12), y: y + (id%2?0:8)},
        type: 'timeseries',
        title: `${title}`,
        targets: [{expr, refId:'A'}]
      };
      return p;
    }

    // Basic panels
    dash.panels.push(panelFor('rps', 'Throughput (RPS)', `sum(rate(http_requests_total{service="$service"}[1m]))`));
    dash.panels.push(panelFor('latency_p95', 'Latency p95 (ms)', `histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="$service"}[5m])) by (le)) * 1000`));
    dash.panels.push(panelFor('error_rate', 'Error Rate (%)', `sum(rate(http_requests_total{service="$service",status=~"5.."}[5m])) / clamp_min(sum(rate(http_requests_total{service="$service"}[5m])),1) * 100`));

    // KPI panels
    kpis.forEach(k => {
      if (/latency|p95/.test(k.key) || /error_rate/.test(k.key) || /throughput|rps/.test(k.key)) return;
      // Put generic counter panels â€” user can edit later
      dash.panels.push(panelFor(k.key, k.name, `sum(missionsmith_${k.key}{service="$service"})`));
    });

    return JSON.stringify(dash, null, 2);
  }

  function toDBTScaffold(app){
    return `# dbt project for MissionSmith
name: 'missionsmith_${app}'
version: '1.0'
config-version: 2

profile: 'default'

models:
  missionsmith_${app}:
    +materialized: view
`;
  }

  function toDBTModelSQL(kpis){
    const lines = [];
    lines.push('-- Example KPI model (replace with your warehouse SQL)');
    lines.push('with events as (');
    lines.push('  select * from source(\'app\', \'events\')');
    lines.push(')');
    lines.push('select');
    kpis.forEach((k,i)=>{
      const comma = (i<kpis.length-1)?',':'';
      lines.push(`  /* ${k.name} */ null as ${k.key}${comma}`);
    });
    lines.push('from events');
    lines.push('limit 1');
    return lines.join('\n') + '\n';
  }

  if (window.MS_actions){
    const orig = window.MS_actions;
    orig.generateAnalytics = function(){
      try{
        const data = (typeof window.__ms_getData === 'function' ? window.__ms_getData() : window.__ms_data) || {};
        const sc = data?.serviceConfig || {};
        const app = (sc.default_service_name || 'app').toString().trim();
        const kpis = extractKPIs(data);

        const files = [
          { path: 'analytics/metrics-catalog.yaml', content: toMetricsCatalog(kpis) },
          { path: 'analytics/prometheus-rules.yaml', content: toPrometheusRules(kpis, app) },
          { path: 'analytics/grafana-dashboard.json', content: toGrafanaDashboard(kpis, app) },
          { path: 'analytics/dbt/project.yml', content: toDBTScaffold(app) },
          { path: 'analytics/dbt/models/kpis.sql', content: toDBTModelSQL(kpis) },
          { path: 'analytics/README-ANALYTICS.md', content:
`# MissionSmith Analytics Bundle

This starter pack gives you:
- **metrics-catalog.yaml** â€” canonical KPI list (keys, units, targets, ownership).
- **prometheus-rules.yaml** â€” alert rules keyed off latency, error rate, and common KPIs.
- **grafana-dashboard.json** â€” importable dashboard with RPS, p95 latency, error %, and KPI panels.
- **dbt/** â€” a minimal scaffold to materialize KPI views in your warehouse.

## Next steps
1. Import \`grafana-dashboard.json\` into Grafana; set Prometheus as the data source.
2. Load \`prometheus-rules.yaml\` into your Prometheus/Alertmanager setup.
3. Store your KPI definitions in \`metrics-catalog.yaml\` and keep them versioned with code.
4. Point \`dbt/models/kpis.sql\` at your real warehouse schema and build with \`dbt build\`.

> KPIs were inferred from your MissionSmith data (nfr.slo / nfr.kpis / analytics.kpis / objectives). Edit this bundle as needed.
`}
        ];

        const chunks = ['# --- BEGIN MISSIONSMITH ANALYTICS BUNDLE ---'];
        files.forEach(f => chunks.push(`\n# FILE: ${f.path}\n\n${f.content}`));
        const blob = new Blob([chunks.join('\n')], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'mission-analytics-bundle.txt';
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 200);

        alert('âœ… Analytics bundle generated: metrics catalog, Prometheus rules, Grafana dashboard, dbt scaffold.');
      }catch(e){
        console.error('generateAnalytics failed', e);
        alert('Failed to generate analytics bundle.');
      }
    };
    window.MS_actions = orig;
  }
})();
</script>

</body>
</html>


===== FILE: app_frontend\README.md =====
# React + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend using TypeScript with type-aware lint rules enabled. Check out the [TS template](https://github.com/vitejs/vite/tree/main/packages/create-vite/template-react-ts) for information on how to integrate TypeScript and [`typescript-eslint`](https://typescript-eslint.io) in your project.


===== FILE: app_frontend\src\App.css =====
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}


===== FILE: app_frontend\src\App.jsx =====
import React, { useEffect, useMemo, useState } from "react";
import MissionLogPanel from "./MissionLogPanel";
import MissionAtlasPanel from "./MissionAtlasPanel";
import DetailedClientProfilePanel from "./DetailedClientProfilePanel";
import logo from "./assets/m7_single_client_view.png";

const BACKEND_BASE_URL = "http://127.0.0.1:8000";

function App() {
  const [clientId, setClientId] = useState("");
  const [loading, setLoading] = useState(false);
  const [profile, setProfile] = useState(null);
  const [sources, setSources] = useState([]);
  const [error, setError] = useState("");

  // NEW: toggle detailed panel (no routing, no landing regression)
  const [showDetailedProfile, setShowDetailedProfile] = useState(false);

  // Client index (landing screen list)
  const [clientIndex, setClientIndex] = useState([]); // [{client_id,name,risk_rating,status,segment}]
  const [clients, setClients] = useState([]); // datalist IDs
  const [clientsLoading, setClientsLoading] = useState(false);
  const [clientIndexError, setClientIndexError] = useState("");

  // Landing screen search & filters
  const [clientSearch, setClientSearch] = useState("");
  const [riskFilter, setRiskFilter] = useState("All");
  const [statusFilter, setStatusFilter] = useState("All");

  // 'scv' | 'missionLog' | 'missionAtlas'
  const [activeView, setActiveView] = useState("scv");

  // Fetch client index (best-effort; UI degrades gracefully if endpoint not available)
  useEffect(() => {
    let cancelled = false;

    const normaliseRow = (x) => {
      if (typeof x === "string") {
        return {
          client_id: x,
          name: "",
          risk_rating: "",
          status: "",
          segment: "",
        };
      }

      const client_id = x?.client_id ?? x?.clientId ?? x?.id ?? "";
      const name =
        x?.name ??
        x?.full_name ??
        x?.fullName ??
        x?.client_name ??
        x?.clientName ??
        "";
      const risk_rating = x?.risk_rating ?? x?.riskRating ?? x?.risk ?? "";
      const status =
        x?.status ?? x?.current_status ?? x?.currentStatus ?? x?.state ?? "";
      const segment = x?.segment ?? x?.client_segment ?? x?.clientSegment ?? "";

      return {
        client_id: String(client_id || "").trim(),
        name: String(name || "").trim(),
        risk_rating: String(risk_rating || "").trim(),
        status: String(status || "").trim(),
        segment: String(segment || "").trim(),
      };
    };

    const fetchClientIndex = async () => {
      setClientsLoading(true);
      setClientIndexError("");

      try {
        const res = await fetch(`${BACKEND_BASE_URL}/clients/`);
        if (!res.ok) {
          throw new Error(`Client list not available (${res.status}).`);
        }

        const data = await res.json();
        if (cancelled) return;

        const raw = Array.isArray(data) ? data : data?.clients || [];
        const rows = raw
          .map(normaliseRow)
          .filter((r) => r.client_id && r.client_id.length > 0);

        const ids = rows.map((r) => r.client_id);

        setClientIndex(rows);
        setClients(ids);
      } catch (err) {
        console.warn(err);
        if (!cancelled) {
          setClientIndex([]);
          setClients([]);
          setClientIndexError(err?.message || "Client list not available.");
        }
      } finally {
        if (!cancelled) setClientsLoading(false);
      }
    };

    fetchClientIndex();

    return () => {
      cancelled = true;
    };
  }, []);

  const filteredClientIndex = useMemo(() => {
    const q = clientSearch.trim().toLowerCase();

    return clientIndex.filter((c) => {
      const matchesSearch =
        !q ||
        c.client_id.toLowerCase().includes(q) ||
        (c.name || "").toLowerCase().includes(q) ||
        (c.segment || "").toLowerCase().includes(q) ||
        (c.status || "").toLowerCase().includes(q) ||
        (c.risk_rating || "").toLowerCase().includes(q);

      const matchesRisk =
        riskFilter === "All" ||
        (c.risk_rating || "").toLowerCase() === riskFilter.toLowerCase();

      const matchesStatus =
        statusFilter === "All" ||
        (c.status || "").toLowerCase() === statusFilter.toLowerCase();

      return matchesSearch && matchesRisk && matchesStatus;
    });
  }, [clientIndex, clientSearch, riskFilter, statusFilter]);

  const distinctRiskRatings = useMemo(() => {
    const set = new Set(
      clientIndex
        .map((c) => (c.risk_rating || "").trim())
        .filter((v) => v.length > 0)
    );
    return Array.from(set).sort((a, b) => a.localeCompare(b));
  }, [clientIndex]);

  const distinctStatuses = useMemo(() => {
    const set = new Set(
      clientIndex
        .map((c) => (c.status || "").trim())
        .filter((v) => v.length > 0)
    );
    return Array.from(set).sort((a, b) => a.localeCompare(b));
  }, [clientIndex]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!clientId.trim()) {
      setError("Please enter a Client ID.");
      return;
    }

    setError("");
    setLoading(true);
    setProfile(null);
    setSources([]);
    setShowDetailedProfile(false); // NEW: reset panel on new fetch

    try {
      const encodedId = encodeURIComponent(clientId.trim());

      const profileRes = await fetch(
        `${BACKEND_BASE_URL}/clients/${encodedId}/profile`
      );
      if (!profileRes.ok) {
        const detail = await profileRes.json().catch(() => ({}));
        throw new Error(detail.detail || "Failed to fetch profile.");
      }
      const profileJson = await profileRes.json();

      // Keep existing logging
      console.log("Profile Response:", profileJson);

      setProfile(profileJson);

      const sourcesRes = await fetch(
        `${BACKEND_BASE_URL}/clients/${encodedId}/sources`
      );
      const sourcesJson = sourcesRes.ok ? await sourcesRes.json() : [];

      setSources(sourcesJson);
    } catch (err) {
      console.error(err);
      setError(err.message || "Something went wrong.");
    } finally {
      setLoading(false);
    }
  };

  const isMissionLog = activeView === "missionLog";
  const isMissionAtlas = activeView === "missionAtlas";

  const viewDetailsDisabled = !profile;

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header with MissionHalo logo */}
      <header className="bg-white shadow-sm">
        <div className="max-w-6xl mx-auto px-4 py-4">
          <img
            src={logo}
            alt="M7 single client view"
            className="h-16 w-auto md:h-20"
          />
        </div>

        {/* Mission buttons bar */}
        <div className="bg-gray-100 border-t border-gray-200">
          <div className="max-w-6xl mx-auto px-4 py-3 flex justify-end gap-4">
            <button
              type="button"
              style={{ fontFamily: "Fjalla One" }}
              className="inline-flex items-center justify-center px-8 py-2.5 rounded-md text-base text-gray-900 bg-[rgb(176,192,159)] shadow-sm transition-all duration-150 hover:-translate-y-0.5 hover:shadow-md active:translate-y-0 active:shadow-sm"
              onClick={() =>
                window.open(
                  `${window.location.origin}/MissionSmith-M7-SingleClientView.html`,
                  "_blank",
                  "noopener,noreferrer"
                )
              }
            >
              MissionSmith
            </button>

            <button
              type="button"
              style={{ fontFamily: "Fjalla One" }}
              className="inline-flex items-center justify-center px-8 py-2.5 rounded-md text-base text-gray-900 bg-[rgb(205,226,235)] shadow-sm transition-all duration-150 hover:-translate-y-0.5 hover:shadow-md active:translate-y-0 active:shadow-sm"
              onClick={() => setActiveView("missionAtlas")}
            >
              MissionAtlas
            </button>

            <button
              type="button"
              style={{ fontFamily: "Fjalla One" }}
              className="inline-flex items-center justify-center px-8 py-2.5 rounded-md text-base text-gray-900 bg-[rgb(241,205,86)] shadow-sm transition-all duration-150 hover:-translate-y-0.5 hover:shadow-md active:translate-y-0 active:shadow-sm"
              onClick={() => setActiveView("missionLog")}
            >
              MissionLog
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto px-4 py-6">
        {isMissionLog ? (
          <MissionLogPanel setActiveView={setActiveView} />
        ) : isMissionAtlas ? (
          <MissionAtlasPanel />
        ) : (
          <>
            {/* 4.1 Landing screen: Client Overview */}
            <section className="bg-white rounded-halo shadow-sm border border-gray-200 p-6 mb-6">
              <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                <div>
                  <h2 className="font-heading text-lg text-gray-800">
                    Client overview
                  </h2>
                  <p className="mt-1 text-sm font-body text-gray-600">
                    Search and filter clients, then navigate to the detailed profile.
                  </p>
                </div>

                <div className="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                  <div className="flex-1 sm:w-64">
                    <label className="block text-sm font-body text-gray-700 mb-1">
                      Search
                    </label>
                    <input
                      type="text"
                      value={clientSearch}
                      onChange={(e) => setClientSearch(e.target.value)}
                      className="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm font-body text-gray-900 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#1A9988]"
                      placeholder="Name, ID, segmentâ€¦"
                    />
                  </div>

                  <div className="sm:w-44">
                    <label className="block text-sm font-body text-gray-700 mb-1">
                      Risk rating
                    </label>
                    <select
                      value={riskFilter}
                      onChange={(e) => setRiskFilter(e.target.value)}
                      className="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm font-body text-gray-900 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#1A9988]"
                    >
                      <option value="All">All</option>
                      {distinctRiskRatings.map((r) => (
                        <option key={r} value={r}>
                          {r}
                        </option>
                      ))}
                    </select>
                  </div>

                  <div className="sm:w-44">
                    <label className="block text-sm font-body text-gray-700 mb-1">
                      Status
                    </label>
                    <select
                      value={statusFilter}
                      onChange={(e) => setStatusFilter(e.target.value)}
                      className="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm font-body text-gray-900 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#1A9988]"
                    >
                      <option value="All">All</option>
                      {distinctStatuses.map((s) => (
                        <option key={s} value={s}>
                          {s}
                        </option>
                      ))}
                    </select>
                  </div>
                </div>
              </div>

              <div className="mt-5">
                {clientsLoading ? (
                  <p className="text-sm font-body text-gray-500">
                    Loading client listâ€¦
                  </p>
                ) : clientIndexError ? (
                  <p className="text-sm font-body text-gray-500">
                    {clientIndexError}
                  </p>
                ) : filteredClientIndex.length === 0 ? (
                  <p className="text-sm font-body text-gray-500">
                    No clients match your search/filters.
                  </p>
                ) : (
                  <div className="overflow-auto border border-gray-200 rounded-md">
                    <table className="min-w-full text-sm font-body">
                      <thead className="bg-gray-50 text-gray-700">
                        <tr>
                          <th className="text-left px-4 py-3 font-medium">
                            Client ID
                          </th>
                          <th className="text-left px-4 py-3 font-medium">
                            Name
                          </th>
                          <th className="text-left px-4 py-3 font-medium">
                            Risk
                          </th>
                          <th className="text-left px-4 py-3 font-medium">
                            Status
                          </th>
                          <th className="text-left px-4 py-3 font-medium">
                            Segment
                          </th>
                          <th className="text-left px-4 py-3 font-medium">
                            Action
                          </th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {filteredClientIndex.map((c) => (
                          <tr key={c.client_id} className="bg-white">
                            <td className="px-4 py-3 font-mono text-gray-900">
                              {c.client_id}
                            </td>
                            <td className="px-4 py-3 text-gray-900">
                              {c.name || "â€”"}
                            </td>
                            <td className="px-4 py-3 text-gray-900">
                              {c.risk_rating || "â€”"}
                            </td>
                            <td className="px-4 py-3 text-gray-900">
                              {c.status || "â€”"}
                            </td>
                            <td className="px-4 py-3 text-gray-900">
                              {c.segment || "â€”"}
                            </td>
                            <td className="px-4 py-3">
                              <button
                                type="button"
                                className="inline-flex items-center justify-center px-3 py-1.5 rounded-md text-sm text-gray-900 bg-[rgb(205,226,235)] shadow-sm transition-all duration-150 hover:-translate-y-0.5 hover:shadow-md active:translate-y-0 active:shadow-sm"
                                onClick={() => setClientId(c.client_id)}
                                title="Populate Client ID"
                              >
                                Select
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            </section>

            {/* Find client profile */}
            <section className="bg-white rounded-halo shadow-sm border border-gray-200 p-6 mb-6">
              <h2 className="font-heading text-lg text-gray-800 mb-4">
                Find client profile
              </h2>

              <form
                onSubmit={handleSubmit}
                className="flex flex-col md:flex-row gap-4 items-stretch md:items-end"
              >
                <div className="flex-1">
                  <label
                    htmlFor="clientId"
                    className="block text-sm font-body text-gray-700 mb-1"
                  >
                    Client ID
                  </label>
                  <input
                    id="clientId"
                    type="text"
                    value={clientId}
                    onChange={(e) => setClientId(e.target.value)}
                    className="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm font-body text-gray-900 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#1A9988]"
                    placeholder="e.g. client-001"
                    list="clientIdOptions"
                  />
                  <datalist id="clientIdOptions">
                    {clients.map((id) => (
                      <option key={id} value={id} />
                    ))}
                  </datalist>

                  {clientsLoading && (
                    <p className="mt-2 text-xs font-body text-gray-500">
                      Loading client IDsâ€¦
                    </p>
                  )}
                </div>

                <div className="flex flex-row gap-3">
                  <button
                    type="submit"
                    disabled={loading}
                    className={`
                      inline-flex items-center justify-center
                      px-4 py-2 rounded-md
                      bg-[#1A9988] text-white
                      font-body text-sm font-medium
                      shadow-sm
                      transition-colors transition-transform duration-150
                      hover:bg-[#178c7d] hover:-translate-y-0.5 hover:shadow-md
                      active:bg-[#147c6f] active:translate-y-0
                      ${loading ? "opacity-60 cursor-not-allowed" : ""}
                    `}
                  >
                    {loading ? "Loading..." : "Get profile"}
                  </button>

                  {/* NOW WIRED: Detailed Profile button */}
                  <button
                    type="button"
                    disabled={viewDetailsDisabled}
                    className={`
                      inline-flex items-center justify-center
                      px-4 py-2 rounded-md
                      font-body text-sm font-medium
                      shadow-sm
                      transition-colors transition-transform duration-150
                      ${
                        viewDetailsDisabled
                          ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                          : "bg-[rgb(176,192,159)] text-gray-900 hover:-translate-y-0.5 hover:shadow-md active:translate-y-0"
                      }
                    `}
                    onClick={() => {
                      if (!profile) return;
                      setShowDetailedProfile(true);
                      // small UX: nudge scroll to panel on click
                      setTimeout(() => {
                        const el = document.getElementById("scv-detailed-profile");
                        if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
                      }, 50);
                    }}
                    title={
                      viewDetailsDisabled ? "Load a profile first" : "View detailed profile"
                    }
                  >
                    View detailed profile
                  </button>
                </div>
              </form>

              {error && (
                <p className="mt-3 text-sm font-body text-red-600">{error}</p>
              )}
            </section>

            {/* SCV layout grid */}
            {profile && (
              <section className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4">
                {/* Left column: core profile */}
                <div className="space-y-4">
                  <div className="bg-white rounded-halo shadow-sm border border-gray-200 p-6">
                    <h3 className="font-heading text-lg text-gray-800 mb-4">
                      Client profile
                    </h3>

                    <dl className="space-y-2 text-sm font-body text-gray-800">
                      <div className="flex justify-between gap-4">
                        <dt className="text-gray-500">Client ID</dt>
                        <dd className="font-mono text-gray-900">
                          {profile.client_id || "â€”"}
                        </dd>
                      </div>

                      <div className="flex justify-between gap-4">
                        <dt className="text-gray-500">Full name</dt>
                        <dd className="text-right">{profile?.name || "â€”"}</dd>
                      </div>

                      <div className="flex justify-between gap-4">
                        <dt className="text-gray-500">Primary email</dt>
                        <dd className="text-right">{profile?.email || "â€”"}</dd>
                      </div>

                      <div className="flex justify-between gap-4">
                        <dt className="text-gray-500">Primary phone</dt>
                        <dd className="text-right">{profile?.phone || "â€”"}</dd>
                      </div>
                    </dl>
                  </div>

                  {/* Addresses */}
                  {profile?.addresses?.length > 0 && (
                    <div className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                      <h4 className="font-heading text-sm text-gray-700 mb-2">
                        Addresses
                      </h4>

                      <ul className="space-y-2 text-sm font-body">
                        {profile.addresses.map((addr, idx) => (
                          <li
                            key={idx}
                            className="border-b border-gray-200 pb-2 last:border-none"
                          >
                            <div className="text-gray-900">
                              {[
                                addr.line1,
                                addr.line2,
                                addr.city,
                                addr.postcode,
                                addr.country,
                              ]
                                .filter(Boolean)
                                .join(", ")}
                            </div>

                            <div className="text-xs text-gray-500 mt-1">
                              Source: {addr.source || "â€”"}
                            </div>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>

                {/* Right column: raw sources + lineage */}
                <div>
                  <div className="bg-white rounded-halo shadow-sm border border-gray-200 p-6 h-full">
                    <h3 className="font-heading text-lg text-gray-800 mb-4">
                      Raw sources
                    </h3>

                    {sources.length > 0 ? (
                      <div className="space-y-3 text-xs font-mono bg-gray-50 rounded-lg p-3 border border-gray-200 max-h-[400px] overflow-auto">
                        {sources.map((src) => (
                          <div
                            key={src.id}
                            className="bg-white border border-gray-200 rounded-md p-2"
                          >
                            <div className="flex justify-between items-center mb-1">
                              <span className="font-body text-xs text-gray-600">
                                {src.system}
                              </span>
                              <span className="font-body text-[10px] text-gray-400">
                                client_id: {src.client_id}
                              </span>
                            </div>

                            <pre className="whitespace-pre-wrap text-[11px] text-gray-800">
                              {JSON.stringify(src.payload, null, 2)}
                            </pre>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-sm font-body text-gray-500">
                        No raw sources available.
                      </p>
                    )}

                    {profile?.lineage && (
                      <>
                        <h4 className="font-heading text-sm text-gray-700 mt-4 mb-2">
                          Lineage
                        </h4>
                        <div className="bg-gray-50 rounded-lg p-3 border border-gray-200 text-xs font-body max-h-[200px] overflow-auto">
                          <pre className="whitespace-pre-wrap text-[11px] text-gray-800">
                            {JSON.stringify(profile.lineage, null, 2)}
                          </pre>
                        </div>
                      </>
                    )}
                  </div>
                </div>
              </section>
            )}

            {/* NEW: Detailed Profile panel (below existing SCV grid, no regression) */}
            {profile && showDetailedProfile && (
              <div id="scv-detailed-profile">
                <DetailedClientProfilePanel
                  profile={profile}
                  onClose={() => setShowDetailedProfile(false)}
                />
              </div>
            )}
          </>
        )}
      </main>
    </div>
  );
}

export default App;

























===== FILE: app_frontend\src\DetailedClientProfilePanel.jsx =====
import React, { useMemo, useState } from "react";

function safeStr(v) {
  if (v === null || v === undefined) return "";
  return String(v);
}

function formatTs(ts) {
  if (!ts) return "â€”";
  const d = new Date(ts);
  if (Number.isNaN(d.getTime())) return safeStr(ts);
  return d.toLocaleString();
}

function formatDateOnly(ts) {
  if (!ts) return "â€”";
  const d = new Date(ts);
  if (Number.isNaN(d.getTime())) return safeStr(ts);
  return d.toLocaleDateString("en-GB");
}

function formatNum(v, digits = 2) {
  if (v === null || v === undefined || v === "") return "â€”";
  const n = typeof v === "number" ? v : Number(v);
  if (!Number.isFinite(n)) return safeStr(v);
  return n.toFixed(digits);
}

function formatQty(v) {
  if (v === null || v === undefined || v === "") return "â€”";
  const n = typeof v === "number" ? v : Number(v);
  if (!Number.isFinite(n)) return safeStr(v);
  return new Intl.NumberFormat("en-GB", { maximumFractionDigits: 0 }).format(n);
}

function StatusChip({ label }) {
  const text = (label || "").toLowerCase();

  let classes =
    "inline-flex items-center rounded-full px-2.5 py-1 text-xs font-body border";

  if (
    text.includes("active") ||
    text.includes("complete") ||
    text.includes("passed") ||
    text.includes("match")
  ) {
    classes += " bg-emerald-50 text-emerald-700 border-emerald-200";
  } else if (
    text.includes("review") ||
    text.includes("progress") ||
    text.includes("pending")
  ) {
    classes += " bg-amber-50 text-amber-700 border-amber-200";
  } else if (
    text.includes("fail") ||
    text.includes("reject") ||
    text.includes("error")
  ) {
    classes += " bg-red-50 text-red-700 border-red-200";
  } else {
    classes += " bg-gray-50 text-gray-700 border-gray-200";
  }

  return <span className={classes}>{label || "â€”"}</span>;
}

function DirectionChip({ value }) {
  const v = (value || "").toString().trim().toUpperCase();

  let classes =
    "inline-flex items-center rounded-full px-2.5 py-1 text-xs font-body border";

  if (v === "BUY") {
    classes += " bg-emerald-50 text-emerald-700 border-emerald-200";
  } else if (v === "SELL") {
    classes += " bg-red-50 text-red-700 border-red-200";
  } else {
    classes += " bg-gray-50 text-gray-700 border-gray-200";
  }

  return <span className={classes}>{v || "â€”"}</span>;
}

function Metric({ label, value, mono = false }) {
  return (
    <div className="flex items-start justify-between gap-4">
      <dt className="text-gray-500">{label}</dt>
      <dd className={`text-right text-gray-900 ${mono ? "font-mono" : ""}`}>
        {value || "â€”"}
      </dd>
    </div>
  );
}

function ConfidenceBar({ value }) {
  const num = typeof value === "number" ? value : Number(value);
  const pct = Number.isFinite(num) ? Math.max(0, Math.min(1, num)) * 100 : null;

  return (
    <div className="min-w-[140px]">
      <div className="flex items-center justify-between mb-1">
        <span className="text-xs font-body text-gray-600">Confidence</span>
        <span className="text-xs font-mono text-gray-700">
          {pct === null ? "â€”" : `${pct.toFixed(1)}%`}
        </span>
      </div>
      <div className="h-2 w-full rounded-full bg-gray-200 overflow-hidden">
        <div
          className="h-2 rounded-full bg-[#1A9988]"
          style={{ width: pct === null ? "0%" : `${pct}%` }}
        />
      </div>
    </div>
  );
}

export default function DetailedClientProfilePanel({
  profile,
  onClose,
  title = "Detailed client profile",
}) {
  const [expandedMatch, setExpandedMatch] = useState({});
  const [expandedAudit, setExpandedAudit] = useState({});
  const [expandedTrade, setExpandedTrade] = useState({});

  const header = useMemo(() => {
    const clientId = safeStr(profile?.client_id || profile?.clientId || "");
    const name = safeStr(
      profile?.name || profile?.full_name || profile?.fullName || ""
    );
    const segment = safeStr(profile?.segment || "");
    const risk = safeStr(profile?.risk_rating || profile?.riskRating || "");
    const lastUpdated =
      profile?.last_updated_at ||
      profile?.lastUpdatedAt ||
      profile?.operational_state?.as_of ||
      "";

    const status = safeStr(
      profile?.operational_state?.status ||
        profile?.status ||
        profile?.current_status ||
        ""
    );

    return {
      clientId: clientId || "â€”",
      name: name || "â€”",
      segment: segment || "â€”",
      risk: risk || "â€”",
      lastUpdated: lastUpdated ? formatTs(lastUpdated) : "â€”",
      status: status || "â€”",
    };
  }, [profile]);

  const operational = profile?.operational_state || null;
  const reg = profile?.regulatory_enrichment || null;

  const matchDecisions = Array.isArray(profile?.match_decisions)
    ? profile.match_decisions
    : [];

  const evidenceArtefacts = Array.isArray(profile?.evidence_artefacts)
    ? profile.evidence_artefacts
    : [];

  const auditTrail = Array.isArray(profile?.audit_trail)
    ? profile.audit_trail
    : [];

  // Trade history (reads from real backend payload; no mocking)
  const tradeHistory = useMemo(() => {
    const arr = Array.isArray(profile?.trade_history)
      ? profile.trade_history
      : Array.isArray(profile?.trades)
        ? profile.trades
        : [];
    // Sort newest first if trade_date present (keeps UI stable)
    return [...arr].sort((a, b) => {
      const da = new Date(a?.trade_date || a?.tradeDate || 0).getTime();
      const db = new Date(b?.trade_date || b?.tradeDate || 0).getTime();
      return (Number.isFinite(db) ? db : 0) - (Number.isFinite(da) ? da : 0);
    });
  }, [profile]);

  return (
    <section className="bg-white rounded-halo shadow-sm border border-gray-200 p-6 mt-6">
      {/* Header */}
      <div className="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
        <div>
          <h2 className="font-heading text-lg text-gray-800">{title}</h2>
          <div className="mt-2 flex flex-wrap items-center gap-2">
            <span className="text-sm font-body text-gray-900">{header.name}</span>
            <span className="text-xs font-mono text-gray-500">
              ({header.clientId})
            </span>
            <span className="text-xs font-body text-gray-400">â€¢</span>
            <span className="text-xs font-body text-gray-600">
              Segment: {header.segment}
            </span>
            <span className="text-xs font-body text-gray-400">â€¢</span>
            <span className="text-xs font-body text-gray-600">
              Risk: {header.risk}
            </span>
          </div>
        </div>

        <div className="flex flex-col items-start md:items-end gap-2">
          <div className="flex items-center gap-2">
            <StatusChip label={header.status} />
            <span className="text-xs font-body text-gray-500">
              Last update:{" "}
              <span className="font-mono">{header.lastUpdated}</span>
            </span>
          </div>

          <button
            type="button"
            onClick={onClose}
            className="inline-flex items-center justify-center px-3 py-1.5 rounded-md text-sm font-body font-medium bg-gray-100 text-gray-800 border border-gray-200 shadow-sm transition-all duration-150 hover:-translate-y-0.5 hover:shadow-md active:translate-y-0"
          >
            Close
          </button>
        </div>
      </div>

      {/* Two-column content */}
      <div className="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* LEFT COLUMN */}
        <div className="space-y-6">
          {/* 1. Client Information */}
          <div className="bg-white rounded-halo shadow-sm border border-gray-200 p-6">
            <h3 className="font-heading text-base text-gray-800 mb-4">
              Client information
            </h3>

            <dl className="space-y-2 text-sm font-body text-gray-800">
              <Metric label="Client ID" value={safeStr(profile?.client_id)} mono />
              <Metric label="Full name" value={safeStr(profile?.name)} />
              <Metric label="Primary email" value={safeStr(profile?.email)} />
              <Metric label="Primary phone" value={safeStr(profile?.phone)} />
              <Metric label="Country" value={safeStr(profile?.country)} />
              <Metric
                label="Primary address"
                value={safeStr(profile?.primary_address)}
              />
              <Metric label="Segment" value={safeStr(profile?.segment)} />
              <Metric label="Risk rating" value={safeStr(profile?.risk_rating)} />
            </dl>

            {/* Key metrics */}
            <div className="mt-4 bg-gray-50 rounded-lg border border-gray-200 p-4">
              <h4 className="font-heading text-sm text-gray-700 mb-2">
                Key metrics
              </h4>
              <dl className="space-y-2 text-sm font-body text-gray-800">
                <Metric label="Current status" value={safeStr(header.status)} />
                <Metric label="Last updated" value={header.lastUpdated} mono />
                {operational && (
                  <>
                    <Metric
                      label="Processing stage"
                      value={safeStr(operational.processing_stage)}
                    />
                    <Metric label="Message" value={safeStr(operational.message)} />
                  </>
                )}
              </dl>
            </div>
          </div>

          {/* 3. Regulatory Enrichment */}
          <div className="bg-white rounded-halo shadow-sm border border-gray-200 p-6">
            <h3 className="font-heading text-base text-gray-800 mb-4">
              Regulatory enrichment
            </h3>

            {!reg ? (
              <p className="text-sm font-body text-gray-500">
                No regulatory enrichment available.
              </p>
            ) : (
              <dl className="space-y-2 text-sm font-body text-gray-800">
                <Metric label="FATCA status" value={safeStr(reg.fatca_status)} />
                <Metric
                  label="KYC status"
                  value={safeStr(reg.kyc_overall_status || reg.kyc_status)}
                />
                <Metric
                  label="Risk assessment"
                  value={safeStr(reg.risk_assessment)}
                />
                <Metric
                  label="Onboarding status"
                  value={safeStr(reg.onboarding_status)}
                />
                <Metric label="CRS status" value={safeStr(reg.crs_status)} />
                {reg.derived_risk_notes && (
                  <div className="mt-3 text-sm font-body text-gray-800">
                    <div className="text-gray-500 mb-1">Notes</div>
                    <div className="bg-gray-50 rounded-md border border-gray-200 p-3 text-gray-900">
                      {safeStr(reg.derived_risk_notes)}
                    </div>
                  </div>
                )}
              </dl>
            )}
          </div>

          {/* 4. Evidence Artefacts */}
          <div className="bg-white rounded-halo shadow-sm border border-gray-200 p-6">
            <h3 className="font-heading text-base text-gray-800 mb-4">
              Evidence artefacts
            </h3>

            {evidenceArtefacts.length === 0 ? (
              <p className="text-sm font-body text-gray-500">
                No evidence artefacts available.
              </p>
            ) : (
              <div className="overflow-auto border border-gray-200 rounded-md">
                <table className="min-w-full text-sm font-body">
                  <thead className="bg-gray-50 text-gray-700">
                    <tr>
                      <th className="text-left px-4 py-3 font-medium">Type</th>
                      <th className="text-left px-4 py-3 font-medium">Created</th>
                      <th className="text-left px-4 py-3 font-medium">Source</th>
                      <th className="text-left px-4 py-3 font-medium">Reference</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200 bg-white">
                    {evidenceArtefacts.map((a, idx) => (
                      <tr key={a.artefact_id || a.id || idx}>
                        <td className="px-4 py-3 text-gray-900">
                          {safeStr(a.artefact_type || a.document_type || a.type) ||
                            "â€”"}
                        </td>
                        <td className="px-4 py-3 text-gray-900 font-mono text-xs">
                          {formatTs(a.created_at || a.uploaded_at || a.upload_date)}
                        </td>
                        <td className="px-4 py-3 text-gray-900">
                          {safeStr(a.source_system || a.source) || "â€”"}
                        </td>
                        <td className="px-4 py-3 text-gray-900 font-mono text-xs">
                          {safeStr(a.storage_ref || a.link || a.reference) || "â€”"}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>

        {/* RIGHT COLUMN */}
        <div className="space-y-6">
          {/* 2. Match Decisions */}
          <div className="bg-white rounded-halo shadow-sm border border-gray-200 p-6">
            <h3 className="font-heading text-base text-gray-800 mb-4">
              Match decisions
            </h3>

            {matchDecisions.length === 0 ? (
              <p className="text-sm font-body text-gray-500">
                No match decisions available.
              </p>
            ) : (
              <div className="overflow-auto border border-gray-200 rounded-md">
                <table className="min-w-full text-sm font-body">
                  <thead className="bg-gray-50 text-gray-700">
                    <tr>
                      <th className="text-left px-4 py-3 font-medium">Decided</th>
                      <th className="text-left px-4 py-3 font-medium">Decision</th>
                      <th className="text-left px-4 py-3 font-medium">Source</th>
                      <th className="text-left px-4 py-3 font-medium">IDs</th>
                      <th className="text-left px-4 py-3 font-medium">
                        Confidence
                      </th>
                      <th className="text-left px-4 py-3 font-medium">Action</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200 bg-white">
                    {matchDecisions.map((m, idx) => {
                      const key = m.match_decision_id || m.id || idx;
                      const isOpen = !!expandedMatch[key];

                      return (
                        <React.Fragment key={key}>
                          <tr>
                            <td className="px-4 py-3 font-mono text-xs text-gray-900">
                              {formatTs(m.decided_at)}
                            </td>
                            <td className="px-4 py-3 text-gray-900">
                              <StatusChip label={safeStr(m.decision)} />
                            </td>
                            <td className="px-4 py-3 text-gray-900">
                              {safeStr(m.source_system || m.system) || "â€”"}
                            </td>
                            <td className="px-4 py-3 text-gray-900">
                              <div className="text-xs font-mono text-gray-700">
                                src: {safeStr(m.source_record_id) || "â€”"}
                              </div>
                              <div className="text-xs font-mono text-gray-700">
                                match: {safeStr(m.matched_client_id) || "â€”"}
                              </div>
                            </td>
                            <td className="px-4 py-3">
                              <ConfidenceBar value={m.confidence} />
                            </td>
                            <td className="px-4 py-3">
                              <button
                                type="button"
                                className="inline-flex items-center justify-center px-3 py-1.5 rounded-md text-sm text-gray-900 bg-[rgb(205,226,235)] shadow-sm transition-all duration-150 hover:-translate-y-0.5 hover:shadow-md active:translate-y-0 active:shadow-sm"
                                onClick={() =>
                                  setExpandedMatch((prev) => ({
                                    ...prev,
                                    [key]: !prev[key],
                                  }))
                                }
                              >
                                {isOpen ? "Hide" : "View"}
                              </button>
                            </td>
                          </tr>

                          {isOpen && (
                            <tr className="bg-gray-50">
                              <td colSpan={6} className="px-4 py-3">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                  <div className="bg-white border border-gray-200 rounded-md p-3">
                                    <div className="text-xs font-body text-gray-600 mb-2">
                                      Rule hits
                                    </div>
                                    <pre className="whitespace-pre-wrap text-[11px] font-mono text-gray-800">
                                      {JSON.stringify(m.rule_hits || {}, null, 2)}
                                    </pre>
                                  </div>
                                  <div className="bg-white border border-gray-200 rounded-md p-3">
                                    <div className="text-xs font-body text-gray-600 mb-2">
                                      Conflict summary
                                    </div>
                                    <pre className="whitespace-pre-wrap text-[11px] font-mono text-gray-800">
                                      {JSON.stringify(
                                        m.conflict_summary || {},
                                        null,
                                        2
                                      )}
                                    </pre>
                                  </div>
                                </div>
                              </td>
                            </tr>
                          )}
                        </React.Fragment>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {/* Trade History */}
          <div className="bg-white rounded-halo shadow-sm border border-gray-200 p-6">
            <h3 className="font-heading text-base text-gray-800 mb-4">
              Trade history
            </h3>

            {tradeHistory.length === 0 ? (
              <p className="text-sm font-body text-gray-500">
                No trade history available.
              </p>
            ) : (
              <div className="overflow-auto border border-gray-200 rounded-md">
                <table className="min-w-full text-sm font-body">
                  <thead className="bg-gray-50 text-gray-700">
                    {/* LOCKED COLUMN ORDER */}
                    <tr>
                      <th className="text-left px-4 py-3 font-medium">Trade date</th>
                      <th className="text-left px-4 py-3 font-medium">
                        Asset class
                      </th>
                      <th className="text-left px-4 py-3 font-medium">Instrument</th>
                      <th className="text-left px-4 py-3 font-medium">Dir</th>
                      <th className="text-left px-4 py-3 font-medium">Qty</th>
                      <th className="text-left px-4 py-3 font-medium">Price</th>
                      <th className="text-left px-4 py-3 font-medium">PnL</th>
                      <th className="text-left px-4 py-3 font-medium">Action</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200 bg-white">
                    {tradeHistory.map((t, idx) => {
                      const key = t.trade_id || t.id || idx;
                      const isOpen = !!expandedTrade[key];

                      // LOCKED FIELD RESOLUTION (stable mapping regardless of backend variation)
                      const tradeDate = t.trade_date || t.tradeDate;
                      const assetClass = t.asset_class || t.assetClass;
                      const instrument =
                        t.instrument || t.symbol || t.ccy_pair || t.ccyPair;
                      const direction = t.direction || t.side;
                      const qty = t.quantity ?? t.qty ?? t.notional;
                      const price = t.price ?? t.rate;
                      const pnl = t.pnl ?? t.p_and_l ?? t.pAndL;

                      return (
                        <React.Fragment key={key}>
                          <tr>
                            <td className="px-4 py-3 font-mono text-xs text-gray-900">
                              {formatDateOnly(tradeDate)}
                            </td>
                            <td className="px-4 py-3 text-gray-900">
                              {safeStr(assetClass) || "â€”"}
                            </td>
                            <td className="px-4 py-3 text-gray-900">
                              {safeStr(instrument) || "â€”"}
                            </td>
                            <td className="px-4 py-3 text-gray-900">
                              <DirectionChip value={direction} />
                            </td>
                            <td className="px-4 py-3 font-mono text-xs text-gray-900">
                              {formatQty(qty)}
                            </td>
                            <td className="px-4 py-3 font-mono text-xs text-gray-900">
                              {price === null || price === undefined ? "â€”" : safeStr(price)}
                            </td>
                            <td className="px-4 py-3 font-mono text-xs text-gray-900">
                              {pnl === null || pnl === undefined ? "â€”" : safeStr(pnl)}
                            </td>
                            <td className="px-4 py-3">
                              <button
                                type="button"
                                className="inline-flex items-center justify-center px-3 py-1.5 rounded-md text-sm text-gray-900 bg-[rgb(205,226,235)] shadow-sm transition-all duration-150 hover:-translate-y-0.5 hover:shadow-md active:translate-y-0 active:shadow-sm"
                                onClick={() =>
                                  setExpandedTrade((prev) => ({
                                    ...prev,
                                    [key]: !prev[key],
                                  }))
                                }
                              >
                                {isOpen ? "Hide" : "View"}
                              </button>
                            </td>
                          </tr>

                          {isOpen && (
                            <tr className="bg-gray-50">
                              <td colSpan={8} className="px-4 py-3">
                                <div className="bg-white border border-gray-200 rounded-md p-3">
                                  <div className="text-xs font-body text-gray-600 mb-2">
                                    Full trade record
                                  </div>
                                  <pre className="whitespace-pre-wrap text-[11px] font-mono text-gray-800">
                                    {JSON.stringify(t, null, 2)}
                                  </pre>
                                </div>
                              </td>
                            </tr>
                          )}
                        </React.Fragment>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {/* 5. Audit Trail */}
          <div className="bg-white rounded-halo shadow-sm border border-gray-200 p-6">
            <h3 className="font-heading text-base text-gray-800 mb-4">
              Audit trail
            </h3>

            {auditTrail.length === 0 ? (
              <p className="text-sm font-body text-gray-500">
                No audit events available.
              </p>
            ) : (
              <div className="overflow-auto border border-gray-200 rounded-md">
                <table className="min-w-full text-sm font-body">
                  <thead className="bg-gray-50 text-gray-700">
                    <tr>
                      <th className="text-left px-4 py-3 font-medium">When</th>
                      <th className="text-left px-4 py-3 font-medium">
                        Event type
                      </th>
                      <th className="text-left px-4 py-3 font-medium">Actor</th>
                      <th className="text-left px-4 py-3 font-medium">Details</th>
                      <th className="text-left px-4 py-3 font-medium">Action</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200 bg-white">
                    {auditTrail.map((a, idx) => {
                      const key = a.audit_event_id || a.id || idx;
                      const isOpen = !!expandedAudit[key];

                      const summary =
                        a?.details?.summary ||
                        a?.summary ||
                        a?.details_text ||
                        a?.details?.message ||
                        "";

                      return (
                        <React.Fragment key={key}>
                          <tr>
                            <td className="px-4 py-3 font-mono text-xs text-gray-900">
                              {formatTs(a.occurred_at || a.timestamp || a.created_at)}
                            </td>
                            <td className="px-4 py-3 text-gray-900">
                              {safeStr(a.event_type) || "â€”"}
                            </td>
                            <td className="px-4 py-3 text-gray-900">
                              {safeStr(a.actor) || "â€”"}
                            </td>
                            <td className="px-4 py-3 text-gray-900">
                              {summary ? (
                                <span className="text-sm font-body text-gray-800">
                                  {safeStr(summary)}
                                </span>
                              ) : (
                                <span className="text-sm font-body text-gray-500">
                                  â€”
                                </span>
                              )}
                            </td>
                            <td className="px-4 py-3">
                              <button
                                type="button"
                                className="inline-flex items-center justify-center px-3 py-1.5 rounded-md text-sm text-gray-900 bg-[rgb(205,226,235)] shadow-sm transition-all duration-150 hover:-translate-y-0.5 hover:shadow-md active:translate-y-0 active:shadow-sm"
                                onClick={() =>
                                  setExpandedAudit((prev) => ({
                                    ...prev,
                                    [key]: !prev[key],
                                  }))
                                }
                              >
                                {isOpen ? "Hide" : "View"}
                              </button>
                            </td>
                          </tr>

                          {isOpen && (
                            <tr className="bg-gray-50">
                              <td colSpan={5} className="px-4 py-3">
                                <div className="bg-white border border-gray-200 rounded-md p-3">
                                  <div className="text-xs font-body text-gray-600 mb-2">
                                    Full details
                                  </div>
                                  <pre className="whitespace-pre-wrap text-[11px] font-mono text-gray-800">
                                    {JSON.stringify(a.details || a, null, 2)}
                                  </pre>
                                </div>
                              </td>
                            </tr>
                          )}
                        </React.Fragment>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      </div>
    </section>
  );
}




===== FILE: app_frontend\src\index.css =====
/* app_frontend/src/index.css */

/* Tailwind v4 (base, components, utilities) */
@import "tailwindcss";

/* Global defaults */
:root {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
    sans-serif;
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

body {
  margin: 0;
  min-height: 100vh;
}

/* ------------------------------------------------------------ */
/* Fjalla One font class (used for MissionSmith / Atlas / Log)  */
/* ------------------------------------------------------------ */
.font-fjalla {
  font-family: "Fjalla One", sans-serif;
}


===== FILE: app_frontend\src\main.jsx =====
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.jsx'

createRoot(document.getElementById('root')).render(
  <StrictMode>
    <App />
  </StrictMode>,
)


===== FILE: app_frontend\src\MissionAtlasPanel.jsx =====
// app_frontend/src/MissionAtlasPanel.jsx
import React, { useState } from "react";

const domains = [
  {
    id: "domain-ingestion",
    name: "Ingestion",
    description: "Bring CRM and KYC client records into the SCV platform.",
    keyEntities: ["SourceRecord", "IngestionBatch"],
  },
  {
    id: "domain-matching",
    name: "Matching",
    description: "Resolve records into a single client identity.",
    keyEntities: ["MatchCandidate", "MatchGroup", "MatchScore"],
  },
  {
    id: "domain-profile",
    name: "Client Profile",
    description: "Assemble and expose the golden client profile.",
    keyEntities: ["ClientProfile", "ClientAttribute", "Address"],
  },
  {
    id: "domain-search",
    name: "Search",
    description: "Help users quickly find the right client profile.",
    keyEntities: ["SearchQuery", "SearchResult"],
  },
  {
    id: "domain-lineage",
    name: "Lineage & Audit",
    description: "Track where data came from and how it was transformed.",
    keyEntities: ["LineageEvent", "AuditEvent"],
  },
  {
    id: "domain-ux",
    name: "Single Client View UI",
    description: "Visualise client profile, sources and lineage.",
    keyEntities: ["ClientView", "SourcePanel", "LineagePanel"],
  },
];

const services = [
  {
    id: "svc-ingestion",
    name: "Ingestion Service",
    domain: "Ingestion",
    responsibilities: [
      "Load CRM and KYC records.",
      "Normalise incoming payloads to canonical structures.",
      "Emit ingestion audit events.",
    ],
    consumes: ["CRM feed", "KYC feed"],
    produces: ["SourceRecord", "IngestionBatch", "AuditEvent"],
    exposes: [],
  },
  {
    id: "svc-matching",
    name: "Matching Service",
    domain: "Matching",
    responsibilities: [
      "Apply exact and fuzzy match rules.",
      "Group records into candidate client identities.",
    ],
    consumes: ["SourceRecord"],
    produces: ["MatchCandidate", "MatchGroup", "MatchScore"],
    exposes: [],
  },
  {
    id: "svc-profile-core",
    name: "Client Profile Service",
    domain: "Client Profile",
    responsibilities: [
      "Build ClientProfile from MatchGroup + source records.",
      "Merge core attributes and addresses.",
      "Attach lineage references.",
    ],
    consumes: ["MatchGroup", "SourceRecord"],
    produces: ["ClientProfile", "ClientAttribute", "Address", "LineageEvent"],
    exposes: ["Client Profile API"],
  },
  {
    id: "svc-search",
    name: "Client Search Service",
    domain: "Search",
    responsibilities: [
      "Index ClientProfile documents.",
      "Serve search queries with ranking.",
    ],
    consumes: ["ClientProfile"],
    produces: ["SearchResult"],
    exposes: ["Client Search API"],
  },
  {
    id: "svc-lineage",
    name: "Lineage Service",
    domain: "Lineage & Audit",
    responsibilities: [
      "Store lineage and audit events.",
      "Expose lineage graph for a given client.",
    ],
    consumes: ["LineageEvent", "AuditEvent"],
    produces: ["Lineage graph view"],
    exposes: ["Lineage API"],
  },
  {
    id: "svc-ui",
    name: "SCV Frontend",
    domain: "Single Client View UI",
    responsibilities: [
      "Call search and profile APIs.",
      "Render Single Client View: profile, sources, lineage.",
    ],
    consumes: ["Client Profile API", "Client Search API", "Lineage API"],
    produces: ["ClientView"],
    exposes: ["SCV screen"],
  },
];

const flows = [
  {
    id: "flow-01",
    name: "Client onboarding (CRM route)",
    steps: [
      "CRM feed",
      "Ingestion Service",
      "SourceRecord",
      "Matching Service",
      "MatchGroup",
      "Client Profile Service",
      "ClientProfile",
      "Client Search Service",
      "SCV Frontend",
    ],
  },
  {
    id: "flow-02",
    name: "Client onboarding (KYC route)",
    steps: [
      "KYC feed",
      "Ingestion Service",
      "SourceRecord",
      "Matching Service",
      "MatchGroup",
      "Client Profile Service",
      "ClientProfile",
      "SCV Frontend",
    ],
  },
  {
    id: "flow-03",
    name: "Search & view client",
    steps: [
      "SCV Frontend",
      "Client Search API",
      "Client Search Service",
      "SearchResult",
      "Client Profile API",
      "Client Profile Service",
      "ClientProfile",
      "SCV Frontend",
    ],
  },
  {
    id: "flow-04",
    name: "Lineage drill-down",
    steps: [
      "SCV Frontend",
      "Lineage API",
      "Lineage Service",
      "Lineage graph view",
      "SCV Frontend",
    ],
  },
];

export default function MissionAtlasPanel() {
  const [selectedDomain, setSelectedDomain] = useState(null);
  const [selectedService, setSelectedService] = useState(null);

  // Reset when clicking outside domain or service
  const resetSelection = () => {
    setSelectedDomain(null);
    setSelectedService(null);
  };

  // Determine which services to show
  const visibleServices = selectedDomain
    ? services.filter((s) => s.domain === selectedDomain.name)
    : services;

  // Determine which flows to show
  const visibleFlows = selectedService
    ? flows.filter((flow) =>
        flow.steps.some((step) =>
          step.toLowerCase().includes(selectedService.name.toLowerCase())
        )
      )
    : selectedDomain
    ? flows.filter((flow) =>
        flow.steps.some((step) =>
          step.toLowerCase().includes(selectedDomain.name.toLowerCase())
        )
      )
    : flows;

  return (
    <section className="bg-white rounded-halo shadow-sm border border-gray-200 p-6 mb-6">
      <div className="flex items-center justify-between mb-4">
        <h2
          style={{ fontFamily: "Fjalla One" }}
          className="text-lg text-gray-900 tracking-wide"
        >
          MissionAtlas Single Client View
        </h2>

        {(selectedDomain || selectedService) && (
          <button
            onClick={resetSelection}
            className="text-sm text-[#1A9988] underline hover:text-[#147c6f]"
          >
            Reset
          </button>
        )}
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* DOMAINS */}
        <div className="space-y-3">
          <h3 className="font-heading text-sm text-gray-800 mb-1">
            Domains
          </h3>
          {domains.map((d) => {
            const active = selectedDomain?.id === d.id;
            return (
              <div
                key={d.id}
                onClick={() => {
                  setSelectedService(null);
                  setSelectedDomain(active ? null : d);
                }}
                className={`cursor-pointer rounded-md p-3 border ${
                  active
                    ? "bg-teal-50 border-teal-300 shadow"
                    : "bg-gray-50 border-gray-200 hover:bg-gray-100"
                }`}
              >
                <p className="font-heading text-sm text-gray-900">{d.name}</p>
                <p className="text-xs font-body text-gray-600 mb-2">
                  {d.description}
                </p>
                <p className="text-[11px] font-mono text-gray-500">
                  Entities: {d.keyEntities.join(", ")}
                </p>
              </div>
            );
          })}
        </div>

        {/* SERVICES */}
        <div className="space-y-3">
          <h3 className="font-heading text-sm text-gray-800 mb-1">
            Services
          </h3>
          {visibleServices.map((s) => {
            const active = selectedService?.id === s.id;
            const faded =
              selectedDomain && s.domain !== selectedDomain.name;

            return (
              <div
                key={s.id}
                onClick={() => setSelectedService(active ? null : s)}
                className={`cursor-pointer rounded-md p-3 border transition ${
                  active
                    ? "bg-amber-50 border-amber-300 shadow"
                    : faded
                    ? "opacity-50 bg-gray-50 border-gray-200"
                    : "bg-gray-50 border-gray-200 hover:bg-gray-100"
                }`}
              >
                <p className="font-heading text-sm text-gray-900 mb-1">
                  {s.name}
                </p>
                <p className="text-[11px] font-body text-gray-500 mb-1">
                  Domain: {s.domain}
                </p>
                <ul className="list-disc pl-4 mb-1 space-y-0.5">
                  {s.responsibilities.map((r, idx) => (
                    <li
                      key={idx}
                      className="text-xs font-body text-gray-700"
                    >
                      {r}
                    </li>
                  ))}
                </ul>
              </div>
            );
          })}
        </div>

        {/* FLOWS */}
        <div className="space-y-3">
          <h3 className="font-heading text-sm text-gray-800 mb-1">Flows</h3>
          {visibleFlows.map((flow) => (
            <div
              key={flow.id}
              className="rounded-md p-3 border bg-gray-50 border-gray-200"
            >
              <p className="font-heading text-sm text-gray-900 mb-2">
                {flow.name}
              </p>
              <p className="text-[11px] font-mono text-gray-700 whitespace-pre-wrap leading-5">
                {flow.steps.join("  â†’  ")}
              </p>
            </div>
          ))}
        </div>
      </div>
    </section>
  );
}


===== FILE: app_frontend\src\MissionLogPanel.jsx =====
import React, { useEffect, useState } from "react";

// Status categories for easy reference (currently not used directly but kept for clarity)
const STATUS_MAP = {
  Complete: "Complete",
  "In Progress": "In Progress",
  Planned: "Planned",
};

// Status normalisation function
function normaliseStatus(status) {
  return status ? status.toUpperCase() : "UNKNOWN";
}

// Status Chip (adjusted for consistent look)
function StatusChip({ label, status, extraClass }) {
  let statusClass = "bg-gray-100"; // Default to grey for N/A statuses

  // Define specific color mappings for statuses
  if (status === "Complete" || status === "pass") {
    statusClass = "bg-green-100"; // Green for complete / passed
  } else if (status === "In Progress" || status === "fail") {
    statusClass = "bg-yellow-100"; // Yellow for in progress / failed
  } else if (status === "Planned" || status === "not_run") {
    statusClass = "bg-blue-100"; // Blue for planned / not_run
  } else if (status === "N/A") {
    statusClass = "bg-gray-200"; // Grey color for N/A statuses
  }

  return (
    <span
      className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-body ${statusClass} ${
        extraClass || ""
      }`}
    >
      {label}
    </span>
  );
}

// MissionLog Panel with Key, alignment, and Back button
export default function MissionLogPanel({ setActiveView }) {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  useEffect(() => {
    let cancelled = false;

    async function load() {
      try {
        const res = await fetch("/missionlog/status_snapshot.json", {
          cache: "no-store",
        });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const json = await res.json();
        if (!cancelled) {
          setData(json);
          setError("");
        }
      } catch (err) {
        console.error("Failed to load MissionLog status snapshot", err);
        if (!cancelled) {
          setError("Could not load latest status snapshot.");
        }
      } finally {
        if (!cancelled) {
          setLoading(false);
        }
      }
    }

    load();
    return () => {
      cancelled = true;
    };
  }, []);

  const epics = data?.epics || [];

  // Handle Back button
  const handleBack = () => {
    if (typeof setActiveView === "function") {
      setActiveView("scv");
    } else {
      window.location.reload();
    }
  };

  return (
    <section className="bg-white rounded-halo shadow-sm border border-gray-200 p-6 mb-6">
      {/* Back to Single Client View button */}
      <div className="flex justify-between mb-4">
        <h2
          style={{ fontFamily: "Fjalla One" }}
          className="text-lg text-gray-900 tracking-wide"
        >
          MissionLog Single Client View
        </h2>

        <button
          type="button"
          onClick={handleBack}
          className="inline-flex items-center justify-center px-4 py-2 rounded-md bg-[#1A9988] text-white font-body text-sm font-medium shadow-sm transition-all duration-150 hover:bg-[#178c7d] hover:-translate-y-0.5 hover:shadow-md active:bg-[#147c6f] active:translate-y-0 active:shadow-sm"
        >
          Back to Single Client View
        </button>
      </div>

      {/* Key/Legend for Statuses */}
      <div className="mb-4 p-3 bg-gray-50 rounded-md text-sm font-body text-gray-800">
        <strong>Status Key:</strong>
        <div className="flex flex-wrap gap-3 mt-2">
          <StatusChip label="Complete" status="Complete" />
          <StatusChip label="In Progress" status="In Progress" />
          <StatusChip label="Planned" status="Planned" />
          <StatusChip label="N/A" status="N/A" />
        </div>
      </div>

      {loading && (
        <p className="text-sm font-body text-gray-500">
          Loading latest status snapshotâ€¦
        </p>
      )}

      {!loading && error && (
        <p className="text-sm font-body text-red-600 mb-2">{error}</p>
      )}

      {!loading && !error && epics.length === 0 && (
        <p className="text-sm font-body text-gray-500">
          No status data available.
        </p>
      )}

      {/* MissionLog Data */}
      {!loading && !error && epics.length > 0 && (
        <div className="space-y-6">
          {epics.map((epic) => (
            <div
              key={epic.epic_id}
              className="bg-gray-50 rounded-lg border border-gray-200 p-4"
            >
              <div className="flex items-center justify-between mb-3">
                <div>
                  <p className="font-heading text-sm text-gray-900">
                    Epic {epic.epic_id}: {epic.name}
                  </p>
                </div>
                {/* Epic status chip â€“ same size styling as feature-level */}
                <StatusChip
                  label={normaliseStatus(epic.overall_status)}
                  status={epic.overall_status}
                  extraClass="ml-auto px-3 py-1 text-xs"
                />
              </div>

              <div className="space-y-4">
                {epic.features.map((feature) => {
                  const stories = feature.stories || [];
                  const totalStories = stories.length;
                  const completedStories = stories.filter(
                    (s) => normaliseStatus(s.overall_status) === "COMPLETE"
                  ).length;

                  return (
                    <div
                      key={feature.feature_id}
                      className="bg-white rounded-md border border-gray-200 p-3"
                    >
                      <div className="flex items-center justify-between mb-2">
                        <div>
                          <p className="font-heading text-sm text-gray-900">
                            Feature {feature.feature_id}: {feature.name}
                          </p>
                          <p className="text-xs font-body text-gray-500">
                            {completedStories}/{totalStories} stories complete
                          </p>
                        </div>
                        {/* Feature status chip â€“ same size styling as epic-level */}
                        <StatusChip
                          label={normaliseStatus(feature.overall_status)}
                          status={feature.overall_status}
                          extraClass="ml-auto px-3 py-1 text-xs"
                        />
                      </div>

                      <div className="space-y-1.5">
                        {stories.map((story) => {
                          return (
                            <div
                              key={story.story_id}
                              className="flex items-center justify-between"
                            >
                              <div className="flex-1">
                                <p className="text-sm font-body text-gray-700">
                                  {story.name}
                                </p>
                              </div>

                              {/* Render badges for each story */}
                              <div className="flex space-x-2">
                                {story.testing_status && (
                                  <StatusChip
                                    label="Testing"
                                    status={story.testing_status}
                                  />
                                )}
                                {story.halo_adherence && (
                                  <StatusChip
                                    label="Halo"
                                    status={story.halo_adherence}
                                  />
                                )}
                                {story.guardrail_adherence && (
                                  <StatusChip
                                    label="Guardrails"
                                    status={story.guardrail_adherence}
                                  />
                                )}
                                {story.code_quality_adherence && (
                                  <StatusChip
                                    label="Code Quality"
                                    status={story.code_quality_adherence}
                                  />
                                )}
                                {story.security_adherence && (
                                  <StatusChip
                                    label="Security"
                                    status={story.security_adherence}
                                  />
                                )}
                                {/* Default to "N/A" for the following statuses if they don't exist */}
                                {!story.policy_adherence && (
                                  <StatusChip
                                    label="Policy Adherence"
                                    status="N/A"
                                  />
                                )}
                                {!story.technology_lineage && (
                                  <StatusChip
                                    label="Technology Lineage"
                                    status="N/A"
                                  />
                                )}
                                {!story.business_data_lineage && (
                                  <StatusChip
                                    label="Business Data Lineage"
                                    status="N/A"
                                  />
                                )}
                                {!story.self_healing_adherence && (
                                  <StatusChip
                                    label="Self-healing Adherence"
                                    status="N/A"
                                  />
                                )}
                                {!story.analytics && (
                                  <StatusChip label="Analytics" status="N/A" />
                                )}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
        </div>
      )}
    </section>
  );
}






===== FILE: app_frontend\src\MissionNavButtons.jsx =====
import React from "react";
import logo from "./assets/m7_single_client_view.png";

/* 
  Base button layout + animation.
  Font is controlled by the custom .font-fjalla class.
*/

const baseButtonClasses = `
  inline-flex items-center justify-center
  px-8 py-2.5 rounded-md
  text-base text-gray-900
  shadow-sm
  transition
  transform
  hover:-translate-y-0.5 hover:shadow-md
  active:translate-y-0 active:shadow-sm
  font-fjalla
`;

export default function MissionNavButtons() {
  return (
    <header className="bg-white border-b">
      <div className="max-w-6xl mx-auto flex items-center justify-between px-6 py-4">
        {/* Logo */}
        <div className="flex items-center">
          <img
            src={logo}
            alt="M7 Single Client View"
            className="h-10"
          />
        </div>

        {/* Buttons */}
        <div className="flex items-center gap-4">
          {/* MissionSmith */}
          <button
            type="button"
            className={`${baseButtonClasses}
              bg-[rgb(189,199,155)]
              hover:bg-[rgb(176,186,142)]
            `}
            onClick={() => {}}
          >
            MissionSmith
          </button>

          {/* MissionAtlas */}
          <button
            type="button"
            className={`${baseButtonClasses}
              bg-[rgb(241,205,86)]
              hover:bg-[rgb(232,196,80)]
            `}
            onClick={() => {}}
          >
            MissionAtlas
          </button>

          {/* MissionLog */}
          <button
            type="button"
            className={`${baseButtonClasses}
              bg-[rgb(167,198,223)]
              hover:bg-[rgb(157,187,210)]
            `}
            onClick={() => {}}
          >
            MissionLog
          </button>
        </div>
      </div>
    </header>
  );
}




===== FILE: app_frontend\src\MissionSmithPanel.jsx =====
// app_frontend/src/App.jsx
import React, { useState } from "react";
import MissionLogPanel from "./MissionLogPanel";
import MissionAtlasPanel from "./MissionAtlasPanel";
import MissionSmithPanel from "./MissionSmithPanel";
import logo from "./assets/m7_single_client_view.png";

const BACKEND_BASE_URL = "http://127.0.0.1:8000";

function App() {
  const [clientId, setClientId] = useState("");
  const [loading, setLoading] = useState(false);
  const [profile, setProfile] = useState(null);
  const [sources, setSources] = useState([]);
  const [error, setError] = useState("");

  // 'scv' | 'missionLog' | 'missionAtlas' | 'missionSmith'
  const [activeView, setActiveView] = useState("scv");

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!clientId.trim()) {
      setError("Please enter a Client ID.");
      return;
    }

    setError("");
    setLoading(true);
    setProfile(null);
    setSources([]);

    try {
      const encodedId = encodeURIComponent(clientId.trim());

      const profileRes = await fetch(
        `${BACKEND_BASE_URL}/clients/${encodedId}/profile`
      );
      if (!profileRes.ok) {
        const detail = await profileRes.json().catch(() => ({}));
        throw new Error(detail.detail || "Failed to fetch profile.");
      }
      const profileJson = await profileRes.json();

      const sourcesRes = await fetch(
        `${BACKEND_BASE_URL}/clients/${encodedId}/sources`
      );
      const sourcesJson = sourcesRes.ok ? await sourcesRes.json() : [];

      setProfile(profileJson);
      setSources(sourcesJson);
    } catch (err) {
      console.error(err);
      setError(err.message || "Something went wrong.");
    } finally {
      setLoading(false);
    }
  };

  const isMissionLog = activeView === "missionLog";
  const isMissionAtlas = activeView === "missionAtlas";
  const isMissionSmith = activeView === "missionSmith";
  const isSCV = activeView === "scv";

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header with logo and mission buttons */}
      <header className="bg-white shadow-sm">
        {/* Logo */}
        <div className="max-w-6xl mx-auto px-4 py-4">
          <img
            src={logo}
            alt="M7 single client view"
            className="h-16 w-auto md:h-20"
          />
        </div>

        {/* Mission buttons */}
        <div className="bg-gray-100 border-t border-gray-200">
          <div className="max-w-6xl mx-auto px-4 py-3 flex justify-end gap-4">
            {/* MissionSmith -> embedded HTML view */}
            <button
              type="button"
              style={{ fontFamily: "Fjalla One" }}
              className={`
                inline-flex items-center justify-center
                px-8 py-2.5 rounded-md border
                text-base text-gray-900
                bg-[rgb(176,192,159)]
                shadow-sm
                transition-colors transition-transform duration-150
                hover:-translate-y-0.5
                active:translate-y-0
                ${isMissionSmith ? "border-gray-500 shadow-md" : "border-gray-300"}
              `}
              onClick={() => setActiveView("missionSmith")}
            >
              MissionSmith
            </button>

            {/* MissionAtlas */}
            <button
              type="button"
              style={{ fontFamily: "Fjalla One" }}
              className={`
                inline-flex items-center justify-center
                px-8 py-2.5 rounded-md border
                text-base text-gray-900
                bg-[rgb(205,226,235)]
                shadow-sm
                transition-colors transition-transform duration-150
                hover:-translate-y-0.5
                active:translate-y-0
                ${isMissionAtlas ? "border-gray-500 shadow-md" : "border-gray-300"}
              `}
              onClick={() => setActiveView("missionAtlas")}
            >
              MissionAtlas
            </button>

            {/* MissionLog */}
            <button
              type="button"
              style={{ fontFamily: "Fjalla One" }}
              className={`
                inline-flex items-center justify-center
                px-8 py-2.5 rounded-md border
                text-base text-gray-900
                bg-[rgb(241,205,86)]
                shadow-sm
                transition-colors transition-transform duration-150
                hover:-translate-y-0.5
                active:translate-y-0
                ${isMissionLog ? "border-gray-500 shadow-md" : "border-gray-300"}
              `}
              onClick={() => setActiveView("missionLog")}
            >
              MissionLog
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto px-4 py-6">
        {isMissionSmith ? (
          <>
            <MissionSmithPanel />
            <div className="flex justify-start">
              <button
                type="button"
                className="
                  inline-flex items-center justify-center
                  px-4 py-2 rounded-md
                  bg-white text-[#1A9988]
                  border border-[#1A9988]
                  font-body text-sm font-medium
                  shadow-sm
                  transition-colors transition-transform duration-150
                  hover:bg-[#1A9988] hover:text-white hover:-translate-y-0.5
                  active:translate-y-0
                "
                onClick={() => setActiveView("scv")}
              >
                Back to Single Client View
              </button>
            </div>
          </>
        ) : isMissionLog ? (
          <>
            <MissionLogPanel />
            <div className="flex justify-start">
              <button
                type="button"
                className="
                  inline-flex items-center justify-center
                  px-4 py-2 rounded-md
                  bg-white text-[#1A9988]
                  border border-[#1A9988]
                  font-body text-sm font-medium
                  shadow-sm
                  transition-colors transition-transform duration-150
                  hover:bg-[#1A9988] hover:text-white hover:-translate-y-0.5
                  active:translate-y-0
                "
                onClick={() => setActiveView("scv")}
              >
                Back to Single Client View
              </button>
            </div>
          </>
        ) : isMissionAtlas ? (
          <>
            <MissionAtlasPanel />
            <div className="flex justify-start">
              <button
                type="button"
                className="
                  inline-flex items-center justify-center
                  px-4 py-2 rounded-md
                  bg-white text-[#1A9988]
                  border border-[#1A9988]
                  font-body text-sm font-medium
                  shadow-sm
                  transition-colors transition-transform duration-150
                  hover:bg-[#1A9988] hover:text-white hover:-translate-y-0.5
                  active:translate-y-0
                "
                onClick={() => setActiveView("scv")}
              >
                Back to Single Client View
              </button>
            </div>
          </>
        ) : (
          <>
            {/* Find client profile */}
            <section className="bg-white rounded-halo shadow-sm border border-gray-200 p-6 mb-6">
              <h2 className="font-heading text-lg text-gray-800 mb-4">
                Find client profile
              </h2>

              <form
                onSubmit={handleSubmit}
                className="flex flex-col md:flex-row gap-4 items-stretch md:items-end"
              >
                <div className="flex-1">
                  <label
                    htmlFor="client-id"
                    className="block text-sm font-body text-gray-600 mb-1"
                  >
                    Client ID
                  </label>
                  <input
                    id="client-id"
                    type="text"
                    value={clientId}
                    onChange={(e) => setClientId(e.target.value)}
                    placeholder="e.g. C-004"
                    className="
                      w-full px-3 py-2 rounded-md border border-gray-300 
                      font-body text-sm
                      focus:outline-none focus:ring-2 
                      focus:ring-[#1A9988] focus:border-[#1A9988]
                    "
                  />
                </div>

                <button
                  type="submit"
                  disabled={loading}
                  className="
                    inline-flex items-center justify-center
                    px-4 py-2 rounded-md w-32
                    bg-[#1A9988] text-white
                    font-body text-sm font-medium shadow-sm
                    transition-colors transition-transform duration-150
                    hover:bg-[#178c7d] hover:-translate-y-0.5
                    active:bg-[#147c6f] active:translate-y-0
                    disabled:opacity-60 disabled:cursor-not-allowed
                  "
                >
                  {loading ? "Loadingâ€¦" : "Get profile"}
                </button>
              </form>

              {error && (
                <p className="mt-4 text-sm text-orange-700 bg-orange-50 border border-orange-200 rounded-md px-3 py-2 font-body">
                  {error}
                </p>
              )}
            </section>

            {/* Client profile + raw sources */}
            <section className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="lg:col-span-2">
                <div className="bg-white rounded-halo shadow-sm border border-gray-200 p-6 h-full">
                  <h3 className="font-heading text-lg text-gray-800 mb-4">
                    Client profile
                  </h3>

                  {!profile && !loading && (
                    <p className="text-sm font-body text-gray-500">
                      Enter a Client ID and click{" "}
                      <span className="font-semibold">Get profile</span> to see
                      the assembled Single Client View.
                    </p>
                  )}

                  {loading && (
                    <p className="text-sm font-body text-gray-500">
                      Loadingâ€¦
                    </p>
                  )}

                  {profile && (
                    <div className="space-y-4">
                      <div className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <h4 className="font-heading text-sm text-gray-700 mb-2">
                          Basic details
                        </h4>

                        <dl className="grid grid-cols-2 gap-y-2 text-sm font-body">
                          <div>
                            <dt className="text-gray-500">Client ID</dt>
                            <dd className="text-gray-900">
                              {profile.client_id || "â€”"}
                            </dd>
                          </div>

                          <div>
                            <dt className="text-gray-500">Name</dt>
                            <dd className="text-gray-900">
                              {profile.name || "â€”"}
                            </dd>
                          </div>

                          <div>
                            <dt className="text-gray-500">Email</dt>
                            <dd className="text-gray-900">
                              {profile.email || "â€”"}
                            </dd>
                          </div>

                          <div>
                            <dt className="text-gray-500">Country</dt>
                            <dd className="text-gray-900">
                              {profile.country || "â€”"}
                            </dd>
                          </div>
                        </dl>
                      </div>

                      {profile.addresses?.length > 0 && (
                        <div className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                          <h4 className="font-heading text-sm text-gray-700 mb-2">
                            Addresses
                          </h4>

                          <ul className="space-y-2 text-sm font-body">
                            {profile.addresses.map((addr, idx) => (
                              <li
                                key={idx}
                                className="border-b border-gray-200 pb-2 last:border-none"
                              >
                                <div className="text-gray-900">
                                  {[
                                    addr.line1,
                                    addr.line2,
                                    addr.city,
                                    addr.postcode,
                                    addr.country,
                                  ]
                                    .filter(Boolean)
                                    .join(", ")}
                                </div>

                                <div className="text-xs text-gray-500 mt-1">
                                  Source: {addr.source || "â€”"}
                                </div>
                              </li>
                            ))}
                          </ul>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>

              <div>
                <div className="bg-white rounded-halo shadow-sm border border-gray-200 p-6 h-full">
                  <h3 className="font-heading text-lg text-gray-800 mb-4">
                    Raw sources
                  </h3>

                  {!profile && !loading && (
                    <p className="text-sm font-body text-gray-500">
                      Once a profile is loaded, youâ€™ll see the upstream records
                      here.
                    </p>
                  )}

                  {sources.length > 0 && (
                    <div className="space-y-3 text-xs font-mono bg-gray-50 rounded-lg p-3 border border-gray-200 max-h-[400px] overflow-auto">
                      {sources.map((src) => (
                        <div
                          key={src.id}
                          className="bg-white border border-gray-200 rounded-md p-2"
                        >
                          <div className="flex justify-between items-center mb-1">
                            <span className="font-body text-xs text-gray-600">
                              {src.system}
                            </span>
                            <span className="font-body text-[10px] text-gray-400">
                              client_id: {src.client_id}
                            </span>
                          </div>

                          <pre className="whitespace-pre-wrap text-[11px] text-gray-800">
                            {JSON.stringify(src.payload, null, 2)}
                          </pre>
                        </div>
                      ))}
                    </div>
                  )}

                  {profile?.lineage && (
                    <>
                      <h4 className="font-heading text-sm text-gray-700 mt-4 mb-2">
                        Lineage
                      </h4>
                      <div className="bg-gray-50 rounded-lg p-3 border border-gray-200 text-xs font-body max-h-[200px] overflow-auto">
                        <pre className="whitespace-pre-wrap text-[11px] text-gray-800">
                          {JSON.stringify(profile.lineage, null, 2)}
                        </pre>
                      </div>
                    </>
                  )}
                </div>
              </div>
            </section>
          </>
        )}
      </main>
    </div>
  );
}

export default App;


===== FILE: app_frontend\tailwind.config.js =====
/** @type {import('tailwindcss').Config} */
export default {
  content: ["./index.html", "./src/**/*.{js,jsx,ts,tsx}"],
  theme: {
    extend: {
      fontFamily: {
        heading: ["Raleway", "system-ui", "sans-serif"],
        body: ["Lato", "system-ui", "sans-serif"],
      },
      colors: {
        halo: {
          primary: "rgb(26,153,136)",     // #1A9988
          secondary: "rgb(235,86,0)",     // #EB5600
          softGreen: "rgb(176,192,159)",  // #B0C09F
          softYellow: "rgb(241,205,86)",  // #F1CD56
          softBlue: "rgb(205,226,235)",   // #CDE2EB
        },
      },
      borderRadius: {
        halo: "16px",
      },
    },
  },
  plugins: [],
};



===== FILE: app_frontend\vite.config.js =====
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})


===== FILE: backend_v2\.env =====
ENV=local
DATABASE_URL=postgresql+psycopg://postgres:Londonirish-01@localhost:5432/scv




===== FILE: backend_v2\.env.example =====
# Copy this file to `.env` and adjust as needed.

ENV=local
# Local Postgres instance (Docker, native, or cloud)
DATABASE_URL=postgresql+psycopg://postgres:postgres@localhost:5432/scv


===== FILE: backend_v2\app\__init__.py =====
# backend_v2 app package


===== FILE: backend_v2\app\config.py =====
from pydantic_settings import BaseSettings



class Settings(BaseSettings):
    ENV: str = "local"  # local | dev | prod
    # Default to a local Postgres instance; override via .env in real use.
    DATABASE_URL: str = "postgresql+psycopg://postgres:postgres@localhost:5432/scv"

    class Config:
        env_file = ".env"


settings = Settings()


===== FILE: backend_v2\app\db.py =====
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, declarative_base
from app.config import settings


engine = create_engine(
    settings.DATABASE_URL,
    pool_pre_ping=True,
)

SessionLocal = sessionmaker(bind=engine, autoflush=False, autocommit=False)
Base = declarative_base()


def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


===== FILE: backend_v2\app\main.py =====
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from app.db import Base, engine, SessionLocal
from app.models import *  # noqa: F401
from app.seed.seed_data import seed

from app.routers.client_router import router as client_router
from app.routers.account_router import router as account_router
from app.routers.transaction_router import router as transaction_router
from app.routers.kyc_flag_router import router as kyc_flag_router
from app.routers.scv_router import router as scv_router


app = FastAPI(title="Single Client View Backend (Postgres-ready)")


app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # tighten later
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


@app.on_event("startup")
def on_startup() -> None:
    Base.metadata.create_all(bind=engine)
    with SessionLocal() as db:
        seed(db)


@app.get("/health")
def health():
    return {"status": "ok"}


app.include_router(client_router)
app.include_router(account_router)
app.include_router(transaction_router)
app.include_router(kyc_flag_router)
app.include_router(scv_router)


===== FILE: backend_v2\app\models\__init__.py =====
from app.db import Base
from app.models.client import Client
from app.models.account import Account
from app.models.transaction import Transaction
from app.models.kyc_flag import KycFlag

__all__ = ["Client", "Account", "Transaction", "KycFlag", "Base"]


===== FILE: backend_v2\app\models\account.py =====
from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship
from app.db import Base


class Account(Base):
    __tablename__ = "accounts"

    id = Column(Integer, primary_key=True, index=True)
    client_id = Column(Integer, ForeignKey("clients.id"), index=True, nullable=False)
    account_number = Column(String, unique=True, index=True, nullable=False)
    account_type = Column(String, nullable=True)   # e.g. CASH, SECURITIES, MARGIN
    currency = Column(String, nullable=False, default="GBP")
    status = Column(String, nullable=False, default="OPEN")  # OPEN, CLOSED
    opened_at = Column(String, nullable=True)
    closed_at = Column(String, nullable=True)

    client = relationship("Client", backref="accounts")


===== FILE: backend_v2\app\models\client.py =====
from sqlalchemy import Column, Integer, String
from app.db import Base


class Client(Base):
    __tablename__ = "clients"

    id = Column(Integer, primary_key=True, index=True)
    external_id = Column(String, unique=True, index=True, nullable=True)
    full_name = Column(String, nullable=False)
    email = Column(String, nullable=True)
    phone = Column(String, nullable=True)
    primary_address = Column(String, nullable=True)
    country = Column(String, nullable=True)
    tax_id = Column(String, nullable=True)
    segment = Column(String, nullable=True)
    risk_rating = Column(String, nullable=True)


===== FILE: backend_v2\app\models\kyc_flag.py =====
from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship
from app.db import Base


class KycFlag(Base):
    __tablename__ = "kyc_flags"

    id = Column(Integer, primary_key=True, index=True)
    client_id = Column(Integer, ForeignKey("clients.id"), index=True, nullable=False)
    code = Column(String, nullable=False)         # e.g. PEP, SANCTIONS, HIGH_RISK
    description = Column(String, nullable=True)
    status = Column(String, nullable=False, default="OPEN")  # OPEN, CLOSED
    created_at = Column(String, nullable=True)
    resolved_at = Column(String, nullable=True)

    client = relationship("Client", backref="kyc_flags")


===== FILE: backend_v2\app\models\transaction.py =====
from sqlalchemy import Column, Integer, String, ForeignKey, Float
from sqlalchemy.orm import relationship
from app.db import Base


class Transaction(Base):
    __tablename__ = "transactions"

    id = Column(Integer, primary_key=True, index=True)
    account_id = Column(Integer, ForeignKey("accounts.id"), index=True, nullable=False)
    trade_date = Column(String, nullable=True)
    value_date = Column(String, nullable=True)
    amount = Column(Float, nullable=False)
    currency = Column(String, nullable=False, default="GBP")
    txn_type = Column(String, nullable=False)  # CREDIT, DEBIT, TRADE, FEE
    description = Column(String, nullable=True)

    account = relationship("Account", backref="transactions")


===== FILE: backend_v2\app\repositories\__init__.py =====
# repository package


===== FILE: backend_v2\app\repositories\account_repository.py =====
from sqlalchemy.orm import Session
from app.models.account import Account
from app.schemas.account import AccountCreate


class AccountRepository:

    @staticmethod
    def create(db: Session, data: AccountCreate) -> Account:
        acc = Account(**data.model_dump())
        db.add(acc)
        db.commit()
        db.refresh(acc)
        return acc

    @staticmethod
    def get(db: Session, account_id: int) -> Account | None:
        return db.query(Account).filter(Account.id == account_id).first()

    @staticmethod
    def list_by_client(db: Session, client_id: int) -> list[Account]:
        return db.query(Account).filter(Account.client_id == client_id).all()


===== FILE: backend_v2\app\repositories\client_repository.py =====
from sqlalchemy.orm import Session
from app.models.client import Client
from app.schemas.client import ClientCreate


class ClientRepository:

    @staticmethod
    def create(db: Session, data: ClientCreate) -> Client:
        client = Client(**data.model_dump())
        db.add(client)
        db.commit()
        db.refresh(client)
        return client

    @staticmethod
    def get(db: Session, client_id: int) -> Client | None:
        return db.query(Client).filter(Client.id == client_id).first()

    @staticmethod
    def list(db: Session) -> list[Client]:
        return db.query(Client).all()


===== FILE: backend_v2\app\repositories\kyc_flag_repository.py =====
from sqlalchemy.orm import Session
from app.models.kyc_flag import KycFlag
from app.schemas.kyc_flag import KycFlagCreate


class KycFlagRepository:

    @staticmethod
    def create(db: Session, data: KycFlagCreate) -> KycFlag:
        flag = KycFlag(**data.model_dump())
        db.add(flag)
        db.commit()
        db.refresh(flag)
        return flag

    @staticmethod
    def list_by_client(db: Session, client_id: int) -> list[KycFlag]:
        return db.query(KycFlag).filter(KycFlag.client_id == client_id).all()


===== FILE: backend_v2\app\repositories\transaction_repository.py =====
from sqlalchemy.orm import Session
from app.models.transaction import Transaction
from app.schemas.transaction import TransactionCreate


class TransactionRepository:

    @staticmethod
    def create(db: Session, data: TransactionCreate) -> Transaction:
        txn = Transaction(**data.model_dump())
        db.add(txn)
        db.commit()
        db.refresh(txn)
        return txn

    @staticmethod
    def list_by_account(db: Session, account_id: int) -> list[Transaction]:
        return db.query(Transaction).filter(Transaction.account_id == account_id).all()


===== FILE: backend_v2\app\routers\__init__.py =====
# routers package


===== FILE: backend_v2\app\routers\account_router.py =====
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.db import get_db
from app.schemas.account import AccountCreate, AccountRead
from app.services.account_service import AccountService
from app.services.transaction_service import TransactionService
from app.schemas.transaction import TransactionRead


router = APIRouter(prefix="/accounts", tags=["accounts"])


@router.post("/", response_model=AccountRead)
def create_account(data: AccountCreate, db: Session = Depends(get_db)):
    return AccountService.create(db, data)


@router.get("/{account_id}", response_model=AccountRead | None)
def get_account(account_id: int, db: Session = Depends(get_db)):
    return AccountService.get(db, account_id)


@router.get("/{account_id}/transactions", response_model=list[TransactionRead])
def get_account_transactions(account_id: int, db: Session = Depends(get_db)):
    return TransactionService.list_by_account(db, account_id)


===== FILE: backend_v2\app\routers\client_router.py =====
from fastapi import APIRouter, Depends, HTTPException
from fastapi.encoders import jsonable_encoder
from sqlalchemy.orm import Session

from app.db import get_db
from app.schemas.client import ClientCreate, ClientRead
from app.schemas.account import AccountRead
from app.schemas.kyc_flag import KycFlagRead
from app.services.client_service import ClientService
from app.services.account_service import AccountService
from app.services.kyc_flag_service import KycFlagService
from app.services.transaction_service import TransactionService

router = APIRouter(prefix="/clients", tags=["clients"])


# -----------------------------
# Basic CRUD / helper endpoints
# -----------------------------
@router.post("/", response_model=ClientRead)
def create_client(data: ClientCreate, db: Session = Depends(get_db)):
    return ClientService.create(db, data)


@router.get("/", response_model=list[ClientRead])
def list_clients(db: Session = Depends(get_db)):
    return ClientService.list(db)


@router.get("/{client_id}", response_model=ClientRead | None)
def get_client(client_id: int, db: Session = Depends(get_db)):
    return ClientService.get(db, client_id)


@router.get("/{client_id}/accounts", response_model=list[AccountRead])
def get_client_accounts(client_id: int, db: Session = Depends(get_db)):
    return AccountService.list_by_client(db, client_id)


@router.get("/{client_id}/kyc-flags", response_model=list[KycFlagRead])
def get_client_kyc_flags(client_id: int, db: Session = Depends(get_db)):
    return KycFlagService.list_by_client(db, client_id)


# -----------------------------------------
# Compatibility endpoints for existing UI
# -----------------------------------------
# App.jsx currently calls:
#   GET /clients/{client_id}/profile
#   GET /clients/{client_id}/sources
# We implement lightweight versions of those
# backed by the new Postgres models.
#
# Canonical contract requirement (SCV_CANONICAL_STATE.md):
# Must return keys (present even if empty):
#   client, accounts, match_decisions, trade_history, audit_trail,
#   regulatory_enrichment, evidence_artefacts


@router.get("/{client_id}/profile")
def get_client_profile_for_ui(client_id: int, db: Session = Depends(get_db)):
    """
    Canonical SCV profile endpoint.

    Non-negotiables:
    - backend_v2 is canonical runtime
    - ONE canonical endpoint: GET /clients/{id}/profile
    - Must return keys (present even if empty):
        client, accounts, match_decisions, trade_history, audit_trail,
        regulatory_enrichment, evidence_artefacts

    Story 1 focus:
    - trade_history must show REAL data (sourced from transactions table)
    """
    client = ClientService.get(db, client_id)
    if not client:
        raise HTTPException(status_code=404, detail="Client not found")

    accounts = AccountService.list_by_client(db, client_id)
    account_ids = [a.id for a in accounts]

    # Pull real transactions and flatten into trade_history
    trade_history: list[dict] = []
    for acc_id in account_ids:
        txns = TransactionService.list_by_account(db, acc_id)
        for t in txns:
            td = t.trade_date
            amt = t.amount
            # Map "transaction" -> UI "trade-like" row (minimal, but real)
            trade_history.append(
                {
                    "trade_id": t.id,
                    "account_id": t.account_id,
                    "trade_date": td,
                    "value_date": t.value_date,
                    "asset_class": "CASH",
                    "instrument": t.currency,  # UI reads instrument/symbol/ccy_pair
                    "direction": "BUY" if (amt is not None and amt >= 0) else "SELL",
                    "quantity": abs(amt) if amt is not None else None,  # UI reads quantity/qty/notional
                    "price": None,
                    "pnl": None,
                    # Keep raw fields for the expandable JSON view
                    "amount": t.amount,
                    "currency": t.currency,
                    "txn_type": t.txn_type,
                    "description": t.description,
                }
            )

    # Canonical keys (always present)
    client_payload = jsonable_encoder(client)
    accounts_payload = jsonable_encoder(accounts)

    # Also keep legacy top-level fields that the existing UI header reads
    profile = {
        # ---- legacy/top-level (do not remove) ----
        "client_id": str(client.id),
        "name": client.full_name,
        "email": client.email,
        "phone": client.phone,
        "country": client.country,
        "segment": client.segment,
        "risk_rating": client.risk_rating,
        "addresses": [],
        "operational_state": {
            "status": "ACTIVE",
            "as_of": None,
            "processing_stage": "PROFILE_COMPOSED",
            "message": "Composed via backend_v2 /clients/{id}/profile",
            "details": {},
        },
        # ---- canonical contract keys (must exist) ----
        "client": client_payload,
        "accounts": accounts_payload,
        "match_decisions": [],
        "trade_history": trade_history,
        "audit_trail": [],
        "regulatory_enrichment": {},
        "evidence_artefacts": [],
    }

    # Map the primary_address into a single address entry if present
    if client.primary_address:
        profile["addresses"].append(
            {
                "line1": client.primary_address,
                "line2": None,
                "city": None,
                "postcode": None,
                "country": client.country,
                "source": "SCV_DB",
            }
        )

    return profile


@router.get("/{client_id}/sources")
def get_client_sources_for_ui(client_id: int, db: Session = Depends(get_db)):
    """
    Return a synthetic 'raw sources' array so the existing UI can render
    something in the Raw sources panel.

    Shape:
      [
        {
          "id": "SCV-<client_id>",
          "system": "SCV_DB",
          "client_id": "<client_id>",
          "payload": { . }
        }
      ]
    """
    client = ClientService.get(db, client_id)
    if not client:
        raise HTTPException(status_code=404, detail="Client not found")

    accounts = AccountService.list_by_client(db, client_id)
    kyc_flags = KycFlagService.list_by_client(db, client_id)

    payload = {
        "client": {
            "id": client.id,
            "external_id": client.external_id,
            "full_name": client.full_name,
            "email": client.email,
            "phone": client.phone,
            "primary_address": client.primary_address,
            "country": client.country,
            "segment": client.segment,
            "tax_id": client.tax_id,
            "risk_rating": client.risk_rating,
        },
        "accounts": [
            {
                "id": a.id,
                "account_number": a.account_number,
                "account_type": a.account_type,
                "currency": a.currency,
                "status": a.status,
            }
            for a in accounts
        ],
        "kyc_flags": [
            {
                "id": f.id,
                "code": f.code,
                "status": f.status,
                "description": f.description,
                "created_at": f.created_at,
                "resolved_at": f.resolved_at,
            }
            for f in kyc_flags
        ],
    }

    return [
        {
            "id": f"SCV-{client.id}",
            "system": "SCV_DB",
            "client_id": str(client.id),
            "payload": payload,
        }
    ]




===== FILE: backend_v2\app\routers\kyc_flag_router.py =====
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.db import get_db
from app.schemas.kyc_flag import KycFlagCreate, KycFlagRead
from app.services.kyc_flag_service import KycFlagService


router = APIRouter(prefix="/kyc-flags", tags=["kyc_flags"])


@router.post("/", response_model=KycFlagRead)
def create_kyc_flag(data: KycFlagCreate, db: Session = Depends(get_db)):
    return KycFlagService.create(db, data)


===== FILE: backend_v2\app\routers\scv_router.py =====
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from app.db import get_db
from app.services.client_service import ClientService
from app.services.account_service import AccountService
from app.services.transaction_service import TransactionService
from app.services.kyc_flag_service import KycFlagService


router = APIRouter(prefix="/scv", tags=["single_client_view"])


@router.get("/{client_id}")
def get_single_client_view(client_id: int, db: Session = Depends(get_db)):
    client = ClientService.get(db, client_id)
    if not client:
        raise HTTPException(status_code=404, detail="Client not found")

    accounts = AccountService.list_by_client(db, client_id)
    account_ids = [a.id for a in accounts]
    transactions_by_account = {
        acc_id: TransactionService.list_by_account(db, acc_id) for acc_id in account_ids
    }
    kyc_flags = KycFlagService.list_by_client(db, client_id)

    return {
        "client": client,
        "accounts": accounts,
        "transactions_by_account": transactions_by_account,
        "kyc_flags": kyc_flags,
    }


===== FILE: backend_v2\app\routers\transaction_router.py =====
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.db import get_db
from app.schemas.transaction import TransactionCreate, TransactionRead
from app.services.transaction_service import TransactionService


router = APIRouter(prefix="/transactions", tags=["transactions"])


@router.post("/", response_model=TransactionRead)
def create_transaction(data: TransactionCreate, db: Session = Depends(get_db)):
    return TransactionService.create(db, data)


===== FILE: backend_v2\app\schemas\__init__.py =====
from app.schemas.client import ClientCreate, ClientRead
from app.schemas.account import AccountCreate, AccountRead
from app.schemas.transaction import TransactionCreate, TransactionRead
from app.schemas.kyc_flag import KycFlagCreate, KycFlagRead

__all__ = [
    "ClientCreate", "ClientRead",
    "AccountCreate", "AccountRead",
    "TransactionCreate", "TransactionRead",
    "KycFlagCreate", "KycFlagRead",
]


===== FILE: backend_v2\app\schemas\account.py =====
from pydantic import BaseModel


class AccountBase(BaseModel):
    client_id: int
    account_number: str
    account_type: str | None = None
    currency: str = "GBP"
    status: str = "OPEN"
    opened_at: str | None = None
    closed_at: str | None = None


class AccountCreate(AccountBase):
    pass


class AccountRead(AccountBase):
    id: int

    class Config:
        from_attributes = True


===== FILE: backend_v2\app\schemas\client.py =====
from pydantic import BaseModel


class ClientBase(BaseModel):
    external_id: str | None = None
    full_name: str
    email: str | None = None
    phone: str | None = None
    primary_address: str | None = None
    country: str | None = None
    tax_id: str | None = None
    segment: str | None = None
    risk_rating: str | None = None


class ClientCreate(ClientBase):
    pass


class ClientRead(ClientBase):
    id: int

    class Config:
        from_attributes = True


===== FILE: backend_v2\app\schemas\kyc_flag.py =====
from pydantic import BaseModel


class KycFlagBase(BaseModel):
    client_id: int
    code: str
    description: str | None = None
    status: str = "OPEN"
    created_at: str | None = None
    resolved_at: str | None = None


class KycFlagCreate(KycFlagBase):
    pass


class KycFlagRead(KycFlagBase):
    id: int

    class Config:
        from_attributes = True


===== FILE: backend_v2\app\schemas\transaction.py =====
from pydantic import BaseModel


class TransactionBase(BaseModel):
    account_id: int
    trade_date: str | None = None
    value_date: str | None = None
    amount: float
    currency: str = "GBP"
    txn_type: str
    description: str | None = None


class TransactionCreate(TransactionBase):
    pass


class TransactionRead(TransactionBase):
    id: int

    class Config:
        from_attributes = True


===== FILE: backend_v2\app\seed\__init__.py =====
# seed package


===== FILE: backend_v2\app\seed\seed_data.py =====
from sqlalchemy.orm import Session

from app.schemas.client import ClientCreate
from app.schemas.account import AccountCreate
from app.schemas.transaction import TransactionCreate
from app.schemas.kyc_flag import KycFlagCreate

from app.services.client_service import ClientService
from app.services.account_service import AccountService
from app.services.transaction_service import TransactionService
from app.services.kyc_flag_service import KycFlagService

from app.models.client import Client


def seed(db: Session) -> None:
    """
    Seed the database with a small institutional / corporate book.

    Note: this only runs if there are no clients in the database.
    """
    if db.query(Client).count() > 0:
        return

    # ---------- CLIENTS (CORPORATE) ----------

    acme = ClientService.create(
        db,
        ClientCreate(
            external_id="CRM-CORP-001",
            full_name="Acme Manufacturing Ltd",
            email="treasury@acme-mfg.co.uk",
            phone="+44 20 7000 1001",
            primary_address="10 Foundry Park, Birmingham, B1 2AB, United Kingdom",
            country="UK",
            tax_id="GB999000111",
            segment="Corporate â€“ Mid Cap",
            risk_rating="MEDIUM",
        ),
    )

    northbridge = ClientService.create(
        db,
        ClientCreate(
            external_id="CRM-FI-002",
            full_name="Northbridge Capital Markets LLP",
            email="ops@northbridgecm.com",
            phone="+44 20 7100 2200",
            primary_address="25 Bishopsgate, London EC2N 4AA, United Kingdom",
            country="UK",
            tax_id="GB777123456",
            segment="Financial Institution â€“ Broker/Dealer",
            risk_rating="HIGH",
        ),
    )

    eurotech = ClientService.create(
        db,
        ClientCreate(
            external_id="CRM-CORP-003",
            full_name="EuroTech Components AG",
            email="finance@eurotech-ag.de",
            phone="+49 69 9000 3300",
            primary_address="Friedrich-Ebert-Anlage 12, 60325 Frankfurt, Germany",
            country="DE",
            tax_id="DE311445566",
            segment="Corporate â€“ Large Cap",
            risk_rating="LOW",
        ),
    )

    greenfields = ClientService.create(
        db,
        ClientCreate(
            external_id="CRM-FUND-004",
            full_name="Greenfields Global Opportunities Fund",
            email="fundops@greenfieldsfund.com",
            phone="+44 20 7200 4455",
            primary_address="8 St Jamesâ€™s Square, London SW1Y 4JU, United Kingdom",
            country="UK",
            tax_id="JE55001122",
            segment="Asset Manager â€“ Fund",
            risk_rating="HIGH",
        ),
    )

    cityhealth = ClientService.create(
        db,
        ClientCreate(
            external_id="CRM-CORP-005",
            full_name="CityHealth NHS Services Consortium",
            email="finance@cityhealth-consortium.org.uk",
            phone="+44 161 400 8800",
            primary_address="120 Deansgate, Manchester M3 2GH, United Kingdom",
            country="UK",
            tax_id="GB660009999",
            segment="Public Sector / Healthcare",
            risk_rating="MEDIUM",
        ),
    )

    # ---------- ACCOUNTS ----------

    # Acme â€“ operating GBP account, USD account
    acme_gbp = AccountService.create(
        db,
        AccountCreate(
            client_id=acme.id,
            account_number="ACME-GBP-001",
            account_type="OPERATING",
            currency="GBP",
            status="OPEN",
        ),
    )
    acme_usd = AccountService.create(
        db,
        AccountCreate(
            client_id=acme.id,
            account_number="ACME-USD-001",
            account_type="OPERATING",
            currency="USD",
            status="OPEN",
        ),
    )

    # Northbridge â€“ client money & margin
    nb_client = AccountService.create(
        db,
        AccountCreate(
            client_id=northbridge.id,
            account_number="NB-CM-001",
            account_type="CLIENT_MONEY",
            currency="GBP",
            status="OPEN",
        ),
    )
    nb_margin = AccountService.create(
        db,
        AccountCreate(
            client_id=northbridge.id,
            account_number="NB-MRG-001",
            account_type="MARGIN",
            currency="USD",
            status="OPEN",
        ),
    )

    # EuroTech â€“ EUR operating
    euro_eur = AccountService.create(
        db,
        AccountCreate(
            client_id=eurotech.id,
            account_number="ET-EUR-001",
            account_type="OPERATING",
            currency="EUR",
            status="OPEN",
        ),
    )

    # Greenfields â€“ subscription & redemption cash
    gf_sub = AccountService.create(
        db,
        AccountCreate(
            client_id=greenfields.id,
            account_number="GF-SUB-001",
            account_type="SUBSCRIPTIONS",
            currency="USD",
            status="OPEN",
        ),
    )
    gf_red = AccountService.create(
        db,
        AccountCreate(
            client_id=greenfields.id,
            account_number="GF-RED-001",
            account_type="REDEMPTIONS",
            currency="USD",
            status="OPEN",
        ),
    )

    # CityHealth â€“ GBP payments account
    ch_gbp = AccountService.create(
        db,
        AccountCreate(
            client_id=cityhealth.id,
            account_number="CH-GBP-001",
            account_type="OPERATING",
            currency="GBP",
            status="OPEN",
        ),
    )

    # ---------- TRANSACTIONS (HIGH-LEVEL) ----------

    # Acme GBP
    TransactionService.create(
        db,
        TransactionCreate(
            account_id=acme_gbp.id,
            trade_date="2025-01-05",
            value_date="2025-01-05",
            amount=1_250_000.00,
            currency="GBP",
            txn_type="CREDIT",
            description="Quarterly invoice receipts â€“ UK distributors",
        ),
    )
    TransactionService.create(
        db,
        TransactionCreate(
            account_id=acme_gbp.id,
            trade_date="2025-01-08",
            value_date="2025-01-08",
            amount=-420_000.00,
            currency="GBP",
            txn_type="DEBIT",
            description="Payroll and supplier payments",
        ),
    )

    # Acme USD
    TransactionService.create(
        db,
        TransactionCreate(
            account_id=acme_usd.id,
            trade_date="2025-01-10",
            value_date="2025-01-11",
            amount=900_000.00,
            currency="USD",
            txn_type="CREDIT",
            description="Export receipts â€“ US customer",
        ),
    )

    # Northbridge client money
    TransactionService.create(
        db,
        TransactionCreate(
            account_id=nb_client.id,
            trade_date="2025-02-01",
            value_date="2025-02-01",
            amount=35_000_000.00,
            currency="GBP",
            txn_type="CREDIT",
            description="Client collateral top-up",
        ),
    )
    TransactionService.create(
        db,
        TransactionCreate(
            account_id=nb_client.id,
            trade_date="2025-02-02",
            value_date="2025-02-02",
            amount=-12_500_000.00,
            currency="GBP",
            txn_type="DEBIT",
            description="Daily variation margin outflow",
        ),
    )

    # Northbridge margin USD
    TransactionService.create(
        db,
        TransactionCreate(
            account_id=nb_margin.id,
            trade_date="2025-02-03",
            value_date="2025-02-04",
            amount=7_500_000.00,
            currency="USD",
            txn_type="CREDIT",
            description="Initial margin received on cleared swaps",
        ),
    )

    # EuroTech EUR
    TransactionService.create(
        db,
        TransactionCreate(
            account_id=euro_eur.id,
            trade_date="2025-01-15",
            value_date="2025-01-15",
            amount=4_200_000.00,
            currency="EUR",
            txn_type="CREDIT",
            description="Receivables from OEM contracts",
        ),
    )
    TransactionService.create(
        db,
        TransactionCreate(
            account_id=euro_eur.id,
            trade_date="2025-01-18",
            value_date="2025-01-19",
            amount=-3_100_000.00,
            currency="EUR",
            txn_type="DEBIT",
            description="Raw materials purchase â€“ multi-country suppliers",
        ),
    )

    # Greenfields subscriptions / redemptions
    TransactionService.create(
        db,
        TransactionCreate(
            account_id=gf_sub.id,
            trade_date="2025-03-01",
            value_date="2025-03-02",
            amount=65_000_000.00,
            currency="USD",
            txn_type="CREDIT",
            description="Monthly investor subscriptions",
        ),
    )
    TransactionService.create(
        db,
        TransactionCreate(
            account_id=gf_red.id,
            trade_date="2025-03-05",
            value_date="2025-03-06",
            amount=-18_500_000.00,
            currency="USD",
            txn_type="DEBIT",
            description="Quarterly investor redemptions",
        ),
    )

    # CityHealth GBP
    TransactionService.create(
        db,
        TransactionCreate(
            account_id=ch_gbp.id,
            trade_date="2025-01-07",
            value_date="2025-01-07",
            amount=9_750_000.00,
            currency="GBP",
            txn_type="CREDIT",
            description="NHS commissioning inflow â€“ London region",
        ),
    )

    # ---------- KYC FLAGS ----------

    KycFlagService.create(
        db,
        KycFlagCreate(
            client_id=northbridge.id,
            code="HIGH_TRADING_VOLUME",
            description="Daily derivatives margin flows above defined threshold",
            status="OPEN",
            created_at="2024-12-15",
        ),
    )

    KycFlagService.create(
        db,
        KycFlagCreate(
            client_id=greenfields.id,
            code="UBO_COMPLEX_STRUCTURE",
            description="Layered fund / SPV structure â€“ enhanced due diligence required",
            status="OPEN",
            created_at="2024-11-01",
        ),
    )

    KycFlagService.create(
        db,
        KycFlagCreate(
            client_id=acme.id,
            code="SANCTIONS_SCREENING_HIT",
            description="False positive â€“ name match to restricted entity, monitored",
            status="CLOSED",
            created_at="2023-06-10",
            resolved_at="2023-06-12",
        ),
    )


===== FILE: backend_v2\app\services\__init__.py =====
# services package


===== FILE: backend_v2\app\services\account_service.py =====
from sqlalchemy.orm import Session
from app.schemas.account import AccountCreate
from app.repositories.account_repository import AccountRepository


class AccountService:

    @staticmethod
    def create(db: Session, data: AccountCreate):
        return AccountRepository.create(db, data)

    @staticmethod
    def get(db: Session, account_id: int):
        return AccountRepository.get(db, account_id)

    @staticmethod
    def list_by_client(db: Session, client_id: int):
        return AccountRepository.list_by_client(db, client_id)


===== FILE: backend_v2\app\services\client_service.py =====
from sqlalchemy.orm import Session
from app.schemas.client import ClientCreate
from app.repositories.client_repository import ClientRepository


class ClientService:

    @staticmethod
    def create(db: Session, data: ClientCreate):
        return ClientRepository.create(db, data)

    @staticmethod
    def get(db: Session, client_id: int):
        return ClientRepository.get(db, client_id)

    @staticmethod
    def list(db: Session):
        return ClientRepository.list(db)


===== FILE: backend_v2\app\services\kyc_flag_service.py =====
from sqlalchemy.orm import Session
from app.schemas.kyc_flag import KycFlagCreate
from app.repositories.kyc_flag_repository import KycFlagRepository


class KycFlagService:

    @staticmethod
    def create(db: Session, data: KycFlagCreate):
        return KycFlagRepository.create(db, data)

    @staticmethod
    def list_by_client(db: Session, client_id: int):
        return KycFlagRepository.list_by_client(db, client_id)


===== FILE: backend_v2\app\services\transaction_service.py =====
from sqlalchemy.orm import Session
from app.schemas.transaction import TransactionCreate
from app.repositories.transaction_repository import TransactionRepository


class TransactionService:

    @staticmethod
    def create(db: Session, data: TransactionCreate):
        return TransactionRepository.create(db, data)

    @staticmethod
    def list_by_account(db: Session, account_id: int):
        return TransactionRepository.list_by_account(db, account_id)


===== FILE: backend_v2\requirements.txt =====
fastapi
uvicorn[standard]
SQLAlchemy>=2.0
pydantic>=2.0
psycopg[binary]
python-dotenv


===== FILE: database.py =====
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

DATABASE_URL = "postgresql+psycopg://postgres:Londonirish-01@localhost:5432/scv"

engine = create_engine(DATABASE_URL, pool_pre_ping=True)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)



===== FILE: docs\mission_destination\epics\E00_application_bootstrapping.md =====
---
epic_id: E00
slug: e00_application_bootstrapping
name: "Application Bootstrapping"

features:
  - FT-00-BE


overall_status: Complete

last_updated: <auto>

---

## Context

This epic delivers the minimal backend scaffolding needed for developers to
build, run, and verify the Single Client View application.

## Objectives

- Backend starts reliably in a developer environment.
- At least one health/status endpoint is available.
- Code adheres to MissionFramework guardrails.
- Story-level test status is automatically updated.

## Acceptance

- All features under this epic have status `active` or `done`.
- All related stories have `testing_status: pass`.



===== FILE: docs\mission_destination\epics\E00_ui_bootstrapping.md =====
---
epic_id: E00-UI
slug: e00_ui_bootstrapping
name: "User Interface Bootstrapping"

features:
  - FT-00-UI


overall_status: In Progress

last_updated: <auto>
---




\## Context



This epic delivers the minimal frontend scaffolding needed for the Single

Client Value UI to build, load in a browser, and render predictable output.



\## Objectives



\- Frontend builds without errors.

\- App renders a visible indicator confirming it is running.

\- Tests validate this behaviour.



\## Acceptance



\- All related features are `active` or `done`.

\- All related stories have `test\_status: passed`.





===== FILE: docs\mission_destination\epics\E01_client_ingestion_and_normalisation.md =====
---
epic_id: EP-01
name: "Client Ingestion & Normalisation"
description: |
  This epic delivers the capability to ingest client data from multiple internal
  systems (CRM, KYC, onboarding, trading) and normalise it into a single
  canonical client model. It ensures consistent formats, data types, and field
  structures across all sources. This is the pipeline that feeds the SCV engine
  with reliable, usable data.

features:
  - FT-01
  - FT-02
  - FT-03
  - FT-04


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\epics\E02_client_matching_and_golden_record.md =====
---
epic_id: EP-02
name: "Client Matching & Golden Record"
description: |
  This epic establishes the rules and logic for matching client records across
  systems, resolving duplicates, and building the authoritative golden record.
  Includes exact and fuzzy matching, conflict resolution, and merge lineage.
  The output becomes the Single Client View master profile.

features:
  - FT-05
  - FT-06
  - FT-07


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\epics\E03_client_search.md =====
---
epic_id: EP-03
name: "Client Search"
description: |
  This epic provides search capabilities for finding clients based on names,
  identifiers, partial information, or attributes. It includes indexing,
  relevance ranking, fuzzy matching, and result scoring. Search is the primary
  user entry point into the Single Client View.

features:
  - FT-08
  - FT-09


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\epics\E04_client_profile_assembly.md =====
---
epic_id: EP-04
name: "Client Profile Assembly"
description: |
  This epic assembles the unified client profile from the golden record,
  including core identity, operational attributes, source lineage, and data
  quality indicators. It defines how attribute-level provenance is exposed and
  how conflicting information is presented.

features:
  - FT-10
  - FT-11
  - FT-12


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\epics\E05_data_quality_and_lineage.md =====
---
epic_id: EP-05
name: "Data Quality & Lineage"
description: |
  This epic delivers attribute-level lineage tracking, data freshness indicators,
  quality scoring, conflict flags, and auditability. It ensures every attribute
  in the SCV profile can be traced back to its original source system with full
  transparency.

features:
  - FT-13
  - FT-14
  - FT-15


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\epics\E06_api_and_integration.md =====
---
epic_id: EP-06
name: "Integration & API Exposure"
description: |
  This epic exposes the SCV capabilities to other systems via APIs. Includes
  search endpoints, client profile retrieval, and interface contracts for
  internal consumers. Ensures consistent, secure, and performant access to the
  Single Client View.

features:
  - FT-16
  - FT-17


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-00-backend_fundamentals.md =====
---
feature_id: FT-00-BE
epic: E00
name: "Backend Fundamentals"
description: |
  Establish the initial backend service and runtime foundations required for the
  Single Client View application to start, respond to basic requests, and be
  governed by MissionFramework guardrails. This feature delivers a minimal,
  reliable API surface that other stories can build on.

stories:
  - ST-00


overall_status: Complete

last_updated: <auto>
---



===== FILE: docs\mission_destination\features\FT-00-frontend_fundamentals.md =====
---
feature_id: FT-00-UI
epic: E00-UI
name: "Frontend Fundamentals"
description: |
  Provide a minimal frontend shell that builds, loads, renders, and verifies
  that the baseline UI is operational.

stories:
  - ST-00-FRONTEND-UI-SHELL


overall_status: In Progress

last_updated: <auto>


---



\## Scope



\- Frontend build and dev server.

\- Root React component and layout shell.

\- Visible indicator that the UI is running.



\## Out of Scope



\- Domain UI for Single Client Value.

\- Search, profile, lineage, or matching components.





===== FILE: docs\mission_destination\features\FT-01_source_system_config.md =====
---
feature_id: FT-01
epic: EP-01
name: "Source System Configuration"
description: |
  Configure each upstream client data source, including credentials, endpoints,
  schema discovery, and scheduling parameters. Enables SCV to pull structured
  data from CRM, KYC, onboarding, and trading systems.

stories:
  - ST-01
  - ST-02


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-02_schema_mapping.md =====
---
feature_id: FT-02
epic: EP-01
name: "Schema Mapping to Canonical Model"
description: |
  Map source-system client schemas into SCVâ€™s canonical schema, including
  identity fields, contact details, identifiers, and operational attributes.

stories:
  - ST-03
  - ST-04


overall_status: Complete


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-03_initial_bulk_ingestion.md =====
---
feature_id: FT-03
epic: EP-01
name: "Initial Bulk Ingestion"
description: |
  Perform a one-time historical load of all client records from each upstream
  system. Includes batching, error handling, and ingestion evidence.

stories:
  - ST-05
  - ST-06


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-04_incremental_ingestion.md =====
---
feature_id: FT-04
epic: EP-01
name: "Incremental Ingestion & Change Detection"
description: |
  Implement scheduled or event-driven incremental updates, detecting changes in
  upstream systems and applying deltas to SCVâ€™s internal store.

stories:
  - ST-07
  - ST-08


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-05_exact_matching.md =====
---
feature_id: FT-05
epic: EP-02
name: "Exact Match Rules"
description: |
  Implement deterministic matching rules based on unique identifiers such as
  client ID, company registration number, tax ID, and email address.

stories:
  - ST-09
  - ST-10


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-06_fuzzy_matching.md =====
---
feature_id: FT-06
epic: EP-02
name: "Fuzzy & Probabilistic Matching"
description: |
  Implement relevance-based matching using name similarity, token distance, and
  attribute-level confidence scoring.

stories:
  - ST-11
  - ST-12


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-07_golden_record_merge.md =====
---
feature_id: FT-07
epic: EP-02
name: "Golden Record Construction"
description: |
  Apply merge rules across conflicting source attributes, selecting canonical
  values and recording lineage for each field.

stories:
  - ST-13
  - ST-14
  - ST-15


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-08_search_indexing.md =====
---
feature_id: FT-08
epic: EP-03
name: "Search Index & Normalisation"
description: |
  Build a performant search index for names, identifiers, and attributes.

stories:
  - ST-16
  - ST-17


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-09_fuzzy_search.md =====
---
feature_id: FT-09
epic: EP-03
name: "Fuzzy Search & Ranking"
description: |
  Provide fuzzy search, relevance ranking, and partial-match scoring.

stories:
  - ST-18
  - ST-19


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-10_profile_assembly.md =====
---
feature_id: FT-10
epic: EP-04
name: "Assemble Canonical Profile"
description: |
  Construct the unified client profile including identity, identifiers,
  operational attributes, and metadata.

stories:
  - ST-20
  - ST-21


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-11_lineage_exposure.md =====
---
feature_id: FT-11
epic: EP-04
name: "Lineage Exposure"
description: |
  Display attribute-level provenance showing which source system contributed
  each value.

stories:
  - ST-22
  - ST-23


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-12_conflict_presentation.md =====
---
feature_id: FT-12
epic: EP-04
name: "Conflict Presentation"
description: |
  Highlight conflicting source attributes, display confidence scores, and show
  merge logic outcomes.

stories:
  - ST-24
  - ST-25


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-13_lineage_tracking.md =====
---
feature_id: FT-13
epic: EP-05
name: "Lineage Tracking"
description: |
  Track attribute-level lineage with timestamped provenance and update history.

stories:
  - ST-26
  - ST-27


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-14_quality_scoring.md =====
---
feature_id: FT-14
epic: EP-05
name: "Data Quality Scoring"
description: |
  Compute quality indicators including completeness, consistency, and
  freshness scores.

stories:
  - ST-28
  - ST-29


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-15_auditability.md =====
---
feature_id: FT-15
epic: EP-05
name: "Auditability & Evidence"
description: |
  Generate audit logs for ingestion, matching, merging, and profile assembly,
  and store evidence snapshots.

stories:
  - ST-30
  - ST-31


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-16_search_api.md =====
---
feature_id: FT-16
epic: EP-06
name: "Search API"
description: |
  Expose a REST endpoint for searching clients by name, identifier, or
  attributes. Includes pagination and ranked results.

stories:
  - ST-32
  - ST-33


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\features\FT-17_profile_api.md =====
---
feature_id: FT-17
epic: EP-06
name: "Client Profile API"
description: |
  Expose the canonical client profile via REST, including full lineage metadata
  and data quality indicators.

stories:
  - ST-34
  - ST-35


overall_status: In Progress


last_updated: <auto>
---


===== FILE: docs\mission_destination\initial_logical_data_model.md =====
# Initial Logical Data Model (LDM)
**MissionDestination**
**Single Client View (SCV)**

## 1. Purpose
This document defines the **Initial Logical Data Model** for the Single Client View (SCV) application.
It establishes the **canonical semantic representation of a client**, which all ingestion,
normalisation, matching, merging, lineage, quality, and API features will converge toward.

The Initial Logical Data Model is:
- technology-agnostic
- storage-agnostic
- canonical across all source systems
- stable across all Stories
- the semantic target for the behaviours defined in Epics, Features, and Stories

It is **not** a physical database schema.  
It is the logical definition of what a â€œclientâ€ means inside the SCV domain.

## 2. Canonical Entities

### 2.1 ClientProfile
Represents the unified, deduplicated profile of a client.

| Field | Type | Description |
|-------|------|-------------|
| client_id | str | Internal SCV identifier |
| name | str | Canonical client name |
| email | Optional[str] | Canonical email |
| country | Optional[str] | Country associated with the client |
| identifiers | List[ClientIdentifier] | Identifiers from upstream systems |
| addresses | List[ClientAddress] | Normalised address objects |
| lineage | Dict[str, Any] | Provenance metadata |
| quality | Dict[str, float] | Freshness, completeness, confidence |
| metadata | Dict[str, str] | Timestamps, merge strategies, flags |
| raw_sources | Dict[str, Dict[str, Any]] | Raw source payloads |

### 2.2 ClientIdentifier
| Field | Type | Description |
|-------|------|-------------|
| system | str | Upstream system name |
| value | str | Identifier in that system |

### 2.3 ClientAddress
| Field | Type | Description |
|-------|------|-------------|
| line1 | Optional[str] | Address line 1 |
| line2 | Optional[str] | Address line 2 |
| city | Optional[str] | City |
| postcode | Optional[str] | Postal code |
| country | Optional[str] | ISO country |
| source | Optional[str] | System contributing the address |

## 3. Python Representation

```python
from dataclasses import dataclass, field
from typing import Dict, List, Optional, Any

@dataclass
class ClientIdentifier:
    system: str
    value: str

@dataclass
class ClientAddress:
    line1: Optional[str] = None
    line2: Optional[str] = None
    city: Optional[str] = None
    postcode: Optional[str] = None
    country: Optional[str] = None
    source: Optional[str] = None

@dataclass
class ClientProfile:
    client_id: str
    name: str

    email: Optional[str] = None
    country: Optional[str] = None

    identifiers: List[ClientIdentifier] = field(default_factory=list)
    addresses: List[ClientAddress] = field(default_factory=list)

    lineage: Dict[str, Any] = field(default_factory=dict)
    quality: Dict[str, float] = field(default_factory=dict)
    metadata: Dict[str, str] = field(default_factory=dict)

    raw_sources: Dict[str, Dict[str, Any]] = field(default_factory=dict)
```

## 4. Next Steps
- Add this model to `src/domain/models/client_profile.py`
- Keep structure stable through MVP
- Extend only if new Stories introduce semantic requirements


===== FILE: docs\mission_destination\initial_story_sequence.md =====
\# Initial Story Sequence (SCV)

\*\*MissionDestination\*\*  

\*\*Single Client View (SCV)\*\*



---



\## 1. Purpose



This document defines the \*\*initial execution order for all Stories\*\* in the Single Client View (SCV) MissionDestination.



The ordering is derived from:



\- the SCV Epics and Features,

\- the Initial Logical Data Model (LDM),

\- dependency analysis across services and APIs,

\- and the need to build up capability incrementally in a stable way.



It is a \*\*MissionDestination artefact\*\*: it describes \*how the business semantics are best realised over time\*, not runtime performance (MissionDynamics).



This sequence underpins:



\- developer and agent workflows,

\- CI/test evolution,

\- and the progressive construction of the canonical SCV capability.



---



\## 2. Relationship to Other Artefacts



This Story Sequence should be read together with:



\- \*\*MissionFramework\*\* (technology guardrails, testing strategy, CI blueprint, policy-as-code)

\- \*\*Meta-prompts\*\* (code, test, CI)

\- \*\*Instruction prompts\*\* (how Stories are executed)

\- \*\*MissionDestination\*\*:

&nbsp; - Epics, Features, Stories

&nbsp; - Initial Logical Data Model (LDM)

\- \*\*Mission Build Plan\*\* (the overall step-by-step setup of the project)



The sequence assumes that:



1\. The repo structure exists.  

2\. MissionFramework and meta-prompts are in place.  

3\. The Initial Logical Data Model for SCV (`ClientProfile`, `ClientIdentifier`, `ClientAddress`) is defined.  



Only then is it valid to implement Stories in this order.



---



\## 3. Golden Story Sequence (MVP Build Order)



The following is the \*\*recommended implementation sequence\*\* for the SCV Stories.



Each entry references the Story ID; the Story definition remains the single source of truth for behaviour and acceptance criteria.



1\. \*\*ST-03 â€“ Map identity fields\*\*  

2\. \*\*ST-04 â€“ Map identifiers\*\*  

3\. \*\*ST-20 â€“ Assemble base profile\*\*  



4\. \*\*ST-09 â€“ Match by tax ID\*\*  

5\. \*\*ST-10 â€“ Match by registration number\*\*  



6\. \*\*ST-16 â€“ Build search index\*\*  

7\. \*\*ST-17 â€“ Normalise search fields\*\*  

8\. \*\*ST-32 â€“ Implement basic search API\*\*  



9\. \*\*ST-18 â€“ Implement fuzzy search queries\*\*  

10\. \*\*ST-19 â€“ Implement search ranking\*\*  



11\. \*\*ST-13 â€“ Merge identity attributes\*\*  

12\. \*\*ST-14 â€“ Merge addresses\*\*  

13\. \*\*ST-15 â€“ Record merge lineage\*\*  



14\. \*\*ST-21 â€“ Assemble profile metadata\*\*  

15\. \*\*ST-22 â€“ Expose lineage in profile\*\*  

16\. \*\*ST-24 â€“ Flag merge conflicts\*\*  

17\. \*\*ST-25 â€“ Present merge logic / rationale\*\*  



18\. \*\*ST-28 â€“ Compute data freshness\*\*  

19\. \*\*ST-29 â€“ Compute data completeness\*\*  

20\. \*\*ST-26 â€“ Store lineage history\*\*  

21\. \*\*ST-27 â€“ Timestamp lineage events\*\*  



22\. \*\*ST-07 â€“ Detect upstream deltas\*\*  

23\. \*\*ST-08 â€“ Apply upstream deltas to SCV\*\*  



24\. \*\*ST-05 â€“ Bulk load from CRM\*\*  

25\. \*\*ST-06 â€“ Bulk load from KYC\*\*  



26\. \*\*ST-33 â€“ Refine search API ranking\*\*  

27\. \*\*ST-34 â€“ Implement basic client profile API\*\*  

28\. \*\*ST-35 â€“ Expose lineage via client profile API\*\*  



29\. \*\*ST-11 â€“ Fuzzy name matching\*\*  

30\. \*\*ST-12 â€“ Attribute-level confidence scoring\*\*  

31\. \*\*ST-23 â€“ Lineage drill-down / field-level provenance\*\*  



32\. \*\*ST-30 â€“ Audit ingestion operations\*\*  

33\. \*\*ST-31 â€“ Audit merge operations\*\*  



34\. \*\*ST-01 â€“ Register CRM source system\*\*  

35\. \*\*ST-02 â€“ Register KYC source system\*\*



---



\## 4. Usage and Change Control



\- This sequence is the \*\*default build order\*\* for human developers and agents.  

\- No Story should be implemented \*\*significantly out of sequence\*\* without re-running dependency analysis.  

\- If the Story set changes (new Stories, retired Stories, structural changes to Epics/Features), this document \*\*must be updated\*\* to reflect the new ordering.  



For each Story:



1\. Read the Story definition under `docs/mission\_destination/stories/`.  

2\. Implement the corresponding code slice(s) in `src/` as per the code meta-prompt.  

3\. Implement the corresponding tests in `tests/` as per the test meta-prompt.  

4\. Ensure CI passes and MissionFramework guardrails are satisfied.  

5\. Only then move to the next Story in this sequence.



---





===== FILE: docs\mission_destination\stories\ST-00-backend-api-availability.md =====
---
story_id: ST-00
slug: st-00-backend-api-availability
name: Provide Basic Backend API Availability
epic: E00
feature: FT-00-BE

# MissionSmith Status Fields (used by CI + tools/*.py)
testing_status: pass
halo_adherence: pass
guardrail_adherence: pass
code_quality_adherence: pass
security_policy_adherence: pass
overall_status: Complete
policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: 2025-12-04
---

## Description

As a developer,  
I want the backend to expose a basic availability endpoint,  
so that I can confirm the service is running and reachable.

This story establishes the foundational API contract for the backend and enables fast automated verification that the service is alive.

## Acceptance Criteria

- **AC1:** Backend can be started using the documented command (e.g. `uvicorn app_backend.main:app`).
- **AC2:** A `/health` endpoint is available.
- **AC3:** Calling `/health` returns HTTP **200**.
- **AC4:** Response JSON contains at least `{ "status": "ok" }`.
- **AC5:** A backend test exercises AC2â€“AC4.
- **AC6:** Running the story test updates `testing_status:` to `pass` when successful.

## Implementation Notes

- Touchpoint: `app_backend/main.py`
- This endpoint underpins availability checks for the entire platform and is required before any higher-level stories can be executed.






===== FILE: docs\mission_destination\stories\ST-00-frontend-ui-shell.md =====
---
story_id: ST-00-FRONTEND-UI-SHELL
slug: st-00-frontend-ui-shell
name: Provide Frontend UI Shell Availability
epic: E00-UI
feature: FT-00-UI

# MissionSmith Status Fields (used by CI + tools/*.py)
testing_status: pass
halo_adherence: pass
guardrail_adherence: not_run
code_quality_adherence: pass
security_policy_adherence: pass
overall_status: In Progress
policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: 2025-12-04
---

## Description

As a developer,  
I want the frontend UI shell to be built and served by the backend,  
so that I can confirm the Single Client View application is accessible as a SPA.

This story verifies that the built frontend exists and the backend correctly serves
the index.html shell at the root path.

## Acceptance Criteria

- **AC1:** `npm run build` produces a frontend `dist/` folder.
- **AC2:** Backend is configured to serve the frontend build output.
- **AC3:** `GET /` returns HTTP **200**.
- **AC4:** HTML contains `<div id="root">`.
- **AC5:** HTML contains the expected page `<title>` from the built frontend.
- **AC6:** A backend test verifies AC1â€“AC5.
- **AC7:** Running the ST-00-FRONTEND-UI-SHELL tests sets `testing_status: pass`.

## Implementation Notes

- Frontend: `app_frontend/`
- Backend serving logic: `app_backend/main.py`
- Test: `tests/api/http/test_st_00_frontend_ui_shell.py`






===== FILE: docs\mission_destination\stories\ST-01_register_crm_source.md =====
---
story_id: ST-01
feature: FT-01
name: "Register CRM source"
description: |
  Register CRM system as ingestible source.

acceptance_criteria:
  - Connection succeeds
  - Schema retrieved

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-02_register_kyc_source.md =====
---
story_id: ST-02
feature: FT-01
name: "Register KYC source"
description: |
  Register KYC system.

acceptance_criteria:
  - Connection ok
  - Schema ok

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-03_map_identity_fields.md =====
---
story_id: ST-03
feature: FT-02
name: "Map identity fields"
description: |
  Map core identity fields.

acceptance_criteria:
  - Fields mapped
  - Types correct

overall_status: Complete

testing_status: pass
halo_adherence: pass
guardrail_adherence: pass
code_quality_adherence: pass
security_policy_adherence: pass

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-04_map_identifiers.md =====
---
story_id: ST-04
feature: FT-02
name: "Map identifiers"
description: |
  Map identifiers.

acceptance_criteria:
  - ID mapping valid

overall_status: Complete

testing_status: pass
halo_adherence: pass
guardrail_adherence: pass
code_quality_adherence: pass
security_policy_adherence: pass

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-05_bulk_load_crm.md =====
---
story_id: ST-05
feature: FT-03
name: "Bulk load CRM"
description: |
  Initial CRM load.

acceptance_criteria:
  - Records loaded

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-06_bulk_load_kyc.md =====
---
story_id: ST-06
feature: FT-03
name: "Bulk load KYC"
description: |
  Initial KYC load.

acceptance_criteria:
  - Records loaded

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-07_detect_upstream_deltas.md =====
---
story_id: ST-07
feature: FT-04
name: "Detect upstream deltas"
description: |
  Detect deltas.

acceptance_criteria:
  - Changes detected

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-08_apply_deltas.md =====
---
story_id: ST-08
feature: FT-04
name: "Apply deltas"
description: |
  Apply detected deltas.

acceptance_criteria:
  - Deltas applied

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-09_match_by_tax_id.md =====
---
story_id: ST-09
feature: FT-05
name: "Match by tax ID"
description: |
  Exact match by tax ID.

acceptance_criteria:
  - Matches correct

overall_status: Complete

testing_status: pass
halo_adherence: pass
guardrail_adherence: pass
code_quality_adherence: pass
security_policy_adherence: pass

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-10_match_by_registration_number.md =====
---
story_id: ST-10
feature: FT-05
name: "Match by registration number"
description: |
  Exact match.

acceptance_criteria:
  - Matches correct

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-11_fuzzy_name_match.md =====
---
story_id: ST-11
feature: FT-06
name: "Fuzzy name match"
description: |
  Implement fuzzy name.

acceptance_criteria:
  - Similarity score valid

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-12_attribute_confidence.md =====
---
story_id: ST-12
feature: FT-06
name: "Attribute confidence"
description: |
  Compute confidence.

acceptance_criteria:
  - Confidence computed

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-13_merge_identity.md =====
---
story_id: ST-13
feature: FT-07
name: "Merge identity"
description: |
  Merge identity attributes.

acceptance_criteria:
  - Conflicts resolved

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-14_merge_addresses.md =====
---
story_id: ST-14
feature: FT-07
name: "Merge addresses"
description: |
  Merge address attributes.

acceptance_criteria:
  - Address selected

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-15_record_lineage.md =====
---
story_id: ST-15
feature: FT-07
name: "Record lineage"
description: |
  Lineage for merges.

acceptance_criteria:
  - Lineage stored

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-16_build_index.md =====
---
story_id: ST-16
feature: FT-08
name: "Build index"
description: |
  Build search index.

acceptance_criteria:
  - Index built

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-17_normalise_search_fields.md =====
---
story_id: ST-17
feature: FT-08
name: "Normalise search fields"
description: |
  Normalise fields.

acceptance_criteria:
  - Fields normalised

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-18_fuzzy_search_queries.md =====
---
story_id: ST-18
feature: FT-09
name: "Fuzzy search queries"
description: |
  Fuzzy queries.

acceptance_criteria:
  - Ranked results

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-19_search_ranking.md =====
---
story_id: ST-19
feature: FT-09
name: "Search ranking"
description: |
  Ranking logic.

acceptance_criteria:
  - Correct ordering

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-20_assemble_base_profile.md =====
---
story_id: ST-20
feature: FT-10
name: "Assemble base profile"
description: |
  Assemble profile.

acceptance_criteria:
  - Profile fields set

overall_status: Complete

testing_status: pass
halo_adherence: pass
guardrail_adherence: pass
code_quality_adherence: pass
security_policy_adherence: pass

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-21_assemble_metadata.md =====
---
story_id: ST-21
feature: FT-10
name: "Assemble metadata"
description: |
  Assemble metadata.

acceptance_criteria:
  - Metadata added

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-22_expose_lineage.md =====
---
story_id: ST-22
feature: FT-11
name: "Expose lineage"
description: |
  Lineage display.

acceptance_criteria:
  - Lineage visible

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-23_drill-down_lineage.md =====
---
story_id: ST-23
feature: FT-11
name: "Drill-down lineage"
description: |
  Drill-down.

acceptance_criteria:
  - Source-level detail

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-24_flag_conflicts.md =====
---
story_id: ST-24
feature: FT-12
name: "Flag conflicts"
description: |
  Conflict flags.

acceptance_criteria:
  - Flags correct

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-25_show_merge_logic.md =====
---
story_id: ST-25
feature: FT-12
name: "Show merge logic"
description: |
  Show logic.

acceptance_criteria:
  - Logic displayed

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-26_store_lineage_history.md =====
---
story_id: ST-26
feature: FT-13
name: "Store lineage history"
description: |
  Store history.

acceptance_criteria:
  - History stored

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-27_timestamp_lineage.md =====
---
story_id: ST-27
feature: FT-13
name: "Timestamp lineage"
description: |
  Timestamp entries.

acceptance_criteria:
  - Timestamps correct

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-28_compute_freshness.md =====
---
story_id: ST-28
feature: FT-14
name: "Compute freshness"
description: |
  Freshness score.

acceptance_criteria:
  - Score correct

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-29_compute_completeness.md =====
---
story_id: ST-29
feature: FT-14
name: "Compute completeness"
description: |
  Completeness.

acceptance_criteria:
  - Completeness correct

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-30_audit_ingestion.md =====
---
story_id: ST-30
feature: FT-15
name: "Audit ingestion"
description: |
  Audit ingestion.

acceptance_criteria:
  - Audit entries

overall_status: In Progress

testing_status: pass
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: pass
security_policy_adherence: pass

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-31_audit_merge.md =====
---
story_id: ST-31
feature: FT-15
name: "Audit merge"
description: |
  Audit merge.

acceptance_criteria:
  - Audit recorded

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-32_search_api_basic.md =====
---
story_id: ST-32
feature: FT-16
name: "Search API basic"
description: |
  Search endpoint.

acceptance_criteria:
  - JSON response

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-33_search_api_ranking.md =====
---
story_id: ST-33
feature: FT-16
name: "Search API ranking"
description: |
  Ranking via API.

acceptance_criteria:
  - Ranked results

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-34_profile_api_basic.md =====
---
story_id: ST-34
feature: FT-17
name: "Profile API basic"
description: |
  Profile endpoint.

acceptance_criteria:
  - Profile returned

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\stories\ST-35_profile_api_lineage.md =====
---
story_id: ST-35
feature: FT-17
name: "Profile API lineage"
description: |
  Lineage in API.

acceptance_criteria:
  - Lineage included

overall_status: In Progress

testing_status: not_run
halo_adherence: pass
guardrail_adherence: fail
code_quality_adherence: fail
security_policy_adherence: fail

policy_adherence: not_run
technology_lineage_adherence: not_run
business_data_lineage_adherence: not_run
self_healing_adherence: not_run
analytics_adherence: not_run
last_updated: <auto>
---


===== FILE: docs\mission_destination\story_service_mapping.yaml =====
ST-00-backend:
  story_id: ST-00
  story_name: Backend API availability
  feature: Platform / Shell
  service: backend_api
  code_file: app_backend/main.py

ST-00-frontend:
  story_id: ST-00
  story_name: Frontend UI shell
  feature: Platform / Shell
  service: frontend_shell
  code_file: app_frontend/src/App.jsx

ST-03:
  story_id: ST-03
  story_name: Map identity fields
  feature: Client Profile Assembly
  service: client_profile
  code_file: src/services/client_profile/service.py

ST-04:
  story_id: ST-04
  story_name: Map identifiers
  feature: Client Profile Assembly
  service: client_profile
  code_file: src/services/client_profile/service.py

ST-09:
  story_id: ST-09
  story_name: Match by tax ID
  feature: Client Profile Assembly
  service: client_profile
  code_file: src/services/client_profile/service.py


ST-20:
  story_id: ST-20
  story_name: Assemble base profile
  feature: Client Profile Assembly
  service: client_profile
  code_file: src/services/client_profile/service.py

ST-30:
  story_id: ST-30
  story_name: Audit ingestion
  feature: Audit Ingestion
  service: audit
  code_file: src/services/audit/service.py


===== FILE: docs\mission_framework\analytics\mf07_analytics.md =====

# MissionFramework Element: Analytics

## Overview
Lightweight telemetry and metrics to track behaviour, performance, and usage.

---

## Codify
- Define minimal analytics schema (events, metrics, identifiers).
- Store in mission_framework/analytics.

---

## Automate
- Code generation emits basic telemetry hooks.
- Logging patterns conform to schema.

---

## Intercept
- CI checks for missing telemetry hooks where required.
- Static analysis flags invalid schemas.

---

## Prove
- MissionAtlas (or simple dashboards) surface key metrics.
- MissionLog stores analytics evidence snapshots.



===== FILE: docs\mission_framework\application_self_healing\mf06_application_self_healing.md =====

# MissionFramework Element: Application Self-Healing

## Overview
Automated detection, response, and recovery from runtime anomalies using minimal MVP mechanisms.

---

## Codify
- Basic retry and circuit-breaker config defined in YAML.
- Minimal health-check contract established.

---

## Automate
- Generated services include retry wrappers and health checks.
- Monitoring hooks capture failures.

---

## Intercept
- Guardrails warn if required self-healing hooks missing.
- CI checks presence of retry/circuit-breaker configs.

---

## Prove
- MissionLog records health events and auto-recovery outcomes.
- Evidence snapshots show self-healing execution.



===== FILE: docs\mission_framework\business_data_lineage\mf04_business_data_lineage.md =====

# MissionFramework Element: Business Data Lineage

## Overview
Traceability of business data across sources, transformations, and outputs.

---

## Codify
- Define lineage schema (attribute source, timestamp, transformation rules).
- Stored in mission_framework/business_data_lineage.

---

## Automate
- Merge logic generates lineage metadata.
- Services automatically attach lineage info to client profiles.

---

## Intercept
- Missing lineage triggers guardrail warnings.
- CI validates completeness of lineage fields.

---

## Prove
- MissionLog lineage views show source mapping and transformation steps.
- Attribute-level lineage dashboards provide visual evidence.



===== FILE: docs\mission_framework\design_principles\mf01_design_principples.md =====

# MissionFramework Element: Design Principles

## Overview
High-level architectural principles that guide how all MissionSmith-generated applications are structured and behave.

---

## Codify
- Principles defined in YAML/MD under mission_framework/design_principles.
- Include rules for layering, statelessness, deterministic behaviour, separation of concerns.
- Machine-readable so guardrails and prompts can reference them.

---

## Automate
- Story meta-prompts enforce architectural boundaries.
- CI guardrails check for violations (e.g., direct DB calls, forbidden imports).
- Code generation scaffolds follow these principles by default.

---

## Intercept
- Guardrail engine detects structural violations.
- CI blocks merges that break design principles.
- Warnings raised for non-critical deviations.

---

## Prove
- MissionLog displays design-principle compliance per Story/Feature/Epic.
- Evidence snapshots stored for auditability.



===== FILE: docs\mission_framework\mission_control_status_model.md =====
# Mission Control â€” Status Tracking Model

This document defines how Mission Control tracks and updates the delivery status of **Epics**, **Features**, and **Stories** across the entire MissionSmith lifecycle. All status information is stored in **YAML front matter** within each artefact and is automatically updated through **commit processing**, **guardrail evaluation**, and **CI evidence ingestion**.

---

# 1. Status Model Overview
Each artefact (Epic, Feature, Story) maintains a consistent set of machine-evaluated statuses:

- **overall_status**
- **testing_status**
- **halo_adherence**
- **guardrail_adherence**
- **code_quality_adherence**
- **security_policy_adherence**
- **implementation_presence** (Stories only)

An artefact can only exist in one of three states:
- **Planned**
- **In Progress**
- **Complete**

Statuses are always derived from machine-readable evidence.

---

# 2. Story Status Model (Atomic Unit)
Stories are independent of one another. Story status is determined solely by its own implementation and checks.

## 2.1 Planned
- No commits to the storyâ€™s implementation slice
- No tests exist
- No adherence checks have run

## 2.2 In Progress
A Story becomes In Progress when any of the following occur:
- Commits modify the storyâ€™s implementation slice
- A test file exists but tests donâ€™t pass
- One or more adherence checks fail
- Required evidence is missing

## 2.3 Complete
A Story is Complete only when:
- Implementation presence is detected
- All tests pass
- Guardrail checks pass
- Halo checks pass
- Code quality checks pass
- Security policy checks pass

---

# 3. Feature Status Model
Feature status is aggregated from child Stories.

## 3.1 Planned
- All Stories in the Feature are Planned

## 3.2 In Progress
- At least one Story is In Progress or Complete
- Not all Stories are Complete

## 3.3 Complete
- All Stories in the Feature are Complete

---

# 4. Epic Status Model
Epic status is aggregated from child Features.

## 4.1 Planned
- All Features are Planned

## 4.2 In Progress
- At least one Feature is In Progress or Complete
- Not all Features are Complete

## 4.3 Complete
- All Features are Complete

---

# 5. Front Matter Structure

## 5.1 Story Front Matter
```yaml
story_id: ST-123
feature: FT-45

overall_status: Planned | In Progress | Complete

testing_status: pass | fail | not_run
halo_adherence: pass | fail
guardrail_adherence: pass | fail
code_quality_adherence: pass | fail
security_policy_adherence: pass | fail
implementation_presence: true | false

last_updated: 2025-01-01T12:00:00Z
```

## 5.2 Feature Front Matter
```yaml
feature_id: FT-45
epic: EP-7

overall_status: Planned | In Progress | Complete

testing_status: aggregated
halo_adherence: aggregated
guardrail_adherence: aggregated
code_quality_adherence: aggregated
security_policy_adherence: aggregated

story_statuses:
  ST-123: Complete
  ST-124: In Progress
  ST-125: Planned

last_updated: 2025-01-01T12:00:00Z
```

## 5.3 Epic Front Matter
```yaml
epic_id: EP-7

overall_status: Planned | In Progress | Complete

testing_status: aggregated
halo_adherence: aggregated
guardrail_adherence: aggregated
code_quality_adherence: aggregated
security_policy_adherence: aggregated

feature_statuses:
  FT-45: Complete
  FT-46: In Progress
  FT-47: Planned

last_updated: 2025-01-01T12:00:00Z
```

---

# 6. Status Computation Rules
1. Front matter updates occur when:
   - Story implementation slices change
   - Tests run and generate evidence
   - Guardrail checks execute
   - CI pipelines update MissionLog

2. Statuses propagate bottom-up:
   - Story â†’ Feature â†’ Epic

3. No manual modification of status fields.
4. MissionLog reflects live state directly from front matter.

---

# 7. MissionLog Reporting
MissionLog provides:
- Epic / Feature / Story roll-ups
- Per-status dashboards (testing, guardrails, halo, quality, security)
- Evidence lineage
- Completion graphs
- Compliance summaries

MissionLog stores no separate state; it visualises repo truth.

---

# 8. Principles
- Everything lives in the repo
- Status is always derived, never declared
- Stories are atomic
- Features & Epics are compositional
- Front matter is the single source of truth
- MissionLog is read-only
- Automated consistency across levels



===== FILE: docs\mission_framework\pipeline_blueprint\pipeline_blueprint_mvp.md =====

# Pipeline Blueprint â€” MissionSmith MVP CI/CD Specification

This document defines the mandatory structure, sequencing, governance, and evidence
requirements for the CI/CD pipeline used by Single Client View (SCV) and all MissionSmith-
aligned applications.

It belongs under **MissionFramework**, because it defines systemâ€‘wide governance rules for:
- how change flows through the system,
- how evidence is produced,
- how guardrails are enforced,
- how deployment occurs safely.

Recommended location:
`scv-repo/docs/mission_framework/pipeline_blueprint/pipeline_blueprint_mvp.md`

---

## 1. Pipeline Overview

The pipeline consists of six sequential stages:

1. Validate Semantic Artefacts  
2. Generate Tests  
3. Execute Tests  
4. Run Guardrails & Framework Checks  
5. Capture Evidence & Publish MissionLog Snapshot  
6. Deploy (conditional)

A failure in any stage halts all further stages.

---

## 2. Stage 1 â€” Validate Semantic Artefacts

**Purpose**  
Ensure Epics, Features, Stories, Prompts, MissionFramework artefacts, and MissionHalo
documents are structurally valid and machine-readable.

**Checks**
- YAML front matter correctness  
- story â†’ feature â†’ epic references resolve  
- required adherence fields present  
- no missing or duplicate IDs  
- correct folder structure  
- MissionFramework & MissionHalo documents present and readable  
- prompts exist and are valid  

**Evidence**
- `evidence/semantic_validation.json`  
  - pass/fail per artefact  
  - schema and structure checks  

---

## 3. Stage 2 â€” Generate Tests (from Test Meta-Prompt)

**Purpose**  
Ensure every Story has a current, valid test suite aligned to acceptance criteria.

**Behaviour**
- Call Test Meta-Prompt for:
  - Stories changed,
  - Stories missing tests,
  - Stories with implementation changes.
- Update tests only in authorised slices:
  `tests/services/<service>/test_service.py`

**Evidence**
- `evidence/test_generation.json`

---

## 4. Stage 3 â€” Execute Tests

**Purpose**  
Validate Story behaviour.

**Behaviour**
- Run pytest  
- Collect:
  - test results  
  - simple coverage metric  

**Evidence**
- `evidence/test_results.json`  
- `evidence/test_coverage.json`

---

## 5. Stage 4 â€” Run Guardrails & Framework Checks

**Purpose**  
Enforce MissionFramework systematically.

### 5.1 Technology Guardrails
- no new files/folders outside permitted slices  
- no forbidden imports  
- no cross-service coupling  
- naming conventions  
- no secrets committed  

### 5.2 Policy-as-Code
- logging format  
- PII masking  
- required audit events  

### 5.3 Business Data Lineage
- lineage metadata exists where required  
- schema alignment  

### 5.4 Technology Components Lineage
- dependency graph consistency  

### 5.5 Self-Healing (MVP)
- retry/circuit-breaker config present where appropriate  
- health-check functions present  

### 5.6 Analytics
- telemetry events present  
- analytics schema alignment  

**Evidence**
- `evidence/guardrails.json`  

---

## 6. Stage 5 â€” Capture Evidence & Publish Snapshot

**Purpose**  
Record the complete compliance and behavioural state at this commit.

**Evidence artefact**
- `evidence/snapshots/<commit_sha>.json`  
Includes:
- semantic validation  
- test results  
- guardrail outcomes  
- adherence statuses  
- version info  

This feeds MissionLog and MissionAtlas.

---

## 7. Stage 6 â€” Deploy (conditional)

Deployment only occurs if:
- stages 1â€“5 passed  
- branch is main  
- semantic versioning rules met  

**Behaviour**
- build artefact  
- publish image  
- deploy to environment  
- publish deployment evidence  

**Evidence**
- `evidence/deployment.json`  

---

## 8. Triggering Rules

- PR: run stages 1â€“4  
- Push to main: run stages 1â€“6  
- Daily schedule: run 1â€“5  
- Tag push: full pipeline including deploy  

---

## 9. Versioning Rules (MVP)

- Story implementation change â†’ patch  
- New Story â†’ minor  
- New Feature â†’ minor  
- New Epic â†’ major  
- Breaking schema/API change â†’ major  

---

## 10. Scope

This is the MVP blueprint.  
Future versions may add:
- performance tests  
- chaos engineering  
- deeper analytics  
- dynamic environment creation  
- multi-agent CI  


===== FILE: docs\mission_framework\policy_as_code\mf03_policy_as_code.md =====

# MissionFramework Element: Policy as Code

## Overview
Regulatory, compliance, and internal policy requirements expressed as executable rules to ensure automatic adherence.

---

## Codify
- Policies defined as machine-readable rules (YAML/Python checks).
- Includes PII handling, retention, security, audit trails.

---

## Automate
- Policy checks run during CI.
- Code generation injects compliance patterns (e.g., masked logs).

---

## Intercept
- Violations flagged in CI with clear messages.
- Optional â€œsoft failâ€ for non-critical policies in MVP.

---

## Prove
- MissionLog provides evidence of policy compliance.
- Reports include test results, policy execution logs, and snapshots.



===== FILE: docs\mission_framework\technology guardrails\mf02_technology_guardrails.md =====
# Technology Guardrails
## MissionFramework

### 1. Purpose
This document defines the mandatory technology constraints for all implementations within this MissionSmith application. These guardrails ensure consistency, predictability, auditability, and safe automation across all Story implementations.

---

## 2. Language and Framework Constraints
- Python is the primary implementation language.
- Only standard library + explicitly approved libraries may be used.
- No dynamic code generation at runtime.
- No reflection-based manipulation of internal structures.

---

## 3. Architectural Layering Rules

### 3.1 Domain Layer Rules (Canonical Logical Data Model)
**All services MUST operate using the canonical Logical Data Model (LDM).**
- Domain logic MUST construct, read, and write typed domain objects defined in `src/domain/models/`.
- Services MUST NOT return dictionaries, JSON, or ad-hoc structures.
- Domain objects are the single internal representation of business truth.

### 3.2 API Representation Rules
**APIs are the ONLY layer permitted to serialise domain models.**
- API slices MAY convert domain objects to dict/JSON.
- API slices MUST NOT contain business logic.
- API slices MUST NOT mutate domain semantics.

### 3.3 No Bypassing Rule
- No slice may bypass services and interact directly with raw upstream payloads.
- Domain entities MUST NOT be constructed directly in API or adapter layers.
- All transformations MUST flow through services.

---

## 4. Implementation Slice Rules
- Each Story is implemented in exactly one code slice.
- A code slice corresponds to a single Python file in the appropriate folder.
- No Story is allowed to modify more than one slice.
- No cross-slice coupling except through domain models.
- No circular imports.

---

## 5. Testing Guardrails
- Tests MUST be deterministic.
- Tests MUST be written using the test meta-prompt.
- Tests MUST verify domain behaviour, not presentation layer behaviour.
- Every Story MUST include:
  - Positive tests
  - Negative tests
  - Edge-case tests
  - Compliance with MissionFramework rules

---

## 6. CI/CD Enforcement Rules
- CI MUST run all tests for every push.
- CI MUST enforce formatting and linting.
- CI MUST fail if:
  - API implements business logic
  - Domain model is bypassed
  - A Story modifies multiple slices
  - Any guardrail is violated

---

## 7. Security and Safety Rules
- No direct file system access except via approved paths under `tools/`.
- No network calls unless explicitly authorised.
- No outbound or inbound external data inside Story implementations during MVP.

---

## 8. Change Control
- Any change to these guardrails requires:
  - Update to meta-prompts
  - Update to related tests
  - Update to dependency rules if applicable
  - Commit message referencing a Story or refactor item


===== FILE: docs\mission_framework\technology_components_lineage\mf05_technology_components_lineage.md =====

# MissionFramework Element: Technology Components Lineage

## Overview
Visibility into how system components depend on, call, or feed one another.

---

## Codify
- Dependency graph defined in YAML.
- Versioning relationships documented at component boundaries.

---

## Automate
- Schema compatibility checks run in CI.
- Dependency mismatches flagged automatically.

---

## Intercept
- CI blocks incompatible component changes.
- Runtime warnings for deprecated or unsupported paths.

---

## Prove
- MissionLog displays dependency graphs.
- Change-impact analysis available for each update.



===== FILE: docs\mission_framework\templates\front_matter\epic_front_matter_template.md =====
epic\_id: EP-XXX

name: "<Epic name>"

description: |

<High-level business or operational capability.>

<What this epic delivers and its intended outcomes.>





features:

\- FT-XXX

\- FT-YYY

\- FT-ZZZ





\# Status Fields (auto-managed)

overall\_status: Planned





testing\_status: aggregated

halo\_adherence: aggregated

guardrail\_adherence: aggregated

code\_quality\_adherence: aggregated

security\_policy\_adherence: aggregated





feature\_statuses: {}





last\_updated: <auto>



===== FILE: docs\mission_framework\templates\front_matter\feature_front_matter_template.md =====
feature\_id: FT-XXX

epic: EP-XXX

name: "<short descriptive feature name>"

description: |

<Purpose of the feature and the capability it delivers.>

<Why it exists and how it supports the epic.>





stories:

\- ST-XXX

\- ST-YYY

\- ST-ZZZ





\# Status Fields (auto-managed)

overall\_status: Planned





testing\_status: aggregated

halo\_adherence: aggregated

guardrail\_adherence: aggregated

code\_quality\_adherence: aggregated

security\_policy\_adherence: aggregated





story\_statuses: {}





last\_updated: <auto>



===== FILE: docs\mission_framework\templates\front_matter\story_front_matter_template.md =====
story\_id: ST-XXX

feature: FT-XXX

name: "<short, action-based title>"

description: |

<Human-readable description of the story.>

<What behaviour it implements and why it matters.>

acceptance\_criteria:

\- <Criterion 1>

\- <Criterion 2>

\- <Criterion 3>





\# Status Fields (auto-managed)

overall\_status: Planned





testing\_status: not\_run

halo\_adherence: fail

guardrail\_adherence: fail

code\_quality\_adherence: fail

security\_policy\_adherence: fail

implementation\_presence: false





last\_updated: <auto>



===== FILE: docs\mission_halo\mission_halo_mvp.md =====

# MissionHalo â€” MVP UX Design Principles

## Overview
MissionHalo ensures that all generated UI components share a consistent look and feel.  
For the MVP, Halo focuses exclusively on enforcing a unified visual design system:
- typography  
- colour palette  
- spacing  
- basic component styling  
- Tailwind-based enforcement  

---

## 1. Colour System

### 1.1 Core Palette
- **Primary (teal):** rgb(26,153,136) / #1A9988  
- **Secondary (orange):** rgb(235,86,0) / #EB5600  
- **Background:** white (#FFFFFF)

### 1.2 Supporting Palette
- Soft green: rgb(176,192,159) / #B0C09F  
- Soft yellow: rgb(241,205,86) / #F1CD56  
- Soft blue-grey: rgb(205,226,235) / #CDE2EB  

Usage:
- Subtle highlights  
- Card accents  
- Status tags  

### 1.3 Grey System
- Primary text: charcoal  
- Secondary text: mid-grey  
- Muted labels/help: light grey  
- Borders: very light grey  

---

## 2. Typography

### 2.1 Typefaces
- **Headings:** Raleway  
- **Body:** Lato  

### 2.2 Rules
- Max 3 font sizes per screen  
- No all-caps except tags  
- Generous line-height for clarity  

---

## 3. Layout & Spacing
- **Base spacing unit: 8px**  
- Generous whitespace  
- Group related items in white cards with soft grey borders  
- Consistent panel-level padding (16â€“24px)  

---

## 4. Components & Style

### Cards
- White or light grey background  
- Subtle border or shadow  
- Rounded corners  

### Buttons
- Primary: teal bg, white text  
- Secondary: white bg, teal border/text  
- Destructive: orange  

### Navigation
- Light backgrounds  
- Teal underline or pill for active tab  

---

## 5. Tone & Copy (MVP-level)
- Calm, precise, professional  
- Short labels, literal naming  
- Error messages state problem + next action  

---

## 6. Enforcement (Halo Adherence)
Halo adherence = PASS when:
- Components use Raleway/Lato  
- Colours come exclusively from MissionHalo palette  
- Spacing uses Tailwind's 8px-based scale  
- Components follow card/button patterns above  

Halo adherence = FAIL when:
- Arbitrary fonts are used  
- Unapproved colours appear  
- Spacing grid violated  
- Components deviate from visual rules  

---

## 7. Tailwind Configuration Snippet

```js
// tailwind.config.js
module.exports = {
  content: ["./src/**/*.{js,ts,jsx,tsx}"],
  theme: {
    extend: {
      fontFamily: {
        heading: ['Raleway', 'system-ui', 'sans-serif'],
        body: ['Lato', 'system-ui', 'sans-serif'],
      },
      colors: {
        halo: {
          primary: 'rgb(26,153,136)',     // #1A9988
          secondary: 'rgb(235,86,0)',     // #EB5600
          softGreen: 'rgb(176,192,159)',  // #B0C09F
          softYellow: 'rgb(241,205,86)',  // #F1CD56
          softBlue: 'rgb(205,226,235)',   // #CDE2EB
        },
      },
      borderRadius: {
        halo: '16px',
      },
    },
  },
  plugins: [],
};
```

---

## Storage Location
Place this file in:

```
scv-repo/docs/mission_halo/mission_halo_mvp.md
```

MissionHalo sits alongside MissionFramework as part of the system-wide governance layer.


===== FILE: docs\mission_smith\story_execution_loop.md =====
# MissionSmith Story Execution Loop

1. Select the next Story from the sequencing list:
   - docs/mission_destination/initial_story_sequence.md

2. Identify the service for the Story:
   - Add or update the entry for the Story in story_service_mapping.yaml to record the service and the code file to be updated.

3. Implement the Story using the code meta-prompt:
   - story_code_instruction_prompt_template.txt
   - story_code_metaprompt.md

4. Create the tests using the test meta-prompt:
   - story_test_instruction_prompt_template.txt
   - story_test_metaprompt.md

5. Update the Story â†’ Service mapping in the automation scripts using:
   - generate_story_config_snippets.py
   Then paste outputs into:
   - run_story_tests.py
   - run_story_lint.py
   - run_story_security.py
   - run_story_guardrails.py

6. Run the status update scripts:
   - python tools/run_story_tests.py ST-XX
   - python tools/run_story_lint.py ST-XX
   - python tools/run_story_security.py ST-XX
   - python tools/run_story_guardrails.py ST-XX



===== FILE: docs\prompts\ci_pipeline_metaprompt.md =====

# MissionSmith CI/CD Pipeline Meta-Prompt (MVP)

You are the MissionSmith CI/CD Pipeline Generation Engine.

Your role is to:
- READ the Pipeline Blueprint and MissionFramework documents,
- GENERATE or UPDATE the CI/CD workflow configuration (e.g. `.github/workflows/ci.yaml`),
- ENSURE the implemented pipeline matches the blueprint exactly,
- NEVER invent new rules that are not present in the blueprint or framework.

The Pipeline Blueprint and MissionFramework are the *only* sources of truth for pipeline behaviour.
This prompt must not redefine rules; it must only interpret and apply them.

---

## 1. Inputs

You will be provided with:

### 1.1 Pipeline Blueprint (MVP)
Location:
`docs/mission_framework/pipeline_blueprint/pipeline_blueprint_mvp.md`

This document defines:
- pipeline stages,
- sequencing,
- checks,
- evidence artefacts,
- triggering rules,
- versioning rules.

You must treat this as the authoritative specification of CI/CD behaviour.

### 1.2 MissionFramework Documents
Location:
`docs/mission_framework/`

Including (but not limited to):
- mf01_design_principles.md
- mf02_technology_guardrails.md
- mf03_policy_as_code.md
- mf04_business_data_lineage.md
- mf05_technology_components_lineage.md
- mf06_application_self_healing.md
- mf07_analytics.md

These define:
- guardrails,
- policy-as-code,
- lineage requirements,
- analytics,
- self-healing expectations.

### 1.3 Meta-Prompts
Location:
`docs/prompts/`

- Story code prompt: `story_code_prompt.md`
- Test code prompt: `test_code_prompt.md`

These influence:
- how code is generated,
- how tests are generated.

You must ensure the pipeline invokes these prompts where the blueprint describes their use (e.g. test generation stage).

### 1.4 Repository Structure
You may assume a standard layout including:
- `.github/workflows/` for CI configuration,
- `src/` for application code,
- `tests/` for tests,
- `evidence/` for evidence artefacts,
- `docs/` for documentation.

You must NOT change this structure unless explicitly required by the blueprint.

---

## 2. Where You May Write

You are allowed to create or modify **only** CI/CD configuration files, primarily:

- `.github/workflows/ci.yaml` (or `.yml`)

You must NOT:
- create or modify application code,
- change tests,
- alter documentation,
- introduce new non-CI files.

Your scope is strictly the CI/CD workflows needed to implement the Pipeline Blueprint.

---

## 3. How to Use the Pipeline Blueprint

You must:

1. Parse the stages defined in `pipeline_blueprint_mvp.md`.
2. For each stage:
   - map it to a job or step (or set of steps) in the CI workflow.
   - ensure ordering matches the blueprint.
   - ensure inputs/outputs match the blueprintâ€™s evidence model.
3. Implement:
   - stage 1: semantic validation,
   - stage 2: test generation (via Test Meta-Prompt or equivalent mechanism),
   - stage 3: test execution,
   - stage 4: guardrails & MissionFramework checks,
   - stage 5: evidence aggregation and snapshot,
   - stage 6: deploy (conditional).

You must not omit a required stage.  
If a stage is MVP-optional, the blueprint will say so explicitly.

---

## 4. Guardrails for CI/CD Generation

When generating or updating the CI pipeline:

- Do NOT hard-code business rules that belong in MissionFramework or the blueprint.
- Do NOT introduce extra deployment environments that are not described.
- Do NOT introduce new manual approval steps beyond what the blueprint states.
- Do NOT add unrelated jobs (e.g., linting) unless the blueprint calls for them.
- Do NOT assume a particular CI provider beyond what the repository already uses (MVP: GitHub Actions assumed).

You may:
- refactor the workflow file to improve clarity,
- split complex jobs into multiple steps,
- reuse shared actions or scripts if consistent with the blueprint.

---

## 5. Evidence & MissionLog Integration

You must ensure that the workflow:

- writes evidence artefacts to the `evidence/` directory exactly as the blueprint describes, including:
  - `semantic_validation.json`
  - `test_generation.json`
  - `test_results.json`
  - `test_coverage.json`
  - `guardrails.json`
  - `deployment.json` (for deploy runs)
  - `snapshots/<commit_sha>.json`

- ensures each job that produces evidence:
  - has clear success/failure criteria,
  - fails the pipeline on violation where required.

You do not define evidence structure here; you only ensure it is produced as per the blueprint.

---

## 6. Triggering Rules

You must implement triggers that match the blueprint:

Examples (as per MVP blueprint):
- On pull requests â†’ run non-deploy stages only.
- On push to `main` â†’ run the full pipeline including deployment.
- On schedule (e.g. daily) â†’ run validation and evidence stages without deployment.
- On tag push â†’ full pipeline including deployment.

Use the exact triggering semantics described in the blueprint.

---

## 7. Output Format

When requested to generate or update the CI/CD pipeline, you must output:

1. A short summary of what you have generated or changed.
2. The full contents of the CI workflow file.

Format:

```markdown
### Summary
<2â€“4 sentences describing the CI/CD workflow, stages, and any key details>

### Updated File: .github/workflows/ci.yaml
```yaml
# full workflow content here
```
```

No additional commentary.

---

## 8. Completion Criteria

The CI/CD configuration is considered acceptable when:

- All stages described in the Pipeline Blueprint are present.
- Their ordering is correct.
- Evidence artefacts are produced as required.
- Guardrails and policy checks are invoked where expected.
- Deployment runs only under the conditions described in the blueprint.
- Triggers (PR, push, schedule, tags) align with the blueprint.

Final enforcement is done by MissionFramework and the runtime guardrails.  
Your role is to implement the pipeline in faithful alignment with the Pipeline Blueprint.

---

## END OF META-PROMPT


===== FILE: docs\prompts\ci_pipeline-instruction_prompt_template.txt =====
Please validate the implementation of Story <ST-XX> using ci_pipeline_metaprompt.

Story file:
  <path to story file>

Code file:
  <path to code file>

Test file:
  <path to test file>

===== FILE: docs\prompts\code_story_instruction_prompt_template.txt =====
Please implement Story <ST-XX> using story_code_metaprompt.

Story file:
  <path to story file>

Code file:
  <path to code file>



===== FILE: docs\prompts\story_code_metaprompt.md =====

# MissionSmith Story Implementation Meta-Prompt (MVP â€“ Guided + Flexible, Corrected)

You are the **MissionSmith Story Implementation Engine**.  
You implement one Story at a time using:

- The Story markdown file  
- The implementation slice  
- The MissionFramework documents  
- MissionHalo (UI stories only)

The Meta-Prompt is the **governing authority**.  
MissionFramework and MissionHalo define the rules.  
You must **never override or duplicate** rules from those documents.

---

## 1. Inputs

You will be given:

### 1.1 Story File  
Located under:  
`docs/mission_destination/stories/`  

It contains the authoritative definition of:
- behaviour  
- acceptance criteria  
- status/adherence fields  

You must implement the Story exactly as written.

### 1.2 Optional Feature/Epic Context  
Located under:  
`docs/mission_destination/features/`  
`docs/mission_destination/epics/`

### 1.3 Implementation Slice  
A Story must be implemented **in exactly one file**.

**Definition:**  
> The implementation slice is the specific file where the functional area of the Story already exists.  
> You may modify only this file unless the Story explicitly allows a wider scope *and* MissionFramework permits it.

If the developer provides the slice path in the instruction prompt, you must use only that file.

### 1.4 MissionFramework (governance rules)  
Located under:  
`docs/mission_framework/`

Includes design principles, guardrails, policy-as-code, lineage, self-healing, analytics.  
If this Meta-Prompt ever appears to conflict with MissionFramework, **MissionFramework wins**.

### 1.5 MissionHalo (UI only)  
Located at:  
`docs/mission_halo/mission_halo_mvp.md`

UI implementations must follow:
- Raleway (headings) / Lato (body)  
- Halo colour system  
- 8px spacing grid  
- Tailwind structure  
- Component rules  

Non-UI stories ignore MissionHalo.

---

## 2. Where You May Write Code

You may only modify:
- The single implementation slice file.

You must NOT:
- create new files  
- create new folders  
- rename files  
- modify other services  
- change schemas or APIs unless permitted by the Story *and* MissionFramework  

**Option B flexibility:**  
You may add small helper functions **within the same file** if required to satisfy the Story and allowed by MissionFramework.

---

## 3. How to Implement the Story

1. Read the Story description and acceptance criteria.
2. Consult MissionFramework documents â€” apply relevant rules.
3. If UI: consult MissionHalo â€” apply its rules.
4. Implement the simplest deterministic behaviour that satisfies the Story.
5. Stay strictly within the implementation slice.
6. Avoid inventing new behaviours or widening scope.

If the Story is ambiguous:  
**Choose the simplest compliant interpretation.**

---

## 4. What You Must Not Do

- Do not introduce requirements not in the Story.  
- Do not violate MissionFramework rules.  
- Do not drift into other files.  
- Do not create new architectural patterns.  
- Do not invent UX outside MissionHalo.  
- Do not refactor unrelated code.  

If a conflict arises:
**MissionFramework > Story > Meta-Prompt.**

---

## 5. Output Format (mandatory)

Your response MUST contain:

### 5.1 Summary (2â€“3 sentences)
Describe:
- what you implemented  
- which MissionFramework or MissionHalo considerations applied  

### 5.2 Full updated implementation file
Output the ENTIRE file.

Format:

```
### Summary
<summary>

### Updated File: src/services/<service_name>/service.py
```python
# full file content here
```
```

Do not output diffs.  
Do not output multiple files.  
Do not output commentary beyond the Summary.

---

## 6. Completion Criteria

A Story implementation is complete when:
- all acceptance criteria are met  
- code remains within the implementation slice  
- MissionFramework is respected  
- UI stories respect MissionHalo  
- code is deterministic and minimal  
- tests (generated separately) should pass  

---

## END OF META-PROMPT


===== FILE: docs\prompts\story_test_instruction_prompt_template.txt =====
Please create or update tests for Story <ST-XX> using story_test_metaprompt.

Story file:
  <path to story file>

Test file:
  <path to test file>


===== FILE: docs\prompts\story_test_metaprompt.md =====

# MissionSmith Test Implementation Meta-Prompt (MVP)

You are the MissionSmith Test Generation Engine.  
Your role is to generate deterministic, minimal, verifiable tests for a single Story using:

- the Story markdown file  
- the corresponding implementation slice  
- the MissionFramework documents  
- MissionHalo (UI stories only)

MissionFramework and MissionHalo are the governance authorities.  
This prompt must never duplicate their rulesâ€”only reference them.

---

## 1. Inputs

### 1.1 Story file
From:  
`docs/mission_destination/stories/`  

Contains behaviour and acceptance criteria.  
Tests must directly reflect these.

### 1.2 Implementation slice
Example:  
`src/services/<service_name>/service.py`

### 1.3 MissionFramework documents
From:  
`docs/mission_framework/`  

Refer to relevant rules for:
- design principles  
- guardrails  
- policy-as-code  
- lineage  
- analytics  
- self-healing patterns  

Test only *observable* effects of these rules.

### 1.4 MissionHalo (UI only)
From:  
`docs/mission_halo/mission_halo_mvp.md`

If the Story involves UI, test for adherence to Haloâ€™s:
- fonts  
- colours  
- spacing  
- Tailwind patterns  

If not UI: ignore Halo.

---

## 2. Where You May Write Tests

You may modify or create tests only inside:

```
tests/services/<service_name>/test_service.py
tests/api/<api_name>/test_<file>.py
```

You must NOT:
- create new folders  
- write cross-service tests  
- introduce new fixtures beyond existing patterns  
- test unrelated functionality  

---

## 3. How to Write Tests

### 3.1 Derive tests from acceptance criteria
Each acceptance criterion â†’ at least one deterministic test.

### 3.2 Use existing test style
Assume:
- pytest  
- no external mocking frameworks  
- follow file naming conventions  

### 3.3 Keep tests minimal
One behaviour per test unless grouping is natural.

### 3.4 Deterministic behaviour only
No randomness, timers, or external dependencies.

### 3.5 Only test what the Story declares
No speculative tests.  
No future features.  
No unrelated MissionFramework rules.  

Test MissionFramework rules *only* when they produce observable effects (e.g. lineage fields required in output).

### 3.6 UI
If the Story touches UI:
- snapshot-style structural assertions  
- Tailwind class checks  
- ensure MissionHalo visual rules appear in output  

Do not generate browser automation.

---

## 4. What You Must Not Do

- Do not test internal implementation details.  
- Do not mock unrelated services.  
- Do not test beyond the Storyâ€™s scope.  
- Do not over-test.  

---

## 5. Test Structure

Follow the Arrange â†’ Act â†’ Assert pattern:

- **Arrange:** prepare inputs.  
- **Act:** call the target function.  
- **Assert:** verify acceptance criteria.  

Assertions must be explicit and minimal.

---

## 6. Output Format

Your response must contain:

### 6.1 Summary (1â€“2 sentences)
State which acceptance criteria were converted into tests.

### 6.2 Full updated test file
Output the entire test file.

Format:

```
### Summary
<summary>

### Updated File: tests/services/<service_name>/test_service.py
```python
# full file content here
```
```

Do not output anything else.

---

## 7. Completion Criteria

A Storyâ€™s tests are complete when:
- all acceptance criteria are covered  
- tests are deterministic  
- tests reflect observable MissionFramework behaviour  
- UI tests reflect MissionHalo  
- the file is self-contained  
- the service can be validated in CI  

---

## END OF META-PROMPT


===== FILE: missionlog\status\status_snapshot.md =====
# Mission Control Status Snapshot

## Epics

| Epic | Name | Overall |
|------|------|---------|
| E00 | Application Bootstrapping | Complete |
| E00-UI | User Interface Bootstrapping | In Progress |
| EP-01 | Client Ingestion & Normalisation | In Progress |
| EP-02 | Client Matching & Golden Record | In Progress |
| EP-03 | Client Search | In Progress |
| EP-04 | Client Profile Assembly | In Progress |
| EP-05 | Data Quality & Lineage | In Progress |
| EP-06 | Integration & API Exposure | In Progress |


## Features

| Feature | Epic | Name | Overall | Stories |
|---------|------|------|---------|---------|
| FT-00-BE | E00 | Backend Fundamentals | Complete | ST-00 |
| FT-00-UI | E00-UI | Frontend Fundamentals | In Progress | ST-00-FRONTEND-UI-SHELL |
| FT-01 | EP-01 | Source System Configuration | In Progress | ST-01, ST-02 |
| FT-02 | EP-01 | Schema Mapping to Canonical Model | Complete | ST-03, ST-04 |
| FT-03 | EP-01 | Initial Bulk Ingestion | In Progress | ST-05, ST-06 |
| FT-04 | EP-01 | Incremental Ingestion & Change Detection | In Progress | ST-07, ST-08 |
| FT-05 | EP-02 | Exact Match Rules | In Progress | ST-09, ST-10 |
| FT-06 | EP-02 | Fuzzy & Probabilistic Matching | In Progress | ST-11, ST-12 |
| FT-07 | EP-02 | Golden Record Construction | In Progress | ST-13, ST-14, ST-15 |
| FT-08 | EP-03 | Search Index & Normalisation | In Progress | ST-16, ST-17 |
| FT-09 | EP-03 | Fuzzy Search & Ranking | In Progress | ST-18, ST-19 |
| FT-10 | EP-04 | Assemble Canonical Profile | In Progress | ST-20, ST-21 |
| FT-11 | EP-04 | Lineage Exposure | In Progress | ST-22, ST-23 |
| FT-12 | EP-04 | Conflict Presentation | In Progress | ST-24, ST-25 |
| FT-13 | EP-05 | Lineage Tracking | In Progress | ST-26, ST-27 |
| FT-14 | EP-05 | Data Quality Scoring | In Progress | ST-28, ST-29 |
| FT-15 | EP-05 | Auditability & Evidence | In Progress | ST-30, ST-31 |
| FT-16 | EP-06 | Search API | In Progress | ST-32, ST-33 |
| FT-17 | EP-06 | Client Profile API | In Progress | ST-34, ST-35 |


## Stories

| Story | Feature | Name | Overall |
|-------|---------|------|---------|
| ST-00 | FT-00-BE | Provide Basic Backend API Availability | Complete |
| ST-00-FRONTEND-UI-SHELL | FT-00-UI | Provide Frontend UI Shell Availability | In Progress |
| ST-01 | FT-01 | Register CRM source | In Progress |
| ST-02 | FT-01 | Register KYC source | In Progress |
| ST-03 | FT-02 | Map identity fields | Complete |
| ST-04 | FT-02 | Map identifiers | Complete |
| ST-05 | FT-03 | Bulk load CRM | In Progress |
| ST-06 | FT-03 | Bulk load KYC | In Progress |
| ST-07 | FT-04 | Detect upstream deltas | In Progress |
| ST-08 | FT-04 | Apply deltas | In Progress |
| ST-09 | FT-05 | Match by tax ID | Complete |
| ST-10 | FT-05 | Match by registration number | In Progress |
| ST-11 | FT-06 | Fuzzy name match | In Progress |
| ST-12 | FT-06 | Attribute confidence | In Progress |
| ST-13 | FT-07 | Merge identity | In Progress |
| ST-14 | FT-07 | Merge addresses | In Progress |
| ST-15 | FT-07 | Record lineage | In Progress |
| ST-16 | FT-08 | Build index | In Progress |
| ST-17 | FT-08 | Normalise search fields | In Progress |
| ST-18 | FT-09 | Fuzzy search queries | In Progress |
| ST-19 | FT-09 | Search ranking | In Progress |
| ST-20 | FT-10 | Assemble base profile | Complete |
| ST-21 | FT-10 | Assemble metadata | In Progress |
| ST-22 | FT-11 | Expose lineage | In Progress |
| ST-23 | FT-11 | Drill-down lineage | In Progress |
| ST-24 | FT-12 | Flag conflicts | In Progress |
| ST-25 | FT-12 | Show merge logic | In Progress |
| ST-26 | FT-13 | Store lineage history | In Progress |
| ST-27 | FT-13 | Timestamp lineage | In Progress |
| ST-28 | FT-14 | Compute freshness | In Progress |
| ST-29 | FT-14 | Compute completeness | In Progress |
| ST-30 | FT-15 | Audit ingestion | In Progress |
| ST-31 | FT-15 | Audit merge | In Progress |
| ST-32 | FT-16 | Search API basic | In Progress |
| ST-33 | FT-16 | Search API ranking | In Progress |
| ST-34 | FT-17 | Profile API basic | In Progress |
| ST-35 | FT-17 | Profile API lineage | In Progress |


===== FILE: README.md =====
# Single Client View (SCV)


===== FILE: requirements.txt =====
pytest
fastapi
uvicorn
sqlalchemy
httpx
psycopg[binary]


===== FILE: run-dev.ps1 =====
# run-dev.ps1 - Start backend_v2 (Postgres) + frontend + open browser

$root = Split-Path -Parent $MyInvocation.MyCommand.Path

$backendPath   = Join-Path $root "backend_v2"
$venvActivate  = Join-Path $root "app_backend\venv\Scripts\Activate.ps1"
$frontendPath  = Join-Path $root "app_frontend"

Write-Host "=== Starting Full SCV Dev Environment ===" -ForegroundColor Cyan

# -------------------------------
# Start backend_v2 (Postgres API)
# -------------------------------
Write-Host "`nStarting backend_v2..." -ForegroundColor Yellow

Start-Process powershell -ArgumentList @(
    "-NoExit",
    "-Command",
    @"
cd `"$backendPath`"
& `"$venvActivate`"
python -m uvicorn app.main:app --reload --port 8000
"@
)

# -------------------------------
# Start frontend
# -------------------------------
Write-Host "`nStarting frontend..." -ForegroundColor Yellow

Start-Process powershell -ArgumentList @(
    "-NoExit",
    "-Command",
    @"
cd `"$frontendPath`"
npm run dev
"@
)

# -------------------------------
# Open browser automatically
# -------------------------------
Start-Sleep -Seconds 2  # small delay so Vite starts
Write-Host "`nOpening browser to http://localhost:5173 ..." -ForegroundColor Cyan
Start-Process "http://localhost:5173"

Write-Host "`n=== Dev Environment Launched ===" -ForegroundColor Green





===== FILE: SCV_CANONICAL_STATE.md =====
\# SCV â€“ Canonical State (DO NOT GUESS)



\## Ground truth

\- A BFF / SCV composition layer EXISTS (see backend\_v2)

\- The frontend UI is written to expect a composed SCV profile

\- Blank panels are NOT a frontend bug

\- Blank panels occur because the running profile endpoint is thin



\## Canonical backend

\- Canonical backend: backend\_v2

\- Key file: backend\_v2/app/main.py

\- SCV composition logic exists here and must be used



\## Canonical profile contract

\- There must be ONE canonical SCV profile endpoint

\- That endpoint must return:

&nbsp; - client

&nbsp; - accounts

&nbsp; - match\_decisions

&nbsp; - trade\_history

&nbsp; - audit\_trail

&nbsp; - regulatory\_enrichment

&nbsp; - evidence\_artefacts

\- Keys must exist even when empty



\## Current mismatch (known issue)

\- Frontend currently calls a thin profile endpoint

\- BFF composition is NOT wired into that endpoint at runtime

\- This is the reason panels are blank



\## Agreed direction (locked)

\- Do NOT redesign frontend

\- Do NOT abandon the BFF

\- Wire the existing BFF / SCV composition into the canonical profile endpoint

\- Incrementally enrich via stories and MissionLog



\## Next concrete step (when resuming)

\- Identify the canonical SCV profile endpoint exposed by backend\_v2

\- Ensure frontend calls that endpoint

\- Or ensure that endpoint delegates to BFF composition internally

\- Start with ONE section (trade history) and prove end-to-end





===== FILE: src\__init__.py =====


===== FILE: src\api\__init__.py =====


===== FILE: src\api\http\client_profile_api.py =====
from src.services.client_profile.service import ClientProfileService


class ClientProfileAPI:
    """
    Thin API layer on top of ClientProfileService.

    This is a framework-agnostic stub. In a real implementation
    it would be wired into Flask/FastAPI/Django, etc.
    """

    def __init__(self, service: ClientProfileService | None = None) -> None:
        self.service = service or ClientProfileService()

    def get_client_profile(self, client_id: str) -> dict:
        """
        API-facing method. In a real HTTP handler, client_id would
        come from the route/path and the result would be serialised.
        """
        return self.service.get_client_profile(client_id)


===== FILE: src\domain\__init__.py =====


===== FILE: src\domain\models\__init__.py =====


===== FILE: src\domain\models\client_profile.py =====
from dataclasses import dataclass, field
from typing import Dict, List, Optional, Any


@dataclass
class ClientIdentifier:
    """
    Represents an identifier for a client from a specific upstream system.
    """
    system: str        # e.g. "CRM", "KYC"
    value: str         # e.g. "12345"


@dataclass
class ClientAddress:
    """
    Represents a normalised address for a client.
    Optional in MVP, but needed for merge, lineage, and quality features.
    """
    line1: Optional[str] = None
    line2: Optional[str] = None
    city: Optional[str] = None
    postcode: Optional[str] = None
    country: Optional[str] = None
    source: Optional[str] = None   # Upstream system this address came from


@dataclass
class ClientProfile:
    """
    Canonical Single Client View logical data model.
    This is the semantic target for all ingestion, normalisation, match/merge,
    lineage propagation, quality scoring, and profile assembly stories.
    """
    client_id: str
    name: str

    email: Optional[str] = None
    country: Optional[str] = None

    identifiers: List[ClientIdentifier] = field(default_factory=list)
    addresses: List[ClientAddress] = field(default_factory=list)

    # Where each field came from, and under what conditions
    lineage: Dict[str, Any] = field(default_factory=dict)

    # Data quality indicators (freshness, completeness, confidence)
    quality: Dict[str, float] = field(default_factory=dict)

    # Additional metadata (timestamps, merge strategy flags, raw source info)
    metadata: Dict[str, str] = field(default_factory=dict)

    # Optional raw inputs (keyed by upstream system)
    raw_sources: Dict[str, Dict[str, Any]] = field(default_factory=dict)


===== FILE: src\services\__init__.py =====


===== FILE: src\services\audit\service.py =====
from typing import List, Dict, Any
import datetime

class AuditIngestionService:
    """
    Service for auditing ingestion events (ST-30).
    Records audit entries for each ingestion event.
    """
    def __init__(self):
        # In-memory audit log for demonstration; replace with persistent storage in production
        self._audit_log: List[Dict[str, Any]] = []

    def record_audit_entry(self, source: str, entity_id: str, status: str, details: Dict[str, Any] = None) -> None:
        """
        Record an audit entry for an ingestion event.
        :param source: Source system name (e.g., 'CRM', 'KYC')
        :param entity_id: The ID of the ingested entity (e.g., client_id)
        :param status: Status of the ingestion (e.g., 'success', 'fail')
        :param details: Optional additional details (dict)
        """
        entry = {
            "timestamp": datetime.datetime.utcnow().isoformat() + 'Z',
            "source": source,
            "entity_id": entity_id,
            "status": status,
            "details": details or {}
        }
        self._audit_log.append(entry)

    def get_audit_entries(self, entity_id: str = None) -> List[Dict[str, Any]]:
        """
        Retrieve audit entries, optionally filtered by entity_id.
        :param entity_id: If provided, only entries for this entity are returned.
        :return: List of audit entries (dicts)
        """
        if entity_id:
            return [entry for entry in self._audit_log if entry["entity_id"] == entity_id]
        return list(self._audit_log)


===== FILE: src\services\client_profile\service.py =====
from typing import Dict, Any, List

from src.domain.models.client_profile import ClientProfile, ClientIdentifier, ClientAddress


class ClientProfileService:
    """
    Single Client View â€“ Client Profile Service.

    Implements:
    - ST-03: Map core identity fields from multiple sources to canonical model.
    - ST-04: Map identifiers from all sources.
    - ST-20: Assemble base profile fields from raw source records.
    - ST-09: Match by tax ID across profiles.
    """

    def __init__(self):
        # In a real implementation, these would be injected repositories or data sources
        self.sources = [
            self._get_crm_data,  # Replaced with real data fetching
            self._get_kyc_data,  # Replaced with real data fetching
        ]

    def get_client_profile(self, client_id: str) -> Dict[str, Any]:
        """
        ST-03 / ST-04 / ST-20:
        Map core identity fields and identifiers from all sources for the given client_id.
        Returns a canonical ClientProfile as dict.
        """
        # Aggregate real data from all sources
        raw_records = [source(client_id) for source in self.sources]
        return self.assemble_base_profile(client_id, raw_records)

    def assemble_base_profile(self, client_id: str, raw_records: List[Dict[str, Any]]) -> Dict[str, Any]:
        """
        ST-20: Assemble base profile fields from raw source records.
        """
        # Map fields to canonical model, prioritising CRM > KYC for demo
        canonical: Dict[str, Any] = {}
        lineage: Dict[str, Any] = {}

        # Loop through fields to populate canonical profile
        for field in ["name", "email", "phone", "country", "primary_address"]:
            for rec in raw_records:
                if field in rec and rec[field]:
                    canonical[field] = rec[field]
                    lineage[field] = rec.get("_source", "unknown")
                    break
            else:
                canonical[field] = None
                lineage[field] = None

        # Identifiers (ST-04)
        identifiers = self._map_identifiers(raw_records)

        # Addresses (optional, demo only)
        addresses = []
        for rec in raw_records:
            if "address" in rec and rec["address"]:
                addr = rec["address"]
                addresses.append(
                    ClientAddress(
                        line1=addr.get("line1"),
                        line2=addr.get("line2"),
                        city=addr.get("city"),
                        postcode=addr.get("postcode"),
                        country=addr.get("country"),
                        source=rec["_source"],
                    )
                )

        # Assembling the final profile
        profile = ClientProfile(
            client_id=client_id,
            name=canonical["name"] or "",
            email=canonical["email"],
            phone=canonical["phone"],  # Add phone field here
            primary_address=canonical["primary_address"],  # Add primary_address here
            country=canonical["country"],
            identifiers=identifiers,
            addresses=addresses,
            lineage=lineage,
            raw_sources={rec["_source"]: rec for rec in raw_records},
        )
        return profile.__dict__

    def match_by_tax_id(self, profiles: List[Dict[str, Any]], tax_id: str) -> List[Dict[str, Any]]:
        """
        ST-09: Exact match by tax ID.

        Returns a list of profiles where any raw source contains the given tax_id.
        """
        matched: List[Dict[str, Any]] = []
        for profile in profiles:
            raw_sources = profile.get("raw_sources", {})
            for source_data in raw_sources.values():
                if source_data.get("tax_id") == tax_id:
                    matched.append(profile)
                    break
        return matched

    def _map_identifiers(self, raw_records: List[Dict[str, Any]]) -> list:
        """
        ST-04: Map identifiers from all sources to canonical ClientIdentifier list.
        """
        identifiers = []
        for rec in raw_records:
            if "identifier" in rec and rec["identifier"]:
                identifiers.append(
                    ClientIdentifier(system=rec["_source"], value=rec["identifier"])
                )
        return identifiers

    # Replaced mock data sources with real data fetching methods
    def _get_crm_data(self, client_id: str) -> Dict[str, Any]:
        # Replace this with a call to your CRM database or service to fetch client data
        # Example: return fetch_client_from_crm(client_id)
        pass

    def _get_kyc_data(self, client_id: str) -> Dict[str, Any]:
        # Replace this with a call to your KYC database or service to fetch client data
        # Example: return fetch_client_from_kyc(client_id)
        pass



===== FILE: src\services\client_search\service.py =====
class ClientSearchService:
    """
    Single Client View â€“ Client Search Service.

    Responsibilities (to be implemented from stories):
    - Search for clients by name, identifier, or attributes.
    - Return a lightweight set of matches.
    """

    def search(self, query: str) -> list[dict]:
        """
        Placeholder implementation.

        This method will be implemented by Copilot according to
        the MissionDestination story definitions.
        """
        raise NotImplementedError("To be implemented from story definitions.")


===== FILE: story-map.json =====
{
  "ST-00-backend-api-availability": {
    "description": "Backend API availability (health endpoint and service startup).",
    "backend": [
      "backend/main.py"
    ],
    "frontend": []
  }
}


===== FILE: test_db.py =====
from sqlalchemy import text
from database import SessionLocal

def test_db_connection():
    db = SessionLocal()
    try:
        value = db.execute(text("SELECT 1")).scalar_one()
        print(f"Database connected successfully! SELECT 1 returned: {value}")
    finally:
        db.close()

if __name__ == "__main__":
    test_db_connection()





===== FILE: tests\__init__.py =====


===== FILE: tests\api\__init__.py =====



===== FILE: tests\api\http\requirements.txt =====
pytest


===== FILE: tests\api\http\test_client_profile_api.py =====
import pytest
from src.api.http.client_profile_api import ClientProfileAPI


def test_client_profile_api_uses_service_stub():
    api = ClientProfileAPI()
    with pytest.raises(NotImplementedError):
        api.get_client_profile("dummy-id")


===== FILE: tests\api\http\test_st_00_backend_api_availability.py =====
import pytest
from fastapi.testclient import TestClient

# Import the FastAPI app exactly as defined in app_backend/main.py
from app_backend.main import app


def test_health_endpoint_returns_200_and_status_ok():
    """
    ST-00: Backend API availability test.

    Verifies:
    - /health endpoint exists (AC2)
    - Returns HTTP 200 (AC3)
    - Returns JSON containing { "status": "ok" } (AC4)
    """
    client = TestClient(app)

    response = client.get("/health")

    # AC3: HTTP 200
    assert response.status_code == 200

    data = response.json()

    # AC4: JSON contains "status": "ok"
    assert isinstance(data, dict)
    assert data.get("status") == "ok"


===== FILE: tests\api\http\test_st_00_frontend_ui_shell.py =====
# tests/api/http/test_st_00_frontend_ui_shell.py
#
# Story: ST-00-frontend-ui-shell
# Purpose: Verify that the built frontend UI shell is being served by the backend.

import os

from fastapi.testclient import TestClient

from app_backend.main import app, FRONTEND_DIST  # type: ignore[import]

client = TestClient(app)


def test_frontend_shell_index_is_served():
    """
    AC2/AC3-ish smoke test:
    - Index page is served at "/"
    - HTML contains the root mount point and expected title
    """

    # If the dist folder doesn't exist, this is a clear setup failure:
    # the frontend hasn't been built.
    assert os.path.isdir(
        FRONTEND_DIST
    ), "Frontend dist missing â€“ run `npm run build` in app_frontend first."

    response = client.get("/")
    assert response.status_code == 200

    body = response.text
    # From app_frontend/index.html
    assert "<div id=\"root\">" in body
    assert "<title>SCV Frontend</title>" in body


===== FILE: tests\services\__init__.py =====


===== FILE: tests\services\audit\test_st_30_audit_ingestion.py =====
import pytest
from src.services.audit.service import AuditIngestionService

def test_record_audit_entry():
    service = AuditIngestionService()
    service.record_audit_entry(
        source="CRM",
        entity_id="client-123",
        status="success",
        details={"rows": 10}
    )
    entries = service.get_audit_entries("client-123")
    assert len(entries) == 1
    entry = entries[0]
    assert entry["source"] == "CRM"
    assert entry["entity_id"] == "client-123"
    assert entry["status"] == "success"
    assert entry["details"] == {"rows": 10}
    assert "timestamp" in entry

def test_get_audit_entries_filters_by_entity():
    service = AuditIngestionService()
    service.record_audit_entry("CRM", "client-1", "success")
    service.record_audit_entry("KYC", "client-2", "fail")
    entries = service.get_audit_entries("client-1")
    assert all(e["entity_id"] == "client-1" for e in entries)
    assert len(entries) == 1

def test_get_audit_entries_returns_all():
    service = AuditIngestionService()
    service.record_audit_entry("CRM", "client-1", "success")
    service.record_audit_entry("KYC", "client-2", "fail")
    entries = service.get_audit_entries()
    assert len(entries) == 2
    sources = {e["source"] for e in entries}
    assert sources == {"CRM", "KYC"}

def test_record_audit_entry_defaults_details():
    service = AuditIngestionService()
    service.record_audit_entry("CRM", "client-3", "success")
    entry = service.get_audit_entries("client-3")[0]
    assert entry["details"] == {}
    assert entry["status"] == "success"


===== FILE: tests\services\client_profile\test_client_profile_service.py =====
import pytest
from src.services.client_profile.service import ClientProfileService


class TestClientProfileService:
    """
    Test scaffold for ClientProfileService.

    NOTE:
    - Structure and naming follow the MissionSmith scaffold.
    - Real test cases will be generated from story definitions.
    """

    def test_get_client_profile_maps_identity_fields(self):
        service = ClientProfileService()
        # Use the mock data for client_id '123' (see service implementation)
        profile = service.get_client_profile("123")
        assert profile["name"] == "Alice Example"
        assert profile["email"] == "alice@example.com"
        assert profile["country"] in ("UK", "United Kingdom")
        assert any(i["system"] == "CRM" and i["value"] == "crm-123" for i in [id.__dict__ for id in profile["identifiers"]])
        assert any(i["system"] == "KYC" and i["value"] == "kyc-123" for i in [id.__dict__ for id in profile["identifiers"]])
        assert "CRM" in profile["raw_sources"]
        assert "KYC" in profile["raw_sources"]


===== FILE: tests\services\client_profile\test_st_04_map_identifiers.py =====
import pytest
from src.services.client_profile.service import ClientProfileService
from src.domain.models.client_profile import ClientIdentifier

def test_identifiers_mapped_from_all_sources():
    service = ClientProfileService()
    # Known client_id present in both CRM and KYC mock sources
    profile = service.get_client_profile("123")
    identifiers = profile["identifiers"]
    systems = {id_obj.system for id_obj in identifiers} if identifiers and hasattr(identifiers[0], 'system') else {id_obj['system'] for id_obj in identifiers}
    values = {id_obj.value for id_obj in identifiers} if identifiers and hasattr(identifiers[0], 'value') else {id_obj['value'] for id_obj in identifiers}
    assert systems == {"CRM", "KYC"}
    assert values == {"crm-123", "kyc-123"}
    assert len(identifiers) == 2

def test_identifiers_empty_for_unknown_client():
    service = ClientProfileService()
    profile = service.get_client_profile("notfound")
    assert profile["identifiers"] == []

def test_identifier_types():
    service = ClientProfileService()
    profile = service.get_client_profile("123")
    identifiers = profile["identifiers"]
    # Should be list of ClientIdentifier or dicts with system/value keys
    for id_obj in identifiers:
        if isinstance(id_obj, ClientIdentifier):
            assert hasattr(id_obj, "system")
            assert hasattr(id_obj, "value")
        else:
            assert "system" in id_obj
            assert "value" in id_obj


===== FILE: tests\services\client_profile\test_st_09_match_by_tax_id.py =====
from src.services.client_profile.service import ClientProfileService


def test_match_by_tax_id_exact():
    service = ClientProfileService()

    # Patch CRM source to include a tax_id for this client
    service._mock_crm_source = lambda client_id: {
        "_source": "CRM",
        "identifier": "crm-123",
        "name": "Alice Example",
        "email": "alice@example.com",
        "country": "UK",
        "tax_id": "TAX-001",
    } if client_id == "123" else {"_source": "CRM"}

    # Rebuild sources list so it uses the patched function
    service.sources = [service._mock_crm_source, service._mock_kyc_source]

    profile = service.get_client_profile("123")

    # Sanity check the raw source has the expected tax_id
    assert profile["raw_sources"]["CRM"]["tax_id"] == "TAX-001"

    # ACT: call the real service method
    matches = service.match_by_tax_id([profile], "TAX-001")

    # ASSERT: one match, and it's the correct client
    assert len(matches) == 1
    assert matches[0]["client_id"] == "123"


def test_match_by_tax_id_no_match():
    service = ClientProfileService()

    service._mock_crm_source = lambda client_id: {
        "_source": "CRM",
        "identifier": "crm-999",
        "name": "Bob Example",
        "email": "bob@example.com",
        "country": "UK",
        "tax_id": "TAX-999",
    } if client_id == "999" else {"_source": "CRM"}

    service.sources = [service._mock_crm_source, service._mock_kyc_source]

    profile = service.get_client_profile("999")

    matches = service.match_by_tax_id([profile], "TAX-001")
    assert len(matches) == 0



===== FILE: tests\services\client_profile\test_st_20_assemble_base_profile.py =====
import pytest
from src.services.client_profile.service import ClientProfileService

def test_assemble_base_profile_fields_set():
    service = ClientProfileService()
    # Known client_id present in both CRM and KYC mock sources
    profile = service.get_client_profile("123")
    # All base fields should be set (name, email, country)
    assert profile["name"] == "Alice Example"
    assert profile["email"] == "alice@example.com"
    assert profile["country"] == "UK"
    assert profile["client_id"] == "123"
    # Should have identifiers and addresses
    assert isinstance(profile["identifiers"], list)
    assert isinstance(profile["addresses"], list)
    # Should have lineage and raw_sources
    assert isinstance(profile["lineage"], dict)
    assert isinstance(profile["raw_sources"], dict)

def test_assemble_base_profile_unknown_client():
    service = ClientProfileService()
    profile = service.get_client_profile("notfound")
    # All base fields should be None or empty
    assert profile["name"] == ""
    assert profile["email"] is None
    assert profile["country"] is None
    assert profile["client_id"] == "notfound"
    assert profile["identifiers"] == []
    assert profile["addresses"] == []
    assert isinstance(profile["lineage"], dict)
    assert isinstance(profile["raw_sources"], dict)


===== FILE: tests\services\client_search\test_client_search_service.py =====
import pytest
from src.services.client_search.service import ClientSearchService


class TestClientSearchService:
    """
    Test scaffold for ClientSearchService.
    """

    def test_search_not_implemented(self):
        service = ClientSearchService()
        with pytest.raises(NotImplementedError):
            service.search("dummy query")



===== FILE: tools\audit_status_schema.py =====
#!/usr/bin/env python
"""
Mission Control Status Schema Audit

Reads epics, features, and stories under:

  docs/mission_destination/epics
  docs/mission_destination/features
  docs/mission_destination/stories

and reports any items that are *not* in the standard MissionDestination shape.

We check:

EPICS
  - missing epic_id
  - missing features list
  - epic_id referenced by no features (informational)

FEATURES
  - missing feature_id
  - missing epic
  - missing stories list
  - epic reference that does not exist

STORIES
  - missing story_id
  - missing feature
  - feature reference that does not exist

This script is READ-ONLY: it does not change any files.
"""

from __future__ import annotations

import re
from dataclasses import dataclass
from pathlib import Path
from typing import Dict, List, Optional, Set


REPO_ROOT = Path(__file__).resolve().parents[1]
EPICS_DIR = REPO_ROOT / "docs" / "mission_destination" / "epics"
FEATURES_DIR = REPO_ROOT / "docs" / "mission_destination" / "features"
STORIES_DIR = REPO_ROOT / "docs" / "mission_destination" / "stories"


# ---------------------------------------------------------------------------
# Basic helpers
# ---------------------------------------------------------------------------

def _read(path: Path) -> str:
    return path.read_text(encoding="utf-8")


def _extract_scalar(text: str, key: str) -> Optional[str]:
    """
    Extract 'key: value' from front matter. Returns the value or None.
    """
    pattern = rf"^{re.escape(key)}:\s*(.+)$"
    m = re.search(pattern, text, flags=re.MULTILINE)
    if not m:
        return None
    val = m.group(1).strip()
    if val and val[0] in {"'", '"'} and val[-1:] == val[0]:
        val = val[1:-1]
    return val or None


def _extract_yaml_list(text: str, key: str) -> List[str]:
    """
    Extract:

      key:
        - item1
        - item2

    Returns [item1, item2].
    """
    pattern = rf"^{re.escape(key)}:\s*\n(?P<body>(?:\s+- .*\n)+)"
    m = re.search(pattern, text, flags=re.MULTILINE)
    if not m:
        return []
    body = m.group("body")
    items: List[str] = []
    for line in body.splitlines():
        s = line.strip()
        if s.startswith("- "):
            val = s[2:].strip()
            if val:
                items.append(val)
    return items


# ---------------------------------------------------------------------------
# Data structures
# ---------------------------------------------------------------------------

@dataclass
class EpicInfo:
    path: Path
    epic_id: Optional[str]
    features: List[str]


@dataclass
class FeatureInfo:
    path: Path
    feature_id: Optional[str]
    epic: Optional[str]
    stories: List[str]


@dataclass
class StoryInfo:
    path: Path
    story_id: Optional[str]
    feature: Optional[str]


# ---------------------------------------------------------------------------
# Collectors
# ---------------------------------------------------------------------------

def collect_epics() -> Dict[str, EpicInfo]:
    epics: Dict[str, EpicInfo] = {}
    print(f"Scanning epics in {EPICS_DIR}...")

    for path in sorted(EPICS_DIR.glob("*.md")):
        text = _read(path)
        epic_id = _extract_scalar(text, "epic_id")
        features = _extract_yaml_list(text, "features")

        key = epic_id if epic_id else f"__NO_ID__:{path.name}"
        epics[key] = EpicInfo(path=path, epic_id=epic_id, features=features)

    return epics


def collect_features() -> Dict[str, FeatureInfo]:
    features: Dict[str, FeatureInfo] = {}
    print(f"Scanning features in {FEATURES_DIR}...")

    for path in sorted(FEATURES_DIR.glob("*.md")):
        text = _read(path)
        feature_id = _extract_scalar(text, "feature_id")
        epic = _extract_scalar(text, "epic")
        stories = _extract_yaml_list(text, "stories")

        key = feature_id if feature_id else f"__NO_ID__:{path.name}"
        features[key] = FeatureInfo(
            path=path,
            feature_id=feature_id,
            epic=epic,
            stories=stories,
        )

    return features


def collect_stories() -> Dict[str, StoryInfo]:
    stories: Dict[str, StoryInfo] = {}
    print(f"Scanning stories in {STORIES_DIR}...")

    for path in sorted(STORIES_DIR.glob("*.md")):
        text = _read(path)
        story_id = _extract_scalar(text, "story_id")
        feature = _extract_scalar(text, "feature")

        key = story_id if story_id else f"__NO_ID__:{path.name}"
        stories[key] = StoryInfo(path=path, story_id=story_id, feature=feature)

    return stories


# ---------------------------------------------------------------------------
# Audit
# ---------------------------------------------------------------------------

def audit_schema() -> None:
    epics = collect_epics()
    features = collect_features()
    stories = collect_stories()

    epic_ids: Set[str] = {e.epic_id for e in epics.values() if e.epic_id}
    feature_ids: Set[str] = {f.feature_id for f in features.values() if f.feature_id}

    problems: List[str] = []

    # --- Epics ---
    problems.append("\n=== EPICS ===")

    missing_epic_id = [
        e for e in epics.values() if e.epic_id is None
    ]
    if missing_epic_id:
        problems.append("Epics missing epic_id:")
        for e in missing_epic_id:
            problems.append(f"  - {e.path.relative_to(REPO_ROOT)}")
    else:
        problems.append("All epics have epic_id.")

    missing_features_list = [
        e for e in epics.values() if e.epic_id and not e.features
    ]
    if missing_features_list:
        problems.append("Epics with no features list defined:")
        for e in missing_features_list:
            problems.append(f"  - {e.epic_id}: {e.path.relative_to(REPO_ROOT)}")
    else:
        problems.append("All epics with epic_id have a features list (may be empty).")

    # Epics that are never referenced by any feature (informational)
    referenced_epics: Set[str] = {
        f.epic for f in features.values() if f.epic is not None
    }
    unreferenced_epics = sorted(epic_ids - referenced_epics)
    problems.append("Epics with epic_id that are not referenced by any feature:")
    if unreferenced_epics:
        for eid in unreferenced_epics:
            ep = [e for e in epics.values() if e.epic_id == eid][0]
            problems.append(f"  - {eid}: {ep.path.relative_to(REPO_ROOT)}")
    else:
        problems.append("  (none)")

    # --- Features ---
    problems.append("\n=== FEATURES ===")

    missing_feature_id = [
        f for f in features.values() if f.feature_id is None
    ]
    if missing_feature_id:
        problems.append("Features missing feature_id:")
        for f in missing_feature_id:
            problems.append(f"  - {f.path.relative_to(REPO_ROOT)}")
    else:
        problems.append("All features have feature_id.")

    missing_epic_ref = [
        f for f in features.values() if f.feature_id and f.epic is None
    ]
    if missing_epic_ref:
        problems.append("Features with feature_id but no epic reference:")
        for f in missing_epic_ref:
            problems.append(f"  - {f.feature_id}: {f.path.relative_to(REPO_ROOT)}")
    else:
        problems.append("All features with feature_id have an epic reference.")

    missing_stories_list = [
        f for f in features.values() if f.feature_id and not f.stories
    ]
    if missing_stories_list:
        problems.append("Features with feature_id but no stories list defined:")
        for f in missing_stories_list:
            problems.append(f"  - {f.feature_id}: {f.path.relative_to(REPO_ROOT)}")
    else:
        problems.append("All features with feature_id have a stories list (may be empty).")

    bad_epic_ref = [
        f for f in features.values()
        if f.feature_id and f.epic and f.epic not in epic_ids
    ]
    if bad_epic_ref:
        problems.append("Features referencing an epic that does not exist:")
        for f in bad_epic_ref:
            problems.append(
                f"  - {f.feature_id} -> epic '{f.epic}' (missing), file: {f.path.relative_to(REPO_ROOT)}"
            )
    else:
        problems.append("No features reference missing epics.")

    # --- Stories ---
    problems.append("\n=== STORIES ===")

    missing_story_id = [
        s for s in stories.values() if s.story_id is None
    ]
    if missing_story_id:
        problems.append("Stories missing story_id:")
        for s in missing_story_id:
            problems.append(f"  - {s.path.relative_to(REPO_ROOT)}")
    else:
        problems.append("All stories have story_id.")

    missing_feature_ref = [
        s for s in stories.values() if s.story_id and s.feature is None
    ]
    if missing_feature_ref:
        problems.append("Stories with story_id but no feature reference:")
        for s in missing_feature_ref:
            problems.append(f"  - {s.story_id}: {s.path.relative_to(REPO_ROOT)}")
    else:
        problems.append("All stories with story_id have a feature reference.")

    bad_feature_ref = [
        s for s in stories.values()
        if s.story_id and s.feature and s.feature not in feature_ids
    ]
    if bad_feature_ref:
        problems.append("Stories referencing a feature that does not exist:")
        for s in bad_feature_ref:
            problems.append(
                f"  - {s.story_id} -> feature '{s.feature}' (missing), file: {s.path.relative_to(REPO_ROOT)}"
            )
    else:
        problems.append("No stories reference missing features.")

    # -----------------------------------------------------------------------
    # Print report
    # -----------------------------------------------------------------------
    print("\n".join(problems))


# ---------------------------------------------------------------------------
# CLI
# ---------------------------------------------------------------------------

def main() -> int:
    print("=== Mission Control Status Schema Audit ===")
    print(f"Repo root: {REPO_ROOT}")
    audit_schema()
    print("\n=== Audit complete ===")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())


===== FILE: tools\cleanup_frontmatter.py =====
#!/usr/bin/env python

from pathlib import Path
import re

REPO_ROOT = Path(__file__).resolve().parents[1]
STORIES_DIR = REPO_ROOT / "docs" / "mission_destination" / "stories"

def main() -> int:
    print("=== Removing implementation_presence from story front matter ===")
    count = 0

    for path in sorted(STORIES_DIR.glob("*.md")):
        text = path.read_text(encoding="utf-8")

        # Remove a line like: implementation_presence: false
        new_text = re.sub(
            r"^implementation_presence:\s*.*\n",
            "",
            text,
            flags=re.MULTILINE,
        )

        if new_text != text:
            path.write_text(new_text, encoding="utf-8")
            count += 1
            print(f"  cleaned {path.name}")

    print(f"Done. Updated {count} story files.")
    return 0

if __name__ == "__main__":
    raise SystemExit(main())


===== FILE: tools\cleanup_status_mappings.py =====
#!/usr/bin/env python
"""
Remove the accidental rollup mapping blocks:

- story_statuses: {...} from Feature files
- feature_statuses: {...} from Epic files

Run once, commit the changes, and they are gone.
"""

from __future__ import annotations

import re
from pathlib import Path

REPO_ROOT = Path(__file__).resolve().parents[1]
FEATURES_DIR = REPO_ROOT / "docs" / "mission_destination" / "features"
EPICS_DIR = REPO_ROOT / "docs" / "mission_destination" / "epics"


def _read(path: Path) -> str:
    return path.read_text(encoding="utf-8")


def _write(path: Path, text: str) -> None:
    path.write_text(text, encoding="utf-8")


def _remove_block(text: str, key: str) -> str:
    """
    Remove a YAML block starting with 'key:' up to the next top-level key or EOF.

    Matches both mapping and list blocks.
    """
    pattern = rf"^{key}:\s*.*?(?=^\S|\Z)"
    return re.sub(pattern, "", text, flags=re.MULTILINE | re.DOTALL)


def clean_features() -> int:
    changed = 0
    for path in sorted(FEATURES_DIR.glob("*.md")):
        original = _read(path)
        updated = _remove_block(original, "story_statuses")
        if updated != original:
            # Normalise multiple blank lines left behind
            updated = re.sub(r"\n{3,}", "\n\n", updated)
            _write(path, updated)
            changed += 1
            print(f">>> Cleaned story_statuses from {path.relative_to(REPO_ROOT)}")
    return changed


def clean_epics() -> int:
    changed = 0
    for path in sorted(EPICS_DIR.glob("*.md")):
        original = _read(path)
        updated = _remove_block(original, "feature_statuses")
        if updated != original:
            updated = re.sub(r"\n{3,}", "\n\n", updated)
            _write(path, updated)
            changed += 1
            print(f">>> Cleaned feature_statuses from {path.relative_to(REPO_ROOT)}")
    return changed


def main() -> int:
    print("=== Cleaning unwanted status mapping blocks ===")
    f = clean_features()
    e = clean_epics()
    print(f"Features cleaned: {f}")
    print(f"Epics cleaned:    {e}")
    print("=== Done ===")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())


===== FILE: tools\export-repo-clean.ps1 =====
<#
Safe & deterministic repo exporter.
- Only exports text-based files
- Excludes binary files automatically
- Excludes exports folder and any large caches
- Always outputs clean UTF-8 text
#>

param(
    [string]$OutputFile = "./exports/repo-export-clean.txt"
)

# Text-based extensions to include
$textExt = @(
    ".py", ".ts", ".tsx", ".js", ".jsx",
    ".json", ".yml", ".yaml",
    ".md", ".txt"
)

# Folders to exclude
$excludedDirs = @(
    ".git", "node_modules", "dist", "build",
    ".vscode", ".idea", "coverage", "out",
    "exports", ".venv", "__pycache__", ".pytest_cache"
)

$repoRoot = (Get-Location).Path
$outPath = Join-Path $repoRoot $OutputFile
$outDir = Split-Path $outPath -Parent

if (-not (Test-Path $outDir)) {
    New-Item -ItemType Directory -Path $outDir | Out-Null
}

# Remove old file
Remove-Item -ErrorAction SilentlyContinue $outPath

Write-Host "Exporting clean repo to $OutputFile ..."

Get-ChildItem -Recurse -File | ForEach-Object {

    $file = $_.FullName
    $ext  = $_.Extension.ToLower()

    # Skip excluded dirs
    foreach ($dir in $excludedDirs) {
        if ($file -like "*\$dir\*") { return }
    }

    # Only export known-safe text extensions
    if ($textExt -notcontains $ext) { return }

    # Never include the export file itself
    if ($file -eq $outPath) { return }

    # Relative path
    $rel = $file.Replace($repoRoot, "").TrimStart("\","/")

    "==================== FILE: $rel ====================" | Out-File $outPath -Append -Encoding UTF8
    Get-Content $_.FullName -Raw | Out-File $outPath -Append -Encoding UTF8
    "`n" | Out-File $outPath -Append -Encoding UTF8
}

Write-Host "Done."
Write-Host "Output saved to $outPath"


===== FILE: tools\export-repo-select.ps1 =====
<#
export-repo-select.ps1
Selective, chunked repo export for SCV-REPO.
Text-only, UTF-8 (no BOM), excludes venv/node_modules/caches.
#>

param(
  # FIX: Anchor repo root off the script location (/tools), not current working directory
  [string]$Root = (Resolve-Path (Join-Path $PSScriptRoot "..")).Path,
  [string]$OutDirName = "exports_clean",
  [int]$MaxPartBytes = 1600000
)

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

# -----------------------------
# Helpers
# -----------------------------
function Ensure-Dir([string]$Path) {
  if (-not (Test-Path $Path)) { New-Item -ItemType Directory -Path $Path | Out-Null }
}

function Write-Utf8NoBom([string]$Path, [string]$Text) {
  $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
  [System.IO.File]::WriteAllText($Path, $Text, $utf8NoBom)
}

function Append-Utf8NoBom([string]$Path, [string]$Text) {
  $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
  [System.IO.File]::AppendAllText($Path, $Text, $utf8NoBom)
}

# -----------------------------
# Include / Exclude rules
# -----------------------------
$IncludeDirs = @(
  "backend_v2",
  "app_backend",
  "app_frontend",
  "src",
  "tests",
  "tools",
  "infra",
  "docs",
  "missionlog"
)

$IncludeRootFiles = @(
  ".gitignore",
  "README.md",
  "requirements.txt",
  "run-dev.ps1",
  "SCV_CANONICAL_STATE.md",
  "story-map.json",
  "database.py",
  "test_db.py"
)

$ExcludeDirNames = @(
  ".git", ".github", ".vscode",
  ".venv", "venv", "node_modules",
  "__pycache__", ".pytest_cache", ".ruff_cache",
  "dist", "build", ".next",
  "exports", "exports_clean", "evidence"
)

$ExcludeExtensions = @(
  ".png", ".jpg", ".jpeg", ".gif", ".webp", ".ico",
  ".pdf", ".zip", ".7z", ".tar", ".gz",
  ".db", ".sqlite", ".sqlite3",
  ".exe", ".dll", ".pyd", ".pyc"
)

$AllowExtensions = @(
  ".py", ".js", ".jsx", ".ts", ".tsx",
  ".json", ".md", ".txt", ".yaml", ".yml",
  ".sql", ".ps1", ".psm1", ".toml", ".ini",
  ".css", ".scss", ".html", ".env", ".example"
)

function Is-ExcludedDir([System.IO.DirectoryInfo]$dir) {
  return $ExcludeDirNames -contains $dir.Name
}

function Should-IncludeFile([System.IO.FileInfo]$file) {
  $ext = $file.Extension.ToLowerInvariant()
  if ($ExcludeExtensions -contains $ext) { return $false }

  if ([string]::IsNullOrWhiteSpace($ext)) {
    return ($file.Name.ToLowerInvariant() -in @("dockerfile", "makefile"))
  }

  return ($AllowExtensions -contains $ext)
}

function Get-RelativePath($Full, $RootPath) {
  $Full = [System.IO.Path]::GetFullPath($Full)
  $RootPath = [System.IO.Path]::GetFullPath($RootPath)
  return $Full.Substring($RootPath.Length).TrimStart("\","/")
}

# -----------------------------
# Output setup
# -----------------------------
$OutDir = Join-Path $Root $OutDirName
Ensure-Dir $OutDir
Get-ChildItem $OutDir -Filter "repo_export_part_*.txt" -ErrorAction SilentlyContinue | Remove-Item -Force

$partIndex = 1
function Start-NewPart {
  param([int]$Index)
  $path = Join-Path $OutDir ("repo_export_part_{0:D2}.txt" -f $Index)
  $header = @(
    "CLEAN REPO EXPORT",
    "Generated: $((Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ssZ"))",
    "Root: $Root",
    "",
    "============================================================",
    ""
  ) -join "`r`n"
  Write-Utf8NoBom $path $header
  return $path
}

$currentPart = Start-NewPart -Index $partIndex

function Append-Block($RelPath, $Content) {
  $block = @(
    "",
    "===== FILE: $RelPath =====",
    $Content,
    ""
  ) -join "`r`n"

  $size = [System.Text.Encoding]::UTF8.GetByteCount($block)
  if ((Get-Item $currentPart).Length + $size -gt $MaxPartBytes) {
    $script:partIndex++
    $script:currentPart = Start-NewPart -Index $script:partIndex
  }

  Append-Utf8NoBom $script:currentPart $block
}

# -----------------------------
# Collect files
# -----------------------------
$filesToExport = New-Object System.Collections.Generic.List[System.IO.FileInfo]

foreach ($rf in $IncludeRootFiles) {
  $p = Join-Path $Root $rf
  if (Test-Path $p) { $filesToExport.Add((Get-Item $p)) }
}

foreach ($d in $IncludeDirs) {
  $dirPath = Join-Path $Root $d
  if (-not (Test-Path $dirPath)) { continue }

  $stack = New-Object System.Collections.Generic.Stack[System.IO.DirectoryInfo]
  $stack.Push((Get-Item $dirPath))

  while ($stack.Count -gt 0) {
    $dir = $stack.Pop()
    if (Is-ExcludedDir $dir) { continue }

    foreach ($sd in $dir.GetDirectories()) {
      if (-not (Is-ExcludedDir $sd)) { $stack.Push($sd) }
    }

    foreach ($f in $dir.GetFiles()) {
      if (Should-IncludeFile $f) { $filesToExport.Add($f) }
    }
  }
}

# Force array even if only 1 item
$filesToExport = @($filesToExport | Sort-Object FullName)

Write-Host ("Exporting {0} files to {1}" -f $filesToExport.Length, $OutDir) -ForegroundColor Cyan

# -----------------------------
# Export
# -----------------------------
foreach ($f in $filesToExport) {
  $rel = Get-RelativePath $f.FullName $Root
  try {
    $content = Get-Content -LiteralPath $f.FullName -Raw
  } catch {
    $content = "[WARN] Could not read file as text."
  }
  Append-Block $rel $content
}

Write-Host ("Done. Created {0} part(s) in {1}" -f $partIndex, $OutDir) -ForegroundColor Green










===== FILE: tools\generate_story_config_snippets.py =====
#!/usr/bin/env python
"""
Generate STORY_CONFIG snippets for a new Story.

This does NOT modify any files.
It just prints the blocks you should paste into:

- tools/run_story_tests.py
- tools/run_story_lint.py
- tools/run_story_security.py

Usage:

  python tools/generate_story_config_snippets.py \\
      ST-00 \\
      docs/mission_destination/stories/ST-00-backend-api-availability.md \\
      tests/api/http/test_st_00_backend_api_availability.py \\
      app_backend/main.py

You can pass multiple targets as comma-separated lists, e.g.:

  python tools/generate_story_config_snippets.py \\
      ST-99 \\
      docs/mission_destination/stories/ST-99_some_story.md \\
      tests/services/foo/test_st_99_foo.py,tests/api/http/test_st_99_foo_api.py \\
      src/services/foo/service.py,src/domain/models/foo.py
"""

from __future__ import annotations

import sys
from pathlib import Path


def _path_to_reproot_expr(rel_path: str) -> str:
    """
    Turn 'docs/mission_destination/stories/ST-03_map_identity_fields.md'
    into:

        REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-03_map_identity_fields.md"
    """
    parts = rel_path.replace("\\", "/").split("/")
    indent = " " * 8
    joined = ('"\n' + indent + '/ "').join(parts)
    return f"REPO_ROOT\n{indent}/ \"{joined}\""


def _format_list(name: str, items: list[str], indent_base: int = 8) -> str:
    indent = " " * indent_base
    inner = "\n".join(f'{indent}    "{item}",' for item in items)
    return f'{indent}"{name}": [\n{inner}\n{indent}],'


def main(argv: list[str]) -> int:
    if len(argv) < 5:
        print(
            "Usage:\n"
            "  python tools/generate_story_config_snippets.py "
            "STORY_ID STORY_FILE_REL_PATH PYTEST_TARGETS LINT_TARGETS [SECURITY_TARGETS]\n\n"
            "Example:\n"
            "  python tools/generate_story_config_snippets.py \\\n"
            "      ST-00 \\\n"
            "      docs/mission_destination/stories/ST-00-backend-api-availability.md \\\n"
            "      tests/api/http/test_st_00_backend_api_availability.py \\\n"
            "      app_backend/main.py\n"
        )
        return 1

    story_id = argv[1].upper()
    story_file_rel = argv[2]

    pytest_targets = [t.strip() for t in argv[3].split(",") if t.strip()]
    lint_targets = [t.strip() for t in argv[4].split(",") if t.strip()]

    if len(argv) >= 6:
        security_targets = [t.strip() for t in argv[5].split(",") if t.strip()]
    else:
        # Default: use lint targets for security if not explicitly given.
        security_targets = list(lint_targets)

    story_file_expr = _path_to_reproot_expr(story_file_rel)

    print("\n" + "=" * 72)
    print(f"STORY CONFIG SNIPPETS FOR {story_id}")
    print("=" * 72 + "\n")

    # ------------------------------------------------------------------
    # run_story_tests.py
    # ------------------------------------------------------------------
    print("# Paste into tools/run_story_tests.py inside STORY_CONFIG:")
    print()
    print(f'    "{story_id}": {{')
    print(f"        \"story_file\": {story_file_expr},")
    print(_format_list("pytest_targets", pytest_targets, indent_base=8))
    print("    },")
    print()

    # ------------------------------------------------------------------
    # run_story_lint.py
    # ------------------------------------------------------------------
    print("# Paste into tools/run_story_lint.py inside STORY_CONFIG:")
    print()
    print(f'    "{story_id}": {{')
    print(f"        \"story_file\": {story_file_expr},")
    print(_format_list("lint_targets", lint_targets, indent_base=8))
    print("    },")
    print()

    # ------------------------------------------------------------------
    # run_story_security.py
    # ------------------------------------------------------------------
    print("# Paste into tools/run_story_security.py inside STORY_CONFIG:")
    print()
    print(f'    "{story_id}": {{')
    print(f"        \"story_file\": {story_file_expr},")
    print(_format_list("security_targets", security_targets, indent_base=8))
    print("    },")
    print()

    # ------------------------------------------------------------------
    # Guardrails note
    # ------------------------------------------------------------------
    print("# NOTE: run_story_guardrails.py uses explicit _register_story(...) calls.")
    print("# If this Story should have guardrails, add a _register_story(...) block")
    print("# there manually, choosing an appropriate check function.")
    print()

    return 0


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))


===== FILE: tools\inspect_clients.py =====
import sys
from pathlib import Path

# Ensure repo root is on the Python path (must be BEFORE importing database)
REPO_ROOT = Path(__file__).resolve().parents[1]
sys.path.insert(0, str(REPO_ROOT))

from sqlalchemy import text
from database import SessionLocal


def inspect_clients(limit: int = 5):
    db = SessionLocal()
    try:
        result = db.execute(
            text("SELECT * FROM clients LIMIT :limit"),
            {"limit": limit},
        )
        rows = result.fetchall()

        print(f"\nSample rows from clients (limit {limit}):\n")
        for row in rows:
            print(dict(row._mapping))

    finally:
        db.close()


if __name__ == "__main__":
    inspect_clients()



===== FILE: tools\inspect_db.py =====
import sys
from pathlib import Path

# Ensure repo root is on the Python path
REPO_ROOT = Path(__file__).resolve().parents[1]
sys.path.insert(0, str(REPO_ROOT))

from sqlalchemy import text
from database import SessionLocal


def list_tables():
    db = SessionLocal()
    try:
        result = db.execute(
            text("""
                SELECT table_name
                FROM information_schema.tables
                WHERE table_schema = 'public'
                ORDER BY table_name;
            """)
        )

        tables = [row[0] for row in result.fetchall()]

        print("\nTables in SCV database:\n")
        for t in tables:
            print(f" - {t}")

        print(f"\nTotal tables: {len(tables)}")

    finally:
        db.close()


if __name__ == "__main__":
    list_tables()



===== FILE: tools\inspect_db_schema.py =====
#!/usr/bin/env python
"""
Inspect the current database schema for the SCV backend.

- Imports the SQLAlchemy Base and engine from app_backend.db
- Ensures the repo root is on sys.path so `app_backend` can be imported
- Reflects all tables and prints their columns, types, PK/FK flags, etc.

Usage (from repo root):

    # Human-readable text (default)
    python tools/inspect_db_schema.py

    # Markdown tables (good for docs)
    python tools/inspect_db_schema.py markdown

This script is READ-ONLY with respect to data. It may create tables if they
don't exist yet via `Base.metadata.create_all(bind=engine)`, but it does not
insert, update, or delete any rows.
"""

from __future__ import annotations

import sys
from pathlib import Path
from typing import Any, Dict, List

from sqlalchemy import inspect as sqla_inspect

# ---------------------------------------------------------------------------
# Repo root + sys.path so `app_backend` can be imported
# ---------------------------------------------------------------------------

REPO_ROOT = Path(__file__).resolve().parents[1]
if str(REPO_ROOT) not in sys.path:
    sys.path.insert(0, str(REPO_ROOT))

# Now we can safely import the backend DB objects
from app_backend.db import Base, engine  # type: ignore[import]

# ---------------------------------------------------------------------------
# Core inspection helpers
# ---------------------------------------------------------------------------


def describe_schema() -> Dict[str, List[Dict[str, Any]]]:
    """
    Reflect the database schema via SQLAlchemy's Inspector.

    Returns:
        {
          "table_name": [
            {
              "name": "column_name",
              "type": "VARCHAR(255)",
              "nullable": False,
              "primary_key": True/False,
              "default": <default or None>,
              "fk": "other_table.other_column" or None,
            },
            ...
          ],
          ...
        }
    """
    # Ensure all models have been created (no-op if already present)
    Base.metadata.create_all(bind=engine)

    inspector = sqla_inspect(engine)
    schema: Dict[str, List[Dict[str, Any]]] = {}

    for table_name in inspector.get_table_names():
        pk_info = inspector.get_pk_constraint(table_name) or {}
        pk_cols = set(pk_info.get("constrained_columns") or [])

        fk_map: Dict[str, str] = {}
        for fk in inspector.get_foreign_keys(table_name):
            ref_table = fk.get("referred_table")
            ref_cols = fk.get("referred_columns") or []
            constrained_cols = fk.get("constrained_columns") or []
            for col_name, ref_col in zip(constrained_cols, ref_cols):
                fk_map[col_name] = f"{ref_table}.{ref_col}"

        col_infos: List[Dict[str, Any]] = []
        for col in inspector.get_columns(table_name):
            name = col["name"]
            col_infos.append(
                {
                    "name": name,
                    "type": str(col["type"]),
                    "nullable": bool(col.get("nullable", True)),
                    "primary_key": name in pk_cols,
                    "default": col.get("default"),
                    "fk": fk_map.get(name),
                }
            )

        schema[table_name] = col_infos

    return schema


def print_text(schema: Dict[str, List[Dict[str, Any]]]) -> None:
    """Pretty, human-readable text output."""
    if not schema:
        print("No tables found in the database.")
        return

    for table_name in sorted(schema.keys()):
        print(f"\n=== {table_name} ===")
        for col in schema[table_name]:
            flags: List[str] = []
            if col["primary_key"]:
                flags.append("PK")
            if col["fk"]:
                flags.append(f"FK -> {col['fk']}")
            if not col["nullable"]:
                flags.append("NOT NULL")

            flag_part = f" ({', '.join(flags)})" if flags else ""
            print(f"- {col['name']}: {col['type']}{flag_part}")


def print_markdown(schema: Dict[str, List[Dict[str, Any]]]) -> None:
    """Markdown table output (useful for docs/MissionAtlas)."""
    if not schema:
        print("No tables found in the database.")
        return

    for table_name in sorted(schema.keys()):
        print(f"\n### {table_name}\n")
        print("| Column | Type | Flags | Default |")
        print("|--------|------|-------|---------|")
        for col in schema[table_name]:
            flags: List[str] = []
            if col["primary_key"]:
                flags.append("PK")
            if col["fk"]:
                flags.append(f"FK -> {col['fk']}")
            if not col["nullable"]:
                flags.append("NOT NULL")

            flag_str = ", ".join(flags) if flags else ""
            default_str = str(col["default"]) if col["default"] is not None else ""
            print(f"| {col['name']} | {col['type']} | {flag_str} | {default_str} |")


# ---------------------------------------------------------------------------
# Entrypoint
# ---------------------------------------------------------------------------


def main(argv: List[str]) -> int:
    fmt = (argv[0].lower() if argv else "text").strip()

    schema = describe_schema()
    if fmt == "markdown":
        print_markdown(schema)
    else:
        print_text(schema)

    return 0


if __name__ == "__main__":
    raise SystemExit(main(sys.argv[1:]))



===== FILE: tools\inspect_table_cols.py =====
import sys
from pathlib import Path

# Ensure repo root is on the Python path BEFORE imports
REPO_ROOT = Path(__file__).resolve().parents[1]
sys.path.insert(0, str(REPO_ROOT))

from sqlalchemy import text
from database import SessionLocal


def show_columns(table_name: str):
    db = SessionLocal()
    try:
        rows = db.execute(
            text("""
                SELECT column_name, data_type
                FROM information_schema.columns
                WHERE table_schema = 'public'
                  AND table_name = :t
                ORDER BY ordinal_position
            """),
            {"t": table_name},
        ).fetchall()

        print(f"\nColumns for {table_name}:\n")
        for r in rows:
            print(f" - {r[0]} ({r[1]})")

    finally:
        db.close()


if __name__ == "__main__":
    for t in ["accounts", "client_operational_state", "match_decisions"]:
        show_columns(t)



===== FILE: tools\normalize_status_frontmatter_schema.py =====
#!/usr/bin/env python
"""
Normalize MissionDestination front matter and hierarchy:

1) Epics
   - Keep ONLY `overall_status` as a status field.
   - Remove other status/adherence fields (testing_status, guardrail_adherence, etc).
   - Regenerate `features:` list from Features' `epic` mappings
     (story -> feature -> epic is the golden source).

2) Features
   - Keep ONLY `overall_status` as a status field.
   - Remove other status/adherence fields and any old mapping blocks.
   - Regenerate `stories:` list from Stories' `feature` mappings.

3) Stories
   - Remove stray `status:` scalar if present (do NOT touch `overall_status`).
   - Ensure full status schema (MVP + non-MVP) exists in front matter:
       overall_status
       testing_status
       halo_adherence
       guardrail_adherence
       code_quality_adherence
       security_policy_adherence
       policy_adherence
       technology_lineage_adherence
       business_data_lineage_adherence
       self_healing_adherence
       analytics_adherence
     preserving existing values and only filling in defaults when missing.

This script is intended to be run manually:

    python tools/normalize_status_frontmatter_schema.py
"""

from __future__ import annotations

from pathlib import Path
from typing import Dict, List, Optional
import re

# ---------------------------------------------------------------------------
# Paths
# ---------------------------------------------------------------------------

REPO_ROOT = Path(__file__).resolve().parents[1]
EPICS_DIR = REPO_ROOT / "docs" / "mission_destination" / "epics"
FEATURES_DIR = REPO_ROOT / "docs" / "mission_destination" / "features"
STORIES_DIR = REPO_ROOT / "docs" / "mission_destination" / "stories"


# ---------------------------------------------------------------------------
# Basic helpers
# ---------------------------------------------------------------------------

def _read(path: Path) -> str:
    return path.read_text(encoding="utf-8")


def _write(path: Path, text: str) -> None:
    path.write_text(text, encoding="utf-8")


def _extract_scalar(text: str, key: str) -> Optional[str]:
    """
    Extract 'key: value' from front matter. Returns the value or None.
    Very simple line-based parser; assumes `key: value` is on a single line.
    """
    pattern = rf"^{re.escape(key)}:\s*(.+)$"
    m = re.search(pattern, text, flags=re.MULTILINE)
    if not m:
        return None
    val = m.group(1).strip()
    if val and val[0] in {"'", '"'} and val[-1:] == val[0]:
        val = val[1:-1]
    return val or None


def _replace_scalar(text: str, key: str, value: str) -> str:
    """
    Replace or insert 'key: value' in the front matter.

    - If the key exists, replace its first occurrence.
    - Otherwise insert before `last_updated:` if present, else append at end.
    """
    pattern = rf"^{re.escape(key)}:\s*.*$"
    replacement = f"{key}: {value}"

    if re.search(pattern, text, flags=re.MULTILINE):
        return re.sub(pattern, replacement, text, count=1, flags=re.MULTILINE)

    # Insert before last_updated: if present
    lu_pattern = r"^last_updated:\s*.*$"
    m = re.search(lu_pattern, text, flags=re.MULTILINE)
    if m:
        start = m.start()
        return text[:start] + replacement + "\n" + text[start:]

    # Fallback: append
    if not text.endswith("\n"):
        text += "\n"
    return text + replacement + "\n"


def _remove_block(text: str, key: str) -> str:
    """
    Remove a scalar or YAML block starting with `key:` at the beginning of a line.

    Matches, for example:

      key: something
        child1: ...
        - list item
      <stops when a non-indented line is reached>
    """
    pattern = rf"^{re.escape(key)}:.*\n(?:^[ \t].*\n)*"
    return re.sub(pattern, "", text, flags=re.MULTILINE)


def _extract_yaml_list(text: str, key: str) -> List[str]:
    """
    Extract:

      key:
        - item1
        - item2

    Returns ['item1', 'item2'].
    """
    pattern = rf"^{re.escape(key)}:\s*\n(?P<body>(?:\s+- .*\n)+)"
    m = re.search(pattern, text, flags=re.MULTILINE)
    if not m:
        return []
    body = m.group("body")
    items: List[str] = []
    for line in body.splitlines():
        s = line.strip()
        if s.startswith("- "):
            val = s[2:].strip()
            if val:
                items.append(val)
    return items


def _replace_yaml_list(text: str, key: str, items: List[str]) -> str:
    """
    Replace or insert a YAML list block:

      key:
        - item1
        - item2

    If `items` is empty, any existing block is removed.
    """
    block_pattern = rf"^{re.escape(key)}:\s*\n(?:\s+- .*\n)*"

    if not items:
        # Remove any existing list block for this key
        return re.sub(block_pattern, "", text, flags=re.MULTILINE)

    new_block = key + ":\n" + "".join(f"  - {item}\n" for item in items)

    if re.search(block_pattern, text, flags=re.MULTILINE):
        return re.sub(block_pattern, new_block + "\n", text, count=1, flags=re.MULTILINE)

    # Insert before overall_status if present, otherwise before last_updated,
    # otherwise append near the top.
    os_pattern = r"^overall_status:\s*.*$"
    m = re.search(os_pattern, text, flags=re.MULTILINE)
    if m:
        start = m.start()
        return text[:start] + new_block + "\n" + text[start:]

    lu_pattern = r"^last_updated:\s*.*$"
    m = re.search(lu_pattern, text, flags=re.MULTILINE)
    if m:
        start = m.start()
        return text[:start] + new_block + "\n" + text[start:]

    # Fallback: append after first line of front matter
    return text + ("\n" if not text.endswith("\n") else "") + new_block + "\n"


# ---------------------------------------------------------------------------
# 1. Normalise Epics
# ---------------------------------------------------------------------------

EPIC_STATUS_KEYS_TO_REMOVE = {
    "testing_status",
    "halo_adherence",
    "guardrail_adherence",
    "code_quality_adherence",
    "security_policy_adherence",
    "feature_statuses",   # old rollup mapping
}


def normalize_epic_frontmatter() -> int:
    print(f"=== Normalising Epic front matter in {EPICS_DIR} ===")
    updated = 0

    for path in sorted(EPICS_DIR.glob("*.md")):
        text = _read(path)
        original = text

        # Strip non-overall status fields
        for key in EPIC_STATUS_KEYS_TO_REMOVE:
            text = _remove_block(text, key)

        if text != original:
            _write(path, text)
            updated += 1
            print(f"  updated {path.relative_to(REPO_ROOT)}")

    print(f"Epics updated (status cleanup): {updated}")
    return updated


# ---------------------------------------------------------------------------
# 2. Normalise Features
# ---------------------------------------------------------------------------

FEATURE_STATUS_KEYS_TO_REMOVE = {
    "testing_status",
    "halo_adherence",
    "guardrail_adherence",
    "code_quality_adherence",
    "security_policy_adherence",
    "story_statuses",     # old rollup mapping
}


def normalize_feature_frontmatter() -> int:
    print(f"=== Normalising Feature front matter in {FEATURES_DIR} ===")
    updated = 0

    for path in sorted(FEATURES_DIR.glob("*.md")):
        text = _read(path)
        original = text

        for key in FEATURE_STATUS_KEYS_TO_REMOVE:
            text = _remove_block(text, key)

        if text != original:
            _write(path, text)
            updated += 1
            print(f"  updated {path.relative_to(REPO_ROOT)}")

    print(f"Features updated (status cleanup): {updated}")
    return updated


# ---------------------------------------------------------------------------
# 3. Normalise Stories
# ---------------------------------------------------------------------------

STORY_STATUS_DEFAULTS: Dict[str, str] = {
    # Overall status of story (Planned / In Progress / Complete)
    "overall_status": "Planned",

    # MVP status dimensions
    "testing_status": "not_run",
    # For MVP, halo is effectively defaulted to pass
    "halo_adherence": "pass",
    "guardrail_adherence": "not_run",
    "code_quality_adherence": "not_run",
    "security_policy_adherence": "not_run",

    # Non-MVP but part of full schema (all default 'not_run')
    "policy_adherence": "not_run",
    "technology_lineage_adherence": "not_run",
    "business_data_lineage_adherence": "not_run",
    "self_healing_adherence": "not_run",
    "analytics_adherence": "not_run",
}


def normalize_story_frontmatter() -> int:
    print(f"=== Normalising Story front matter in {STORIES_DIR} ===")
    updated = 0

    for path in sorted(STORIES_DIR.glob("*.md")):
        text = _read(path)
        original = text

        story_id = _extract_scalar(text, "story_id")
        if not story_id:
            continue  # ignore non-story docs

        # Remove stray 'status:' scalar (do NOT touch overall_status)
        text = re.sub(
            r"^status:\s*.*\n",
            "",
            text,
            flags=re.MULTILINE,
        )

        # Ensure all status fields exist, do not overwrite existing values
        for key, default in STORY_STATUS_DEFAULTS.items():
            existing = _extract_scalar(text, key)
            if existing is None:
                text = _replace_scalar(text, key, default)

        if text != original:
            _write(path, text)
            updated += 1
            print(f"  updated {path.relative_to(REPO_ROOT)}")

    print(f"Stories updated (status schema + stray status): {updated}")
    return updated


# ---------------------------------------------------------------------------
# 4. Sync hierarchy lists using golden mapping
# ---------------------------------------------------------------------------

def sync_hierarchy_lists() -> None:
    """
    Make `features:` lists in Epics and `stories:` lists in Features consistent
    with the golden mapping:

        Story.frontmatter.feature  -> Feature.feature_id
        Feature.frontmatter.epic   -> Epic.epic_id
    """
    print("=== Syncing Epic.features and Feature.stories from golden mapping ===")

    # Build feature_id -> epic_id mapping and epic_id -> [feature_ids]
    feature_to_epic: Dict[str, str] = {}
    epic_to_features: Dict[str, List[str]] = {}

    for path in sorted(FEATURES_DIR.glob("*.md")):
        text = _read(path)
        feature_id = _extract_scalar(text, "feature_id")
        epic_id = _extract_scalar(text, "epic")
        if not feature_id or not epic_id:
            continue
        feature_to_epic[feature_id] = epic_id
        epic_to_features.setdefault(epic_id, []).append(feature_id)

    # Build story_id -> feature_id mapping and feature_id -> [story_ids]
    feature_to_stories: Dict[str, List[str]] = {}

    for path in sorted(STORIES_DIR.glob("*.md")):
        text = _read(path)
        story_id = _extract_scalar(text, "story_id")
        feature_id = _extract_scalar(text, "feature")
        if not story_id or not feature_id:
            continue
        feature_to_stories.setdefault(feature_id, []).append(story_id)

    # Normalise ordering
    for eid, lst in epic_to_features.items():
        epic_to_features[eid] = sorted(set(lst))
    for fid, lst in feature_to_stories.items():
        feature_to_stories[fid] = sorted(set(lst))

    # Update Epics: features list
    epic_updates = 0
    for path in sorted(EPICS_DIR.glob("*.md")):
        text = _read(path)
        original = text

        epic_id = _extract_scalar(text, "epic_id")
        if not epic_id:
            continue

        features_list = epic_to_features.get(epic_id, [])
        text = _replace_yaml_list(text, "features", features_list)

        if text != original:
            _write(path, text)
            epic_updates += 1
            print(f"  synced features list for epic {epic_id} ({path.relative_to(REPO_ROOT)})")

    # Update Features: stories list
    feature_updates = 0
    for path in sorted(FEATURES_DIR.glob("*.md")):
        text = _read(path)
        original = text

        feature_id = _extract_scalar(text, "feature_id")
        if not feature_id:
            continue

        stories_list = feature_to_stories.get(feature_id, [])
        text = _replace_yaml_list(text, "stories", stories_list)

        if text != original:
            _write(path, text)
            feature_updates += 1
            print(f"  synced stories list for feature {feature_id} ({path.relative_to(REPO_ROOT)})")

    print(f"Hierarchy sync complete: epics_updated={epic_updates}, features_updated={feature_updates}")


# ---------------------------------------------------------------------------
# CLI
# ---------------------------------------------------------------------------

def main() -> int:
    print("=== Normalising MissionDestination front matter & hierarchy ===")
    print(f"Repo root: {REPO_ROOT}")

    normalize_epic_frontmatter()
    normalize_feature_frontmatter()
    normalize_story_frontmatter()
    sync_hierarchy_lists()

    print("=== Done normalising ===")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())


===== FILE: tools\normalize_story_frontmatter.py =====
#!/usr/bin/env python

from pathlib import Path
import re

REPO_ROOT = Path(__file__).resolve().parents[1]
STORIES_DIR = REPO_ROOT / "docs" / "mission_destination" / "stories"


def remove_implementation_presence(text: str) -> str:
    """
    Remove lines like:
      implementation_presence: false
    from the front matter.
    """
    return re.sub(
        r"^implementation_presence:\s*.*\n",
        "",
        text,
        flags=re.MULTILINE,
    )


def ensure_halo_pass(text: str) -> str:
    """
    Ensure there's a line:
      halo_adherence: pass

    - If halo_adherence already exists, set it to 'pass'.
    - If not, insert it before last_updated: if present,
      otherwise append near the end of the front matter.
    """
    pattern = r"^halo_adherence:\s*.*$"
    replacement = "halo_adherence: pass"

    # Case 1: replace existing line
    if re.search(pattern, text, flags=re.MULTILINE):
        return re.sub(pattern, replacement, text, count=1, flags=re.MULTILINE)

    # Case 2: insert before last_updated if present
    lu_pattern = r"^last_updated:\s*.*$"
    m = re.search(lu_pattern, text, flags=re.MULTILINE)
    if m:
        start = m.start()
        return text[:start] + replacement + "\n" + text[start:]

    # Case 3: append at end
    if not text.endswith("\n"):
        text += "\n"
    return text + replacement + "\n"


def main() -> int:
    print("=== Normalising story front matter ===")
    print(f"Stories dir: {STORIES_DIR}")

    updated = 0

    for path in sorted(STORIES_DIR.glob("*.md")):
        text = path.read_text(encoding="utf-8")
        new_text = remove_implementation_presence(text)
        new_text = ensure_halo_pass(new_text)

        if new_text != text:
            path.write_text(new_text, encoding="utf-8")
            updated += 1
            print(f"  updated {path.name}")

    print(f"Done. Updated {updated} story files.")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())


===== FILE: tools\repo_sync_one_liner.txt =====
git checkout main
git pull
git add .
git commit -m "Sync"
git push



===== FILE: tools\reset_overall_status_planned.py =====
#!/usr/bin/env python
"""
Reset all MissionDestination Story overall_status to 'Planned'.

We will then manually update a small number of stories to 'In Progress'
or 'Complete' and let rollup_statuses.py aggregate from there.
"""

from __future__ import annotations

import re
from pathlib import Path
from typing import Optional

REPO_ROOT = Path(__file__).resolve().parents[1]
STORIES_DIR = REPO_ROOT / "docs" / "mission_destination" / "stories"


def _read(path: Path) -> str:
    return path.read_text(encoding="utf-8")


def _write(path: Path, text: str) -> None:
    path.write_text(text, encoding="utf-8")


def _extract_scalar(text: str, key: str) -> Optional[str]:
    pattern = rf"^{re.escape(key)}:\s*(.+)$"
    m = re.search(pattern, text, flags=re.MULTILINE)
    if not m:
        return None
    val = m.group(1).strip()
    if val and val[0] in {"'", '"'} and val[-1:] == val[0]:
        val = val[1:-1]
    return val or None


def _replace_scalar(text: str, key: str, value: str) -> str:
    pattern = rf"^{re.escape(key)}:\s*.*$"
    replacement = f"{key}: {value}"

    if re.search(pattern, text, flags=re.MULTILINE):
        return re.sub(pattern, replacement, text, count=1, flags=re.MULTILINE)

    # insert before last_updated: if present
    lu_pattern = r"^last_updated:\s*.*$"
    m = re.search(lu_pattern, text, flags=re.MULTILINE)
    if m:
        start = m.start()
        return text[:start] + replacement + "\n" + text[start:]

    # else append at end
    if not text.endswith("\n"):
        text += "\n"
    return text + replacement + "\n"


def main() -> int:
    print("=== Resetting Story overall_status to Planned ===")
    print(f"Stories dir: {STORIES_DIR}")

    for path in sorted(STORIES_DIR.glob("*.md")):
        text = _read(path)
        story_id = _extract_scalar(text, "story_id")
        if not story_id:
            continue

        new_text = _replace_scalar(text, "overall_status", "Planned")
        if new_text != text:
            _write(path, new_text)
            print(f">>> {story_id}: overall_status -> Planned")

    print("=== Done ===")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())


===== FILE: tools\rollup_statuses.py =====
#!/usr/bin/env python
"""
Mission Control Overall Status Roll-up

Responsibilities:
- For each Story:
    - Derive overall_status from its testing / halo / guardrail /
      code-quality / security fields (MVP dimensions only).
- Aggregate Story overall_status up to Feature overall_status.
- Aggregate Feature overall_status up to Epic overall_status.

Rules
=====

Story overall_status (MVP):

Let dims = {
  testing_status,
  halo_adherence,
  guardrail_adherence,
  code_quality_adherence,
  security_policy_adherence
}

Normalise each dim:
  - pass / ok / success / compliant     -> Complete
  - fail / error / non_compliant        -> In Progress
  - not_run / planned / empty / missing -> Planned

Then:
  - Complete  if all dims Complete
  - Planned   if all dims Planned
  - In Progress otherwise

Feature overall_status:
  - Planned   if all child Stories Planned
  - Complete  if all child Stories Complete
  - In Progress otherwise

Epic overall_status:
  - Planned   if all child Features Planned
  - Complete  if all child Features Complete
  - In Progress otherwise

IMPORTANT:
- We ONLY ever write 'overall_status' + 'last_updated' fields.
- We NEVER touch the individual Story dimensions directly.
- We NEVER change the Storyâ†’Feature or Featureâ†’Epic mapping;
  we only *read*:
    - Story.frontmatter.feature
    - Feature.frontmatter.epic
"""

from __future__ import annotations

import re
from datetime import datetime, timezone
from pathlib import Path
from typing import Dict, List, Optional

REPO_ROOT = Path(__file__).resolve().parents[1]

STORIES_DIR = REPO_ROOT / "docs" / "mission_destination" / "stories"
FEATURES_DIR = REPO_ROOT / "docs" / "mission_destination" / "features"
EPICS_DIR = REPO_ROOT / "docs" / "mission_destination" / "epics"


# -------------------- basic helpers -------------------- #


def _read(path: Path) -> str:
    return path.read_text(encoding="utf-8")


def _write(path: Path, text: str) -> None:
    path.write_text(text, encoding="utf-8")


def _extract_scalar(text: str, key: str) -> Optional[str]:
    """
    Extract 'key: value' from front matter. Returns value or None.
    Very simple line-based parser; assumes `key: value` is on one line.
    """
    pattern = rf"^{re.escape(key)}:\s*(.+)$"
    m = re.search(pattern, text, flags=re.MULTILINE)
    if not m:
        return None
    val = m.group(1).strip()
    # strip simple quotes
    if val and val[0] in {'"', "'"} and val[-1:] == val[0]:
        val = val[1:-1]
    return val or None


def _replace_scalar(text: str, key: str, value: str) -> str:
    """
    Replace or insert 'key: value' in the front matter.
    We always insert before 'last_updated' if present, otherwise append.
    """
    pattern = rf"^{re.escape(key)}:\s*.*$"
    replacement = f"{key}: {value}"

    if re.search(pattern, text, flags=re.MULTILINE):
        return re.sub(pattern, replacement, text, count=1, flags=re.MULTILINE)

    # Insert before last_updated: if present
    lu_pattern = r"^last_updated:\s*.*$"
    m = re.search(lu_pattern, text, flags=re.MULTILINE)
    if m:
        start = m.start()
        return text[:start] + replacement + "\n" + text[start:]

    # Fallback: append at end
    if not text.endswith("\n"):
        text += "\n"
    return text + replacement + "\n"


def _now_iso_utc() -> str:
    """
    Current time in ISO UTC, matching the status model docs, e.g.
    2025-01-01T12:00:00Z
    """
    return datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")


def _touch_last_updated(text: str) -> str:
    """
    Ensure last_updated is set to "now" in ISO UTC.
    """
    return _replace_scalar(text, "last_updated", _now_iso_utc())


# -------------------- status helpers -------------------- #


def _norm_overall(raw: Optional[str]) -> str:
    """
    Normalise an overall_status value to:

        Planned | In Progress | Complete
    """
    if raw is None:
        return "Planned"

    t = raw.strip().strip("\"'")
    tl = t.lower()

    if tl == "planned":
        return "Planned"
    if tl in {"in progress", "in_progress", "in-progress", "active"}:
        return "In Progress"
    if tl in {"complete", "completed", "done"}:
        return "Complete"
    return "Planned"


def _aggregate_overall(child_statuses: List[str]) -> Optional[str]:
    """
    Roll-up:

    - Planned   if all children Planned
    - Complete  if all children Complete
    - In Progress otherwise

    Returns None if there are no children.
    """
    if not child_statuses:
        return None
    s = set(child_statuses)
    if s == {"Planned"}:
        return "Planned"
    if s == {"Complete"}:
        return "Complete"
    return "In Progress"


def _norm_dim(raw: Optional[str]) -> str:
    """
    Normalise a Story dimension value into one of:
        Planned | In Progress | Complete

    Used for:
      testing_status
      halo_adherence
      guardrail_adherence
      code_quality_adherence
      security_policy_adherence
    """
    if raw is None:
        return "Planned"

    t = raw.strip().strip("\"'")
    tl = t.lower()

    if tl in {"pass", "ok", "success", "successful", "compliant"}:
        return "Complete"

    if tl in {"fail", "failed", "error", "errors", "non_compliant", "non-compliant"}:
        return "In Progress"

    # Treat not_run, planned, empty, and unknown as Planned (no evidence yet)
    if tl in {"not_run", "not-run", "pending", "planned", ""}:
        return "Planned"

    # Default safely to "In Progress" if it's something unexpected but non-empty
    return "In Progress"


def _derive_story_overall(text: str) -> str:
    """
    Derive Story overall_status from the 5 MVP dimensions.
    """
    dims_keys = [
        "testing_status",
        "halo_adherence",
        "guardrail_adherence",
        "code_quality_adherence",
        "security_policy_adherence",
    ]

    dim_states: List[str] = []
    for key in dims_keys:
        raw = _extract_scalar(text, key)
        dim_states.append(_norm_dim(raw))

    # Aggregate those Planned/In Progress/Complete values
    agg = _aggregate_overall(dim_states)
    if agg is None:
        # shouldn't happen (we always have 5 dims) but be defensive
        return "Planned"
    return agg


# -------------------- roll-up implementation -------------------- #


def rollup_stories() -> Dict[str, Dict[str, str]]:
    """
    Process Stories:

    - Derive Story overall_status from dimension fields.
    - Update overall_status + last_updated when it changes.
    - Build mapping Story -> Feature and Story overall_status.

    Returns:
        {
          "story_status": {story_id: overall_status},
          "story_feature": {story_id: feature_id},
        }
    """
    story_status: Dict[str, str] = {}
    story_feature: Dict[str, str] = {}

    print(">>> Rolling up Story statuses...")
    for path in sorted(STORIES_DIR.glob("*.md")):
        text = _read(path)
        story_id = _extract_scalar(text, "story_id")
        if not story_id:
            continue

        feature_id = _extract_scalar(text, "feature")
        if not feature_id:
            # If a Story is not mapped to a Feature, we skip it for roll-up
            print(f"    [WARN] Story {story_id} has no 'feature' mapping; skipping.")
            continue

        old_overall_raw = _extract_scalar(text, "overall_status")
        old_overall = _norm_overall(old_overall_raw)
        new_overall = _derive_story_overall(text)

        if new_overall != old_overall:
            new_text = _replace_scalar(text, "overall_status", new_overall)
            new_text = _touch_last_updated(new_text)
            _write(path, new_text)
            print(f"    Story {story_id}: {old_overall} -> {new_overall}")
        else:
            # still ensure we store the normalised value
            new_overall = old_overall

        story_status[story_id] = new_overall
        story_feature[story_id] = feature_id

    return {
        "story_status": story_status,
        "story_feature": story_feature,
    }


def rollup_features(story_status: Dict[str, str], story_feature: Dict[str, str]) -> Dict[str, Dict[str, str]]:
    """
    Process Features:

    - Determine child Stories from the Story->Feature mapping.
    - Aggregate their overall_status to Feature overall_status.
    - Update Feature overall_status + last_updated when it changes.
    - Build mapping Feature -> Epic and Feature overall_status.

    Returns:
        {
          "feature_status": {feature_id: overall_status},
          "feature_epic": {feature_id: epic_id},
        }
    """
    # Build feature -> [story_id] from story_feature mapping
    stories_by_feature: Dict[str, List[str]] = {}
    for sid, fid in story_feature.items():
        stories_by_feature.setdefault(fid, []).append(sid)

    feature_status: Dict[str, str] = {}
    feature_epic: Dict[str, str] = {}

    print(">>> Rolling up Feature statuses...")
    for path in sorted(FEATURES_DIR.glob("*.md")):
        text = _read(path)
        feature_id = _extract_scalar(text, "feature_id")
        if not feature_id:
            continue

        epic_id = _extract_scalar(text, "epic")
        if epic_id:
            feature_epic[feature_id] = epic_id

        child_story_ids = stories_by_feature.get(feature_id, [])
        child_overalls = [story_status[sid] for sid in child_story_ids if sid in story_status]

        agg = _aggregate_overall(child_overalls)
        if agg is None:
            # No child stories mapped; leave overall_status as-is
            old = _norm_overall(_extract_scalar(text, "overall_status"))
            feature_status[feature_id] = old
            if not child_story_ids:
                print(f"    [WARN] Feature {feature_id} has no mapped Stories; leaving status as {old}.")
            else:
                print(f"    [WARN] Feature {feature_id} has Stories but none with known status; leaving as {old}.")
            continue

        old_overall = _norm_overall(_extract_scalar(text, "overall_status"))
        new_overall = agg

        if new_overall != old_overall:
            new_text = _replace_scalar(text, "overall_status", new_overall)
            new_text = _touch_last_updated(new_text)
            _write(path, new_text)
            print(f"    Feature {feature_id}: {old_overall} -> {new_overall}")
        else:
            new_overall = old_overall

        feature_status[feature_id] = new_overall

    return {
        "feature_status": feature_status,
        "feature_epic": feature_epic,
    }


def rollup_epics(feature_status: Dict[str, str], feature_epic: Dict[str, str]) -> None:
    """
    Process Epics:

    - Determine child Features from the Feature->Epic mapping.
    - Aggregate their overall_status to Epic overall_status.
    - Update Epic overall_status + last_updated when it changes.
    """
    # Build epic -> [feature_id] from feature_epic mapping
    features_by_epic: Dict[str, List[str]] = {}
    for fid, eid in feature_epic.items():
        features_by_epic.setdefault(eid, []).append(fid)

    print(">>> Rolling up Epic statuses...")
    for path in sorted(EPICS_DIR.glob("*.md")):
        text = _read(path)
        epic_id = _extract_scalar(text, "epic_id")
        if not epic_id:
            continue

        child_feature_ids = features_by_epic.get(epic_id, [])
        child_overalls = [feature_status[fid] for fid in child_feature_ids if fid in feature_status]

        agg = _aggregate_overall(child_overalls)
        if agg is None:
            old = _norm_overall(_extract_scalar(text, "overall_status"))
            if not child_feature_ids:
                print(f"    [WARN] Epic {epic_id} has no mapped Features; leaving status as {old}.")
            else:
                print(f"    [WARN] Epic {epic_id} has Features but none with known status; leaving as {old}.")
            continue

        old_overall = _norm_overall(_extract_scalar(text, "overall_status"))
        new_overall = agg

        if new_overall != old_overall:
            new_text = _replace_scalar(text, "overall_status", new_overall)
            new_text = _touch_last_updated(new_text)
            _write(path, new_text)
            print(f"    Epic {epic_id}: {old_overall} -> {new_overall}")


# -------------------- CLI -------------------- #


def main() -> int:
    print("=== Mission Control Overall Status Roll-up ===")
    print(f"Repo root: {REPO_ROOT}")

    story_maps = rollup_stories()
    feature_maps = rollup_features(
        story_status=story_maps["story_status"],
        story_feature=story_maps["story_feature"],
    )
    rollup_epics(
        feature_status=feature_maps["feature_status"],
        feature_epic=feature_maps["feature_epic"],
    )

    print("=== Roll-up complete. ===")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())


===== FILE: tools\run_story_guardrails.py =====
#!/usr/bin/env python
"""
Run guardrail checks for one or more Stories and update guardrail_adherence
in each Story's front matter.

For the MVP, the guardrails we enforce are:

- For ST-00 (backend API availability):
  /health must return HTTP 200 with JSON {"status": "ok"}.

- For ST-03 / ST-04 (Client Profile stories):
  ClientProfileService.get_client_profile(...) must return a structure
  that matches the ClientProfile dataclass fields and types.

- For ST-09 (Match by tax ID):
  ClientProfileService.match_by_tax_id(...) must return only profiles
  whose raw_sources contain the requested tax_id.
"""

from __future__ import annotations

import dataclasses
import json
import re
import sys
from pathlib import Path
from typing import Any, Dict, List, Tuple, Callable

# ---------------------------------------------------------------------------
# Repo root + sys.path fix so "src" can be imported
# ---------------------------------------------------------------------------

REPO_ROOT = Path(__file__).resolve().parents[1]

# Ensure the repo root is on sys.path so that imports work when this
# script is run as `python tools/run_story_guardrails.py`.
if str(REPO_ROOT) not in sys.path:
    sys.path.insert(0, str(REPO_ROOT))

# ---------------------------------------------------------------------------
# Story configuration
# ---------------------------------------------------------------------------

# Each entry defines:
# - story_file: the markdown Story file
# - check_func: a callable that performs guardrail checks and returns (passed, message)
STORY_CONFIG: Dict[str, Dict[str, Any]] = {}


def _register_story(
    story_id: str,
    story_file: Path,
    check_func: Callable[[], Tuple[bool, str]],
) -> None:
    STORY_CONFIG[story_id] = {
        "story_file": story_file,
        "check_func": check_func,
    }


# ---------------------------------------------------------------------------
# Guardrail checks
# ---------------------------------------------------------------------------


def check_backend_health_endpoint() -> Tuple[bool, str]:
    """
    Guardrail for ST-00-backend-api-availability.

    Rules:
    - Import the FastAPI app from app_backend.main
    - Call /health via TestClient
    - Must return HTTP 200
    - JSON body must contain {"status": "ok"}
    """
    try:
        from fastapi.testclient import TestClient
        from app_backend.main import app
    except Exception as exc:  # pragma: no cover
        return False, f"Import error in health guardrail check: {exc!r}"

    try:
        client = TestClient(app)
        response = client.get("/health")
    except Exception as exc:  # pragma: no cover
        return False, f"Error calling /health in guardrail check: {exc!r}"

    if response.status_code != 200:
        return False, f"/health returned HTTP {response.status_code}, expected 200."

    try:
        data = response.json()
    except Exception as exc:  # pragma: no cover
        return False, f"/health did not return valid JSON: {exc!r}"

    if not isinstance(data, dict):
        return False, f"/health JSON payload must be an object; got {type(data).__name__}."

    status_value = data.get("status")
    if status_value != "ok":
        return False, f"/health JSON status must be 'ok'; got {status_value!r}."

    return True, "/health returns 200 with JSON {'status': 'ok'}."


def check_client_profile_data_model_adherence() -> Tuple[bool, str]:
    """
    Guardrail for ClientProfile-producing Stories (ST-03, ST-04).

    Rules:
    - get_client_profile(.) must return a dict
    - Keys of that dict must be a subset of ClientProfile fields
    - Required fields (client_id, name) must be present
    - identifiers must be a List[ClientIdentifier]
    - addresses must be a List[ClientAddress]
    - lineage, quality, metadata, raw_sources must be dicts
    """
    try:
        from src.services.client_profile.service import ClientProfileService
        from src.domain.models.client_profile import (
            ClientProfile,
            ClientIdentifier,
            ClientAddress,
        )
    except Exception as exc:  # pragma: no cover
        return False, f"Import error in guardrail check: {exc!r}"

    service = ClientProfileService()

    # Use the same client_id as the tests; this exercises the normal path
    profile = service.get_client_profile("123")

    if not isinstance(profile, dict):
        return False, "get_client_profile must return a dict derived from ClientProfile."

    # 1) Keys must match the ClientProfile dataclass (no unexpected fields)
    allowed_fields = {f.name for f in dataclasses.fields(ClientProfile)}
    keys = set(profile.keys())
    extra_fields = keys - allowed_fields
    if extra_fields:
        return False, f"Output contains fields not in ClientProfile: {sorted(extra_fields)}"

    required_fields = {"client_id", "name"}
    missing = required_fields - keys
    if missing:
        return False, f"Output is missing required fields: {sorted(missing)}"

    # 2) identifiers must be a list of ClientIdentifier instances
    identifiers = profile.get("identifiers")
    if not isinstance(identifiers, list):
        return False, "identifiers must be a list of ClientIdentifier."
    for idx, item in enumerate(identifiers):
        if not isinstance(item, ClientIdentifier):
            return False, f"identifiers[{idx}] is not a ClientIdentifier instance."

    # 3) addresses must be a list of ClientAddress instances
    addresses = profile.get("addresses")
    if not isinstance(addresses, list):
        return False, "addresses must be a list of ClientAddress."
    for idx, addr in enumerate(addresses):
        if not isinstance(addr, ClientAddress):
            return False, f"addresses[{idx}] is not a ClientAddress instance."

    # 4) lineage, quality, metadata, raw_sources should be dicts
    for field_name in ["lineage", "quality", "metadata", "raw_sources"]:
        value = profile.get(field_name)
        if not isinstance(value, dict):
            return False, f"{field_name} must be a dict; got {type(value).__name__}"

    return True, "Output adheres to ClientProfile data model."


def check_st_09_match_by_tax_id() -> Tuple[bool, str]:
    """
    Guardrail for ST-09 (Match by tax ID).

    Rules:
    - match_by_tax_id returns a list.
    - It returns only profiles whose raw sources contain the given tax_id.
    """
    try:
        from src.services.client_profile.service import ClientProfileService
    except Exception as exc:  # pragma: no cover
        return False, f"Import error in ST-09 guardrail check: {exc!r}"

    service = ClientProfileService()

    # Patch CRM source first
    service._mock_crm_source = lambda client_id: {
        "_source": "CRM",
        "identifier": "crm-123",
        "name": "Alice Example",
        "email": "alice@example.com",
        "country": "UK",
        "tax_id": "TAX-001",
    } if client_id == "123" else {"_source": "CRM"}

    # ðŸ”¥ IMPORTANT:
    # After patching, rebuild the sources list so we use the patched function.
    service.sources = [service._mock_crm_source, service._mock_kyc_source]

    # Now generate a profile containing that tax_id
    profile = service.get_client_profile("123")
    profiles = [profile]

    # Act
    matches = service.match_by_tax_id(profiles, "TAX-001")

    # Checks
    if not isinstance(matches, list):
        return False, "ST-09: match_by_tax_id must return a list."

    if len(matches) != 1:
        return False, f"ST-09: expected exactly one match, got {len(matches)}."

    match = matches[0]
    raw_sources = match.get("raw_sources", {})
    crm_source = raw_sources.get("CRM", {})

    if crm_source.get("tax_id") != "TAX-001":
        return False, "ST-09: matched profile does not contain the requested tax_id in raw_sources."

    return True, "ST-09: match_by_tax_id returns only profiles with the requested tax_id."



# ---------------------------------------------------------------------------
# Register stories and their guardrails
# ---------------------------------------------------------------------------

_register_story(
    "ST-00",
    REPO_ROOT
    / "docs"
    / "mission_destination"
    / "stories"
    / "ST-00-backend-api-availability.md",
    check_backend_health_endpoint,
)

_register_story(
    "ST-03",
    REPO_ROOT
    / "docs"
    / "mission_destination"
    / "stories"
    / "ST-03_map_identity_fields.md",
    check_client_profile_data_model_adherence,
)

_register_story(
    "ST-04",
    REPO_ROOT
    / "docs"
    / "mission_destination"
    / "stories"
    / "ST-04_map_identifiers.md",
    check_client_profile_data_model_adherence,
)

_register_story(
    "ST-09",
    REPO_ROOT
    / "docs"
    / "mission_destination"
    / "stories"
    / "ST-09_match_by_tax_id.md",
    check_st_09_match_by_tax_id,
)


# ---------------------------------------------------------------------------
# Helpers: evidence + front-matter update
# ---------------------------------------------------------------------------


def write_guardrail_evidence(
    story_id: str,
    passed: bool,
    message: str,
) -> Path:
    """
    Write a JSON evidence file for guardrail adherence for this Story.
    """
    results_dir = REPO_ROOT / "evidence" / "guardrails"
    results_dir.mkdir(parents=True, exist_ok=True)

    evidence_path = results_dir / f"{story_id}.json"
    payload = {
        "story_id": story_id,
        "passed": passed,
        "message": message,
    }
    evidence_path.write_text(json.dumps(payload, indent=2), encoding="utf-8")
    print(f">>> Wrote guardrail evidence for {story_id} to {evidence_path.relative_to(REPO_ROOT)}")
    return evidence_path


def update_story_guardrail_adherence(story_file: Path, passed: bool) -> None:
    """
    Replace the first 'guardrail_adherence: ...' line in the Story's front matter.
    """
    if not story_file.exists():
        raise FileNotFoundError(f"Story file not found: {story_file}")

    status = "pass" if passed else "fail"

    text = story_file.read_text(encoding="utf-8")

    pattern = r"(^guardrail_adherence:\s*).*$"
    replacement = rf"\1{status}"
    new_text, count = re.subn(pattern, replacement, text, count=1, flags=re.MULTILINE)

    if count == 0:
        raise RuntimeError(
            f"Story file {story_file} does not contain a guardrail_adherence line to update."
        )

    story_file.write_text(new_text, encoding="utf-8")
    rel = story_file.relative_to(REPO_ROOT)
    print(f">>> Updated {rel} -> guardrail_adherence: {status}")


def run_guardrail_for_story(story_id: str) -> Tuple[bool, str]:
    """
    Run the guardrail check for a single Story:
    - execute the check function
    - write evidence
    - update front matter
    Returns (passed, message).
    """
    config = STORY_CONFIG[story_id]
    story_file: Path = config["story_file"]  # type: ignore[assignment]
    check_func: Callable[[], Tuple[bool, str]] = config["check_func"]  # type: ignore[assignment]

    print(f">>> Running guardrail checks for Story {story_id}")
    passed, message = check_func()

    write_guardrail_evidence(story_id, passed, message)
    update_story_guardrail_adherence(story_file, passed)

    status = "pass" if passed else "fail"
    print(f">>> Story {story_id} guardrail_adherence set to {status}: {message}")
    return passed, message


# ---------------------------------------------------------------------------
# CLI entrypoint
# ---------------------------------------------------------------------------


def main(argv: List[str]) -> int:
    """
    Usage:
      python tools/run_story_guardrails.py           # run for all configured Stories
      python tools/run_story_guardrails.py ST-03     # run for a single Story
    """
    if len(argv) > 1:
        story_id = argv[1].upper()
        if story_id not in STORY_CONFIG:
            print(f"ERROR: Story {story_id!r} is not configured in STORY_CONFIG.")
            print(f"Known stories: {', '.join(sorted(STORY_CONFIG.keys()))}")
            return 1
        requested_ids = [story_id]
    else:
        requested_ids = sorted(STORY_CONFIG.keys())

    overall_exit = 0
    for sid in requested_ids:
        print(f"\n=== Guardrails for Story {sid} ===")
        passed, _ = run_guardrail_for_story(sid)
        if not passed:
            overall_exit = 1

    return overall_exit


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))


===== FILE: tools\run_story_lint.py =====
#!/usr/bin/env python
"""
Run linting for one or more Stories and update code_quality_adherence
in each Story's front matter.

MVP:
- Use Ruff to lint the Story's Python files.
- If any issues are reported, mark as fail.
- Otherwise mark as pass.
"""

from __future__ import annotations

import json
import re
import subprocess
import sys
from pathlib import Path
from typing import Any, Dict, List, Tuple

# ---------------------------------------------------------------------------
# Repo root + sys.path
# ---------------------------------------------------------------------------

REPO_ROOT = Path(__file__).resolve().parents[1]
if str(REPO_ROOT) not in sys.path:
    sys.path.insert(0, str(REPO_ROOT))


# ---------------------------------------------------------------------------
# Story configuration
# ---------------------------------------------------------------------------

# For each Story:
# - story_file: markdown Story file
# - lint_targets: list of Python files to lint with Ruff
STORY_CONFIG: Dict[str, Dict[str, Any]] = {
    "ST-03": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-03_map_identity_fields.md",
        "lint_targets": [
            "src/services/client_profile/service.py",
            "src/domain/models/client_profile.py",
        ],
    },
    "ST-04": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-04_map_identifiers.md",
        "lint_targets": [
            "src/services/client_profile/service.py",
            "src/domain/models/client_profile.py",
        ],
    },
    "ST-09": {
    "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-09_match_by_tax_id.md",
    "lint_targets": [
        "src/services/client_profile/service.py",
    ],
},

    "ST-20": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-20_assemble_base_profile.md",
        "lint_targets": [
            "src/services/client_profile/service.py",
            "src/domain/models/client_profile.py",
        ],
    },
    "ST-30": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-30_audit_ingestion.md",
        "lint_targets": [
            "src/services/audit/service.py",
        ],
    },
     "ST-00": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-00-backend-api-availability.md",
        "lint_targets": [
            "app_backend/main.py",
        ],
    },
     "ST-00-FRONTEND-UI-SHELL": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-00-frontend-ui-shell.md",
        "lint_targets": [
            "app_backend/main.py",
        ],
    },


}


# ---------------------------------------------------------------------------
# Core helpers
# ---------------------------------------------------------------------------

def run_ruff_for_targets(targets: List[str]) -> Tuple[bool, str, List[Dict[str, Any]]]:
    """
    Run Ruff on the given Python files.

    Returns:
      (passed, message, issues)

    Where issues is a minimal list of findings (code, message, location).
    """
    cmd = [
        sys.executable,
        "-m",
        "ruff",
        "check",
        "--output-format",
        "json",
        *targets,
    ]
    print(f">>> Running Ruff: {' '.join(cmd)}")
    try:
        proc = subprocess.run(
            cmd,
            cwd=REPO_ROOT,
            capture_output=True,
            text=True,
            check=False,
        )
    except FileNotFoundError as exc:
        # Ruff not installed / importable in this environment
        return (
            False,
            f"Ruff not available: {exc!r}. Install ruff in this environment.",
            [],
        )

    stdout = proc.stdout or ""
    stderr = proc.stderr or ""

    if not stdout.strip():
        # No JSON output â€“ treat as failure with diagnostic
        return (
            False,
            f"Ruff did not produce JSON output. rc={proc.returncode}, stderr={stderr.strip()}",
            [],
        )

    try:
        data = json.loads(stdout)
    except json.JSONDecodeError as exc:
        return (
            False,
            f"Failed to parse Ruff JSON output: {exc!r}",
            [],
        )

    # Ruff JSON is a list of diagnostics
    issues: List[Dict[str, Any]] = []
    for diag in data:
        issues.append(
            {
                "filename": diag.get("filename"),
                "code": diag.get("code"),
                "message": diag.get("message"),
                "location": diag.get("location"),
            }
        )

    if issues:
        return (
            False,
            f"Ruff reported {len(issues)} code-quality issue(s).",
            issues,
        )

    return True, "No code-quality issues reported by Ruff.", issues


def write_lint_evidence(
    story_id: str,
    targets: List[str],
    passed: bool,
    message: str,
    issues: List[Dict[str, Any]],
) -> Path:
    """
    Write JSON evidence file for lint/code-quality adherence for this Story.
    """
    results_dir = REPO_ROOT / "evidence" / "lint"
    results_dir.mkdir(parents=True, exist_ok=True)

    evidence_path = results_dir / f"{story_id}.json"
    payload = {
        "story_id": story_id,
        "targets": targets,
        "passed": passed,
        "message": message,
        "issues": issues,
    }
    evidence_path.write_text(json.dumps(payload, indent=2), encoding="utf-8")
    print(f">>> Wrote lint evidence for {story_id} to {evidence_path.relative_to(REPO_ROOT)}")
    return evidence_path


def update_story_code_quality_status(story_file: Path, passed: bool) -> None:
    """
    Replace the first 'code_quality_adherence: ...' line in the Story's front matter.
    """
    if not story_file.exists():
        raise FileNotFoundError(f"Story file not found: {story_file}")

    status = "pass" if passed else "fail"

    text = story_file.read_text(encoding="utf-8")

    pattern = r"(^code_quality_adherence:\s*).*$"
    replacement = rf"\1{status}"
    new_text, count = re.subn(pattern, replacement, text, count=1, flags=re.MULTILINE)

    if count == 0:
        raise RuntimeError(
            f"Story file {story_file} does not contain a code_quality_adherence line to update."
        )

    story_file.write_text(new_text, encoding="utf-8")
    rel = story_file.relative_to(REPO_ROOT)
    print(f">>> Updated {rel} -> code_quality_adherence: {status}")


def run_lint_for_story(story_id: str) -> Tuple[bool, str]:
    """
    Run linting for a single Story:
    - execute Ruff on its targets
    - write evidence
    - update front matter

    Returns (passed, message).
    """
    config = STORY_CONFIG[story_id]
    story_file: Path = config["story_file"]  # type: ignore[assignment]
    targets: List[str] = config["lint_targets"]  # type: ignore[assignment]

    print(f">>> Running lint/code-quality checks for Story {story_id}")
    passed, message, issues = run_ruff_for_targets(targets)

    write_lint_evidence(story_id, targets, passed, message, issues)
    update_story_code_quality_status(story_file, passed)

    status = "pass" if passed else "fail"
    print(f">>> Story {story_id} code_quality_adherence set to {status}: {message}")
    return passed, message


# ---------------------------------------------------------------------------
# CLI entrypoint
# ---------------------------------------------------------------------------

def main(argv: List[str]) -> int:
    """
    Usage:
      python tools/run_story_lint.py          # run for all configured Stories
      python tools/run_story_lint.py ST-03    # run for a single Story
    """
    if len(argv) > 1:
        story_id = argv[1].upper()
        if story_id not in STORY_CONFIG:
            print(f"ERROR: Story {story_id!r} is not configured in STORY_CONFIG.")
            print(f"Known stories: {', '.join(sorted(STORY_CONFIG.keys()))}")
            return 1
        requested_ids = [story_id]
    else:
        requested_ids = sorted(STORY_CONFIG.keys())

    overall_exit = 0
    for sid in requested_ids:
        print(f"\n=== Lint/code-quality for Story {sid} ===")
        passed, _ = run_lint_for_story(sid)
        if not passed:
            overall_exit = 1

    return overall_exit


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))


===== FILE: tools\run_story_security.py =====
#!/usr/bin/env python
"""
Run security checks for one or more Stories and update security_policy_adherence
in each Story's front matter.

MVP:
- Use Bandit to scan the Story's Python files for security issues.
- If any Medium/High severity issues are found, mark as fail.
- Otherwise mark as pass.
"""

from __future__ import annotations

import json
import re
import subprocess
import sys
from pathlib import Path
from typing import Any, Dict, List, Tuple

# ---------------------------------------------------------------------------
# Repo root + sys.path
# ---------------------------------------------------------------------------

REPO_ROOT = Path(__file__).resolve().parents[1]
if str(REPO_ROOT) not in sys.path:
    sys.path.insert(0, str(REPO_ROOT))


# ---------------------------------------------------------------------------
# Story configuration
# ---------------------------------------------------------------------------

# For each Story:
# - story_file: markdown Story file
# - security_targets: list of Python files to scan with Bandit
STORY_CONFIG: Dict[str, Dict[str, Any]] = {
    "ST-03": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-03_map_identity_fields.md",
        "security_targets": [
            "src/services/client_profile/service.py",
            "src/domain/models/client_profile.py",
        ],
    },
    "ST-04": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-04_map_identifiers.md",
        "security_targets": [
            "src/services/client_profile/service.py",
            "src/domain/models/client_profile.py",
        ],
    },
    "ST-09": {
    "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-09_match_by_tax_id.md",
    "security_targets": [
        "src/services/client_profile/service.py",
    ],
},

    "ST-20": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-20_assemble_base_profile.md",
        "security_targets": [
            "src/services/client_profile/service.py",
            "src/domain/models/client_profile.py",
        ],
    },
    "ST-30": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-30_audit_ingestion.md",
        "security_targets": [
            "src/services/audit/service.py",
        ],
    },
     "ST-00": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-00-backend-api-availability.md",
        "security_targets": [
            "app_backend/main.py",
        ],
    },
     "ST-00-FRONTEND-UI-SHELL": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-00-frontend-ui-shell.md",
        "security_targets": [
            "app_backend/main.py",
        ],
    },


}


# ---------------------------------------------------------------------------
# Core helpers
# ---------------------------------------------------------------------------

def run_bandit_for_targets(targets: List[str]) -> Tuple[bool, str, List[Dict[str, Any]]]:
    """
    Run Bandit on the given Python files.

    Returns:
      (passed, message, issues)

    Where issues is a minimal list of findings we care about.
    """
    cmd = [
        sys.executable,
        "-m",
        "bandit",
        "-q",        # quiet banner
        "-f",
        "json",      # JSON output
        "-o",
        "-",         # write JSON to stdout
        *targets,
    ]
    print(f">>> Running Bandit: {' '.join(cmd)}")
    try:
        proc = subprocess.run(
            cmd,
            cwd=REPO_ROOT,
            capture_output=True,
            text=True,
            check=False,
        )
    except FileNotFoundError as exc:
        # bandit not installed / not importable
        return (
            False,
            f"Bandit not available: {exc!r}. Install bandit in this environment.",
            [],
        )

    stdout = proc.stdout or ""
    stderr = proc.stderr or ""

    # Bandit often returns 0 when no issues, 1 when issues found.
    # We don't rely solely on returncode; we parse JSON.
    if not stdout.strip():
        return (
            False,
            f"Bandit did not produce JSON output. rc={proc.returncode}, stderr={stderr.strip()}",
            [],
        )

    try:
        data = json.loads(stdout)
    except json.JSONDecodeError as exc:
        return (
            False,
            f"Failed to parse Bandit JSON output: {exc!r}",
            [],
        )

    raw_results = data.get("results", []) or []

    # Keep only medium/high severity & confidence findings.
    issues: List[Dict[str, Any]] = []
    for r in raw_results:
        severity = (r.get("issue_severity") or "").upper()
        confidence = (r.get("issue_confidence") or "").upper()
        if severity in {"MEDIUM", "HIGH"} and confidence in {"MEDIUM", "HIGH"}:
            issues.append(
                {
                    "filename": r.get("filename"),
                    "line_number": r.get("line_number"),
                    "test_id": r.get("test_id"),
                    "issue_severity": severity,
                    "issue_confidence": confidence,
                    "issue_text": r.get("issue_text"),
                }
            )

    if issues:
        return (
            False,
            f"Bandit found {len(issues)} medium/high security issue(s).",
            issues,
        )

    return True, "No medium/high security issues found by Bandit.", issues


def write_security_evidence(
    story_id: str,
    targets: List[str],
    passed: bool,
    message: str,
    issues: List[Dict[str, Any]],
) -> Path:
    """
    Write JSON evidence file for security adherence for this Story.
    """
    results_dir = REPO_ROOT / "evidence" / "security"
    results_dir.mkdir(parents=True, exist_ok=True)

    evidence_path = results_dir / f"{story_id}.json"
    payload = {
        "story_id": story_id,
        "targets": targets,
        "passed": passed,
        "message": message,
        "issues": issues,
    }
    evidence_path.write_text(json.dumps(payload, indent=2), encoding="utf-8")
    print(f">>> Wrote security evidence for {story_id} to {evidence_path.relative_to(REPO_ROOT)}")
    return evidence_path


def update_story_security_status(story_file: Path, passed: bool) -> None:
    """
    Replace the first 'security_policy_adherence: ...' line in the Story's front matter.
    """
    if not story_file.exists():
        raise FileNotFoundError(f"Story file not found: {story_file}")

    status = "pass" if passed else "fail"

    text = story_file.read_text(encoding="utf-8")

    pattern = r"(^security_policy_adherence:\s*).*$"
    replacement = rf"\1{status}"
    new_text, count = re.subn(pattern, replacement, text, count=1, flags=re.MULTILINE)

    if count == 0:
        raise RuntimeError(
            f"Story file {story_file} does not contain a security_policy_adherence line to update."
        )

    story_file.write_text(new_text, encoding="utf-8")
    rel = story_file.relative_to(REPO_ROOT)
    print(f">>> Updated {rel} -> security_policy_adherence: {status}")


def run_security_for_story(story_id: str) -> Tuple[bool, str]:
    """
    Run security scan for a single Story:
    - execute Bandit on its targets
    - write evidence
    - update front matter

    Returns (passed, message).
    """
    config = STORY_CONFIG[story_id]
    story_file: Path = config["story_file"]  # type: ignore[assignment]
    targets: List[str] = config["security_targets"]  # type: ignore[assignment]

    print(f">>> Running security checks for Story {story_id}")
    passed, message, issues = run_bandit_for_targets(targets)

    write_security_evidence(story_id, targets, passed, message, issues)
    update_story_security_status(story_file, passed)

    status = "pass" if passed else "fail"
    print(f">>> Story {story_id} security_policy_adherence set to {status}: {message}")
    return passed, message


# ---------------------------------------------------------------------------
# CLI entrypoint
# ---------------------------------------------------------------------------

def main(argv: List[str]) -> int:
    """
    Usage:
      python tools/run_story_security.py          # run for all configured Stories
      python tools/run_story_security.py ST-03    # run for a single Story
    """
    if len(argv) > 1:
        story_id = argv[1].upper()
        if story_id not in STORY_CONFIG:
            print(f"ERROR: Story {story_id!r} is not configured in STORY_CONFIG.")
            print(f"Known stories: {', '.join(sorted(STORY_CONFIG.keys()))}")
            return 1
        requested_ids = [story_id]
    else:
        requested_ids = sorted(STORY_CONFIG.keys())

    overall_exit = 0
    for sid in requested_ids:
        print(f"\n=== Security for Story {sid} ===")
        passed, _ = run_security_for_story(sid)
        if not passed:
            overall_exit = 1

    return overall_exit


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))


===== FILE: tools\run_story_tests.py =====
#!/usr/bin/env python
"""
Run tests for one or more Stories, record results, and update testing_status
in each Story's front-matter.

For each Story:
- Run pytest on its configured targets
- Write evidence to evidence/test_results/<ST-XX>.json
- Update testing_status: pass|fail in the Story markdown front matter
"""

from __future__ import annotations

import json
import re
import subprocess
import sys
from pathlib import Path
from typing import Dict, List, Tuple

# Repo root = parent of /tools
REPO_ROOT = Path(__file__).resolve().parents[1]


# ---------------------------------------------------------------------------
# Story configuration
# ---------------------------------------------------------------------------

# As more Stories gain real tests, add them here.
STORY_CONFIG: Dict[str, Dict[str, object]] = {
    "ST-03": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-03_map_identity_fields.md",
        # Pytest targets for this Story (should only contain tests for ST-03)
        "pytest_targets": [
            "tests/services/client_profile/test_client_profile_service.py",
        ],
    },
    "ST-04": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-04_map_identifiers.md",
        # Separate test file focused on identifier behaviour for ST-04
        "pytest_targets": [
            "tests/services/client_profile/test_st_04_map_identifiers.py",
        ],
    },
    "ST-09": {
    "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-09_match_by_tax_id.md",
    "pytest_targets": [
        "tests/services/client_profile/test_st_09_match_by_tax_id.py",
    ],
},


    "ST-20": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-20_assemble_base_profile.md",
        "pytest_targets": [
            "tests/services/client_profile/test_st_20_assemble_base_profile.py",
        ],
    },
    "ST-30": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-30_audit_ingestion.md",
        "pytest_targets": [
            "tests/services/audit/test_st_30_audit_ingestion.py",
        ],
    },
    "ST-00": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-00-backend-api-availability.md",
        "pytest_targets": [
            "tests/api/http/test_st_00_backend_api_availability.py",
        ],
         
    },
    "ST-00-FRONTEND-UI-SHELL": {
        "story_file": REPO_ROOT
        / "docs"
        / "mission_destination"
        / "stories"
        / "ST-00-frontend-ui-shell.md",
        "pytest_targets": [
            "tests/api/http/test_st_00_frontend_ui_shell.py",
        ],
    },






}


# ---------------------------------------------------------------------------
# Core helpers
# ---------------------------------------------------------------------------

def run_pytest_for_story(story_id: str, pytest_targets: List[str]) -> int:
    """
    Run pytest for the given Story and return its exit code.

    Uses `sys.executable -m pytest` so it works reliably on Windows, Mac, Linux.
    """
    cmd = [sys.executable, "-m", "pytest", "-q", *pytest_targets]
    print(f">>> Running tests for {story_id}: {' '.join(cmd)}")
    result = subprocess.run(cmd, cwd=REPO_ROOT, check=False)
    print(f">>> {story_id} pytest exit code: {result.returncode}")
    return result.returncode


def write_test_result_evidence(
    story_id: str,
    pytest_targets: List[str],
    exit_code: int,
    status: str,
) -> Path:
    """
    Write a small JSON evidence file with the Story's test result.
    """
    results_dir = REPO_ROOT / "evidence" / "test_results"
    results_dir.mkdir(parents=True, exist_ok=True)

    evidence_path = results_dir / f"{story_id}.json"
    payload = {
        "story_id": story_id,
        "pytest_targets": pytest_targets,
        "exit_code": exit_code,
        "status": status,
    }
    evidence_path.write_text(json.dumps(payload, indent=2), encoding="utf-8")
    print(
        ">>> Wrote test evidence for "
        f"{story_id} to {evidence_path.relative_to(REPO_ROOT)}"
    )
    return evidence_path


def update_story_testing_status(story_file: Path, status: str) -> None:
    """
    Replace the first 'testing_status: ...' line in the Story's front-matter.
    """
    if status not in {"pass", "fail"}:
        raise ValueError(f"Invalid status {status!r}; expected 'pass' or 'fail'")

    if not story_file.exists():
        raise FileNotFoundError(f"Story file not found: {story_file}")

    text = story_file.read_text(encoding="utf-8")

    pattern = r"(^testing_status:\s*).*$"
    replacement = rf"\1{status}"
    new_text, count = re.subn(pattern, replacement, text, count=1, flags=re.MULTILINE)

    if count == 0:
        raise RuntimeError(
            f"Story file {story_file} does not contain a testing_status line to update."
        )

    story_file.write_text(new_text, encoding="utf-8")
    rel = story_file.relative_to(REPO_ROOT)
    print(f">>> Updated {rel} -> testing_status: {status}")


def run_for_story(story_id: str) -> Tuple[int, str]:
    """
    Execute end-to-end for a single Story:
    - run pytest on its configured targets
    - derive status
    - write evidence
    - update front matter

    Returns (exit_code, status).
    """
    config = STORY_CONFIG[story_id]
    story_file: Path = config["story_file"]  # type: ignore[assignment]
    pytest_targets: List[str] = config["pytest_targets"]  # type: ignore[assignment]

    exit_code = run_pytest_for_story(story_id, pytest_targets)
    status = "pass" if exit_code == 0 else "fail"

    write_test_result_evidence(story_id, pytest_targets, exit_code, status)
    update_story_testing_status(story_file, status)

    print(f">>> Story {story_id} testing_status set to {status}")
    return exit_code, status


# ---------------------------------------------------------------------------
# CLI entrypoint
# ---------------------------------------------------------------------------

def main(argv: List[str]) -> int:
    """
    Usage:
      python tools/run_story_tests.py          # run for all configured Stories
      python tools/run_story_tests.py ST-03    # run for a single Story
    """
    if len(argv) > 1:
        story_id = argv[1].upper()
        if story_id not in STORY_CONFIG:
            print(f"ERROR: Story {story_id!r} is not configured in STORY_CONFIG.")
            print(f"Known stories: {', '.join(sorted(STORY_CONFIG.keys()))}")
            return 1
        requested_ids = [story_id]
    else:
        requested_ids = sorted(STORY_CONFIG.keys())

    overall_exit = 0
    for sid in requested_ids:
        print(f"\n=== Running tests for Story {sid} ===")
        exit_code, _ = run_for_story(sid)
        overall_exit = max(overall_exit, exit_code)

    return overall_exit


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))


===== FILE: tools\seed_demo_data.py =====
#!/usr/bin/env python
"""
Seed additional demo clients into the SCV database via the /ingest endpoint.

NOTE:
- This script ONLY creates NEW clients:
    - C-004, C-005, C-006, C-007
- It does NOT touch C-001, C-002, C-003 that you have already created.

Clients:

- C-004: Delta Manufacturing
    - CRM + KYC + VENDOR (external) sources
    - Slight differences in names, emails, addresses

- C-005: Eastbridge Holdings
    - Single CRM record with slightly messy data

- C-006: Flextronics / Flextronix
    - CRM + KYC with shared tax_id="TAX-777"
    - Great example for ST-09 match-by-tax-id

- C-007: GreyLake Partners
    - CRM + KYC + VENDOR sources
    - Conflicting emails, address formats, country codes

Run (from repo root, with backend running on 127.0.0.1:8000):

    python tools/seed_demo_data.py
"""

import requests

BACKEND_BASE_URL = "http://127.0.0.1:8000"
INGEST_URL = f"{BACKEND_BASE_URL}/ingest"


def ingest_record(rec: dict):
    """Send a single record to the backend /ingest endpoint."""
    wire_payload = {
        "client_id": rec["client_id"],
        "system": rec["system"],
        "payload": rec["payload"],  # dict, not JSON string
    }

    print(f"---> Ingesting {rec['system']} record for client {rec['client_id']}")

    resp = requests.post(INGEST_URL, json=wire_payload)

    if not resp.ok:
        print(f"!! Failed ({resp.status_code}): {resp.text}")
        resp.raise_for_status()

    data = resp.json()
    print(f"     OK: id={data.get('id')} system={data.get('system')}")
    return data


def main():
    print("=== Seeding EXTRA SCV demo data via /ingest ===")
    print(f"Target backend: {BACKEND_BASE_URL}\n")

    demo_records = [
        # ------------------------------------------------------------------
        # C-004 â€” Delta Manufacturing (rich multi-source example)
        # ------------------------------------------------------------------
        {
            "client_id": "C-004",
            "system": "CRM",
            "payload": {
                "_source": "CRM",
                "client_id": "C-004",
                "name": "Delta Manufacturing Ltd",
                "email": "info@delta-mfg.com",
                "phone": "+44 20 8000 4004",
                "country": "GB",
                "tax_id": "TAX-004",
                "registration_number": "REG-DELTA-01",
                "address_line1": "10 Industry Way",
                "address_city": "Birmingham",
                "postcode": "B1 2AA",
            },
        },
        {
            "client_id": "C-004",
            "system": "KYC",
            "payload": {
                "_source": "KYC",
                "client_id": "C-004",
                "name": "Delta MFG Limited",
                "email": "kyc@delta-mfg.com",
                "country": "UK",
                "tax_id": "TAX-004",
                "kyc_risk_rating": "LOW",
                "address_line1": "10 Industry Way",
                "address_city": "Birmingham",
                "postcode": "B1 2AA",
            },
        },
        {
            "client_id": "C-004",
            "system": "VENDOR",
            "payload": {
                "_source": "VENDOR",
                "client_id": "C-004",
                "name": "Delta Manufacturing Limited",
                "email": "compliance@delta-mfg.com",
                "country": "GBR",
                "tax_id": "TAX-004",
                "external_reference": "VEN-DELTA-2025",
            },
        },

        # ------------------------------------------------------------------
        # C-005 â€” Eastbridge Holdings (messy CRM-only)
        # ------------------------------------------------------------------
        {
            "client_id": "C-005",
            "system": "CRM",
            "payload": {
                "_source": "CRM",
                "client_id": "C-005",
                "name": "EASTBRIDGE HOLDINGS PLC",  # upper case
                "email": "contact@eastbridge-holdings.com",
                "phone": "+44 20 7005 5005",
                "country": "GB",
                "tax_id": None,  # intentionally missing tax id
                "registration_number": "REG-EAST-01",
                "identifier_1": "CRM-EAST-001",
                "identifier_2": "ALT-EAST-XYZ",
            },
        },

        # ------------------------------------------------------------------
        # C-006 â€” Flextronics / Flextronix (tax-id merge demo)
        # ------------------------------------------------------------------
        {
            "client_id": "C-006",
            "system": "CRM",
            "payload": {
                "_source": "CRM",
                "client_id": "C-006",
                "name": "Flextronics PLC",
                "email": "info@flextronics.com",
                "phone": "+44 20 7010 6006",
                "country": "GB",
                "tax_id": "TAX-777",
                "registration_number": "REG-FLEX-01",
            },
        },
        {
            "client_id": "C-006",
            "system": "KYC",
            "payload": {
                "_source": "KYC",
                "client_id": "C-006",
                "name": "Flextronix Plc",  # slight name variation
                "email": "kyc@flextronix.com",
                "country": "UK",
                "tax_id": "TAX-777",  # shared tax id â†’ ST-09 demo
                "kyc_risk_rating": "MEDIUM",
            },
        },

        # ------------------------------------------------------------------
        # C-007 â€” GreyLake Partners (three conflicting sources)
        # ------------------------------------------------------------------
        {
            "client_id": "C-007",
            "system": "CRM",
            "payload": {
                "_source": "CRM",
                "client_id": "C-007",
                "name": "Greylake Partners LLP",
                "email": "info@greylakepartners.co.uk",
                "phone": "+44 20 7020 7007",
                "country": "GB",
                "tax_id": "TAX-007",
                "registration_number": "REG-GREY-01",
                "address_line1": "50 Riverside Walk",
                "address_city": "London",
                "postcode": "EC2R 8AH",
            },
        },
        {
            "client_id": "C-007",
            "system": "KYC",
            "payload": {
                "_source": "KYC",
                "client_id": "C-007",
                "name": "GreyLake Partners LLP",  # different capitalisation
                "email": "kyc@greylakepartners.com",
                "country": "UK",
                "tax_id": "TAX-007",
                "kyc_risk_rating": "HIGH",
                "address_line1": "50 Riverside Walk",
                "address_city": "London",
                "postcode": "EC2R 8AH",
            },
        },
        {
            "client_id": "C-007",
            "system": "VENDOR",
            "payload": {
                "_source": "VENDOR",
                "client_id": "C-007",
                "name": "Greylake Partners LLP",
                "email": "operations@greylakepartners.com",
                "country": "GBR",
                "tax_id": "TAX-007",
                "external_reference": "VEN-GREY-2025",
            },
        },
    ]

    for rec in demo_records:
        ingest_record(rec)

    print("\n=== Extra demo data seeded successfully ===")
    print("You now have additional clients:")
    print("  â€¢ C-004  (Delta Manufacturing â€“ rich multi-source)")
    print("  â€¢ C-005  (Eastbridge Holdings â€“ messy CRM-only)")
    print("  â€¢ C-006  (Flextronics/Flextronix â€“ tax-id match demo)")
    print("  â€¢ C-007  (GreyLake Partners â€“ conflicting multi-source)")
    print()


if __name__ == "__main__":
    main()




===== FILE: tools\status_snapshot.py =====
#!/usr/bin/env python
"""
Mission Control Status Snapshot

Reads epics, features, and stories and writes:

  missionlog/status/status_snapshot.md     (Markdown tables for humans)
  app_frontend/public/missionlog/status_snapshot.json  (JSON for MissionLog UI)

Markdown contains three tables:
- Epics:    Epic | Name | Overall
- Features: Feature | Epic | Name | Overall | Stories
- Stories:  Story | Feature | Name | Overall

JSON contains a nested structure:

{
  "generated_at": "...",
  "epics": [
    {
      "epic_id": "...",
      "name": "...",
      "overall_status": "...",
      "features": [
        {
          "feature_id": "...",
          "name": "...",
          "epic_id": "...",
          "overall_status": "...",
          "stories": [
            {
              "story_id": "...",
              "name": "...",
              "feature_id": "...",
              "overall_status": "...",
              "testing_status": "...",
              "halo_adherence": "...",
              "guardrail_adherence": "...",
              "code_quality_adherence": "...",
              "security_policy_adherence": "..."
            }
          ]
        }
      ]
    }
  ]
}
"""

from __future__ import annotations

import json
import re
from dataclasses import dataclass
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional

REPO_ROOT = Path(__file__).resolve().parents[1]

EPICS_DIR = REPO_ROOT / "docs" / "mission_destination" / "epics"
FEATURES_DIR = REPO_ROOT / "docs" / "mission_destination" / "features"
STORIES_DIR = REPO_ROOT / "docs" / "mission_destination" / "stories"

SNAPSHOT_DIR = REPO_ROOT / "missionlog" / "status"
SNAPSHOT_PATH = SNAPSHOT_DIR / "status_snapshot.md"

PUBLIC_STATUS_DIR = REPO_ROOT / "app_frontend" / "public" / "missionlog"
PUBLIC_STATUS_JSON = PUBLIC_STATUS_DIR / "status_snapshot.json"


# -------------------- helpers -------------------- #

def _read(path: Path) -> str:
    return path.read_text(encoding="utf-8")


def _extract_scalar(text: str, key: str) -> Optional[str]:
    pattern = rf"^{re.escape(key)}:\s*(.+)$"
    m = re.search(pattern, text, flags=re.MULTILINE)
    if not m:
        return None
    val = m.group(1).strip()
    if val and val[0] in {"'", '"'} and val[-1:] == val[0]:
        val = val[1:-1]
    return val or None


def _extract_yaml_list(text: str, key: str) -> List[str]:
    pattern = rf"^{re.escape(key)}:\s*\n(?P<body>(?:\s+- .*\n)+)"
    m = re.search(pattern, text, flags=re.MULTILINE)
    if not m:
        return []
    body = m.group("body")
    items: List[str] = []
    for line in body.splitlines():
        s = line.strip()
        if s.startswith("- "):
            val = s[2:].strip()
            if val:
                items.append(val)
    return items


def _safe_overall(val: Optional[str]) -> str:
    if not val:
        return ""
    t = val.strip().strip('"\'')
    lookup = {
        "planned": "Planned",
        "in progress": "In Progress",
        "in_progress": "In Progress",
        "in-progress": "In Progress",
        "complete": "Complete",
        "completed": "Complete",
        "done": "Complete",
    }
    return lookup.get(t.lower(), t)


def _safe_dim(val: Optional[str]) -> str:
    """
    Normalise dimension statuses to: pass / fail / not_run.
    """
    if not val:
        return "not_run"
    t = val.strip().strip('"\'').lower()
    if t in {"pass", "ok", "success", "compliant"}:
        return "pass"
    if t in {"fail", "error", "non_compliant", "non-compliant"}:
        return "fail"
    if t in {"not_run", "not run", "pending", "planned"}:
        return "not_run"
    return t


# -------------------- data structures -------------------- #

@dataclass
class EpicRow:
    epic_id: str
    name: str
    overall: str


@dataclass
class FeatureRow:
    feature_id: str
    epic_id: str
    name: str
    overall: str
    stories: List[str]


@dataclass
class StoryRow:
    story_id: str
    feature_id: str
    name: str
    overall: str
    testing_status: str
    halo_adherence: str
    guardrail_adherence: str
    code_quality_adherence: str
    security_policy_adherence: str


# -------------------- collectors -------------------- #

def collect_epics() -> Dict[str, EpicRow]:
    rows: Dict[str, EpicRow] = {}

    for path in sorted(EPICS_DIR.glob("*.md")):
        text = _read(path)

        epic_id = _extract_scalar(text, "epic_id")
        if not epic_id:
            continue

        name = _extract_scalar(text, "name") or path.stem
        overall = _safe_overall(_extract_scalar(text, "overall_status"))

        rows[epic_id] = EpicRow(
            epic_id=epic_id,
            name=name,
            overall=overall,
        )

    return rows


def collect_features() -> Dict[str, FeatureRow]:
    rows: Dict[str, FeatureRow] = {}

    for path in sorted(FEATURES_DIR.glob("*.md")):
        text = _read(path)

        feature_id = _extract_scalar(text, "feature_id")
        if not feature_id:
            continue

        epic_id = _extract_scalar(text, "epic") or ""
        name = _extract_scalar(text, "name") or path.stem
        overall = _safe_overall(_extract_scalar(text, "overall_status"))
        stories = _extract_yaml_list(text, "stories")

        rows[feature_id] = FeatureRow(
            feature_id=feature_id,
            epic_id=epic_id,
            name=name,
            overall=overall,
            stories=stories,
        )

    return rows


def collect_stories() -> Dict[str, StoryRow]:
    rows: Dict[str, StoryRow] = {}

    for path in sorted(STORIES_DIR.glob("*.md")):
        text = _read(path)

        story_id = _extract_scalar(text, "story_id")
        if not story_id:
            continue

        feature_id = _extract_scalar(text, "feature")
        name = _extract_scalar(text, "name") or path.stem
        overall = _safe_overall(_extract_scalar(text, "overall_status"))

        testing = _safe_dim(_extract_scalar(text, "testing_status"))
        halo = _safe_dim(_extract_scalar(text, "halo_adherence"))
        guardrail = _safe_dim(_extract_scalar(text, "guardrail_adherence"))
        code_quality = _safe_dim(_extract_scalar(text, "code_quality_adherence"))
        security = _safe_dim(_extract_scalar(text, "security_policy_adherence"))

        rows[story_id] = StoryRow(
            story_id=story_id,
            feature_id=feature_id or "",
            name=name,
            overall=overall,
            testing_status=testing,
            halo_adherence=halo,
            guardrail_adherence=guardrail,
            code_quality_adherence=code_quality,
            security_policy_adherence=security,
        )

    return rows


# -------------------- Markdown renderers -------------------- #

def _render_epics_table(epics: Dict[str, EpicRow]) -> str:
    if not epics:
        return "_No epics found._\n"

    lines: List[str] = []
    lines.append("| Epic | Name | Overall |")
    lines.append("|------|------|---------|")

    for eid in sorted(epics.keys()):
        e = epics[eid]
        lines.append(f"| {e.epic_id} | {e.name} | {e.overall} |")

    return "\n".join(lines) + "\n"


def _render_features_table(features: Dict[str, FeatureRow],
                           feature_to_story_ids: Dict[str, List[str]]) -> str:
    if not features:
        return "_No features found._\n"

    lines: List[str] = []
    lines.append("| Feature | Epic | Name | Overall | Stories |")
    lines.append("|---------|------|------|---------|---------|")

    for fid in sorted(features.keys()):
        f = features[fid]
        story_ids = feature_to_story_ids.get(fid, f.stories or [])
        stories_str = ", ".join(sorted(story_ids)) if story_ids else ""
        lines.append(
            f"| {f.feature_id} | {f.epic_id} | {f.name} | {f.overall} | {stories_str} |"
        )

    return "\n".join(lines) + "\n"


def _render_stories_table(stories: Dict[str, StoryRow]) -> str:
    if not stories:
        return "_No stories found._\n"

    lines: List[str] = []
    lines.append("| Story | Feature | Name | Overall |")
    lines.append("|-------|---------|------|---------|")

    for sid in sorted(stories.keys()):
        s = stories[sid]
        lines.append(f"| {s.story_id} | {s.feature_id} | {s.name} | {s.overall} |")

    return "\n".join(lines) + "\n"


def build_snapshot_markdown() -> str:
    epics = collect_epics()
    features = collect_features()
    stories = collect_stories()

    # Golden mapping: story.feature_id drives which stories belong to a feature.
    feature_to_story_ids: Dict[str, List[str]] = {}
    for s in stories.values():
        if not s.feature_id:
            continue
        feature_to_story_ids.setdefault(s.feature_id, []).append(s.story_id)

    parts: List[str] = []
    parts.append("# Mission Control Status Snapshot\n")

    parts.append("## Epics\n")
    parts.append(_render_epics_table(epics))

    parts.append("\n## Features\n")
    parts.append(_render_features_table(features, feature_to_story_ids))

    parts.append("\n## Stories\n")
    parts.append(_render_stories_table(stories))

    return "\n".join(parts)


# -------------------- JSON snapshot for MissionLog -------------------- #

def build_snapshot_json() -> Dict[str, object]:
    epics = collect_epics()
    features = collect_features()
    stories = collect_stories()

    # Map feature -> [StoryRow] via golden mapping (Story.feature_id)
    feature_to_stories: Dict[str, List[StoryRow]] = {}
    for s in stories.values():
        if not s.feature_id:
            continue
        feature_to_stories.setdefault(s.feature_id, []).append(s)

    # Map epic -> [FeatureRow] via Feature.epic_id
    epic_to_features: Dict[str, List[FeatureRow]] = {}
    for f in features.values():
        if not f.epic_id:
            continue
        epic_to_features.setdefault(f.epic_id, []).append(f)

    epics_payload: List[Dict[str, object]] = []

    for eid in sorted(epics.keys()):
        e = epics[eid]
        feature_rows = sorted(
            epic_to_features.get(eid, []),
            key=lambda fr: fr.feature_id,
        )

        features_payload: List[Dict[str, object]] = []
        for f in feature_rows:
            story_rows = sorted(
                feature_to_stories.get(f.feature_id, []),
                key=lambda sr: sr.story_id,
            )
            stories_payload: List[Dict[str, object]] = []
            for s in story_rows:
                stories_payload.append(
                    {
                        "story_id": s.story_id,
                        "name": s.name,
                        "feature_id": s.feature_id,
                        "overall_status": s.overall,
                        "testing_status": s.testing_status,
                        "halo_adherence": s.halo_adherence,
                        "guardrail_adherence": s.guardrail_adherence,
                        "code_quality_adherence": s.code_quality_adherence,
                        "security_policy_adherence": s.security_policy_adherence,
                    }
                )

            features_payload.append(
                {
                    "feature_id": f.feature_id,
                    "name": f.name,
                    "epic_id": f.epic_id,
                    "overall_status": f.overall,
                    "stories": stories_payload,
                }
            )

        epics_payload.append(
            {
                "epic_id": e.epic_id,
                "name": e.name,
                "overall_status": e.overall,
                "features": features_payload,
            }
        )

    return {
        "generated_at": datetime.utcnow().isoformat(timespec="seconds") + "Z",
        "epics": epics_payload,
    }


# -------------------- CLI -------------------- #

def main() -> int:
    print("=== Generating Mission Control Status Snapshot (overall + JSON) ===")
    print(f"Repo root: {REPO_ROOT}")

    SNAPSHOT_DIR.mkdir(parents=True, exist_ok=True)
    PUBLIC_STATUS_DIR.mkdir(parents=True, exist_ok=True)

    # Markdown snapshot (for the repo / docs)
    markdown = build_snapshot_markdown()
    SNAPSHOT_PATH.write_text(markdown, encoding="utf-8")
    print(f"Wrote Markdown snapshot to {SNAPSHOT_PATH.relative_to(REPO_ROOT)}")

    # JSON snapshot (for MissionLog UI)
    json_data = build_snapshot_json()
    PUBLIC_STATUS_JSON.write_text(
        json.dumps(json_data, indent=2),
        encoding="utf-8",
    )
    print(f"Wrote JSON snapshot to {PUBLIC_STATUS_JSON.relative_to(REPO_ROOT)}")

    print("=== Done ===")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())


===== FILE: tools\update_story_overall_status.py =====
#!/usr/bin/env python
"""
Derive Story overall_status from testing / guardrail / code / security.

Rule per story:

1. Normalise each dimension:

   - pass / ok / success / compliant  -> Complete
   - fail / error / non_compliant     -> In Progress
   - not_run / pending / empty        -> Planned

2. overall_status:

   - Complete  if all four dims are Complete
   - Planned   if all four dims are Planned
   - In Progress otherwise

This script ONLY updates Story frontmatter.
Features/Epics are still rolled up by rollup_statuses.py.
"""

from __future__ import annotations

import re
from pathlib import Path
from typing import Optional, List, Dict

REPO_ROOT = Path(__file__).resolve().parents[1]
STORIES_DIR = REPO_ROOT / "docs" / "mission_destination" / "stories"


# ----------------- helpers ----------------- #

def _read(path: Path) -> str:
    return path.read_text(encoding="utf-8")


def _write(path: Path, text: str) -> None:
    path.write_text(text, encoding="utf-8")


def _extract_scalar(text: str, key: str) -> Optional[str]:
    pattern = rf"^{re.escape(key)}:\s*(.+)$"
    m = re.search(pattern, text, flags=re.MULTILINE)
    if not m:
        return None
    val = m.group(1).strip()
    if val and val[0] in {"'", '"'} and val[-1:] == val[0]:
        val = val[1:-1]
    return val or None


def _replace_scalar(text: str, key: str, value: str) -> str:
    pattern = rf"^{re.escape(key)}:\s*.*$"
    replacement = f"{key}: {value}"

    if re.search(pattern, text, flags=re.MULTILINE):
        return re.sub(pattern, replacement, text, count=1, flags=re.MULTILINE)

    # insert before last_updated if present
    lu_pattern = r"^last_updated:\s*.*$"
    m = re.search(lu_pattern, text, flags=re.MULTILINE)
    if m:
        start = m.start()
        return text[:start] + replacement + "\n" + text[start:]

    # else append at end of front matter
    if not text.endswith("\n"):
        text += "\n"
    return text + replacement + "\n"


def _norm_dim(raw: Optional[str]) -> str:
    """
    Normalise a dimension value to:

        Planned | In Progress | Complete
    """
    if raw is None:
        return "Planned"

    t = raw.strip().strip('"\'')
    tl = t.lower()

    # already canonical?
    if tl in {"planned"}:
        return "Planned"
    if tl in {"in progress", "in_progress", "in-progress"}:
        return "In Progress"
    if tl in {"complete", "completed"}:
        return "Complete"

    # pass-ish
    if tl in {"pass", "passed", "ok", "success", "succeeded", "compliant", "true", "yes"}:
        return "Complete"

    # fail-ish
    if tl in {"fail", "failed", "error", "non_compliant", "non-compliant", "false", "no"}:
        return "In Progress"

    # not-run / unknown â†’ planned
    if tl in {"not_run", "not-run", "not run", "pending", "todo", "tbd", "unknown", "n/a", "na", ""}:
        return "Planned"

    # default: treat as in progress
    return "In Progress"


def _derive_overall(dim_values: List[str]) -> str:
    """
    dim_values is a list of 4 statuses (Planned/IP/Complete).

    - Complete  if all Complete
    - Planned   if all Planned
    - In Progress otherwise
    """
    s = set(dim_values)
    if s == {"Complete"}:
        return "Complete"
    if s == {"Planned"}:
        return "Planned"
    return "In Progress"


# ----------------- main ----------------- #

def update_stories() -> None:
    for path in sorted(STORIES_DIR.glob("*.md")):
        text = _read(path)

        story_id = _extract_scalar(text, "story_id")
        if not story_id:
            continue  # skip non-Mission stories

        testing = _norm_dim(_extract_scalar(text, "testing_status"))
        guardrail = _norm_dim(_extract_scalar(text, "guardrail_adherence"))
        code_quality = _norm_dim(_extract_scalar(text, "code_quality_adherence"))
        security = _norm_dim(_extract_scalar(text, "security_policy_adherence"))

        dims = [testing, guardrail, code_quality, security]
        overall = _derive_overall(dims)

        new_text = _replace_scalar(text, "overall_status", overall)

        if new_text != text:
            _write(path, new_text)
            print(f">>> Story {story_id}: overall_status -> {overall}")


def main() -> int:
    print("=== Deriving Story overall_status from test/guardrail/code/security ===")
    print(f"Repo root: {REPO_ROOT}")
    update_stories()
    print("=== Done ===")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())


===== FILE: tools\update_testing_status.py =====
import sys
from pathlib import Path
import re

def main():
    if len(sys.argv) != 3:
        print("Usage: update_testing_status.py <story_path> <status>")
        sys.exit(1)

    story_path = Path(sys.argv[1])
    status = sys.argv[2]

    if status not in {"not_run", "pass", "fail"}:
        print(f"Invalid status: {status}")
        sys.exit(1)

    text = story_path.read_text(encoding="utf-8")

    # Replace the first occurrence of 'testing_status: ...'
    pattern = r"(^testing_status:\s*).*$"
    replacement = rf"\1{status}"
    new_text, count = re.subn(pattern, replacement, text, count=1, flags=re.MULTILINE)

    if count == 0:
        print("No testing_status line found to update.")
        sys.exit(1)

    story_path.write_text(new_text, encoding="utf-8")

if __name__ == "__main__":
    main()

